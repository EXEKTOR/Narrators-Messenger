<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARRATORS // V6 RED</title>
    <style>
        :root {
            /* –¢–í–û–Ø –ü–ê–õ–ò–¢–†–ê */
            --bg-body: #ffffff;
            --bg-sidebar: #f7f7f7; /* –ß—É—Ç—å —Å–µ—Ä–æ–≤–∞—Ç—ã–π –¥–ª—è —Å–ø–∏—Å–∫–∞ */
            --bg-chat: #ffffff;
            --primary: #ff0033;    /* –ö–†–ê–°–ù–´–ô –ì–õ–ê–í–ù–´–ô */
            --text-main: #222222;
            --text-dim: #666666;
            --border: #dddddd;
            
            /* –°–æ–æ–±—â–µ–Ω–∏—è */
            --msg-me: #ff0033;
            --msg-me-text: #ffffff;
            --msg-other: #f0f0f0;
            --msg-other-text: #000000;
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
        }

        /* --- –ü–û–õ–ù–û–≠–ö–†–ê–ù–ù–´–ï –ü–ê–ù–ï–õ–ò (–í—Ö–æ–¥/–†–µ–≥–∞) --- */
        .full-screen-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2000;
        }

        h1 { color: var(--primary); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
        h2 { color: var(--text-main); margin-bottom: 20px; }

        input {
            padding: 12px; border: 1px solid var(--border); border-radius: 4px;
            font-size: 1rem; width: 300px; margin-bottom: 15px; outline: none;
            background: #f9f9f9;
        }
        input:focus { border-color: var(--primary); background: #fff; }
        
        button.btn-primary {
            padding: 12px 30px; border: none; background: var(--primary); color: #fff;
            font-weight: bold; cursor: pointer; border-radius: 4px; font-size: 1rem;
            text-transform: uppercase; transition: 0.2s;
        }
        button.btn-primary:hover { transform: scale(1.02); }

        /* --- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (2 –∫–æ–ª–æ–Ω–∫–∏) --- */
        #app-layout {
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è */
            width: 100%; height: 100%;
        }

        /* –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê */
        #sidebar {
            width: 350px;
            height: 100%;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
        }

        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); }
        .search-box { width: 100%; margin: 0; border-radius: 20px; }

        .chat-list { flex: 1; overflow-y: auto; }

        .chat-item {
            padding: 15px; display: flex; align-items: center; gap: 15px;
            cursor: pointer; border-bottom: 1px solid transparent;
            transition: 0.2s;
        }
        .chat-item:hover { background: #fff; border-bottom-color: var(--border); }
        .chat-item.active { background: #fff; border-right: 4px solid var(--primary); }
        
        .avatar {
            width: 50px; height: 50px; border-radius: 50%; 
            background: var(--text-dim); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem;
        }
        .avatar.red { background: var(--primary); }

        /* –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (–ß–ê–¢) */
        #main-chat {
            flex: 1; height: 100%;
            display: flex; flex-direction: column;
            background: var(--bg-chat);
            position: relative;
        }

        .chat-header {
            padding: 10px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            height: 60px;
        }

        #messages {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 10px;
        }

        .message {
            max-width: 60%; padding: 10px 15px; border-radius: 10px;
            font-size: 0.95rem; line-height: 1.4; position: relative;
        }
        
        /* –°–í–û–ò (–ö—Ä–∞—Å–Ω—ã–µ) */
        .message.me {
            background: var(--msg-me); 
            color: var(--msg-me-text);
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        
        /* –ß–£–ñ–ò–ï (–°–µ—Ä—ã–µ/–ë–µ–ª—ã–µ) */
        .message.other {
            background: var(--msg-other);
            color: var(--msg-other-text);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .msg-name {
            font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; display: block;
            color: inherit; opacity: 0.8; cursor: pointer;
        }

        .input-area {
            padding: 15px; border-top: 1px solid var(--border);
            display: flex; gap: 10px; align-items: center;
        }
        
        #btn-send {
            background: none; border: none; color: var(--primary); 
            font-size: 1.5rem; cursor: pointer; padding: 0 10px;
        }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 700px) {
            #sidebar { width: 100%; display: flex; }
            #main-chat { display: none; width: 100%; }
            
            body.chat-open #sidebar { display: none; }
            body.chat-open #main-chat { display: flex; }
            
            #btn-back { display: block !important; margin-right: 10px; }
        }
    </style>
</head>
<body>

    <!-- 1. –í–•–û–î -->
    <div id="login-panel" class="full-screen-panel">
        <h1>NARRATORS</h1>
        <p style="color: #888; margin-bottom: 30px;">AUTHORIZATION REQUIRED</p>
        <button id="btn-login" class="btn-primary">–í–û–ô–¢–ò –ß–ï–†–ï–ó GOOGLE</button>
    </div>

    <!-- 2. –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ü–†–û–§–ò–õ–Ø -->
    <div id="reg-panel" class="full-screen-panel" style="display: none;">
        <h1>IDENTITY</h1>
        <p style="color: #666; margin-bottom: 20px;">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</p>
        
        <input type="text" id="reg-nick" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è (Nick)" maxlength="20">
        <input type="text" id="reg-tag" placeholder="@username (–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–≥)" maxlength="15">
        <button id="btn-save-profile" class="btn-primary">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
    </div>

    <!-- 3. –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div id="app-layout">
        
        <!-- SIDEBAR -->
        <div id="sidebar">
            <div class="sidebar-header">
                <input type="text" class="search-box" placeholder="–ü–æ–∏—Å–∫ @user..." id="search-input">
            </div>
            
            <div class="chat-list" id="chat-list">
                <!-- –û–±—â–∏–π —á–∞—Ç -->
                <div class="chat-item active" onclick="openChat()">
                    <div class="avatar red">G</div>
                    <div class="chat-info">
                        <div style="font-weight: bold;">Global Channel</div>
                        <div style="font-size: 0.8rem; color: #888;">–û–±—â–∏–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö</div>
                    </div>
                </div>
            </div>
            
            <div style="padding: 15px; border-top: 1px solid var(--border); text-align: center;">
                 <span id="my-tag-display" style="font-weight:bold; color: var(--primary);">Loading...</span>
            </div>
        </div>

        <!-- MAIN CHAT -->
        <div id="main-chat">
            <div class="chat-header">
                <div style="display:flex; align-items:center;">
                    <button id="btn-back" style="display:none; border:none; background:none; font-size:1.5rem; color:var(--text-main);">‚¨Ö</button>
                    <div style="font-weight:bold; font-size: 1.1rem; color: var(--primary);">// GLOBAL CHANNEL</div>
                </div>
                <button id="btn-logout" style="border:none; background:none; cursor:pointer; font-size:1.2rem;" title="–í—ã–π—Ç–∏">üö™</button>
            </div>

            <div id="messages"></div>

            <div class="input-area">
                <button id="btn-attach" style="border:none; background:none; font-size:1.3rem; cursor:pointer; opacity: 0.6;">üì∑</button>
                <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; margin:0; border-radius: 20px;">
                <button id="btn-send">‚û§</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, limit, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // –ö–û–ù–§–ò–ì
        const firebaseConfig = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677",
            measurementId: "G-XN1B0KZ5ML"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const els = {
            login: document.getElementById('login-panel'),
            reg: document.getElementById('reg-panel'),
            app: document.getElementById('app-layout'),
            btnLogin: document.getElementById('btn-login'),
            btnReg: document.getElementById('btn-save-profile'),
            btnOut: document.getElementById('btn-logout'),
            inputNick: document.getElementById('reg-nick'),
            inputTag: document.getElementById('reg-tag'),
            myTag: document.getElementById('my-tag-display'),
            msgList: document.getElementById('messages'),
            msgInput: document.getElementById('msg-input'),
            btnSend: document.getElementById('btn-send'),
            btnAttach: document.getElementById('btn-attach'),
            btnBack: document.getElementById('btn-back')
        };

        let user = null;
        let userData = null;

        // --- AUTH ---
        els.btnLogin.addEventListener('click', () => signInWithPopup(auth, provider));
        els.btnOut.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (u) => {
            user = u;
            if (user) {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Ö–æ–¥, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –±–µ–ª—ã–π —Ñ–æ–Ω –Ω–∞ —Å–µ–∫)
                els.login.style.display = 'none';
                
                try {
                    // –ò—â–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –±–∞–∑–µ
                    const docRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        // –ü—Ä–æ—Ñ–∏–ª—å –µ—Å—Ç—å -> –æ—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
                        userData = docSnap.data();
                        initApp();
                    } else {
                        // –ü—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç -> –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                        els.reg.style.display = 'flex';
                        els.inputNick.value = user.displayName;
                    }
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", e);
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç –ø—Ä–∞–≤) - –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∂–µ–º —á–∞—Ç, –Ω–æ –±–µ–∑ –Ω–∏–∫–∞
                    userData = { displayName: user.displayName, usernameDisplay: 'anon' };
                    initApp(); 
                }
            } else {
                // –í—ã—à–ª–∏
                els.login.style.display = 'flex';
                els.reg.style.display = 'none';
                els.app.style.display = 'none';
            }
        });

        // --- REGISTRATION ---
        els.btnReg.addEventListener('click', async () => {
            const nick = els.inputNick.value.trim();
            let tag = els.inputTag.value.trim().replace('@', '');
            if(nick.length < 1 || tag.length < 1) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!');

            try {
                const newData = {
                    displayName: nick,
                    usernameDisplay: tag,
                    username: tag.toLowerCase(),
                    uid: user.uid,
                    photoURL: user.photoURL
                };
                await setDoc(doc(db, "users", user.uid), newData);
                userData = newData;
                els.reg.style.display = 'none';
                initApp();
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å.");
            }
        });

        // --- APP LOGIC ---
        function initApp() {
            els.app.style.display = 'flex';
            els.myTag.innerText = '@' + (userData.usernameDisplay || 'user');
            loadChat();
        }

        async function sendMsg(txt) {
            if(!txt || !user) return;
            try {
                await addDoc(collection(db, "messages"), {
                    text: txt,
                    uid: user.uid,
                    displayName: userData.displayName,
                    username: userData.usernameDisplay,
                    createdAt: serverTimestamp()
                });
            } catch (e) { console.error(e); }
        }

        els.btnSend.addEventListener('click', () => {
            const val = els.msgInput.value.trim();
            if(val) { sendMsg(val); els.msgInput.value = ''; }
        });
        els.msgInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                const val = els.msgInput.value.trim();
                if(val) { sendMsg(val); els.msgInput.value = ''; }
            }
        });
        els.btnAttach.addEventListener('click', () => {
            const url = prompt("URL –∫–∞—Ä—Ç–∏–Ω–∫–∏:");
            if(url) sendMsg(url);
        });

        function loadChat() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"), limit(50));
            onSnapshot(q, (snap) => {
                els.msgList.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === user.uid;
                    const div = document.createElement('div');
                    div.className = `message ${isMe ? 'me' : 'other'}`;
                    
                    let content = m.text;
                    if(content.match(/\.(jpg|jpeg|png|gif)/i) || content.startsWith('http')) {
                         if(content.startsWith('http')) content = `<img src="${content}" style="max-width:100%; border-radius:5px; margin-top:5px;">`;
                    }
                    
                    div.innerHTML = `
                        <span class="msg-name" onclick="alert('@${m.username}')">${m.displayName || 'Anon'}</span>
                        ${content}
                    `;
                    els.msgList.appendChild(div);
                });
                els.msgList.scrollTop = els.msgList.scrollHeight;
            });
        }

        // Mobile Nav
        window.openChat = () => {
            if(window.innerWidth <= 700) {
                document.body.classList.add('chat-open');
                els.btnBack.style.display = 'block';
            }
        };
        els.btnBack.addEventListener('click', () => {
            document.body.classList.remove('chat-open');
            els.btnBack.style.display = 'none';
        });

    </script>
</body>
</html>
