<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Narrators Messenger v0.1.6 (merged UI fixes)</title>

    <style>
        :root{
            --primary:#3390ec;
            --primary-soft:rgba(51,144,236,0.08);
            --bg:#ffffff;
            --muted:#707579;
            --border:#e6e6e9;
            --radius:12px;
            --shadow-sm: 0 6px 18px rgba(18,38,63,0.08);
            --ease: cubic-bezier(.2,.9,.3,1);
            --msg-me: #eeffde;
            --msg-me-text: #000000;
            --msg-other: #f4f4f5;
            --msg-other-text: #000000;
            --font-size:16px;
        }

        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%}
        body{
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background:var(--bg);
            color:#111;
            height:100vh;
            display:flex;
            overflow:hidden;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            font-size:var(--font-size);
        }

        /* subtle animations */
        .fade-in { animation: fadeIn .18s var(--ease) both; }
        @keyframes fadeIn { from{opacity:0; transform: translateY(4px)} to{opacity:1; transform:none} }

        /* layout */
        #app{display:flex;width:100%;height:100%}
        #sidebar{
            width:360px;
            flex-shrink:0;
            border-right:1px solid var(--border);
            display:flex;
            flex-direction:column;
            background:linear-gradient(180deg,var(--bg),#fafbfd);
            position:relative;
            padding-bottom:12px;
        }

        .sidebar-top{
            padding:14px 16px;
            display:flex;
            gap:12px;
            align-items:center;
            border-bottom:1px solid var(--border);
        }

        .user-avatar{
            width:56px;height:56px;border-radius:12px;object-fit:cover;cursor:pointer;
            box-shadow:var(--shadow-sm);
            transition:transform .18s var(--ease);
        }
        .user-avatar:hover{ transform:translateY(-2px) scale(1.03) }

        .sidebar-meta { flex:1; }
        .sidebar-meta .name{ font-weight:800; font-size:15px; }
        .sidebar-meta .tag{ color:var(--muted); font-size:13px; margin-top:2px; }

        #sidebar-menu-btn{
            background:transparent;border:none;padding:8px;border-radius:10px;cursor:pointer;
            display:inline-flex;align-items:center;justify-content:center;
            transition:transform .18s var(--ease), background .18s var(--ease);
        }
        #sidebar-menu-btn:hover{ background:var(--primary-soft) }

        /* anchored sidebar menu */
        .sidebar-menu{
            position:absolute;
            left:16px;
            top:80px;
            width:220px;
            background:#fff;
            border-radius:12px;
            box-shadow:var(--shadow-sm);
            border:1px solid var(--border);
            overflow:hidden;
            transform-origin:top left;
            transform: translateY(-6px) scale(.98);
            opacity:0;
            pointer-events:none;
            transition: transform .22s var(--ease), opacity .22s var(--ease);
            z-index:80;
        }
        .sidebar-menu.active{
            transform: translateY(0) scale(1);
            opacity:1;
            pointer-events:auto;
        }
        .sidebar-menu .item{
            padding:12px 14px;
            cursor:pointer;
            font-weight:600;
            color:#123;
            display:flex;
            align-items:center;
            gap:10px;
            background:transparent;
            transition: background .12s var(--ease), transform .12s var(--ease);
        }
        .sidebar-menu .item:hover{
            background:linear-gradient(90deg,var(--primary-soft), transparent);
            transform: translateX(4px);
        }
        .sidebar-menu .divider{ height:1px; background:var(--border); margin:6px 0 }

        .search-wrap { padding:12px; }
        .input-field{
            width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff;
            transition:box-shadow .12s var(--ease), border-color .12s var(--ease);
        }
        .input-field:focus{ box-shadow:0 8px 20px rgba(17,24,39,0.04); border-color:var(--primary) }

        .chat-list-container{ flex:1; overflow:auto; padding:8px 12px; }

        .chat-row{
            display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px;
            transition: background .12s var(--ease), transform .12s var(--ease);
        }
        .chat-row:hover{ background:var(--primary-soft); transform:translateX(4px) }

        #chat-window{ flex:1; display:flex; flex-direction:column; background:var(--bg) }
        .chat-top-bar{
            display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:1px solid var(--border);
            background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));
            position:relative;
        }
        #chat-top-avatar{ width:44px;height:44px;border-radius:10px;object-fit:cover;cursor:pointer; transition:transform .15s var(--ease) }
        #chat-top-avatar:hover{ transform:translateY(-2px) }

        #messages-view{ flex:1; overflow:auto; padding:20px; display:flex; flex-direction:column; gap:12px; scroll-behavior:smooth; background:linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.00)); }

        .msg-wrapper{ display:flex; gap:10px; align-items:flex-end; width:100%; animation:msgIn .18s var(--ease); }
        @keyframes msgIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

        .msg-wrapper.my-msg{ justify-content:flex-end }
        .msg-wrapper.other-msg{ justify-content:flex-start }

        .msg-bubble{
            background:var(--msg-other); padding:12px 14px; border-radius:14px; max-width:72%; box-shadow:0 6px 20px rgba(11,22,39,0.04);
            transition: transform .12s var(--ease), box-shadow .12s var(--ease);
        }
        .msg-bubble:hover{ transform:translateY(-3px); box-shadow:0 10px 30px rgba(11,22,39,0.06) }
        .msg-wrapper.my-msg .msg-bubble{ background:var(--msg-me); color:var(--msg-me-text); }

        .msg-avatar{ width:40px;height:40px;border-radius:50%; object-fit:cover; cursor:pointer; transition:transform .12s var(--ease) }
        .msg-avatar:hover{ transform:scale(1.06) }

        /* explicit sizes/colors for author/content/time */
        .author-tag { display:block; font-size:13px; font-weight:800; color:var(--primary); margin-bottom:6px; line-height:1; }
        .msg-content-body { display:block; font-size:15px; color:#14202b; line-height:1.35; white-space:pre-wrap; word-break:break-word; margin-bottom:6px; }
        .time-stamp { display:block; font-size:12px; color:var(--muted); text-align:right; opacity:0.85; }

        /* Bottom input bar */
        .bottom-controls{ border-top:1px solid var(--border); padding:10px 12px; display:flex; gap:8px; align-items:flex-end; background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8)); }
        .input-row{ display:flex; gap:8px; align-items:center; flex:1; }
        #main-input{ width:100%; min-height:44px; max-height:160px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); resize:none; font-size:15px; line-height:1.2; }
        .control-btn{ width:44px; height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; border:none; background:#fff; box-shadow:0 6px 18px rgba(11,22,39,0.04); }
        .control-btn:active{ transform:scale(.98) }
        #send-msg-btn{ background:var(--primary); color:#fff; width:44px; height:44px; border-radius:10px; border:none; }

        /* reply preview */
        #reply-preview{ display:none; padding:8px 12px; background:#fff; border-radius:10px; border-left:4px solid var(--primary); box-shadow:var(--shadow-sm); margin-bottom:8px; position:relative; }
        #reply-preview .close-reply{ position:absolute; right:8px; top:8px; background:transparent; border:none; cursor:pointer; font-size:14px }
        #reply-preview .reply-author{ font-weight:700; margin-bottom:6px }
        #reply-preview .reply-text{ color:#333; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80%; }

        /* group selected chips */
        .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:999px; background:#fff; border:1px solid var(--border); box-shadow:0 6px 18px rgba(11,22,39,0.03); margin-right:8px; margin-bottom:8px; }
        .chip img{ width:28px; height:28px; border-radius:6px; object-fit:cover; }
        .chip span{ font-weight:700; font-size:14px; margin-right:6px; }

        /* image modal */
        .modal{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.25); z-index:11000; width:min(720px,92%); max-height:80vh; overflow:auto; padding:16px; display:none; }
        .modal.active{ display:block; }
        .modal .tabs{ display:flex; gap:8px; margin-bottom:12px; }
        .modal .tab{ padding:8px 12px; border-radius:8px; cursor:pointer; background:#f6f7fb; }
        .modal .tab.active{ background:var(--primary); color:#fff }
        .recent-images{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
        .recent-images img{ width:72px; height:72px; object-fit:cover; border-radius:8px; cursor:pointer; border:1px solid var(--border); }

        /* emoji picker */
        .emoji-picker{ position:absolute; bottom:64px; right:64px; width:320px; max-height:300px; background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;box-shadow:var(--shadow-sm); display:none; overflow:auto; z-index:12000; }
        .emoji-grid{ display:grid; grid-template-columns:repeat(8,1fr); gap:6px; }
        .emoji-cell{ font-size:20px; padding:6px; text-align:center; cursor:pointer; border-radius:6px; }
        .emoji-cell:hover{ background:#f6f7fb }

        @media (max-width:900px){
            #sidebar{ width:320px }
        }
    </style>
</head>
<body>

    <!-- AUTH banners (hidden by default) -->
    <div id="auth-banners" style="position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:12000;pointer-events:none;">
        <div id="auth-error" style="display:none;background:#fff4f4;border:1px solid #ffd2d2;color:#8b1d1d;padding:8px 12px;border-radius:8px;margin-bottom:6px;pointer-events:auto;"></div>
        <div id="auth-info" style="display:none;background:#f0f8ff;border:1px solid #cfe9ff;color:#045;padding:8px 12px;border-radius:8px;pointer-events:auto;"></div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="fade-in" style="display:flex;">
        <div id="sidebar" class="sidebar">
            <div class="sidebar-top">
                <img id="user-profile-img" class="user-avatar" src="https://via.placeholder.com/150" title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å" onerror="this.src='https://via.placeholder.com/150'">
                <div class="sidebar-meta">
                    <div class="name" id="user-display-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="tag muted-xs" id="user-display-tag">@username</div>
                </div>
                <button id="sidebar-menu-btn" aria-expanded="false" title="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">‚â°</button>
            </div>

            <div id="sidebar-menu" class="sidebar-menu" aria-hidden="true" onclick="event.stopPropagation()">
                <div class="item" id="menu-personalization">üé® –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</div>
                <div class="item" id="menu-settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div class="item" id="menu-add-group">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</div>
                <div class="divider"></div>
                <div style="padding:10px;">
                    <input id="sidebar-search" class="input-field" placeholder="–ü–æ–∏—Å–∫ –ø–æ @—Ç–µ–≥—É –∏–ª–∏ –∏–º–µ–Ω–∏...">
                </div>
            </div>

            <div class="search-wrap">
                <input id="user-search-input" class="input-field" placeholder="–ü–æ–∏—Å–∫ –ø–æ @—Ç–µ–≥—É –∏–ª–∏ –∏–º–µ–Ω–∏...">
            </div>

            <div class="chat-list-container" id="conversations-list">
                <div class="chat-row" id="row-global" onclick="uiAction.openGlobal()">
                    <img class="user-avatar" src="https://cdn-icons-png.flaticon.com/512/1041/1041916.png" style="width:46px;height:46px;border-radius:8px;" onerror="this.src='https://via.placeholder.com/150'">
                    <div style="flex:1">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div style="font-weight:700">Global Chat Room</div>
                            <div class="muted-xs" style="color:#aaa">online</div>
                        </div>
                        <div class="muted-xs" style="color:var(--muted)">–û–±—â–∏–π —á–∞—Ç</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-window">
            <div class="chat-top-bar">
                <img id="chat-top-avatar" src="https://via.placeholder.com/100" style="width:44px;height:44px;border-radius:10px;object-fit:cover" onerror="this.src='https://via.placeholder.com/100'">
                <div>
                    <div id="chat-top-title" style="font-weight:800">Global Chat Room</div>
                    <div id="chat-top-sub" class="muted-xs">–û–±—â–∏–π —á–∞—Ç</div>
                </div>
                <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
                    <button id="signout-btn" class="btn btn-ghost">–í—ã–π—Ç–∏</button>
                </div>
            </div>

            <div id="messages-view" aria-live="polite"></div>

            <div style="padding:8px 12px;">
                <div id="reply-preview">
                    <button class="close-reply" onclick="chatEngine.cancelAction()">‚úï</button>
                    <div class="reply-author" id="reply-author-name"></div>
                    <div class="reply-text" id="reply-author-text"></div>
                </div>

                <div class="bottom-controls">
                    <div class="input-row">
                        <div style="position:relative; flex:1;">
                            <textarea id="main-input" rows="1" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                            <div id="emoji-picker" class="emoji-picker" aria-hidden="true"></div>
                        </div>
                        <button id="emoji-btn" class="control-btn" title="Emoji">üôÇ</button>
                        <button id="image-btn" class="control-btn" title="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">üñºÔ∏è</button>
                        <button id="attach-btn" class="control-btn" title="–î–æ–±–∞–≤–∏—Ç—å">Ôºã</button>
                    </div>
                    <button id="send-msg-btn">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PROFILE MODAL (kept) -->
    <div id="profile-overlay" class="profile-overlay" onclick="uiAction.closeProfile()"></div>
    <div id="profile-modal" class="profile-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-weight:800;">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <button onclick="uiAction.closeProfile()" style="background:transparent; font-size:18px; padding:6px;">‚úï</button>
        </div>

        <div class="profile-top" style="display:flex; gap:12px; align-items:center;">
            <img id="p-avatar" src="https://via.placeholder.com/150" alt="avatar" style="width:96px; height:96px; border-radius:12px; object-fit:cover;" onerror="this.src='https://via.placeholder.com/150'">
            <div style="flex:1;">
                <div id="p-displayname" style="font-weight:800; font-size:18px;">–ò–º—è</div>
                <div id="p-username" class="muted-xs">@username</div>
                <div style="margin-top:8px;">
                    <small class="muted-xs">–û —Å–µ–±–µ:</small>
                    <div id="p-about" class="muted-xs" style="margin-top:6px;">–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.</div>
                </div>
            </div>
        </div>

        <div id="profile-edit-area" style="display:none; margin-top:12px;">
            <label style="font-size:13px; color:var(--muted); display:block;">–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä</label>
            <input id="p-avatar-input" class="input-field" placeholder="https://...">
            <label style="font-size:13px; color:var(--muted); display:block; margin-top:8px;">–û —Å–µ–±–µ</label>
            <textarea id="p-about-input" class="input-field" rows="4"></textarea>
        </div>

        <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
            <button id="btn-write" class="btn btn-primary" style="display:none;" onclick="uiAction.createOrOpenDM(uiAction._profileShownUid)">‚úâ –ù–∞–ø–∏—Å–∞—Ç—å</button>
            <button id="btn-edit-profile" class="btn btn-primary" onclick="uiAction.startEditProfile()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="btn-save-profile" class="btn btn-primary" style="display:none;" onclick="uiAction.saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="btn-upgrade" class="btn btn-ghost" style="display:none;" onclick="uiAction.upgradeToGoogle()">üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å Google</button>
        </div>
    </div>

    <!-- SETTINGS & GROUP MODALS (kept) -->
    <div id="settings-modal" class="settings-modal" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-weight:800;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</div>
            <button onclick="uiAction.closeSettings()" style="background:transparent; font-size:18px; padding:6px;">‚úï</button>
        </div>

        <div style="display:flex; gap:12px;">
            <div style="flex:1;">
                <div style="font-weight:700; margin-bottom:6px;">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</div>
                <label class="muted-xs">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç</label>
                <input id="ui-color-primary" type="color" style="width:100%; height:40px; border:none; margin:8px 0;">
                <label class="muted-xs">–¶–≤–µ—Ç –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</label>
                <input id="ui-color-me" type="color" style="width:100%; height:40px; border:none; margin:8px 0;">
                <label class="muted-xs">–§–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</label>
                <input id="ui-bg-color" type="color" style="width:100%; height:40px; border:none; margin:8px 0;">
                <label class="muted-xs">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px)</label>
                <input id="ui-font-range" type="range" min="12" max="22" value="16" style="width:100%; margin:8px 0;">
                <label class="muted-xs">–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ (px)</label>
                <input id="ui-radius-range" type="range" min="0" max="30" value="12" style="width:100%; margin:8px 0;">
                <div style="display:flex; gap:8px; margin-top:12px;">
                    <button class="btn btn-primary" onclick="themeCore.save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn btn-ghost" onclick="themeCore.reset()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>

            <div style="width:260px;">
                <div style="font-weight:700; margin-bottom:6px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <button class="btn btn-ghost" onclick="uiAction.openCreateGroup()">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                    <button class="btn btn-ghost" onclick="uiAction.showRules()">–ü—Ä–∞–≤–∏–ª–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</button>
                </div>
            </div>
        </div>
    </div>

    <div id="group-overlay" class="profile-overlay" onclick="uiAction.closeCreateGroup()"></div>
    <div id="group-modal" class="group-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:800;">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</div>
            <button onclick="uiAction.closeCreateGroup()" style="background:transparent; font-size:18px; padding:6px;">‚úï</button>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:8px;">
            <input id="group-name" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
        </div>

        <div style="margin-bottom:8px;">
            <label class="muted-xs">–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input id="group-image-url" class="input-field" placeholder="https://...">
            <small class="muted-xs">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∏—â–∏—Ç–µ –ø–æ —Ç–µ–≥—É –∏–ª–∏ –∏–º–µ–Ω–∏)</small>
            <input id="group-add-search" class="input-field" placeholder="–ò—Å–∫–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
            <div id="group-search-results" style="max-height:160px; overflow-y:auto; margin-top:8px;"></div>
            <div id="group-selected" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;"></div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:8px;">
            <button class="btn btn-ghost" onclick="uiAction.closeCreateGroup()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="uiAction.createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <!-- IMAGE MODAL (inlined) -->
    <div id="image-modal" class="modal" role="dialog" aria-hidden="true">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <strong>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</strong>
        <div>
          <button id="image-modal-close" class="control-btn" style="width:auto;height:auto;padding:6px 8px;">‚úï</button>
        </div>
      </div>

      <div class="tabs">
        <div id="tab-url" class="tab active">–ü–æ URL</div>
        <div id="tab-file" class="tab">–§–∞–π–ª</div>
      </div>

      <div id="tab-url-panel">
        <input id="image-url-input" class="input-field" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (https://...)">
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="image-url-send" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å URL</button>
        </div>
      </div>

      <div id="tab-file-panel" style="display:none; margin-top:10px;">
        <input id="image-file-input" type="file" accept="image/*">
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="image-upload-send" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:14px;">
        <div style="font-weight:700; margin-bottom:8px;">–ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
        <div id="recent-images" class="recent-images"></div>
      </div>
    </div>

    <script type="module">
        // Firebase imports (app, auth, db, storage)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
            signInWithEmailAndPassword, createUserWithEmailAndPassword,
            sendPasswordResetEmail, onAuthStateChanged, signOut, linkWithPopup
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        import {
            getDatabase, ref, set, push, onValue, get, child, update, remove
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        import {
            getStorage, ref as storageRef, uploadBytes, getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();

        window.state = {
            user: null,
            profile: null,
            isAdmin: false,
            activeAction: null,
            targetMessage: null,
            contextTarget: null,
            currentChat: { type: 'global', id: 'global', title: 'Global Chat Room' }
        };

        const usersCache = {};
        const conversationsIndex = {};
        let dmsListener = null;
        let groupsListener = null;
        let usersListener = null;
        let currentMessagesUnsub = null;

        /* UI helpers */
        const authErrorEl = document.getElementById('auth-error');
        const authInfoEl = document.getElementById('auth-info');
        function showAuthError(msg){ if(authErrorEl){ authErrorEl.style.display='block'; authErrorEl.innerText=msg; setTimeout(()=>authErrorEl.style.display='none',7000);} }
        function clearAuthMessages(){ if(authErrorEl){ authErrorEl.style.display='none'; authErrorEl.innerText=''; } if(authInfoEl){ authInfoEl.style.display='none'; authInfoEl.innerText=''; } }

        /* AUTH wiring */
        document.getElementById('signout-btn').addEventListener('click', async () => {
            try { await signOut(auth); } catch (err) { console.error(err); alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + (err.message || err)); }
        });

        /* Minimal google button handling if exists */
        document.getElementById('google-btn')?.addEventListener('click', async () => {
            try { await signInWithPopup(auth, provider); } catch (err) { console.warn('Popup failed ‚Äî fallback redirect', err); try{ await signInWithRedirect(auth, provider);}catch(e){ console.error(e); showAuthError(e.message || '–û—à–∏–±–∫–∞ Google –≤—Ö–æ–¥–∞'); } }
        });

        /* Users cache */
        function initUsersCacheListener(){
            const usersRef = ref(db, 'users');
            usersListener = onValue(usersRef, (snapshot) => {
                const val = snapshot.val() || {};
                Object.keys(val).forEach(k => usersCache[k] = val[k]);
                if (window.state.user && val[window.state.user.uid]) {
                    window.state.profile = val[window.state.user.uid];
                    document.getElementById('user-profile-img').src = window.state.profile.photoURL || 'https://via.placeholder.com/150';
                    document.getElementById('user-display-name').innerText = window.state.profile.displayName || '';
                    document.getElementById('user-display-tag').innerText = '@' + (window.state.profile.usernameDisplay || '');
                }
            });
        }

        /* Conversations listeners */
        function initConversationsListener(){
            const dmsRef = ref(db, 'dms');
            dmsListener = onValue(dmsRef, (snapshot) => {
                const all = snapshot.val() || {};
                Object.entries(all).forEach(([dmId, dm]) => {
                    const members = (dm.meta && dm.meta.members) || dm.members || {};
                    if (window.state.user && members[window.state.user.uid]) {
                        const otherUid = Object.keys(members).find(u => u !== window.state.user.uid);
                        const title = otherUid ? (usersCache[otherUid] ? usersCache[otherUid].displayName : '–õ–∏—á–Ω—ã–π —á–∞—Ç') : '–ß–∞—Ç';
                        const avatar = otherUid ? (usersCache[otherUid] ? usersCache[otherUid].photoURL : '') : '';
                        addConversationToList({ type: 'dm', id: dmId, title, avatar, otherUid });
                    } else {
                        const key = 'dm:' + dmId;
                        if (conversationsIndex[key]) removeConversationFromList(key);
                    }
                });
            });

            const groupsRef = ref(db, 'groups');
            groupsListener = onValue(groupsRef, (snapshot) => {
                const all = snapshot.val() || {};
                Object.entries(all).forEach(([groupId, group]) => {
                    const members = group.members || {};
                    if (window.state.user && members[window.state.user.uid]) {
                        addConversationToList({ type: 'group', id: groupId, title: group.name || '–ì—Ä—É–ø–ø–∞', avatar: group.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png' });
                    } else {
                        const key = 'group:' + groupId;
                        if (conversationsIndex[key]) removeConversationFromList(key);
                    }
                });
            });
        }

        function addConversationToList({ type, id, title, avatar, otherUid }){
            const key = type + ':' + id;
            if (conversationsIndex[key]) {
                const existing = conversationsIndex[key];
                existing.dom.querySelector('.conv-title').innerText = title;
                if (avatar) existing.dom.querySelector('img').src = avatar;
                return;
            }
            const convList = document.getElementById('conversations-list');
            const row = document.createElement('div');
            row.className = 'chat-row';
            row.dataset.convKey = key;
            row.innerHTML = `<img src="${avatar||'https://via.placeholder.com/150'}" class="user-avatar" style="width:46px; height:46px; border-radius:8px;" onerror="this.src='https://via.placeholder.com/150'">
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="conv-title" style="font-weight:700;">${title}</div>
                        <div class="muted-xs" style="color:#aaa;">${type === 'group' ? '–≥—Ä—É–ø–ø–∞' : '–ª–∏—á–Ω—ã–π'}</div>
                    </div>
                </div>`;
            row.onclick = () => { if (type === 'dm') uiAction.openDMById(id, otherUid); else if (type === 'group') uiAction.openGroupChat(id); };
            const globalRow = document.getElementById('row-global');
            if (globalRow && globalRow.nextSibling) convList.insertBefore(row, globalRow.nextSibling);
            else convList.appendChild(row);
            conversationsIndex[key] = { type, id, dom: row };
        }

        function removeConversationFromList(key){
            const it = conversationsIndex[key];
            if (!it) return;
            if (it.dom && it.dom.parentNode) it.dom.parentNode.removeChild(it.dom);
            delete conversationsIndex[key];
        }

        /* Search */
        function initSearch(){
            const searchInput = document.getElementById('user-search-input');
            const resultsBox = document.createElement('div');
            resultsBox.style.position = 'relative';
            searchInput.parentNode.appendChild(resultsBox);
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim().toLowerCase().replace('@','');
                resultsBox.innerHTML = '';
                if (query.length < 2) return;
                const users = Object.values(usersCache || {});
                const found = users.filter(u => (u.username || '').includes(query) || (u.displayName || '').toLowerCase().includes(query));
                if (found.length === 0) return;
                const box = document.createElement('div');
                box.style.position = 'absolute';
                box.style.left = '0';
                box.style.right = '0';
                box.style.background = '#fff';
                box.style.border = '1px solid var(--border)';
                box.style.borderRadius = '10px';
                box.style.marginTop = '6px';
                box.style.maxHeight = '220px';
                box.style.overflowY = 'auto';
                found.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'chat-row';
                    div.style.padding = '8px 12px';
                    div.innerHTML = `<img src="${u.photoURL||'https://via.placeholder.com/150'}" class="user-avatar" style="width:36px;height:36px;" onerror="this.src='https://via.placeholder.com/150'">
                        <div style="flex:1;">
                            <div style="font-weight:700;">${u.displayName}</div>
                            <div class="muted-xs" style="color:var(--primary);">@${u.usernameDisplay||u.username}</div>
                        </div>`;
                    div.onclick = () => { uiAction.openProfile(u.uid); resultsBox.innerHTML = ''; searchInput.value=''; };
                    box.appendChild(div);
                });
                resultsBox.appendChild(box);
            });
        }

        /* Group search (create modal) */
        function initGroupSearch(){
            const input = document.getElementById('group-add-search');
            const results = document.getElementById('group-search-results');
            if (!input) return;
            input.addEventListener('input', async (e) => {
                const q = e.target.value.trim().toLowerCase().replace('@','');
                results.innerHTML = '';
                if (q.length < 2) return;
                const users = Object.values(usersCache || {});
                const found = users.filter(u => (u.username || '').includes(q) || (u.displayName || '').toLowerCase().includes(q));
                found.forEach(u => {
                    const row = document.createElement('div');
                    row.className = 'user-select-row';
                    row.style.display = 'flex';
                    row.style.gap = '8px';
                    row.style.alignItems = 'center';
                    row.style.padding = '8px';
                    row.style.borderRadius = '8px';
                    row.style.border = '1px solid var(--border)';
                    row.style.marginBottom = '8px';
                    row.innerHTML = `<img src="${u.photoURL || 'https://via.placeholder.com/150'}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;" onerror="this.src='https://via.placeholder.com/150'">
                        <div style="flex:1;">
                            <div style="font-weight:700;">${u.displayName}</div>
                            <div style="font-size:12px; color:var(--muted);">@${u.usernameDisplay||u.username}</div>
                        </div>
                        <button class="btn btn-primary" style="width:auto; padding:8px 10px;" onclick="uiAction.selectGroupMember('${u.uid}', '${escapeHtml(u.displayName)}', '${escapeHtml(u.photoURL||'')}')">–î–æ–±–∞–≤–∏—Ç—å</button>`;
                    results.appendChild(row);
                });
            });
        }

        function escapeHtml(s) { return (s||'').replace(/'/g, "\\'").replace(/"/g,'\\"'); }

        /* Chat engine (kept from prior implementation, but patched here to show reply preview immediately and hide when canceling) */
        window.chatEngine = {
            sendMessage: async function(){
                const input = document.getElementById('main-input');
                const text = input.value.trim();
                if (!text) return;
                const chat = window.state.currentChat || { type:'global', id:'global' };
                let path;
                if (chat.type === 'global') path = 'messages';
                else if (chat.type === 'dm') path = `dms/${chat.id}/messages`;
                else if (chat.type === 'group') path = `groups/${chat.id}/messages`;
                const messageData = {
                    uid: window.state.user.uid,
                    displayName: window.state.profile.displayName,
                    username: window.state.profile.usernameDisplay,
                    text,
                    createdAt: Date.now()
                };
                if (window.state.activeAction === 'reply' && window.state.targetMessage) {
                    messageData.replyTo = { author: window.state.targetMessage.displayName, content: window.state.targetMessage.text };
                }
                await push(ref(db, path), messageData);
                this.cancelAction();
            },

            openChatListener: function(path){
                const messagesContainer = document.getElementById('messages-view');
                messagesContainer.innerHTML = '<div class="muted-xs" style="padding:12px; opacity:0.6;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
                const messagesRef = ref(db, path);
                currentMessagesUnsub = onValue(messagesRef, (snapshot) => {
                    messagesContainer.innerHTML = '';
                    const data = snapshot.val();
                    if (!data) { messagesContainer.innerHTML = '<div class="muted-xs" style="padding:12px; opacity:0.6;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>'; return; }
                    Object.entries(data).sort((a,b)=>a[1].createdAt - b[1].createdAt).forEach(([msgId, msg]) => {
                        const isMyMessage = msg.uid === window.state.user.uid;
                        const wrapper = document.createElement('div');
                        wrapper.className = `msg-wrapper ${isMyMessage ? 'my-msg' : 'other-msg'}`;

                        const senderProfile = usersCache[msg.uid] || {};
                        const avatarURL = senderProfile.photoURL || msg.photoURL || 'https://via.placeholder.com/150';
                        const displayName = msg.displayName || senderProfile.displayName || 'User';
                        const usernameDisplay = (senderProfile.usernameDisplay || senderProfile.username || msg.username || '').toString();

                        let processedText = (msg.text || '').replace(/</g, "&lt;").replace(/>/g,"&gt;");
                        if (processedText.match(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i)) {
                            const url = processedText;
                            processedText = `<img src="${url}" style="max-width:100%; border-radius:8px; margin-top:5px; cursor:pointer;" onclick="window.open(this.src)">`;
                        } else {
                            processedText = processedText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                        }

                        const replyMarkup = msg.replyTo ? `<div style="font-size:12px; border-left:3px solid var(--primary); padding-left:10px; margin-bottom:8px; opacity:0.8;"><b>${msg.replyTo.author}</b><br>${(msg.replyTo.content||'').substring(0,80)}${(msg.replyTo.content && msg.replyTo.content.length>80)?'...':''}</div>` : '';

                        const avatarHTML = `<img src="${avatarURL}" class="msg-avatar" onclick="uiAction.openProfile('${msg.uid}')" title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å" onerror="this.src='https://via.placeholder.com/150'">`;
                        const bubbleHTML = `<div class="msg-bubble" id="msg-${msgId}">
                            <span class="author-tag">${displayName} ${usernameDisplay.toLowerCase()==='admin' ? 'üëë' : ''}</span>
                            ${replyMarkup}
                            <div class="msg-content-body">${processedText}</div>
                            <span class="time-stamp">${msg.isEdited ? '–∏–∑–º. ' : ''} ${new Date(msg.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>`;
                        if (isMyMessage) wrapper.innerHTML = bubbleHTML + avatarHTML;
                        else wrapper.innerHTML = avatarHTML + bubbleHTML;

                        try { wrapper.style.justifyContent = isMyMessage ? 'flex-end' : 'flex-start'; } catch(e){}

                        wrapper.oncontextmenu = (e) => { e.preventDefault(); window.chatEngine.openContextMenu(e, msgId, { key: msgId, ...msg }); };
                        messagesContainer.appendChild(wrapper);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            },

            openContextMenu: function(e, key, data){
                window.state.contextTarget = { key, ...data };
                const popupId = 'context-popup';
                let popup = document.getElementById(popupId);
                if (!popup) {
                    popup = document.createElement('div');
                    popup.id = popupId;
                    popup.style.position = 'fixed';
                    popup.style.zIndex = 10000;
                    popup.style.background = '#fff';
                    popup.style.border = '1px solid var(--border)';
                    popup.style.padding = '8px';
                    popup.style.borderRadius = '10px';
                    popup.innerHTML = `<div style="padding:8px; cursor:pointer;" onclick="chatEngine.handleAction('reply')">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
                                       <div style="padding:8px; cursor:pointer;" onclick="chatEngine.handleAction('copy')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
                                       <div id="popup-edit-btn" style="padding:8px; cursor:pointer;" onclick="chatEngine.handleAction('edit')">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                                       <div id="popup-delete-btn" style="padding:8px; cursor:pointer; color:#ff3b30;" onclick="chatEngine.handleAction('delete')">üóë –£–¥–∞–ª–∏—Ç—å</div>`;
                    document.body.appendChild(popup);
                }
                const popupEl = document.getElementById(popupId);
                popupEl.style.display = 'block';
                let x = e.clientX, y = e.clientY;
                if (x + 220 > window.innerWidth) x -= 220;
                if (y + 150 > window.innerHeight) y -= 150;
                popupEl.style.left = x + 'px'; popupEl.style.top = y + 'px';
                const isMine = data.uid === window.state.user.uid;
                const editBtn = document.getElementById('popup-edit-btn');
                const delBtn = document.getElementById('popup-delete-btn');
                if (editBtn) editBtn.style.display = isMine ? 'block' : 'none';
                if (delBtn) delBtn.style.display = (isMine || window.state.isAdmin) ? 'block' : 'none';
            },

            handleAction: function(type){
                const popup = document.getElementById('context-popup');
                if (popup) popup.style.display = 'none';
                if (type === 'reply' || type === 'edit') {
                    window.state.activeAction = type;
                    window.state.targetMessage = window.state.contextTarget;
                    // Show immediate preview (author + short text)
                    const ctx = window.state.contextTarget || {};
                    document.getElementById('reply-author-name').innerText = type === 'edit' ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" : (ctx.displayName || ctx.username || '');
                    document.getElementById('reply-author-text').innerText = (ctx.text || ctx.content || '').substring(0,200);
                    document.getElementById('reply-preview').style.display = 'block';
                    if (type === 'edit') document.getElementById('main-input').value = window.state.targetMessage.text || '';
                    document.getElementById('main-input').focus();
                } else if (type === 'copy') {
                    navigator.clipboard.writeText(window.state.contextTarget.text || '');
                } else if (type === 'delete') {
                    if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;
                    const chat = window.state.currentChat;
                    let path;
                    if (chat.type === 'global') path = `messages/${window.state.contextTarget.key}`;
                    else if (chat.type === 'dm') path = `dms/${chat.id}/messages/${window.state.contextTarget.key}`;
                    else if (chat.type === 'group') path = `groups/${chat.id}/messages/${window.state.contextTarget.key}`;
                    remove(ref(db, path));
                }
            },

            cancelAction: function(){
                window.state.activeAction = null; window.state.targetMessage = null;
                document.getElementById('reply-preview').style.display = 'none';
                document.getElementById('main-input').value = '';
            },

            attachImage: function(){
                document.getElementById('image-modal').classList.add('active');
            }
        };

        /* uiAction (kept) */
        window.uiAction = {
            openGlobal: () => {
                window.state.currentChat = { type: 'global', id: 'global', title: 'Global Chat Room' };
                document.getElementById('chat-top-title').innerText = 'Global Chat Room';
                document.getElementById('chat-top-sub').innerText = '–û–±—â–∏–π —á–∞—Ç';
                document.getElementById('chat-top-avatar').src = 'https://cdn-icons-png.flaticon.com/512/1041/1041916.png';
                chatEngine.openChatListener('messages');
            },

            createOrOpenDM: async (otherUid) => {
                if (!otherUid) return;
                if (otherUid === window.state.user.uid) { uiAction.openProfile(otherUid); return; }
                const u1 = window.state.user.uid;
                const u2 = otherUid;
                const chatId = ['dm', ...[u1, u2].sort()].join('_');
                const metaRef = ref(db, `dms/${chatId}/meta`);
                const metaSnap = await get(metaRef);
                if (!metaSnap.exists()) {
                    const meta = { members: { [u1]: true, [u2]: true }, createdAt: Date.now() };
                    await set(metaRef, meta);
                }
                addConversationToList({ type: 'dm', id: chatId, title: usersCache[otherUid]?.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç', avatar: usersCache[otherUid]?.photoURL || 'https://via.placeholder.com/150', otherUid });
                uiAction.openDMById(chatId, otherUid);
            },

            openDMById: async (chatId, otherUid) => {
                const other = usersCache[otherUid] || {};
                window.state.currentChat = { type: 'dm', id: chatId, title: other.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç', photo: other.photoURL || '', otherUid };
                document.getElementById('chat-top-title').innerText = other.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç';
                document.getElementById('chat-top-sub').innerText = '@' + (other.usernameDisplay || other.username || '');
                document.getElementById('chat-top-avatar').src = other.photoURL || 'https://via.placeholder.com/150';
                chatEngine.openChatListener(`dms/${chatId}/messages`);
            },

            openProfile: (uid) => {
                if (!uid) return;
                const user = usersCache[uid] || (window.state.user && uid === window.state.user.uid ? window.state.profile : null);
                if (!user) { alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
                uiAction._profileShownUid = uid;
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                overlay.classList.add('active'); modal.classList.add('active'); modal.setAttribute('aria-hidden','false');

                document.getElementById('p-avatar').src = user.photoURL || 'https://via.placeholder.com/150';
                document.getElementById('p-displayname').innerText = user.displayName || 'User';
                document.getElementById('p-username').innerText = '@' + (user.usernameDisplay || user.username || '');
                document.getElementById('p-about').innerText = user.about || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.';

                if (window.state.user && uid === window.state.user.uid) {
                    document.getElementById('profile-edit-area').style.display = 'block';
                    document.getElementById('p-avatar-input').value = user.photoURL || '';
                    document.getElementById('p-about-input').value = user.about || '';
                    document.getElementById('btn-edit-profile').style.display = 'inline-flex';
                    document.getElementById('btn-save-profile').style.display = 'none';
                    document.getElementById('btn-upgrade').style.display = (auth.currentUser && auth.currentUser.isAnonymous) ? 'inline-flex' : 'none';
                    document.getElementById('btn-write').style.display = 'none';
                } else {
                    document.getElementById('profile-edit-area').style.display = 'none';
                    document.getElementById('btn-edit-profile').style.display = 'none';
                    document.getElementById('btn-save-profile').style.display = 'none';
                    document.getElementById('btn-upgrade').style.display = 'none';
                    document.getElementById('btn-write').style.display = 'inline-flex';
                }
            },

            closeProfile: () => {
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                overlay.classList.remove('active'); modal.classList.remove('active'); modal.setAttribute('aria-hidden','true');
            },

            startEditProfile: () => {
                document.getElementById('profile-edit-area').style.display = 'block';
                document.getElementById('btn-edit-profile').style.display = 'none';
                document.getElementById('btn-save-profile').style.display = 'inline-flex';
            },

            saveProfile: async () => {
                if (!window.state.user) return;
                const newAva = document.getElementById('p-avatar-input').value.trim();
                const newAbout = document.getElementById('p-about-input').value.trim();
                if (newAva && !/^https?:\/\//i.test(newAva)) return alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http/https');
                const updates = {};
                if (newAva) updates.photoURL = newAva;
                updates.about = newAbout || '';
                try {
                    await update(ref(db, `users/${window.state.user.uid}`), updates);
                    if (updates.photoURL) {
                        document.getElementById('p-avatar').src = updates.photoURL;
                        document.getElementById('user-profile-img').src = updates.photoURL;
                    }
                    document.getElementById('p-about').innerText = updates.about;
                    window.state.profile = Object.assign(window.state.profile || {}, updates);
                    document.getElementById('profile-edit-area').style.display = 'none';
                    document.getElementById('btn-edit-profile').style.display = 'inline-flex';
                    document.getElementById('btn-save-profile').style.display = 'none';
                    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
                } catch (err) { console.error(err); alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è'); }
            },

            upgradeToGoogle: async () => {
                if (!auth.currentUser) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                if (!auth.currentUser.isAnonymous) return alert('–£–∂–µ –Ω–µ –≥–æ—Å—Ç–µ–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç');
                try {
                    const result = await linkWithPopup(auth.currentUser, provider);
                    const pd = (result.user.providerData && result.user.providerData[0]) || {};
                    const updates = {};
                    if (pd.displayName) updates.displayName = pd.displayName;
                    if (pd.photoURL) updates.photoURL = pd.photoURL;
                    await update(ref(db, `users/${result.user.uid}`), updates);
                    alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ Google');
                    uiAction.closeProfile();
                } catch (err) { console.error(err); alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏: ' + (err.message || err)); }
            },

            openSettings: () => {
                document.getElementById('settings-modal').classList.add('active');
                document.getElementById('settings-modal').setAttribute('aria-hidden','false');
                const root = document.documentElement.style;
                document.getElementById('ui-color-primary').value = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()) || '#3390ec';
                document.getElementById('ui-color-me').value = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--msg-me').trim()) || '#eeffde';
                document.getElementById('ui-bg-color').value = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()) || '#ffffff';
                document.getElementById('ui-font-range').value = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size')) || 16;
                document.getElementById('ui-radius-range').value = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--radius')) || 12;
            },

            closeSettings: () => {
                document.getElementById('settings-modal').classList.remove('active');
                document.getElementById('settings-modal').setAttribute('aria-hidden','true');
            },

            openCreateGroup: () => {
                document.getElementById('group-overlay').classList.add('active');
                document.getElementById('group-modal').classList.add('active');
                document.getElementById('group-name').value = '';
                document.getElementById('group-image-url').value = '';
                document.getElementById('group-add-search').value = '';
                document.getElementById('group-search-results').innerHTML = '';
                document.getElementById('group-selected').innerHTML = '';
                uiAction._groupSelected = { [window.state.user.uid]: { uid: window.state.user.uid, name: window.state.profile.displayName, photo: window.state.profile.photoURL } };
                renderGroupSelected();
            },

            closeCreateGroup: () => {
                document.getElementById('group-overlay').classList.remove('active');
                document.getElementById('group-modal').classList.remove('active');
                uiAction._groupSelected = {};
            },

            selectGroupMember: (uid, name, photo) => {
                uiAction._groupSelected = uiAction._groupSelected || {};
                uiAction._groupSelected[uid] = { uid, name, photo };
                renderGroupSelected();
            },

            removeGroupMember: (uid) => { if (!uiAction._groupSelected) return; delete uiAction._groupSelected[uid]; renderGroupSelected(); },

            createGroup: async () => {
                const name = (document.getElementById('group-name').value || '').trim();
                if (!name || name.length < 2) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–º–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞)');
                const image = (document.getElementById('group-image-url').value || '').trim();
                const selected = uiAction._groupSelected || {};
                const members = Object.keys(selected);
                if (members.length < 2) return alert('–î–æ–±–∞–≤—å—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∫—Ä–æ–º–µ –≤–∞—Å');
                try {
                    const gRef = push(ref(db, 'groups'));
                    const groupId = gRef.key;
                    const membersObj = {};
                    members.forEach(uid => membersObj[uid] = true);
                    const meta = { id: groupId, name, owner: window.state.user.uid, members: membersObj, createdAt: Date.now(), image: image || '' };
                    await set(ref(db, `groups/${groupId}`), meta);
                    uiAction.closeCreateGroup();
                    addConversationToList({ type: 'group', id: groupId, title: name, avatar: image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png' });
                    uiAction.openGroupChat(groupId, meta);
                } catch (err) { console.error(err); alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã'); }
            },

            openGroupChat: async (groupId, meta) => {
                let groupMeta = meta;
                if (!groupMeta) {
                    const snap = await get(ref(db, `groups/${groupId}`));
                    if (!snap.exists()) return alert('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    groupMeta = snap.val();
                }
                window.state.currentChat = { type: 'group', id: groupId, title: groupMeta.name, ownerUid: groupMeta.owner || '', members: groupMeta.members || {} };
                document.getElementById('chat-top-title').innerText = groupMeta.name;
                document.getElementById('chat-top-sub').innerText = `–ì—Ä—É–ø–ø–∞ ‚Ä¢ ${Object.keys(groupMeta.members||{}).length} —É—á–∞—Å—Ç–Ω–∏–∫(–æ–≤)`;
                document.getElementById('chat-top-avatar').src = groupMeta.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
                chatEngine.openChatListener(`groups/${groupId}/messages`);
            },

            openGroupInfo: async (groupId) => {
                const snap = await get(ref(db, `groups/${groupId}`));
                if (!snap.exists()) return alert('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                const group = snap.val();
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                overlay.classList.add('active'); modal.classList.add('active'); modal.setAttribute('aria-hidden','false');
                document.getElementById('p-avatar').src = group.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
                document.getElementById('p-displayname').innerText = group.name;
                document.getElementById('p-username').innerText = `${Object.keys(group.members||{}).length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                const memberList = Object.keys(group.members||{}).map(uid => {
                    const u = usersCache[uid] || {};
                    return `‚Ä¢ ${u.displayName || 'User'} @${u.usernameDisplay||u.username||''}`;
                }).join('\n');
                document.getElementById('p-about').innerText = memberList || '–ü—É—Å—Ç–æ';
                document.getElementById('profile-edit-area').style.display = 'none';
                document.getElementById('btn-edit-profile').style.display = 'none';
                document.getElementById('btn-save-profile').style.display = 'none';
                document.getElementById('btn-upgrade').style.display = 'none';
                document.getElementById('btn-write').style.display = 'none';
            }
        };

        function renderGroupSelected(){
            const container = document.getElementById('group-selected');
            container.innerHTML = '';
            const selected = uiAction._groupSelected || {};
            Object.values(selected).forEach(s => {
                const el = document.createElement('div');
                el.className = 'chip';
                el.innerHTML = `<img src="${s.photo||'https://via.placeholder.com/150'}" style="width:28px;height:28px;border-radius:6px;object-fit:cover;" onerror="this.src='https://via.placeholder.com/150'"><span>${s.name}</span><button onclick="uiAction.removeGroupMember('${s.uid}')" style="background:transparent;border:none;cursor:pointer;">‚úï</button>`;
                container.appendChild(el);
            });
        }

        /* themeCore */
        window.themeCore = {
            preview: function(){
                const root = document.documentElement.style;
                const pr = document.getElementById('ui-color-primary')?.value;
                const me = document.getElementById('ui-color-me')?.value;
                const bg = document.getElementById('ui-bg-color')?.value;
                const fz = document.getElementById('ui-font-range')?.value;
                const rd = document.getElementById('ui-radius-range')?.value;
                if (pr) root.setProperty('--primary', pr);
                if (me) root.setProperty('--msg-me', me);
                if (bg) root.setProperty('--bg', bg);
                if (fz) root.setProperty('--font-size', fz + 'px');
                if (rd) root.setProperty('--radius', rd + 'px');
            },
            save: function(){
                const settings = {
                    pr: document.getElementById('ui-color-primary')?.value,
                    me: document.getElementById('ui-color-me')?.value,
                    bg: document.getElementById('ui-bg-color')?.value,
                    fz: document.getElementById('ui-font-range')?.value,
                    rd: document.getElementById('ui-radius-range')?.value
                };
                localStorage.setItem('narrators_custom_ui', JSON.stringify(settings));
                this.apply(settings);
                uiAction.closeSettings();
            },
            load: function(){
                const saved = localStorage.getItem('narrators_custom_ui');
                if (saved) this.apply(JSON.parse(saved));
            },
            apply: function(t){
                if (!t) return;
                const root = document.documentElement.style;
                if (t.pr) root.setProperty('--primary', t.pr);
                if (t.me) root.setProperty('--msg-me', t.me);
                if (t.bg) root.setProperty('--bg', t.bg);
                if (t.fz) root.setProperty('--font-size', t.fz + 'px');
                if (t.rd) root.setProperty('--radius', t.rd + 'px');
            },
            reset: function(){
                localStorage.removeItem('narrators_custom_ui');
                document.documentElement.style.removeProperty('--primary');
                document.documentElement.style.removeProperty('--msg-me');
                document.documentElement.style.removeProperty('--bg');
                document.documentElement.style.removeProperty('--font-size');
                document.documentElement.style.removeProperty('--radius');
                uiAction.closeSettings();
            }
        };

        function rgbToHex(rgb){
            if (!rgb) return '#000000';
            rgb = rgb.replace(/\s+/g,'');
            if (rgb[0] === '#') return rgb;
            const m = rgb.match(/rgba?\((\d+),(\d+),(\d+)/i);
            if (!m) return '#000000';
            return '#' + [1,2,3].map(i => parseInt(m[i]).toString(16).padStart(2,'0')).join('');
        }

        // INIT
        initGroupSearch();

        /* Sidebar menu open/close (single binding; no duplicate bindings) */
        const sidebarBtn = document.getElementById('sidebar-menu-btn');
        const sidebarMenu = document.getElementById('sidebar-menu');
        sidebarMenu.addEventListener('click', (e) => e.stopPropagation());
        sidebarBtn.addEventListener('click', (e) => { e.stopPropagation(); const isOpen = sidebarMenu.classList.contains('active'); if (isOpen) closeSidebarMenu(); else openSidebarMenu(); });
        document.addEventListener('click', (e) => {
            if (!sidebarMenu.contains(e.target) && !sidebarBtn.contains(e.target)) {
                if (sidebarMenu.classList.contains('active')) closeSidebarMenu();
            }
            const p = document.getElementById('context-popup');
            if (p && !e.target.closest('#context-popup')) p.style.display = 'none';
        });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && sidebarMenu.classList.contains('active')) closeSidebarMenu(); });

        function openSidebarMenu(){
            sidebarMenu.classList.add('active'); sidebarMenu.setAttribute('aria-hidden','false'); sidebarBtn.setAttribute('aria-expanded','true');
            sidebarMenu.querySelectorAll('.item').forEach((it, i) => { it.style.opacity='0'; it.style.transform='translateY(6px)'; setTimeout(()=>{ it.style.transition = `transform .28s ${0.04 + i*0.03}s var(--ease), opacity .22s ${0.04 + i*0.03}s var(--ease)`; it.style.opacity = '1'; it.style.transform='none'; }, 20); });
        }
        function closeSidebarMenu(){
            const items = Array.from(sidebarMenu.querySelectorAll('.item'));
            items.reverse().forEach((it, idx) => { it.style.transition = `transform .16s ${idx*0.02}s var(--ease), opacity .12s ${idx*0.02}s var(--ease)`; it.style.transform = 'translateY(6px)'; it.style.opacity='0'; });
            setTimeout(()=>{ sidebarMenu.classList.remove('active'); sidebarMenu.setAttribute('aria-hidden','true'); sidebarBtn.setAttribute('aria-expanded','false'); items.reverse().forEach(it => { it.style.transition=''; it.style.transform=''; it.style.opacity=''; }); }, 220 + items.length*20);
        }

        // Conversation list animation
        const convList = document.getElementById('conversations-list');
        const convObserver = new MutationObserver((mutations) => {
            mutations.forEach(m => {
                m.addedNodes.forEach((node, idx) => {
                    if (node.nodeType === 1 && node.classList.contains('chat-row')) {
                        node.style.opacity = '0';
                        node.style.transform = 'translateX(-6px)';
                        setTimeout(()=>{ node.style.transition = `transform .24s ${idx*0.02}s var(--ease), opacity .18s ${idx*0.02}s var(--ease)`; node.style.opacity = '1'; node.style.transform = 'none'; }, 20);
                        setTimeout(()=>{ node.style.transition=''; }, 600);
                    }
                });
            });
        });
        convObserver.observe(convList, { childList: true });

        // chat-top avatar click behavior
        document.getElementById('chat-top-avatar').addEventListener('click', () => {
            const c = window.state.currentChat || {};
            if (c.type === 'dm') uiAction.openProfile(c.otherUid);
            else if (c.type === 'group') uiAction.openGroupInfo(c.id);
            else uiAction.openProfile(window.state.user.uid);
        });

        // Enter to send handling & autosize
        const mainInput = document.getElementById('main-input');
        mainInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); chatEngine.sendMessage(); } });
        mainInput.addEventListener('input', () => { mainInput.style.height='auto'; const h = Math.min(160, Math.max(44, mainInput.scrollHeight)); mainInput.style.height = h + 'px'; });

        // Emoji picker + image modal wiring
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.getElementById('emoji-picker');
        const standardEmojis = ["üòÄ","üòÅ","üòÇ","ü§£","üôÇ","üôÉ","üòâ","üòä","üòç","ü§©","üòò","üòé","ü§ì","ü§î","ü§®","üòÖ","üòá","üò≠","üò§","üò°","üëç","üëé","üëè","üôè","üí™","ü§ù","üî•","‚ú®","üéâ","üíØ","‚úîÔ∏è","‚ùå","‚ù§Ô∏è","üß°","üíõ","üíö","üíô","üíú","ü§ç","ü§é","üñ§","üí•","ü•≥","ü§Ø","ü§ñ","üëΩ","üé∂","üçï"];
        function renderEmojiPicker(){ emojiPicker.innerHTML=''; const grid = document.createElement('div'); grid.className='emoji-grid'; standardEmojis.forEach(e=>{ const c=document.createElement('div'); c.className='emoji-cell'; c.innerText=e; c.onclick=()=>{ insertAtCursor(mainInput,e); emojiPicker.style.display='none'; mainInput.focus(); }; grid.appendChild(c); }); emojiPicker.appendChild(grid); }
        emojiBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if (emojiPicker.style.display==='block') emojiPicker.style.display='none'; else { renderEmojiPicker(); emojiPicker.style.display='block'; } });
        document.addEventListener('click', (e)=>{ if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) emojiPicker.style.display='none'; });
        function insertAtCursor(el, text){ const start=el.selectionStart||0; const end=el.selectionEnd||0; el.value=el.value.slice(0,start)+text+el.value.slice(end); const pos=start+text.length; el.setSelectionRange(pos,pos); el.focus(); }

        // Image modal logic (send by URL or upload to storage)
        const imageModal = document.getElementById('image-modal');
        const imageBtn = document.getElementById('image-btn');
        const imageClose = document.getElementById('image-modal-close');
        const tabUrl = document.getElementById('tab-url');
        const tabFile = document.getElementById('tab-file');
        const urlPanel = document.getElementById('tab-url-panel');
        const filePanel = document.getElementById('tab-file-panel');
        const imageUrlInput = document.getElementById('image-url-input');
        const imageFileInput = document.getElementById('image-file-input');
        const imageUrlSend = document.getElementById('image-url-send');
        const imageUploadSend = document.getElementById('image-upload-send');
        const recentImagesContainer = document.getElementById('recent-images');

        const RECENT_KEY = 'narrators_recent_images';
        function loadRecentImages(){ try{ return JSON.parse(localStorage.getItem(RECENT_KEY)||'[]'); }catch(e){return[]} }
        function saveRecentImages(arr){ localStorage.setItem(RECENT_KEY, JSON.stringify(arr.slice(0,20))); }
        function addRecentImage(url){ if(!url) return; let a=loadRecentImages(); a=a.filter(x=>x!==url); a.unshift(url); saveRecentImages(a); renderRecentImages(); }
        function renderRecentImages(){ recentImagesContainer.innerHTML=''; loadRecentImages().forEach(url=>{ const img=document.createElement('img'); img.src=url; img.onclick=()=>{ sendImageUrl(url); imageModal.classList.remove('active'); }; img.onerror=()=>img.remove(); recentImagesContainer.appendChild(img); }); }

        imageBtn.addEventListener('click', ()=>{ renderRecentImages(); imageModal.classList.add('active'); });
        imageClose.addEventListener('click', ()=>imageModal.classList.remove('active'));
        tabUrl.addEventListener('click', ()=>{ tabUrl.classList.add('active'); tabFile.classList.remove('active'); urlPanel.style.display='block'; filePanel.style.display='none'; });
        tabFile.addEventListener('click', ()=>{ tabFile.classList.add('active'); tabUrl.classList.remove('active'); urlPanel.style.display='none'; filePanel.style.display='block'; });

        imageUrlSend.addEventListener('click', ()=>{ const url=(imageUrlInput.value||'').trim(); if(!url){ alert('–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É'); return;} sendImageUrl(url); addRecentImage(url); imageUrlInput.value=''; imageModal.classList.remove('active'); });
        imageUploadSend.addEventListener('click', async ()=>{ const file = imageFileInput.files && imageFileInput.files[0]; if(!file){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'); return;} try{ const ext = (file.name.split('.').pop()||'jpg'); const key = `images/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`; const sRef = storageRef(storage, key); await uploadBytes(sRef, file); const url = await getDownloadURL(sRef); sendImageUrl(url); addRecentImage(url); imageFileInput.value=''; imageModal.classList.remove('active'); } catch(err){ console.error(err); alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); } });

        function sendImageUrl(url){ const chat = window.state.currentChat || { type:'global', id:'global' }; let path = chat.type==='global' ? 'messages' : (chat.type==='dm' ? `dms/${chat.id}/messages` : `groups/${chat.id}/messages`); const messageData = { uid: window.state.user.uid, displayName: window.state.profile.displayName, username: window.state.profile.usernameDisplay, text: url, createdAt: Date.now() }; push(ref(db, path), messageData); }

        // Reply preview close already bound to chatEngine.cancelAction which hides it below.

        // Patch chatEngine.handleAction and cancelAction to show/hide preview reliably
        (function patchChatEngine(){
            const origHandle = window.chatEngine && window.chatEngine.handleAction;
            const origCancel = window.chatEngine && window.chatEngine.cancelAction;
            // if chatEngine exists already, patch directly; else poll
            function doPatch(){
                if (window.chatEngine && window.chatEngine.handleAction && window.chatEngine.cancelAction) {
                    const _origHandle = window.chatEngine.handleAction;
                    const _origCancel = window.chatEngine.cancelAction;
                    window.chatEngine.handleAction = function(type){
                        if (type==='reply' || type==='edit') {
                            const ctx = window.state.contextTarget || {};
                            document.getElementById('reply-author-name').innerText = type==='edit' ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" : (ctx.displayName || ctx.username || '');
                            document.getElementById('reply-author-text').innerText = (ctx.text || ctx.content || '').substring(0,200);
                            document.getElementById('reply-preview').style.display = 'block';
                        }
                        return _origHandle.call(this, type);
                    };
                    window.chatEngine.cancelAction = function(){
                        document.getElementById('reply-preview').style.display = 'none';
                        return _origCancel.call(this);
                    };
                    return true;
                }
                return false;
            }
            if (!doPatch()){
                const interval = setInterval(()=>{ if (doPatch()) clearInterval(interval); }, 150);
            }
        })();

        // Attach small behaviors: hide emoji on doc click, hide image modal on outside
        document.addEventListener('click', (e)=>{ if (!imageModal.contains(e.target) && e.target !== imageBtn) { /* image modal stays until closed intentionally */ } });

        // Helper to render chips for group selected - already handled by renderGroupSelected

        // Initial theme load
        themeCore.load();

        // Expose globals (already set)
        window.uiAction = window.uiAction;
        window.chatEngine = window.chatEngine;
        window.themeCore = window.themeCore;

        // Load recent images into view on boot
        renderRecentImages();

        // Done
    </script>
</body>
</html>
