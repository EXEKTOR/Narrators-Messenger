<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARRATORS // V10 ULTIMATE</title>
    <style>
        :root {
            /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï --- */
            --bg-body: #ffffff;      /* –û–±—â–∏–π —Ñ–æ–Ω */
            --bg-sidebar: #ffffff;   /* –§–æ–Ω –º–µ–Ω—é */
            --primary: #3390ec;      /* –ê–∫—Ü–µ–Ω—Ç (–ö–Ω–æ–ø–∫–∏, –∏–∫–æ–Ω–∫–∏) - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∏–Ω–∏–π –¢–ì */
            --text-main: #000000;
            --text-sec: #707579;
            --border: #dfe1e5;

            /* –°–æ–æ–±—â–µ–Ω–∏—è */
            --msg-me-bg: #eeffde;    /* –§–æ–Ω –º–æ–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
            --msg-me-text: #000000;
            --msg-other-bg: #ffffff; /* –§–æ–Ω —á—É–∂–æ–≥–æ */
            --msg-other-text: #000000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; overflow: hidden; background: var(--bg-body); color: var(--text-main); }
        
        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }

        /* --- –≠–ö–†–ê–ù–´ –í–•–û–î–ê --- */
        .panel { position: fixed; top:0; left:0; width:100%; height:100%; background:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:5000; }
        .btn-main { padding:14px 28px; background:var(--primary); color:#fff; border:none; border-radius:8px; font-weight:600; font-size:1rem; cursor:pointer; transition:0.2s; text-transform: uppercase; }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }
        input.auth-input { padding:12px; border:1px solid var(--border); width:280px; margin-bottom:15px; border-radius:8px; outline:none; font-size:1rem; transition:0.2s; }
        input.auth-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.1); }

        /* --- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° --- */
        #app { display:none; width:100%; height:100%; position: relative; }

        /* –ë–û–ö–û–í–û–ï –ú–ï–ù–Æ (DRAWER) */
        #drawer-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.5); z-index: 3000; 
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #drawer-overlay.open { opacity: 1; pointer-events: all; }

        #drawer {
            position: fixed; top:0; left:0; width: 280px; height: 100%;
            background: var(--bg-sidebar); z-index: 3001;
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        #drawer.open { transform: translateX(0); }

        .drawer-header {
            padding: 20px; background: var(--primary); color: #fff;
            display: flex; flex-direction: column; gap: 10px;
        }
        .drawer-avatar { width: 60px; height: 60px; border-radius: 50%; background: #fff; object-fit: cover; }
        .drawer-info div:first-child { font-weight: bold; font-size: 1.1rem; }
        .drawer-info div:last-child { font-size: 0.9rem; opacity: 0.8; }

        .drawer-menu { flex: 1; padding: 10px 0; overflow-y: auto; }
        .drawer-item {
            padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 15px; font-weight: 500;
        }
        .drawer-item:hover { background: rgba(0,0,0,0.05); }
        .drawer-item i { width: 24px; text-align: center; color: var(--text-sec); }

        /* –ß–ê–¢ –õ–ï–ô–ê–£–¢ */
        #chat-container { flex: 1; display: flex; flex-direction: column; background: var(--bg-body); position: relative; }

        /* –•–µ–¥–µ—Ä */
        .chat-header {
            height: 56px; display: flex; align-items: center; padding: 0 15px;
            background: #fff; border-bottom: 1px solid var(--border); gap: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .burger-btn { font-size: 1.5rem; cursor: pointer; color: var(--text-sec); padding: 5px; background: none; border: none; }
        .chat-title { font-weight: bold; font-size: 1.1rem; flex: 1; }
        
        /* –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π */
        #messages { flex: 1; overflow-y: auto; padding: 10px 0; display: flex; flex-direction: column; gap: 6px; }

        .msg-row { 
            display: flex; padding: 0 10px; max-width: 100%; 
            position: relative; align-items: flex-end; gap: 8px;
        }
        .msg-row.me { justify-content: flex-end; }
        
        .msg-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; margin-bottom: 2px; }
        .msg-row.me .msg-avatar { display: none; } /* –°–≤–æ—é –∞–≤–∞—Ç–∞—Ä–∫—É –≤ —á–∞—Ç–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–∫–∞–∫ –≤ –¢–ì) */

        .msg-bubble {
            max-width: 480px; padding: 8px 12px; border-radius: 12px;
            position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            font-size: 1rem; line-height: 1.4; word-wrap: break-word;
        }
        .msg-row.other .msg-bubble { background: var(--msg-other-bg); color: var(--msg-other-text); border-bottom-left-radius: 2px; }
        .msg-row.me .msg-bubble { background: var(--msg-me-bg); color: var(--msg-me-text); border-bottom-right-radius: 2px; }

        /* –ò–º—è, –†–µ–ø–ª–∞–π, –ú–µ—Ç–∞ */
        .msg-name { font-size: 0.8rem; font-weight: 600; color: var(--primary); margin-bottom: 2px; cursor: pointer; }
        .admin-crown { color: #FFD700; margin-left: 4px; }
        
        .reply-quote {
            border-left: 2px solid var(--primary); background: rgba(0,0,0,0.05);
            padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; margin-bottom: 6px;
            cursor: pointer; display: flex; flex-direction: column;
        }
        .reply-name { color: var(--primary); font-weight: 600; font-size: 0.75rem; }
        .reply-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.8; }

        .msg-meta { 
            float: right; margin-left: 10px; margin-top: 6px; 
            font-size: 0.7rem; color: rgba(0,0,0,0.4); display: flex; align-items: center; gap: 4px;
        }
        .msg-row.me .msg-meta { color: rgba(0,0,0,0.4); } /* –¶–≤–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏—Ö */

        /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
        #input-container { background: #fff; border-top: 1px solid var(--border); padding: 8px 12px; display: flex; flex-direction: column; }
        
        /* –ü–∞–Ω–µ–ª—å "–û—Ç–≤–µ—Ç / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" */
        #action-bar { 
            display: none; padding: 8px; border-bottom: 1px solid var(--border); 
            background: #f9f9f9; align-items: center; justify-content: space-between; 
            border-left: 3px solid var(--primary); margin-bottom: 5px;
        }
        .action-info { display: flex; flex-direction: column; font-size: 0.9rem; }
        .action-title { color: var(--primary); font-weight: bold; font-size: 0.8rem; }
        .btn-close-action { background: none; border: none; font-size: 1.2rem; color: #777; cursor: pointer; }

        .input-row { display: flex; align-items: flex-end; gap: 10px; }
        #msg-input { 
            flex: 1; border: none; outline: none; padding: 10px; font-size: 1rem; 
            max-height: 100px; overflow-y: auto; resize: none; background: transparent;
        }
        .icon-btn { font-size: 1.5rem; color: var(--text-sec); cursor: pointer; background: none; border: none; padding: 5px; transition: 0.2s; }
        .icon-btn:hover { color: var(--primary); }
        .icon-btn.send { color: var(--primary); }

        /* --- –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ (–ü–ö–ú) --- */
        #context-menu {
            display: none; position: fixed; background: #fff; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-radius: 8px; 
            z-index: 10000; padding: 6px 0; min-width: 160px;
        }
        .ctx-item { 
            padding: 10px 16px; font-size: 0.95rem; cursor: pointer; display: flex; gap: 10px; align-items: center; 
        }
        .ctx-item:hover { background: #f0f0f0; }
        .ctx-item.delete { color: #ff3b30; }

        /* --- –ù–ê–°–¢–†–û–ô–ö–ò (–ú–û–î–ê–õ–ö–ê) --- */
        #settings-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 4000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; width: 400px; max-width: 90%; border-radius: 12px;
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            animation: popIn 0.2s ease;
        }
        @keyframes popIn { from{transform: scale(0.9); opacity:0;} to{transform: scale(1); opacity:1;} }
        
        .preview-box {
            background: #e0e0e0; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 10px;
            background-image: url("https://web.telegram.org/img/bg_0.png"); /* –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–æ–Ω */
        }
        .prev-msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; font-size: 0.9rem; }
        
        /* –ö–ª–∞—Å—Å—ã –¥–ª—è –ø—Ä–µ–≤—å—é, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—è—é—Ç—Å—è JS-–æ–º */
        .prev-me { align-self: flex-end; }
        .prev-other { align-self: flex-start; }

        .color-picker-row { display: flex; justify-content: space-between; align-items: center; }
        input[type="color"] { border: none; width: 40px; height: 40px; cursor: pointer; background: none; }

    </style>
</head>
<body>

    <!-- 1. –í–•–û–î -->
    <div id="login-screen" class="panel">
        <h1 style="color:var(--primary); font-size:2rem; margin-bottom:10px;">NARRATORS</h1>
        <p style="color:#777; margin-bottom:30px;">Messenger V10</p>
        <button id="btn-login" class="btn-main">–í–û–ô–¢–ò –ß–ï–†–ï–ó GOOGLE</button>
    </div>

    <!-- 2. –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
    <div id="reg-screen" class="panel" style="display:none;">
        <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
        <p style="color:#777; margin-bottom:20px;">–ö–∞–∫ –≤–∞—Å –Ω–∞–∑—ã–≤–∞—Ç—å?</p>
        <input id="reg-nick" class="auth-input" placeholder="–ò–º—è (Display Name)">
        <input id="reg-tag" class="auth-input" placeholder="@username (–¥–ª—è –ø–æ–∏—Å–∫–∞)">
        <button id="btn-reg-save" class="btn-main">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <!-- 3. –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="app">
        
        <!-- –ë–û–ö–û–í–û–ï –ú–ï–ù–Æ -->
        <div id="drawer-overlay"></div>
        <div id="drawer">
            <div class="drawer-header">
                <img src="" id="drawer-img" class="drawer-avatar">
                <div class="drawer-info">
                    <div id="drawer-name">User</div>
                    <div id="drawer-tag">@username</div>
                </div>
            </div>
            <div class="drawer-menu">
                <div class="drawer-item" onclick="openSettings()"><i>‚öôÔ∏è</i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div class="drawer-item" onclick="alert('–°–∫–æ—Ä–æ!')"><i>üîç</i> –ü–æ–∏—Å–∫ –ª—é–¥–µ–π</div>
                <div class="drawer-item" onclick="doLogout()" style="color:#ff3b30;"><i>üö™</i> –í—ã–π—Ç–∏</div>
            </div>
        </div>

        <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –ß–ê–¢–ê -->
        <div id="chat-container">
            <header class="chat-header">
                <button class="burger-btn" onclick="toggleDrawer()">‚ò∞</button>
                <div class="chat-title">Global Chat</div>
            </header>

            <div id="messages"></div>

            <div id="input-container">
                <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–≤–µ—Ç–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div id="action-bar">
                    <div class="action-info">
                        <span id="action-title" class="action-title">–û—Ç–≤–µ—Ç</span>
                        <span id="action-text" class="action-text">...</span>
                    </div>
                    <button class="btn-close-action" onclick="cancelAction()">‚úï</button>
                </div>

                <div class="input-row">
                    <button class="icon-btn" onclick="sendImgPrompt()">üì∑</button>
                    <textarea id="msg-input" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                    <button class="icon-btn send" id="btn-send">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ -->
    <div id="context-menu">
        <div class="ctx-item" id="ctx-reply">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="ctx-item" id="ctx-copy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="ctx-item" id="ctx-edit">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="ctx-item delete" id="ctx-delete">üóë –£–¥–∞–ª–∏—Ç—å</div>
    </div>

    <!-- 5. –ú–û–î–ê–õ–ö–ê –ù–ê–°–¢–†–û–ï–ö -->
    <div id="settings-modal">
        <div class="modal-content">
            <h3>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
            
            <!-- –ü—Ä–µ–≤—å—é -->
            <div class="preview-box" id="prev-bg">
                <div class="prev-msg prev-other" id="prev-bubble-other">–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?</div>
                <div class="prev-msg prev-me" id="prev-bubble-me">–í—Å–µ —Å—É–ø–µ—Ä! –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é —Ç–µ–º—É.</div>
            </div>

            <!-- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã -->
            <div class="color-picker-row">
                <label>–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (–ö–Ω–æ–ø–∫–∏)</label>
                <input type="color" id="set-primary" value="#3390ec">
            </div>
            <div class="color-picker-row">
                <label>–§–æ–Ω –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</label>
                <input type="color" id="set-me-bg" value="#eeffde">
            </div>
            <div class="color-picker-row">
                <label>–¢–µ–∫—Å—Ç –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</label>
                <input type="color" id="set-me-text" value="#000000">
            </div>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="saveTheme()" class="btn-main" style="flex:1;">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button onclick="closeSettings()" class="btn-main" style="background:#ddd; color:#000;">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, get, child, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // –ö–û–ù–§–ò–ì
        const config = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677"
        };

        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let user = null;
        let profile = null;
        let isAdmin = false;

        // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è Reply / Edit
        let currentAction = null; // 'reply' | 'edit'
        let targetMsg = null; // –û–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, —Å –∫–æ—Ç–æ—Ä—ã–º —Ä–∞–±–æ—Ç–∞–µ–º

        // UI Refs
        const ui = {
            login: document.getElementById('login-screen'),
            reg: document.getElementById('reg-screen'),
            app: document.getElementById('app'),
            drawer: document.getElementById('drawer'),
            drawerOverlay: document.getElementById('drawer-overlay'),
            input: document.getElementById('msg-input'),
            messages: document.getElementById('messages'),
            actionBar: document.getElementById('action-bar'),
            actionTitle: document.getElementById('action-title'),
            actionText: document.getElementById('action-text'),
            ctxMenu: document.getElementById('context-menu'),
            settings: document.getElementById('settings-modal')
        };

        // --- AUTH ---
        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.doLogout = () => signOut(auth);

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                ui.login.style.display = 'none';
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                get(child(ref(db), `users/${user.uid}`)).then((snap) => {
                    if (snap.exists()) {
                        profile = snap.val();
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –≤ –±–∞–∑–µ, –µ—Å–ª–∏ –æ–Ω–∞ —Å–º–µ–Ω–∏–ª–∞—Å—å –≤ –≥—É–≥–ª–µ
                        if(profile.photoURL !== user.photoURL) {
                            update(ref(db, `users/${user.uid}`), { photoURL: user.photoURL });
                            profile.photoURL = user.photoURL;
                        }
                        initApp();
                    } else {
                        ui.reg.style.display = 'flex';
                        document.getElementById('reg-nick').value = user.displayName;
                    }
                });
            } else {
                ui.login.style.display = 'flex';
                ui.reg.style.display = 'none';
                ui.app.style.display = 'none';
            }
        });

        // --- REGISTRATION ---
        document.getElementById('btn-reg-save').onclick = () => {
            const nick = document.getElementById('reg-nick').value.trim();
            const tag = document.getElementById('reg-tag').value.trim().replace('@','');
            if(!nick || !tag) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

            const newData = {
                displayName: nick,
                username: tag.toLowerCase(),
                usernameDisplay: tag,
                photoURL: user.photoURL,
                uid: user.uid
            };
            
            set(ref(db, `users/${user.uid}`), newData).then(() => {
                profile = newData;
                ui.reg.style.display = 'none';
                initApp();
            });
        };

        function initApp() {
            ui.app.style.display = 'block';
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ Drawer
            document.getElementById('drawer-img').src = profile.photoURL || '';
            document.getElementById('drawer-name').innerText = profile.displayName;
            document.getElementById('drawer-tag').innerText = '@' + profile.usernameDisplay;

            // –ê–¥–º–∏–Ω–∫–∞
            if(profile.usernameDisplay.toLowerCase() === 'admin') isAdmin = true;

            loadMessages();
            loadTheme();
        }

        // --- DRAWER LOGIC ---
        window.toggleDrawer = () => {
            ui.drawer.classList.toggle('open');
            ui.drawerOverlay.classList.toggle('open');
        };
        ui.drawerOverlay.onclick = window.toggleDrawer;

        // --- MESSAGING ---
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞
        document.getElementById('btn-send').onclick = sendMessage;
        ui.input.onkeypress = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };

        function sendMessage() {
            const txt = ui.input.value.trim();
            if(!txt) return;

            if (currentAction === 'edit' && targetMsg) {
                // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï
                update(ref(db, `messages/${targetMsg.key}`), {
                    text: txt,
                    isEdited: true
                });
                cancelAction();
            } else {
                // –ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï
                const payload = {
                    text: txt,
                    uid: user.uid,
                    displayName: profile.displayName,
                    username: profile.usernameDisplay,
                    photoURL: profile.photoURL,
                    createdAt: Date.now()
                };

                // –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç
                if (currentAction === 'reply' && targetMsg) {
                    payload.replyTo = {
                        id: targetMsg.key,
                        name: targetMsg.displayName,
                        text: targetMsg.text
                    };
                }

                push(ref(db, 'messages'), payload);
                cancelAction();
            }
            ui.input.value = '';
        }

        window.sendImgPrompt = () => {
            const url = prompt("–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É:");
            if(url) {
                ui.input.value = url;
                sendMessage();
            }
        };

        // --- RENDER ---
        function loadMessages() {
            onValue(ref(db, 'messages'), (snapshot) => {
                ui.messages.innerHTML = '';
                const data = snapshot.val();
                if(!data) return;

                const msgs = Object.entries(data).map(([k,v]) => ({key:k, ...v})).sort((a,b) => a.createdAt - b.createdAt);

                msgs.forEach(m => {
                    const isMe = m.uid === user.uid;
                    
                    // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–æ–∫–∏
                    const row = document.createElement('div');
                    row.className = `msg-row ${isMe ? 'me' : 'other'}`;
                    
                    // –ê–≤–∞—Ç–∞—Ä–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—É–∂–∏—Ö)
                    const ava = document.createElement('img');
                    ava.className = 'msg-avatar';
                    ava.src = m.photoURL || 'https://via.placeholder.com/32';
                    if(!isMe) row.appendChild(ava);

                    // –ü—É–∑—ã—Ä—å
                    const bubble = document.createElement('div');
                    bubble.className = 'msg-bubble';
                    
                    // –°–æ–±—ã—Ç–∏–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                    bubble.addEventListener('contextmenu', (e) => openCtxMenu(e, m));

                    // –ò–º—è –∞–≤—Ç–æ—Ä–∞ (—É —á—É–∂–∏—Ö)
                    if(!isMe) {
                        let crown = m.username === 'admin' ? '<span class="admin-crown">üëë</span>' : '';
                        bubble.innerHTML += `<div class="msg-name">${m.displayName}${crown}</div>`;
                    }

                    // –û—Ç–≤–µ—Ç (Reply UI)
                    if(m.replyTo) {
                        bubble.innerHTML += `
                            <div class="reply-quote">
                                <span class="reply-name">${m.replyTo.name}</span>
                                <span class="reply-text">${m.replyTo.text}</span>
                            </div>
                        `;
                    }

                    // –¢–µ–∫—Å—Ç (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∞—Ä—Ç–∏–Ω–æ–∫)
                    let content = m.text;
                    if(content.match(/^https?:\/\/.*\.(jpg|jpeg|png|gif|webp)$/i)) {
                        content = `<img src="${content}" style="max-width:100%; border-radius:8px; display:block;">`;
                    }
                    
                    // –ú–µ—Ç–∞ (–≤—Ä–µ–º—è + –∏–∑–º)
                    const date = new Date(m.createdAt);
                    const time = date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');
                    const editedMark = m.isEdited ? ' (–∏–∑–º.)' : '';

                    bubble.innerHTML += `
                        <span>${content}</span>
                        <div class="msg-meta">
                            <span>${editedMark}</span>
                            <span>${time}</span>
                        </div>
                    `;

                    row.appendChild(bubble);
                    ui.messages.appendChild(row);
                });
                ui.messages.scrollTop = ui.messages.scrollHeight;
            });
        }

        // --- CONTEXT MENU ---
        let ctxMsg = null; // –°–æ–æ–±—â–µ–Ω–∏–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –æ—Ç–∫—Ä—ã–ª–∏ –º–µ–Ω—é

        function openCtxMenu(e, msg) {
            e.preventDefault();
            ctxMsg = msg;
            
            // –°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤
            const isMine = msg.uid === user.uid;
            document.getElementById('ctx-edit').style.display = isMine ? 'flex' : 'none';
            document.getElementById('ctx-delete').style.display = (isMine || isAdmin) ? 'flex' : 'none';

            // –ü–æ–∑–∏—Ü–∏—è
            ui.ctxMenu.style.display = 'block';
            let x = e.clientX;
            let y = e.clientY;
            
            // –ß—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ–∑–∞–ª–æ –∑–∞ —ç–∫—Ä–∞–Ω
            if(x + 160 > window.innerWidth) x -= 160;
            if(y + 150 > window.innerHeight) y -= 150;

            ui.ctxMenu.style.left = x + 'px';
            ui.ctxMenu.style.top = y + 'px';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ø—É—Å—Ç–æ—Ç—É
        document.addEventListener('click', (e) => {
            if(!ui.ctxMenu.contains(e.target)) ui.ctxMenu.style.display = 'none';
        });

        // --- ACTIONS (REPLY / EDIT / DELETE) ---
        
        document.getElementById('ctx-reply').onclick = () => {
            setupAction('reply', ctxMsg);
            ui.ctxMenu.style.display = 'none';
        };

        document.getElementById('ctx-edit').onclick = () => {
            setupAction('edit', ctxMsg);
            ui.ctxMenu.style.display = 'none';
        };
        
        document.getElementById('ctx-copy').onclick = () => {
            navigator.clipboard.writeText(ctxMsg.text);
            ui.ctxMenu.style.display = 'none';
        };

        document.getElementById('ctx-delete').onclick = () => {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
                remove(ref(db, `messages/${ctxMsg.key}`));
            }
            ui.ctxMenu.style.display = 'none';
        };

        function setupAction(type, msg) {
            currentAction = type;
            targetMsg = msg;
            ui.actionBar.style.display = 'flex';
            
            if(type === 'reply') {
                ui.actionTitle.innerText = "–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é " + msg.displayName;
                ui.actionText.innerText = msg.text;
                ui.input.focus();
            } else if(type === 'edit') {
                ui.actionTitle.innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
                ui.actionText.innerText = msg.text;
                ui.input.value = msg.text;
                ui.input.focus();
            }
        }

        window.cancelAction = () => {
            currentAction = null;
            targetMsg = null;
            ui.actionBar.style.display = 'none';
            ui.input.value = '';
        };


        // --- THEME SETTINGS ---
        window.openSettings = () => {
            ui.settings.style.display = 'flex';
            window.toggleDrawer(); // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é
            
            // Init preview colors
            updatePreview();
        };
        window.closeSettings = () => ui.settings.style.display = 'none';

        // Inputs
        const inPrime = document.getElementById('set-primary');
        const inMeBg = document.getElementById('set-me-bg');
        const inMeTxt = document.getElementById('set-me-text');
        
        // Listeners for Live Preview
        inPrime.addEventListener('input', updatePreview);
        inMeBg.addEventListener('input', updatePreview);
        inMeTxt.addEventListener('input', updatePreview);

        function updatePreview() {
            // Apply to preview elements ONLY
            document.getElementById('prev-bubble-me').style.backgroundColor = inMeBg.value;
            document.getElementById('prev-bubble-me').style.color = inMeTxt.value;
            
            // Button style in preview modal
            document.querySelector('#settings-modal .btn-main').style.backgroundColor = inPrime.value;
        }

        window.saveTheme = () => {
            const r = document.documentElement.style;
            r.setProperty('--primary', inPrime.value);
            r.setProperty('--msg-me-bg', inMeBg.value);
            r.setProperty('--msg-me-text', inMeTxt.value);
            
            // Save to LS
            localStorage.setItem('theme_prime', inPrime.value);
            localStorage.setItem('theme_me_bg', inMeBg.value);
            localStorage.setItem('theme_me_txt', inMeTxt.value);
            
            closeSettings();
        };

        function loadTheme() {
            const r = document.documentElement.style;
            const p = localStorage.getItem('theme_prime');
            if(p) {
                r.setProperty('--primary', p);
                inPrime.value = p;
            }
            const mb = localStorage.getItem('theme_me_bg');
            if(mb) {
                r.setProperty('--msg-me-bg', mb);
                inMeBg.value = mb;
            }
            const mt = localStorage.getItem('theme_me_txt');
            if(mt) {
                r.setProperty('--msg-me-text', mt);
                inMeTxt.value = mt;
            }
        }

    </script>
</body>
</html>
