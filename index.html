<script type="module">
  // --- ИМПОРТЫ FIREBASE (Версия 10.7.1) ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- ТВОЙ КОНФИГ (Я его вставил) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
    authDomain: "narrators-messenger.firebaseapp.com",
    databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
    projectId: "narrators-messenger",
    storageBucket: "narrators-messenger.firebasestorage.app",
    messagingSenderId: "421115209686",
    appId: "1:421115209686:web:94d5560793540f14f02677",
    measurementId: "G-XN1B0KZ5ML"
  };

  // --- ИНИЦИАЛИЗАЦИЯ ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app); // Используем Firestore (современная БД)
  const provider = new GoogleAuthProvider();

  // --- ЭЛЕМЕНТЫ HTML (Проверь, чтобы ID совпадали в твоем HTML!) ---
  const elements = {
    loginPanel: document.getElementById('login-panel'), // Блок с кнопкой входа
    chatPanel: document.getElementById('chat-panel'),   // Блок с чатом
    btnLogin: document.getElementById('btn-login'),     // Кнопка "Войти через Google"
    btnLogout: document.getElementById('btn-logout'),   // Кнопка "Выйти"
    inputMsg: document.getElementById('msg-input'),     // Поле ввода сообщения
    btnSend: document.getElementById('btn-send'),       // Кнопка "Отправить"
    messagesList: document.getElementById('messages')   // Див, где лежат сообщения
  };

  let currentUser = null;

  // --- ЛОГИКА АВТОРИЗАЦИИ ---
  
  // 1. Вход
  if (elements.btnLogin) {
    elements.btnLogin.addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
        console.log("Вход выполнен!");
      } catch (error) {
        console.error("Ошибка входа:", error);
        alert("Не удалось войти: " + error.message);
      }
    });
  }

  // 2. Выход
  if (elements.btnLogout) {
    elements.btnLogout.addEventListener('click', () => signOut(auth));
  }

  // 3. Отслеживание состояния (Вошел/Вышел)
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
      // ПОКАЗАТЬ ЧАТ, СКРЫТЬ ВХОД
      if (elements.loginPanel) elements.loginPanel.style.display = 'none';
      if (elements.chatPanel) elements.chatPanel.style.display = 'flex'; // или 'block'
      loadMessages(); // Загружаем переписку
    } else {
      // ПОКАЗАТЬ ВХОД, СКРЫТЬ ЧАТ
      if (elements.loginPanel) elements.loginPanel.style.display = 'flex';
      if (elements.chatPanel) elements.chatPanel.style.display = 'none';
      if (elements.messagesList) elements.messagesList.innerHTML = '';
    }
  });

  // --- ЛОГИКА ЧАТА ---

  // 4. Отправка сообщения
  const sendMessage = async () => {
    const text = elements.inputMsg.value.trim();
    if (!text || !currentUser) return;

    try {
      await addDoc(collection(db, "messages"), {
        text: text,
        uid: currentUser.uid,
        displayName: currentUser.displayName,
        photoURL: currentUser.photoURL,
        createdAt: serverTimestamp()
      });
      elements.inputMsg.value = ''; // Очистить поле
    } catch (e) {
      console.error("Ошибка отправки:", e);
      alert("Ошибка отправки. Проверь консоль Firebase (Rules).");
    }
  };

  if (elements.btnSend) elements.btnSend.addEventListener('click', sendMessage);
  
  if (elements.inputMsg) {
    elements.inputMsg.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  }

  // 5. Загрузка сообщений в реальном времени
  function loadMessages() {
    const q = query(collection(db, "messages"), orderBy("createdAt", "asc"), limit(50));
    
    onSnapshot(q, (snapshot) => {
      const list = elements.messagesList;
      if (!list) return;

      list.innerHTML = ''; // Очищаем перед отрисовкой (простой способ)

      snapshot.forEach((doc) => {
        const msg = doc.data();
        const div = document.createElement('div');
        
        // Проверка: мое сообщение или чужое?
        const isMe = msg.uid === currentUser.uid;
        
        // Стилизация (используем твои классы из CSS)
        div.className = isMe ? 'message me' : 'message other'; 
        
        // Вставка HTML сообщения
        div.innerHTML = `
          <div class="msg-content" style="padding: 10px; border-radius: 5px; background: ${isMe ? 'var(--msg-me)' : 'var(--msg-other)'}; color: ${isMe ? 'var(--msg-me-text)' : 'var(--msg-other-text)'}">
            <small style="opacity: 0.7; display: block; font-size: 0.7em;">${msg.displayName || 'Anon'}</small>
            <span>${msg.text}</span>
          </div>
        `;
        
        list.appendChild(div);
      });

      // Скролл вниз
      list.scrollTop = list.scrollHeight;
    });
  }
</script>
