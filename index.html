<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARRATORS // TG STYLE</title>
    <style>
        :root {
            --bg-body: #ffffff;
            --bg-sidebar: #f0f2f5; /* –¶–≤–µ—Ç –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –∫–∞–∫ –≤ –¢–ì */
            --bg-chat: #ffffff;    /* –§–æ–Ω —á–∞—Ç–∞ */
            --primary: #3390ec;    /* –°–∏–Ω–∏–π –¢–ì */
            --msg-me: #eeffde;     /* –ó–µ–ª–µ–Ω–æ–≤–∞—Ç—ã–π –¢–ì */
            --msg-other: #ffffff;
            --text-main: #000000;
            --text-dim: #707579;
            --border: #dfe1e5;
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            background-color: var(--bg-body);
            display: flex;
        }

        /* --- –≠–ö–†–ê–ù–´ (–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ) --- */
        .full-screen-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2000;
        }

        /* –ö–Ω–æ–ø–∫–∏ –∏ –∏–Ω–ø—É—Ç—ã */
        input {
            padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 1rem; width: 300px; margin-bottom: 10px; outline: none;
        }
        input:focus { border-color: var(--primary); }
        
        button.btn-primary {
            padding: 12px 30px; border: none; background: var(--primary); color: #fff;
            font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 1rem;
            transition: 0.2s;
        }
        button.btn-primary:hover { opacity: 0.9; }

        /* --- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° (Telegram Layout) --- */
        #app-layout {
            display: none; /* –°–∫—Ä—ã—Ç–æ –¥–æ –≤—Ö–æ–¥–∞ */
            width: 100%; height: 100%;
        }

        /* –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤) */
        #sidebar {
            width: 350px;
            height: 100%;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
        }

        .sidebar-header {
            padding: 10px 15px;
            display: flex; gap: 10px;
        }

        .search-box {
            width: 100%; padding: 8px 15px; border-radius: 20px;
            border: 1px solid var(--border); background: #fff; outline: none;
        }

        .chat-list {
            flex: 1; overflow-y: auto;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ */
        .chat-item {
            padding: 10px 15px; display: flex; align-items: center; gap: 10px;
            cursor: pointer; transition: 0.2s;
        }
        .chat-item:hover { background: rgba(0,0,0,0.05); }
        .chat-item.active { background: #3390ec20; }
        
        .avatar {
            width: 45px; height: 45px; border-radius: 50%; background: #ccc;
            display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold;
            font-size: 1.2rem;
        }

        /* –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–°–∞–º —á–∞—Ç) */
        #main-chat {
            flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ */
            height: 100%;
            display: flex; flex-direction: column;
            background: var(--bg-chat);
            /* –§–æ–Ω —Ç–µ–ª–µ–≥—Ä–∞–º –ø–∞—Ç—Ç–µ—Ä–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2392a1a9' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .chat-header {
            padding: 10px 20px; background: #fff; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }

        #messages {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 5px;
        }

        .message {
            max-width: 60%; padding: 8px 12px; border-radius: 8px;
            font-size: 0.95rem; line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message.me {
            background: var(--msg-me); align-self: flex-end; /* –°–ø—Ä–∞–≤–∞ */
        }
        .message.other {
            background: var(--msg-other); align-self: flex-start; /* –°–ª–µ–≤–∞ */
        }
        
        .msg-meta {
            display: flex; justify-content: space-between; align-items: flex-end; gap: 10px;
        }
        .msg-name { font-weight: bold; color: var(--primary); font-size: 0.8rem; cursor: pointer; }
        .msg-time { font-size: 0.7rem; color: #999; }

        .input-area {
            padding: 10px 20px; background: #fff; display: flex; gap: 10px;
            align-items: center;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 700px) {
            #sidebar { width: 100%; display: flex; } /* –ù–∞ –º–æ–±–∏–ª–∫–∞—Ö —Å–Ω–∞—á–∞–ª–∞ –≤–∏–¥–Ω–æ —Å–ø–∏—Å–æ–∫ */
            #main-chat { display: none; width: 100%; } /* –ß–∞—Ç —Å–∫—Ä—ã—Ç */
            
            body.chat-open #sidebar { display: none; }
            body.chat-open #main-chat { display: flex; }
        }
    </style>
</head>
<body>

    <!-- 1. –ü–ê–ù–ï–õ–¨ –í–•–û–î–ê -->
    <div id="login-panel" class="full-screen-panel">
        <h1 style="color: var(--primary); font-size: 2rem;">NARRATORS</h1>
        <p style="color: #666; margin-bottom: 20px;">Secure Messenger</p>
        <button id="btn-login" class="btn-primary">–í–û–ô–¢–ò –ß–ï–†–ï–ó GOOGLE</button>
    </div>

    <!-- 2. –ü–ê–ù–ï–õ–¨ –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò (–ï—Å–ª–∏ –Ω–µ—Ç —é–∑–µ—Ä–Ω–µ–π–º–∞) -->
    <div id="reg-panel" class="full-screen-panel" style="display: none;">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h2>
        <p style="color: #666; margin-bottom: 20px;">–ö–∞–∫ –≤–∞—Å –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ?</p>
        
        <input type="text" id="reg-nick" placeholder="–ò–º—è (Nick)" maxlength="20">
        <input type="text" id="reg-tag" placeholder="@username (–¥–ª—è –ø–æ–∏—Å–∫–∞)" maxlength="15">
        <button id="btn-save-profile" class="btn-primary">–°–û–•–†–ê–ù–ò–¢–¨ –ò –í–û–ô–¢–ò</button>
    </div>

    <!-- 3. –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="app-layout">
        
        <!-- –°–õ–ï–í–ê: –°–ü–ò–°–û–ö -->
        <div id="sidebar">
            <div class="sidebar-header">
                <input type="text" class="search-box" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π (@tag)..." id="search-input">
            </div>
            <div class="chat-list" id="chat-list">
                <!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –æ–±—â–µ–≥–æ —á–∞—Ç–∞ -->
                <div class="chat-item active" onclick="openGlobalChat()">
                    <div class="avatar" style="background: linear-gradient(45deg, #ff0033, #3390ec);">N</div>
                    <div class="chat-info">
                        <div style="font-weight: bold;">Global Chat</div>
                        <div style="font-size: 0.8rem; color: #777;">–û–±—â–∏–π —á–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>
                    </div>
                </div>
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –ø–∞–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
            </div>
            <div style="padding: 10px; border-top: 1px solid #ddd; text-align: center;">
                 <span id="my-username-display" style="font-size: 0.8rem; color: #777;">@loading...</span>
            </div>
        </div>

        <!-- –°–ü–†–ê–í–ê: –ß–ê–¢ -->
        <div id="main-chat">
            <div class="chat-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="btn-back" style="display:none; background:none; border:none; font-size:1.5rem;">‚¨Ö</button> <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –¥–ª—è –º–æ–±–∏–ª–æ–∫ -->
                    <div class="avatar" style="width:35px; height:35px; font-size:1rem; background: var(--primary);">G</div>
                    <div style="font-weight:bold;">Global Chat</div>
                </div>
                <button id="btn-logout" style="border:none; background:none; cursor:pointer;">üö™</button>
            </div>

            <div id="messages"></div>

            <div class="input-area">
                <button id="btn-attach" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">üì∑</button>
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; margin:0;">
                <button id="btn-send" style="border:none; background:none; color:var(--primary); font-size:1.5rem; cursor:pointer;">‚û§</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, limit, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // –¢–í–û–ô –ö–û–ù–§–ò–ì
        const firebaseConfig = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677",
            measurementId: "G-XN1B0KZ5ML"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // –≠–õ–ï–ú–ï–ù–¢–´
        const els = {
            loginPanel: document.getElementById('login-panel'),
            regPanel: document.getElementById('reg-panel'),
            appLayout: document.getElementById('app-layout'),
            
            btnLogin: document.getElementById('btn-login'),
            btnSaveProfile: document.getElementById('btn-save-profile'),
            btnLogout: document.getElementById('btn-logout'),
            
            regNick: document.getElementById('reg-nick'),
            regTag: document.getElementById('reg-tag'),
            
            myTagDisplay: document.getElementById('my-username-display'),
            
            input: document.getElementById('msg-input'),
            btnSend: document.getElementById('btn-send'),
            btnAttach: document.getElementById('btn-attach'),
            messages: document.getElementById('messages'),
            
            btnBack: document.getElementById('btn-back')
        };

        let currentUser = null;
        let userData = null;

        // 1. –õ–û–ì–ò–ö–ê –í–•–û–î–ê
        els.btnLogin.addEventListener('click', () => signInWithPopup(auth, provider));
        els.btnLogout.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                els.loginPanel.style.display = 'none';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –≤ –±–∞–∑–µ
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    // –ü—Ä–æ—Ñ–∏–ª—å –µ—Å—Ç—å -> –∑–∞–ø—É—Å–∫–∞–µ–º –∞–ø–ø
                    userData = userSnap.data();
                    startApp();
                } else {
                    // –ü—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç -> –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                    els.regPanel.style.display = 'flex';
                    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –Ω–∏–∫ –∏–∑ –≥—É–≥–ª–∞
                    els.regNick.value = user.displayName;
                }
            } else {
                // –í—ã—à–µ–ª
                els.loginPanel.style.display = 'flex';
                els.regPanel.style.display = 'none';
                els.appLayout.style.display = 'none';
            }
        });

        // 2. –õ–û–ì–ò–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò
        els.btnSaveProfile.addEventListener('click', async () => {
            const nick = els.regNick.value.trim();
            let tag = els.regTag.value.trim();
            
            if (nick.length < 2 || tag.length < 2) {
                alert("–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è –∏–ª–∏ —Ç–µ–≥!");
                return;
            }
            // –£–±–∏—Ä–∞–µ–º @ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–∞–ø–∏—Å–∞–ª
            tag = tag.replace('@', '');

            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É users
                await setDoc(doc(db, "users", currentUser.uid), {
                    displayName: nick,
                    username: tag.toLowerCase(), // –¥–ª—è –ø–æ–∏—Å–∫–∞
                    usernameDisplay: tag,
                    photoURL: currentUser.photoURL,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                
                userData = { displayName: nick, usernameDisplay: tag };
                els.regPanel.style.display = 'none';
                startApp();
                
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è");
            }
        });

        // 3. –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        function startApp() {
            els.appLayout.style.display = 'flex';
            els.myTagDisplay.innerText = '@' + userData.usernameDisplay;
            loadMessages(); // –ü–æ–∫–∞ –≥—Ä—É–∑–∏–º –æ–±—â–∏–π —á–∞—Ç
        }

        // 4. –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô
        async function sendMessage(text) {
            if (!text || !currentUser) return;
            try {
                await addDoc(collection(db, "messages"), {
                    text: text,
                    uid: currentUser.uid,
                    displayName: userData.displayName || currentUser.displayName, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ù–∏–∫ –∏–∑ –±–∞–∑—ã
                    username: userData.usernameDisplay || 'anon', // –¢–µ–≥
                    createdAt: serverTimestamp()
                });
            } catch (e) { console.error(e); }
        }

        els.btnSend.addEventListener('click', () => {
            const txt = els.input.value.trim();
            if(txt) { sendMessage(txt); els.input.value = ''; }
        });
        
        els.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const txt = els.input.value.trim();
                if(txt) { sendMessage(txt); els.input.value = ''; }
            }
        });

        // –ö–∞—Ä—Ç–∏–Ω–∫–∏ (–ø—Ä–æ—Å—Ç–æ —Å—Å—ã–ª–∫–æ–π)
        els.btnAttach.addEventListener('click', () => {
            const url = prompt("–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É:");
            if (url) sendMessage(url);
        });

        // 5. –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–ê (–†–ï–ù–î–ï–†)
        function loadMessages() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"), limit(50));
            onSnapshot(q, (snapshot) => {
                els.messages.innerHTML = '';
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const isMe = msg.uid === currentUser.uid;
                    
                    const div = document.createElement('div');
                    div.className = `message ${isMe ? 'me' : 'other'}`;
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫
                    let content = msg.text;
                    if (content.match(/\.(jpeg|jpg|gif|png|webp)/i) || content.startsWith('http')) {
                         if(content.startsWith('http')) content = `<img src="${content}" style="max-width:100%; border-radius:5px; margin-top:5px;">`;
                    }

                    div.innerHTML = `
                        <div class="msg-meta">
                            <span class="msg-name" onclick="alert('–≠—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @${msg.username}')">${msg.displayName}</span>
                        </div>
                        <div class="msg-text">${content}</div>
                    `;
                    els.messages.appendChild(div);
                });
                els.messages.scrollTop = els.messages.scrollHeight;
            });
        }

        // –ú–û–ë–ò–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø
        // (–î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è: –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç —Å—Ä–∞–∑—É. –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫)
        window.openGlobalChat = function() {
            if (window.innerWidth <= 700) {
                document.body.classList.add('chat-open');
                els.btnBack.style.display = 'block';
            }
        };

        els.btnBack.addEventListener('click', () => {
             document.body.classList.remove('chat-open');
             els.btnBack.style.display = 'none';
        });

    </script>
</body>
</html>
