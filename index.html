<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Narrators Messenger v0.1.7</title>

    <style>
        :root {
            --primary: #3390ec;
            --primary-soft: rgba(51, 144, 236, 0.1);
            --bg-body: #ffffff;
            --bg-chat-img: none;
            --bg-chat-color: var(--bg-body);
            --msg-me: #eeffde;
            --msg-me-text: #000000;
            --msg-other: #f4f4f5;
            --msg-other-text: #000000;
            --radius: 12px;
            --font-size: 16px;
            --border: #e4e4e4;
            --text-main: #000000;
            --text-sec: #707579;
            --ease: cubic-bezier(0.25, 1, 0.5, 1);
            --online: #4caf50;
            --offline: #9e9e9e;
            --unread-badge: #ff3b30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin:0; padding:0; outline:none; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height:100vh; width:100vw; display:flex; overflow:hidden;
            background:var(--bg-body); color:var(--text-main); font-size:var(--font-size); line-height:1.5;
        }

        /* AUTH / COMMON */
        .panel { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:20px; }
        .card { width:100%; max-width:480px; border-radius:12px; padding:20px; border:1px solid var(--border); background:#fff; box-shadow:0 12px 40px rgba(0,0,0,0.06); }
        .logo { color:var(--primary); font-weight:800; font-size:28px; margin-bottom:6px; }
        .muted { color:var(--text-sec); font-size:13px; margin-bottom:12px; }
        .input-field { width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border); margin-bottom:10px; font-size:14px; }
        .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px; cursor:pointer; border:none; }
        .btn-primary { background:var(--primary); color:#fff; }
        .btn-ghost { background:#f6f7fb; color:#222; border:1px solid #efefef; }
        .small-link { color:var(--primary); cursor:pointer; font-size:13px; text-decoration:underline; }

        .notice { padding:10px; border-radius:8px; margin:10px 0; font-size:13px; }
        .notice.error { background:#fff4f4; border:1px solid #ffd2d2; color:#8b1d1d; }
        .notice.info { background:#f0f8ff; border:1px solid #cfe9ff; color:#045; }
        .notice.success { background:#f0fff4; border:1px solid #c6f6d5; color:#22543d; }

        /* APP LAYOUT */
        #app { display:none; width:100%; height:100%; opacity:0; transition:opacity 0.45s var(--ease); }
        #app.visible { display:flex; opacity:1; }
        #sidebar { width:360px; flex-shrink:0; background:var(--bg-body); border-right:1px solid var(--border); display:flex; flex-direction:column; z-index:500; }
        .sidebar-top { padding:12px 16px; display:flex; gap:12px; align-items:center; border-bottom:1px solid var(--border); }
        .chat-list-container { flex:1; overflow-y:auto; padding-bottom:12px; }
        .chat-row { padding:12px 16px; display:flex; gap:12px; align-items:center; cursor:pointer; border-bottom:1px solid #f9f9f9; position:relative; }
        .chat-row:hover { background:#f7f9fb; }
        .chat-row.active { background:var(--primary-soft); border-left:4px solid var(--primary); }
        .user-avatar { width:55px; height:55px; border-radius:50%; object-fit:cover; cursor:pointer; }

        /* Online status dot */
        .online-dot { 
            position: absolute; 
            bottom: 2px; 
            right: 2px; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: var(--offline);
            border: 2px solid var(--bg-body);
        }
        .online-dot.active { background: var(--online); }

        /* Unread badge */
        .unread-badge {
            position: absolute;
            top: 8px;
            right: 12px;
            background: var(--unread-badge);
            color: white;
            font-size: 11px;
            font-weight: bold;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
        }

        /* Typing indicator */
        .typing-indicator {
            font-size: 12px;
            color: var(--primary);
            font-style: italic;
            margin-top: 2px;
        }

        #chat-window { flex:1; display:flex; flex-direction:column; background-color:var(--bg-chat-color); background-image:var(--bg-chat-img); background-size:cover; position:relative; }
        .chat-top-bar { height:65px; display:flex; align-items:center; gap:12px; padding:0 18px; border-bottom:1px solid var(--border); background:rgba(255,255,255,0.95); backdrop-filter: blur(6px); }
        #messages-view { flex:1; overflow-y:auto; padding:20px 6%; display:flex; flex-direction:column; gap:12px; scroll-behavior:smooth; }

        /* Message layout */
        .msg-wrapper {
            display:flex;
            align-items:flex-end;
            gap:10px;
            width:100%;
            justify-content:flex-start; /* default left */
        }
        .msg-wrapper.my-msg { justify-content:flex-end !important; }
        .msg-wrapper.other-msg { justify-content:flex-start !important; }

        .msg-wrapper.other-msg .msg-avatar { order: 0; margin-right:8px; }
        .msg-wrapper.other-msg .msg-bubble { order: 1; }

        .msg-wrapper.my-msg .msg-avatar { order: 1; margin-left:8px; }
        .msg-wrapper.my-msg .msg-bubble { order: 0; }

        .msg-bubble { padding:12px 16px; border-radius:var(--radius); max-width:70%; box-shadow:0 2px 5px rgba(0,0,0,0.05); word-wrap:break-word; background:var(--msg-other); color:var(--msg-other-text); }
        .msg-wrapper.my-msg .msg-bubble { background:var(--msg-me); color:var(--msg-me-text); }

        .author-tag { font-size:13px; font-weight:700; color:var(--primary); margin-bottom:6px; display:block; }
        .time-stamp { font-size:11px; opacity:0.6; display:block; margin-top:6px; text-align:right; }

        .msg-avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; cursor:pointer; position:relative; }
        .msg-avatar .online-dot { width:10px; height:10px; bottom:-1px; right:-1px; }

        .bottom-controls { padding:12px 18px; border-top:1px solid var(--border); background:#fff; }
        .input-group { display:flex; gap:10px; align-items:center; }
        #main-input { flex:1; padding:10px; border-radius:10px; border:1px solid var(--border); resize:none; }

        /* profile modal */
        .profile-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:10001; display:none; backdrop-filter:blur(3px); }
        .profile-overlay.active { display:block; }
        .profile-modal { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(0.95); width:92%; max-width:520px; background:#fff; border-radius:14px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,0.3); z-index:10002; display:none; transition:all 0.18s var(--ease); opacity:0; }
        .profile-modal.active { display:block; transform:translate(-50%,-50%) scale(1); opacity:1; }

        /* settings modal */
        .settings-modal { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(0.95); width:92%; max-width:560px; background:#fff; border-radius:12px; padding:18px; box-shadow:0 30px 80px rgba(0,0,0,0.25); z-index:10003; display:none; opacity:0; transition:all 0.18s var(--ease); }
        .settings-modal.active { display:block; transform:translate(-50%,-50%) scale(1); opacity:1; }

        /* group modal */
        .group-modal { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(0.95); background:#fff; z-index:10004; width:92%; max-width:620px; border-radius:12px; padding:16px; display:none; box-shadow:0 20px 60px rgba(0,0,0,0.25); }
        .group-modal.active { display:block; transform:translate(-50%,-50%) scale(1); }

        /* top menu dropdown */
        .top-menu-btn { background:transparent; border:none; cursor:pointer; font-size:20px; padding:8px; border-radius:8px; }
        .top-menu { position:absolute; right:18px; top:12px; background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow:0 6px 24px rgba(0,0,0,0.12); display:none; z-index:10005; min-width:180px; }
        .top-menu.active { display:block; }
        .top-menu .item { padding:10px 12px; cursor:pointer; border-bottom:1px solid #f4f4f4; }
        .top-menu .item:last-child { border-bottom:none; }
        .top-menu .item:hover { background:#f6f9ff; }

        .chip { background:#f3f6fb; padding:6px 10px; border-radius:999px; font-size:13px; display:inline-flex; gap:8px; align-items:center; }

        .muted-xs { font-size:12px; color:var(--text-sec); }

        /* Notification request popup */
        .notification-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 10010;
            max-width: 320px;
            display: none;
        }
        .notification-popup.active { display: block; }

        /* Google button loader */
        .google-loader {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid #ccc;
            border-top-color: #4285F4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width:850px) {
            #sidebar { width:100%; }
            #chat-window { display:none; position:fixed; inset:0; z-index:600; }
            body.is-chatting #chat-window { display:flex; }
            .notification-popup {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>

    <!-- AUTH -->
    <div id="auth-screen" class="panel">
        <div class="card" id="auth-card">
            <div class="logo">Narrators</div>
            <div class="muted">–í–µ—Ä—Å–∏—è 0.1.7 ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å—ã, –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</div>

            <div id="auth-error" class="notice error" style="display:none;"></div>
            <div id="auth-info" class="notice info" style="display:none;"></div>

            <div id="login-view">
                <input id="login-email" class="input-field" placeholder="Email" type="email" autocomplete="email">
                <input id="login-password" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å" type="password" autocomplete="current-password">
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <button id="login-btn" class="btn btn-primary" style="flex:1;">–í–æ–π—Ç–∏</button>
                    <button id="to-register" class="btn btn-ghost" style="width:120px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="small-link" id="forgot-password">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</div>
                    <div class="muted-xs">–ò–ª–∏ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google –Ω–∏–∂–µ</div>
                </div>
            </div>

            <div id="register-view" style="display:none; margin-top:10px;">
                <input id="reg-displayname" class="input-field" placeholder="–í–∞—à–µ –∏–º—è">
                <input id="reg-username" class="input-field" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–≥ (–±–µ–∑ @)">
                <input id="reg-email" class="input-field" placeholder="Email" type="email">
                <input id="reg-password" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" type="password">
                <input id="reg-avatar-url" class="input-field" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                <div style="display:flex; gap:8px; margin-top:6px;">
                    <button id="register-btn" class="btn btn-primary" style="flex:1;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                    <button id="to-login" class="btn btn-ghost" style="width:120px;">–ù–∞–∑–∞–¥</button>
                </div>
            </div>

            <hr style="margin:14px 0; border:none; border-top:1px solid #f0f0f0;">

            <button id="google-btn" class="btn btn-ghost" style="width:100%; gap:12px; position:relative;">
                <div id="google-loader" class="google-loader" style="position:absolute; left:20px;"></div>
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="Google" id="google-icon">
                <span id="google-btn-text">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
            </button>
        </div>
    </div>

    <!-- APP -->
    <div id="app">
        <div id="sidebar">
            <div class="sidebar-top">
                <div style="position:relative;">
                    <img id="user-profile-img" class="user-avatar" src="https://via.placeholder.com/150" title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                    <div class="online-dot" id="user-online-status"></div>
                </div>
                <div style="flex:1;">
                    <div id="user-display-name" style="font-weight:700;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div id="user-display-tag" class="muted-xs">@...</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button onclick="uiAction.openCreateGroup()" class="btn btn-primary" style="padding:8px 10px;">+ –ì—Ä—É–ø–ø–∞</button>
                </div>
            </div>

            <div style="padding:12px;">
                <input id="user-search-input" class="input-field" placeholder="–ü–æ–∏—Å–∫ –ø–æ @—Ç–µ–≥—É –∏–ª–∏ –∏–º–µ–Ω–∏...">
            </div>

            <div class="chat-list-container" id="conversations-list">
                <!-- populated dynamically: global + DMs + groups -->
                <div class="chat-row active" id="row-global" onclick="uiAction.openGlobal()">
                    <img class="user-avatar" src="https://cdn-icons-png.flaticon.com/512/1041/1041916.png" style="width:46px; height:46px; border-radius:8px;">
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b>Global Chat Room</b>
                            <span class="muted-xs" style="color:var(--online);">online</span>
                        </div>
                        <div class="muted-xs" style="color:var(--text-sec);">–û–±—â–∏–π —á–∞—Ç</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-window">
            <div class="chat-top-bar">
                <div id="chat-top-info" style="display:flex; gap:12px; align-items:center; cursor:default;">
                    <div style="position:relative;">
                        <img id="chat-top-avatar" src="https://via.placeholder.com/100" style="width:42px; height:42px; border-radius:10px; object-fit:cover; cursor:pointer;" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —á–∞—Ç–∞">
                        <div class="online-dot" id="chat-top-online"></div>
                    </div>
                    <div>
                        <div id="chat-top-title" style="font-weight:700;">Global Chat Room</div>
                        <div id="chat-top-sub" class="muted-xs">
                            <span id="chat-online-status">v0.1.7</span>
                            <span id="chat-typing" class="typing-indicator" style="display:none;"></span>
                        </div>
                    </div>
                </div>

                <button id="chat-top-menu-btn" class="top-menu-btn" title="–ú–µ–Ω—é">‚ò∞</button>
                <div id="chat-top-menu" class="top-menu" aria-hidden="true">
                    <div class="item" id="menu-personalization">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</div>
                    <div class="item" id="menu-notifications">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                    <div class="item" id="menu-settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <div class="item" id="menu-add-group">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</div>
                </div>

                <div style="margin-left:auto;">
                    <button id="signout-btn" class="btn btn-ghost">–í—ã–π—Ç–∏</button>
                </div>
            </div>

            <div id="messages-view"></div>

            <div class="bottom-controls">
                <div id="reply-preview" style="display:none; background:#f5f5f5; padding:10px; border-left:4px solid var(--primary); margin-bottom:12px; border-radius:6px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <b id="reply-author-name" style="color:var(--primary);"></b><br>
                            <span id="reply-author-text" class="muted-xs"></span>
                        </div>
                        <button onclick="chatEngine.cancelAction()" class="btn btn-ghost">‚úï</button>
                    </div>
                </div>

                <div class="input-group">
                    <textarea id="main-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..." rows="1"></textarea>
                    <button id="send-msg-btn" class="btn btn-primary" onclick="chatEngine.sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification request popup -->
    <div id="notification-popup" class="notification-popup">
        <div style="font-weight:700; margin-bottom:8px;">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?</div>
        <div style="font-size:13px; color:var(--text-sec); margin-bottom:12px;">
            –ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –¥–∞–∂–µ –∫–æ–≥–¥–∞ —Å–∞–π—Ç –∑–∞–∫—Ä—ã—Ç
        </div>
        <div style="display:flex; gap:8px;">
            <button onclick="notificationManager.requestPermission(true)" class="btn btn-primary" style="flex:1;">–í–∫–ª—é—á–∏—Ç—å</button>
            <button onclick="notificationManager.hidePopup()" class="btn btn-ghost">–ü–æ–∑–∂–µ</button>
        </div>
    </div>

    <!-- profile modal -->
    <div id="profile-overlay" class="profile-overlay" onclick="uiAction.closeProfile()"></div>
    <div id="profile-modal" class="profile-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-weight:800;">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <button onclick="uiAction.closeProfile()" style="background:transparent; font-size:18px; padding:6px;">‚úï</button>
        </div>

        <div class="profile-top" style="display:flex; gap:12px; align-items:center;">
            <div style="position:relative;">
                <img id="p-avatar" src="https://via.placeholder.com/150" alt="avatar" style="width:96px; height:96px; border-radius:12px; object-fit:cover;">
                <div class="online-dot" id="p-online-status"></div>
            </div>
            <div style="flex:1;">
                <div id="p-displayname" style="font-weight:800; font-size:18px;">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                <div id="p-username" class="muted-xs">@username</div>
                <div style="margin-top:8px;">
                    <small class="muted-xs">–û —Å–µ–±–µ:</small>
                    <div id="p-about" class="muted-xs" style="margin-top:6px;">–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.</div>
                </div>
            </div>
        </div>

        <div id="profile-edit-area" style="display:none; margin-top:12px;">
            <label style="font-size:13px; color:var(--text-sec); display:block;">–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä</label>
            <input id="p-avatar-input" class="input-field" placeholder="https://...">
            <label style="font-size:13px; color:var(--text-sec); display:block; margin-top:8px;">–û —Å–µ–±–µ</label>
            <textarea id="p-about-input" class="input-field" rows="4"></textarea>
        </div>

        <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
            <button id="btn-write" class="btn btn-primary" style="display:none;" onclick="uiAction.createOrOpenDM(uiAction._profileShownUid)">‚úâ –ù–∞–ø–∏—Å–∞—Ç—å</button>
            <button id="btn-edit-profile" class="btn btn-primary" onclick="uiAction.startEditProfile()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="btn-save-profile" class="btn btn-primary" style="display:none;" onclick="uiAction.saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="btn-upgrade" class="btn btn-ghost" style="display:none;" onclick="uiAction.upgradeToGoogle()">üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å Google</button>
        </div>
    </div>

    <!-- settings modal -->
    <div id="settings-modal" class="settings-modal" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-weight:800;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</div>
            <button onclick="uiAction.closeSettings()" style="background:transparent; font-size:18px; padding:6px;">‚úï</button>
        </div>

        <div style="display:flex; gap:12px;">
            <div style="flex:1;">
                <div style="font-weight:700; margin-bottom:6px;">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</div>
                <label class="muted-xs">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç</label>
                <input id="ui-color-primary" type="color" style="width:100%; height:40px; border:none; margin:8px 0;">
                <label class="muted-xs">–¶–≤–µ—Ç –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</label>
                <input id="ui-color-me" type="color" style="width:100%; height:40px; border:none; margin:8px 0;">
                <label class="muted-xs">–§–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</label>
                <input id="ui-bg-color" type="color" style="width:100%; height:40px; border:none; margin:8px 0;">
                <label class="muted-xs">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px)</label>
                <input id="ui-font-range" type="range" min="12" max="22" value="16" style="width:100%; margin:8px 0;">
                <label class="muted-xs">–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ (px)</label>
                <input id="ui-radius-range" type="range" min="0" max="30" value="12" style="width:100%; margin:8px 0;">
                
                <div style="font-weight:700; margin:20px 0 6px;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                <label style="display:flex; align-items:center; gap:8px; margin:8px 0;">
                    <input type="checkbox" id="notif-enabled">
                    <span>–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; margin:8px 0;">
                    <input type="checkbox" id="notif-sound">
                    <span>–ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                </label>
                
                <div style="display:flex; gap:8px; margin-top:12px;">
                    <button class="btn btn-primary" onclick="themeCore.save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn btn-ghost" onclick="themeCore.reset()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>

            <div style="width:260px;">
                <div style="font-weight:700; margin-bottom:6px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <button class="btn btn-ghost" onclick="uiAction.openCreateGroup()">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                    <button class="btn btn-ghost" onclick="notificationManager.requestPermission()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</button>
                    <button class="btn btn-ghost" onclick="uiAction.showRules()">–ü—Ä–∞–≤–∏–ª–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</button>
                </div>
            </div>
        </div>
    </div>

    <!-- group modal -->
    <div id="group-overlay" class="profile-overlay" onclick="uiAction.closeCreateGroup()"></div>
    <div id="group-modal" class="group-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:800;">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</div>
            <button onclick="uiAction.closeCreateGroup()" style="background:transparent; font-size:18px; padding:6px;">‚úï</button>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:8px;">
            <input id="group-name" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
        </div>

        <div style="margin-bottom:8px;">
            <label class="muted-xs">–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input id="group-image-url" class="input-field" placeholder="https://...">
            <small class="muted-xs">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∏—â–∏—Ç–µ –ø–æ —Ç–µ–≥—É –∏–ª–∏ –∏–º–µ–Ω–∏)</small>
            <input id="group-add-search" class="input-field" placeholder="–ò—Å–∫–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
            <div id="group-search-results" style="max-height:160px; overflow-y:auto; margin-top:8px;"></div>
            <div id="group-selected" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;"></div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:8px;">
            <button class="btn btn-ghost" onclick="uiAction.closeCreateGroup()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="uiAction.createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signInWithRedirect,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            sendPasswordResetEmail,
            onAuthStateChanged,
            signOut,
            linkWithPopup,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        import {
            getDatabase,
            ref,
            set,
            push,
            onValue,
            get,
            child,
            update,
            remove,
            onDisconnect,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // –î–æ–±–∞–≤–∏–º scope –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è email
        provider.addScope('email');
        provider.addScope('profile');

        window.state = {
            user: null,
            profile: null,
            isAdmin: false,
            activeAction: null,
            targetMessage: null,
            contextTarget: null,
            currentChat: { type: 'global', id: 'global', title: 'Global Chat Room' },
            onlineUsers: {},
            typingUsers: {}
        };

        const usersCache = {};
        const conversationsIndex = {};
        let dmsListener = null;
        let groupsListener = null;
        let usersListener = null;
        let currentMessagesUnsub = null;
        let onlineStatusRef = null;
        let typingRef = null;

        /* ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==================== */
        function showAuthError(msg) { 
            const authErrorEl = document.getElementById('auth-error');
            authErrorEl.style.display = 'block'; 
            authErrorEl.innerText = msg; 
        }
        
        function showAuthInfo(msg) { 
            const authInfoEl = document.getElementById('auth-info');
            authInfoEl.style.display = 'block'; 
            authInfoEl.innerText = msg; 
        }
        
        function clearAuthMessages() { 
            const authErrorEl = document.getElementById('auth-error');
            const authInfoEl = document.getElementById('auth-info');
            authErrorEl.style.display = 'none'; 
            authErrorEl.innerText = ''; 
            authInfoEl.style.display = 'none'; 
            authInfoEl.innerText = ''; 
        }

        /* ==================== GOOGLE –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ==================== */
        document.getElementById('google-btn').addEventListener('click', async function() {
            const btn = this;
            const loader = document.getElementById('google-loader');
            const btnText = document.getElementById('google-btn-text');
            const googleIcon = document.getElementById('google-icon');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            btn.disabled = true;
            if (loader) loader.style.display = 'block';
            if (btnText) btnText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            if (googleIcon) googleIcon.style.opacity = '0.5';
            
            clearAuthMessages();
            
            try {
                console.log('Starting Google sign-in...');
                const result = await signInWithPopup(auth, provider);
                console.log('Google sign-in successful:', result.user);
                
            } catch (err) {
                console.error('Google sign-in error:', err.code, err.message);
                
                let errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google';
                
                if (err.code === 'auth/popup-blocked') {
                    errorMessage = '–í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞.';
                } else if (err.code === 'auth/popup-closed-by-user') {
                    errorMessage = '–í—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω. –û–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±—ã–ª–æ –∑–∞–∫—Ä—ã—Ç–æ.';
                } else if (err.code === 'auth/cancelled-popup-request') {
                    errorMessage = '–í—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                } else if (err.code === 'auth/account-exists-with-different-credential') {
                    errorMessage = '–ê–∫–∫–∞—É–Ω—Ç —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ email/–ø–∞—Ä–æ–ª—å.';
                } else if (err.code === 'auth/network-request-failed') {
                    errorMessage = '–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
                } else {
                    errorMessage = '–û—à–∏–±–∫–∞: ' + (err.message || err.code || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
                
                showAuthError(errorMessage);
                
                // Fallback –Ω–∞ redirect –µ—Å–ª–∏ popup –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                if (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user') {
                    setTimeout(() => {
                        const useRedirect = confirm('–í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É Google?');
                        if (useRedirect) {
                            signInWithRedirect(auth, provider).catch(redirectErr => {
                                console.error('Redirect failed:', redirectErr);
                            });
                        }
                    }, 500);
                }
            } finally {
                // –í—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                setTimeout(() => {
                    btn.disabled = false;
                    if (loader) loader.style.display = 'none';
                    if (btnText) btnText.textContent = '–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google';
                    if (googleIcon) googleIcon.style.opacity = '1';
                }, 1000);
            }
        });

        /* ==================== –û–ë–†–ê–ë–û–¢–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ==================== */
        onAuthStateChanged(auth, async (firebaseUser) => {
            console.log('Auth state changed, user:', firebaseUser ? firebaseUser.uid : 'none');
            clearAuthMessages();
            
            if (!firebaseUser) {
                teardownAfterSignOut();
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app').classList.remove('visible');
                document.getElementById('app').style.display = 'none';
                return;
            }
            
            window.state.user = firebaseUser;
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –±–∞–∑–µ
                const userRef = ref(db, `users/${firebaseUser.uid}`);
                const userSnap = await get(userRef);
                
                if (userSnap.exists()) {
                    window.state.profile = userSnap.val();
                    console.log('Profile loaded from DB');
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
                    const displayName = firebaseUser.displayName || 
                                      (firebaseUser.email ? firebaseUser.email.split('@')[0] : 'User');
                    const username = (displayName.split(' ')[0] || displayName)
                                   .toLowerCase()
                                   .replace(/[^a-z0-9]/g, '');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å username
                    let uniqueUsername = username;
                    let counter = 1;
                    
                    const allUsersRef = ref(db, 'users');
                    const allUsersSnap = await get(allUsersRef);
                    const existingUsernames = new Set();
                    
                    if (allUsersSnap.exists()) {
                        Object.values(allUsersSnap.val()).forEach(user => {
                            if (user.username) existingUsernames.add(user.username);
                        });
                    }
                    
                    while (existingUsernames.has(uniqueUsername)) {
                        uniqueUsername = `${username}${counter}`;
                        counter++;
                    }
                    
                    const profile = {
                        uid: firebaseUser.uid,
                        displayName: displayName,
                        username: uniqueUsername,
                        usernameDisplay: uniqueUsername,
                        photoURL: firebaseUser.photoURL || 'https://via.placeholder.com/150',
                        about: '',
                        joinedAt: Date.now(),
                        email: firebaseUser.email || '',
                        provider: firebaseUser.providerData?.[0]?.providerId || 'email'
                    };
                    
                    await set(userRef, profile);
                    window.state.profile = profile;
                    console.log('New profile created');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
                if ((window.state.profile.usernameDisplay || '').toLowerCase() === 'admin') {
                    window.state.isAdmin = true;
                    console.log('Admin user detected');
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                
                setTimeout(() => {
                    document.getElementById('app').classList.add('visible');
                }, 50);

                // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø—Ä–æ—Ñ–∏–ª—è –≤ —Å–∞–π–¥–±–∞—Ä–µ
                const userProfileImg = document.getElementById('user-profile-img');
                const userDisplayName = document.getElementById('user-display-name');
                const userDisplayTag = document.getElementById('user-display-tag');
                
                if (userProfileImg) {
                    userProfileImg.src = window.state.profile.photoURL || 'https://via.placeholder.com/150';
                    userProfileImg.onclick = () => uiAction.openProfile(window.state.user.uid);
                }
                
                if (userDisplayName) {
                    userDisplayName.innerText = window.state.profile.displayName || '';
                }
                
                if (userDisplayTag) {
                    userDisplayTag.innerText = '@' + (window.state.profile.usernameDisplay || '');
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
                themeCore.load();
                notificationManager.init();
                unreadTracker.init();
                onlineManager.init();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏
                initUsersCacheListener();
                initConversationsListener();
                initSearch();
                initGroupSearch();
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                uiAction.openGlobal();

                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–µ–Ω—é
                const menuBtn = document.getElementById('chat-top-menu-btn');
                const topMenu = document.getElementById('chat-top-menu');
                
                if (menuBtn && topMenu) {
                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        topMenu.classList.toggle('active');
                    });
                }

            } catch (err) {
                console.error('Error during post-auth flow:', err);
                
                let errorMsg = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è';
                if (err.code === 'permission-denied') {
                    errorMsg = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase.';
                } else {
                    errorMsg = err.message || errorMsg;
                }
                
                showAuthError(errorMsg);
            }
        });

        /* ==================== EMAIL/–ü–ê–†–û–õ–¨ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ==================== */
        document.getElementById('to-register').addEventListener('click', () => {
            clearAuthMessages();
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('register-view').style.display = 'block';
        });
        
        document.getElementById('to-login').addEventListener('click', () => {
            clearAuthMessages();
            document.getElementById('register-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'block';
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            clearAuthMessages();
            const email = document.getElementById('login-email').value.trim();
            const pwd = document.getElementById('login-password').value;
            
            if (!email || !pwd) { 
                showAuthError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); 
                return; 
            }
            
            try {
                await signInWithEmailAndPassword(auth, email, pwd);
            } catch (err) {
                console.error(err);
                showAuthError(err.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
            }
        });

        document.getElementById('register-btn').addEventListener('click', async () => {
            clearAuthMessages();
            const displayName = document.getElementById('reg-displayname').value.trim();
            const username = document.getElementById('reg-username').value.trim().replace('@','');
            const email = document.getElementById('reg-email').value.trim();
            const pwd = document.getElementById('reg-password').value;
            const avatar = document.getElementById('reg-avatar-url').value.trim();
            
            if (!displayName || !username || !email || !pwd) { 
                showAuthError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è'); 
                return; 
            }
            
            if (pwd.length < 6) { 
                showAuthError('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'); 
                return; 
            }
            
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pwd);
                const profile = {
                    uid: cred.user.uid,
                    displayName,
                    username: username.toLowerCase(),
                    usernameDisplay: username,
                    photoURL: avatar || cred.user.photoURL || 'https://via.placeholder.com/150',
                    about: '',
                    joinedAt: Date.now(),
                    email: email,
                    provider: 'email'
                };
                
                await set(ref(db, `users/${cred.user.uid}`), profile);
                showAuthInfo('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥...');
                
            } catch (err) {
                console.error(err);
                showAuthError(err.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
            }
        });

        document.getElementById('forgot-password').addEventListener('click', async () => {
            clearAuthMessages();
            const email = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:');
            if (!email) return;
            
            try {
                await sendPasswordResetEmail(auth, email);
                showAuthInfo('–ü–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É).');
            } catch (err) {
                console.error(err);
                showAuthError(err.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞');
            }
        });

        document.getElementById('signout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (err) {
                console.error('Sign out failed', err);
                alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + (err.message || err));
            }
        });

        /* ==================== CLEANUP AFTER SIGNOUT ==================== */
        function teardownAfterSignOut() {
            document.getElementById('user-profile-img').onclick = null;
            if (usersListener) usersListener();
            if (dmsListener) dmsListener();
            if (groupsListener) groupsListener();
            
            const convList = document.getElementById('conversations-list');
            convList.querySelectorAll('.chat-row').forEach(el => {
                if (el.id !== 'row-global') el.remove();
            });
            
            Object.keys(conversationsIndex).forEach(k => delete conversationsIndex[k]);
        }

        /* ==================== NOTIFICATION MANAGER ==================== */
        window.notificationManager = {
            isSupported: 'Notification' in window && 'serviceWorker' in navigator,
            permission: null,
            enabled: localStorage.getItem('narrators_notifEnabled') === 'true',
            soundEnabled: localStorage.getItem('narrators_soundEnabled') !== 'false',
            
            init: function() {
                if (!this.isSupported) return;
                
                this.permission = Notification.permission;
                
                if (this.permission === 'default' && this.enabled) {
                    setTimeout(() => {
                        this.showPopup();
                    }, 3000);
                }
                
                this.setupListeners();
            },
            
            showPopup: function() {
                const popup = document.getElementById('notification-popup');
                if (popup) popup.classList.add('active');
            },
            
            hidePopup: function() {
                const popup = document.getElementById('notification-popup');
                if (popup) popup.classList.remove('active');
                localStorage.setItem('narrators_notifAsked', 'true');
            },
            
            requestPermission: async function(fromPopup = false) {
                if (!this.isSupported) {
                    alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                    return;
                }
                
                if (fromPopup) this.hidePopup();
                
                const permission = await Notification.requestPermission();
                this.permission = permission;
                
                if (permission === 'granted') {
                    this.enabled = true;
                    localStorage.setItem('narrators_notifEnabled', 'true');
                    this.showTestNotification();
                    alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!');
                } else {
                    this.enabled = false;
                    localStorage.setItem('narrators_notifEnabled', 'false');
                }
            },
            
            showTestNotification: function() {
                if (this.permission !== 'granted' || !this.enabled) return;
                
                const notification = new Notification('Narrators Messenger', {
                    body: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã!',
                    icon: 'https://cdn-icons-png.flaticon.com/512/1041/1041916.png',
                    tag: 'test-notification'
                });
                
                setTimeout(() => notification.close(), 5000);
            },
            
            showMessageNotification: function(message, senderName, chatTitle) {
                if (this.permission !== 'granted' || !this.enabled) return;
                if (document.hasFocus()) return;
                
                const text = message.text || '';
                const truncatedText = text.length > 100 ? text.substring(0, 100) + '...' : text;
                
                const notification = new Notification(`üí¨ ${senderName}`, {
                    body: `${chatTitle}: ${truncatedText}`,
                    icon: message.photoURL || 'https://via.placeholder.com/150',
                    tag: `msg-${message.uid}-${Date.now()}`,
                    silent: !this.soundEnabled
                });
                
                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
                
                setTimeout(() => notification.close(), 10000);
            },
            
            setupListeners: function() {
                const notifEnabled = document.getElementById('notif-enabled');
                const notifSound = document.getElementById('notif-sound');
                
                if (notifEnabled) {
                    notifEnabled.checked = this.enabled;
                    notifEnabled.addEventListener('change', (e) => {
                        this.enabled = e.target.checked;
                        localStorage.setItem('narrators_notifEnabled', e.target.checked);
                        if (e.target.checked && this.permission === 'default') {
                            this.requestPermission();
                        }
                    });
                }
                
                if (notifSound) {
                    notifSound.checked = this.soundEnabled;
                    notifSound.addEventListener('change', (e) => {
                        this.soundEnabled = e.target.checked;
                        localStorage.setItem('narrators_soundEnabled', e.target.checked);
                    });
                }
                
                const menuBtn = document.getElementById('menu-notifications');
                if (menuBtn) {
                    menuBtn.onclick = () => {
                        document.getElementById('chat-top-menu').classList.remove('active');
                        this.requestPermission();
                    };
                }
            },
            
            playSound: function() {
                if (!this.soundEnabled) return;
                
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
                    audio.volume = 0.3;
                    audio.play().catch(() => {});
                } catch(e) {}
            }
        };

        /* ==================== UNREAD MESSAGES TRACKER ==================== */
        window.unreadTracker = {
            counts: {},
            lastSeen: {},
            
            init: function() {
                const saved = localStorage.getItem('narrators_lastSeen');
                if (saved) this.lastSeen = JSON.parse(saved);
            },
            
            setupChatListener: function(chatType, chatId, path) {
                const messagesRef = ref(db, path);
                onValue(messagesRef, (snapshot) => {
                    if (!window.state.user || !snapshot.exists()) return;
                    
                    const messages = snapshot.val();
                    const lastMsg = Object.values(messages).pop();
                    if (!lastMsg) return;
                    
                    const lastMsgTime = lastMsg.createdAt || 0;
                    const chatKey = chatType + ':' + chatId;
                    const lastSeen = this.lastSeen[chatKey] || 0;
                    
                    if (lastMsgTime > lastSeen && 
                        lastMsg.uid !== window.state.user.uid && 
                        window.state.currentChat.id !== chatId) {
                        
                        this.counts[chatKey] = (this.counts[chatKey] || 0) + 1;
                        this.updateBadge(chatKey);
                        
                        if (notificationManager.enabled && notificationManager.permission === 'granted') {
                            notificationManager.showMessageNotification(
                                lastMsg, 
                                lastMsg.displayName || '–ö—Ç–æ-—Ç–æ',
                                window.state.currentChat.title || '–ß–∞—Ç'
                            );
                            notificationManager.playSound();
                        }
                    }
                });
            },
            
            markAsRead: function(chatType, chatId) {
                const chatKey = chatType + ':' + chatId;
                this.lastSeen[chatKey] = Date.now();
                this.counts[chatKey] = 0;
                this.updateBadge(chatKey);
                this.saveToStorage();
            },
            
            updateBadge: function(chatKey) {
                const count = this.counts[chatKey] || 0;
                const chatRow = document.querySelector(`[data-conv-key="${chatKey}"]`);
                
                if (chatRow) {
                    let badge = chatRow.querySelector('.unread-badge');
                    if (!badge && count > 0) {
                        badge = document.createElement('span');
                        badge.className = 'unread-badge';
                        chatRow.appendChild(badge);
                    }
                    
                    if (badge) {
                        if (count > 0) {
                            badge.textContent = count > 99 ? '99+' : count;
                            badge.style.display = 'flex';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            },
            
            saveToStorage: function() {
                localStorage.setItem('narrators_lastSeen', JSON.stringify(this.lastSeen));
            }
        };

        /* ==================== ONLINE STATUS MANAGER ==================== */
        window.onlineManager = {
            init: function() {
                if (!window.state.user) return;
                
                const userStatusRef = ref(db, `status/${window.state.user.uid}`);
                const isOfflineForDatabase = {
                    state: 'offline',
                    lastChanged: serverTimestamp(),
                };
                const isOnlineForDatabase = {
                    state: 'online',
                    lastChanged: serverTimestamp(),
                };
                
                onDisconnect(userStatusRef).set(isOfflineForDatabase);
                set(userStatusRef, isOnlineForDatabase);
                
                const statusRef = ref(db, 'status');
                onValue(statusRef, (snapshot) => {
                    const statuses = snapshot.val() || {};
                    window.state.onlineUsers = {};
                    
                    Object.entries(statuses).forEach(([uid, data]) => {
                        window.state.onlineUsers[uid] = data.state === 'online';
                    });
                    
                    this.updateUI();
                });
            },
            
            updateUI: function() {
                const userStatusEl = document.getElementById('user-online-status');
                if (userStatusEl) {
                    userStatusEl.classList.toggle('active', true);
                }
                
                const chat = window.state.currentChat;
                const chatStatusEl = document.getElementById('chat-top-online');
                const onlineStatusEl = document.getElementById('chat-online-status');
                
                if (chat.type === 'dm' && chat.otherUid) {
                    const isOnline = window.state.onlineUsers[chat.otherUid];
                    if (chatStatusEl) chatStatusEl.classList.toggle('active', isOnline);
                    if (onlineStatusEl) {
                        onlineStatusEl.textContent = isOnline ? 'online' : '–±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ';
                        onlineStatusEl.style.color = isOnline ? 'var(--online)' : 'var(--text-sec)';
                    }
                }
                
                document.querySelectorAll('.chat-row').forEach(row => {
                    const convKey = row.dataset.convKey;
                    if (!convKey) return;
                    
                    const [type, id] = convKey.split(':');
                    const avatar = row.querySelector('.user-avatar');
                    if (avatar) {
                        let dot = avatar.querySelector('.online-dot');
                        if (!dot) {
                            dot = document.createElement('div');
                            dot.className = 'online-dot';
                            avatar.appendChild(dot);
                        }
                        
                        let isOnline = false;
                        if (type === 'dm') {
                            const otherUid = Object.keys(conversationsIndex[convKey]?.members || {}).find(u => u !== window.state.user?.uid);
                            isOnline = otherUid ? window.state.onlineUsers[otherUid] : false;
                        }
                        
                        dot.classList.toggle('active', isOnline);
                    }
                });
            },
            
            setTyping: function(chatType, chatId, isTyping) {
                if (!window.state.user) return;
                
                const typingRef = ref(db, `typing/${chatType}/${chatId}/${window.state.user.uid}`);
                if (isTyping) {
                    set(typingRef, {
                        uid: window.state.user.uid,
                        displayName: window.state.profile.displayName,
                        timestamp: Date.now()
                    });
                    
                    setTimeout(() => {
                        remove(typingRef);
                    }, 5000);
                } else {
                    remove(typingRef);
                }
            },
            
            setupTypingListener: function(chatType, chatId) {
                if (typingRef) typingRef();
                
                const typingPath = chatType === 'global' ? `typing/global/global` : `typing/${chatType}/${chatId}`;
                typingRef = ref(db, typingPath);
                
                onValue(typingRef, (snapshot) => {
                    const typingData = snapshot.val() || {};
                    window.state.typingUsers = {};
                    
                    Object.entries(typingData).forEach(([uid, data]) => {
                        if (uid !== window.state.user?.uid && data && Date.now() - data.timestamp < 10000) {
                            window.state.typingUsers[uid] = data;
                        }
                    });
                    
                    this.updateTypingUI();
                });
            },
            
            updateTypingUI: function() {
                const typingEl = document.getElementById('chat-typing');
                const typingUsers = Object.values(window.state.typingUsers);
                
                if (typingUsers.length > 0 && typingEl) {
                    const names = typingUsers.map(u => u.displayName).join(', ');
                    typingEl.textContent = `${names} –ø–µ—á–∞—Ç–∞–µ—Ç${typingUsers.length > 1 ? '—é—Ç' : ''}...`;
                    typingEl.style.display = 'block';
                } else if (typingEl) {
                    typingEl.style.display = 'none';
                }
            }
        };

        /* ==================== –ö–≠–® –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ==================== */
        function initUsersCacheListener() {
            const usersRef = ref(db, 'users');
            usersListener = onValue(usersRef, (snapshot) => {
                const val = snapshot.val() || {};
                Object.keys(val).forEach(k => usersCache[k] = val[k]);
                if (window.state.user && val[window.state.user.uid]) {
                    window.state.profile = val[window.state.user.uid];
                    document.getElementById('user-profile-img').src = window.state.profile.photoURL || 'https://via.placeholder.com/150';
                    document.getElementById('user-display-name').innerText = window.state.profile.displayName || '';
                    document.getElementById('user-display-tag').innerText = '@' + (window.state.profile.usernameDisplay || '');
                }
            });
        }

        /* ==================== –°–ü–ò–°–û–ö –ß–ê–¢–û–í ==================== */
        function initConversationsListener() {
            const dmsRef = ref(db, 'dms');
            dmsListener = onValue(dmsRef, (snapshot) => {
                const all = snapshot.val() || {};
                Object.entries(all).forEach(([dmId, dm]) => {
                    const members = (dm.meta && dm.meta.members) || dm.members || {};
                    if (window.state.user && members[window.state.user.uid]) {
                        const otherUid = Object.keys(members).find(u => u !== window.state.user.uid);
                        const title = otherUid ? (usersCache[otherUid] ? usersCache[otherUid].displayName : '–õ–∏—á–Ω—ã–π —á–∞—Ç') : '–ß–∞—Ç';
                        const avatar = otherUid ? (usersCache[otherUid] ? usersCache[otherUid].photoURL : '') : '';
                        addConversationToList({ 
                            type: 'dm', 
                            id: dmId, 
                            title, 
                            avatar, 
                            otherUid,
                            members
                        });
                        unreadTracker.setupChatListener('dm', dmId, `dms/${dmId}/messages`);
                    } else {
                        const key = 'dm:' + dmId;
                        if (conversationsIndex[key]) removeConversationFromList(key);
                    }
                });
            });

            const groupsRef = ref(db, 'groups');
            groupsListener = onValue(groupsRef, (snapshot) => {
                const all = snapshot.val() || {};
                Object.entries(all).forEach(([groupId, group]) => {
                    const members = group.members || {};
                    if (window.state.user && members[window.state.user.uid]) {
                        addConversationToList({ 
                            type: 'group', 
                            id: groupId, 
                            title: group.name || '–ì—Ä—É–ø–ø–∞', 
                            avatar: group.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png',
                            members
                        });
                        unreadTracker.setupChatListener('group', groupId, `groups/${groupId}/messages`);
                    } else {
                        const key = 'group:' + groupId;
                        if (conversationsIndex[key]) removeConversationFromList(key);
                    }
                });
            });
            
            unreadTracker.setupChatListener('global', 'global', 'messages');
        }

        function addConversationToList({ type, id, title, avatar, otherUid, members }) {
            const key = type + ':' + id;
            if (conversationsIndex[key]) {
                const existing = conversationsIndex[key];
                existing.dom.querySelector('.conv-title').innerText = title;
                if (avatar) existing.dom.querySelector('img').src = avatar;
                return;
            }
            
            const convList = document.getElementById('conversations-list');
            const row = document.createElement('div');
            row.className = 'chat-row';
            row.dataset.convKey = key;
            
            const onlineStatus = otherUid ? window.state.onlineUsers[otherUid] : false;
            
            row.innerHTML = `
                <div style="position:relative;">
                    <img src="${avatar||'https://via.placeholder.com/150'}" class="user-avatar" style="width:46px; height:46px; border-radius:8px;">
                    <div class="online-dot" style="${onlineStatus ? 'background:var(--online)' : ''}"></div>
                </div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="conv-title" style="font-weight:700;">${title}</div>
                        <div class="muted-xs" style="color:#aaa;">${type === 'group' ? '–≥—Ä—É–ø–ø–∞' : '–ª–∏—á–Ω—ã–π'}</div>
                    </div>
                    <div class="muted-xs" style="color:var(--text-sec);">${type === 'group' ? `${Object.keys(members||{}).length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤` : '@' + (usersCache[otherUid]?.usernameDisplay || '')}</div>
                </div>
            `;
            
            row.onclick = () => {
                document.querySelectorAll('.chat-row').forEach(r => r.classList.remove('active'));
                row.classList.add('active');
                
                if (type === 'dm') uiAction.openDMById(id, otherUid);
                else if (type === 'group') uiAction.openGroupChat(id);
            };
            
            if (conversationsIndex['global:global']?.dom?.nextSibling) {
                convList.insertBefore(row, conversationsIndex['global:global'].dom.nextSibling);
            } else {
                convList.appendChild(row);
            }
            
            conversationsIndex[key] = { type, id, dom: row, members, otherUid };
            unreadTracker.updateBadge(key);
        }

        function removeConversationFromList(key) {
            const it = conversationsIndex[key];
            if (!it) return;
            if (it.dom && it.dom.parentNode) it.dom.parentNode.removeChild(it.dom);
            delete conversationsIndex[key];
        }

        /* ==================== –ü–û–ò–°–ö ==================== */
        function initSearch() {
            const searchInput = document.getElementById('user-search-input');
            const resultsBox = document.createElement('div');
            resultsBox.style.position = 'relative';
            searchInput.parentNode.appendChild(resultsBox);
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim().toLowerCase().replace('@','');
                resultsBox.innerHTML = '';
                if (query.length < 2) return;
                
                const users = Object.values(usersCache || {});
                const found = users.filter(u => 
                    (u.username || '').includes(query) || 
                    (u.displayName || '').toLowerCase().includes(query)
                );
                
                if (found.length === 0) return;
                
                const box = document.createElement('div');
                box.style.position = 'absolute';
                box.style.left = '0';
                box.style.right = '0';
                box.style.background = '#fff';
                box.style.border = '1px solid var(--border)';
                box.style.borderRadius = '10px';
                box.style.marginTop = '6px';
                box.style.maxHeight = '220px';
                box.style.overflowY = 'auto';
                box.style.zIndex = '1000';
                
                found.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'chat-row';
                    div.style.padding = '8px 12px';
                    div.innerHTML = `
                        <div style="position:relative;">
                            <img src="${u.photoURL||'https://via.placeholder.com/150'}" class="user-avatar" style="width:36px;height:36px;">
                            <div class="online-dot" style="${window.state.onlineUsers[u.uid] ? 'background:var(--online)' : ''}"></div>
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:700;">${u.displayName}</div>
                            <div class="muted-xs" style="color:var(--primary);">@${u.usernameDisplay||u.username}</div>
                            <div class="muted-xs" style="font-size:11px;">${window.state.onlineUsers[u.uid] ? 'online' : 'offline'}</div>
                        </div>
                    `;
                    div.onclick = () => {
                        uiAction.openProfile(u.uid);
                        resultsBox.innerHTML = '';
                        searchInput.value = '';
                    };
                    box.appendChild(div);
                });
                
                resultsBox.appendChild(box);
            });
            
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
                    resultsBox.innerHTML = '';
                }
            });
        }

        /* ==================== –ü–û–ò–°–ö –î–õ–Ø –ì–†–£–ü–ü ==================== */
        function initGroupSearch() {
            const input = document.getElementById('group-add-search');
            const results = document.getElementById('group-search-results');
            if (!input) return;
            
            input.addEventListener('input', async (e) => {
                const q = e.target.value.trim().toLowerCase().replace('@','');
                results.innerHTML = '';
                if (q.length < 2) return;
                
                const users = Object.values(usersCache || {});
                const found = users.filter(u => 
                    u.uid !== window.state.user?.uid &&
                    ((u.username || '').includes(q) || (u.displayName || '').toLowerCase().includes(q))
                );
                
                found.forEach(u => {
                    const row = document.createElement('div');
                    row.className = 'user-select-row';
                    row.style.display = 'flex';
                    row.style.gap = '8px';
                    row.style.alignItems = 'center';
                    row.style.padding = '8px';
                    row.style.borderRadius = '8px';
                    row.style.border = '1px solid var(--border)';
                    row.style.marginBottom = '8px';
                    row.innerHTML = `
                        <div style="position:relative;">
                            <img src="${u.photoURL || 'https://via.placeholder.com/150'}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                            <div class="online-dot" style="${window.state.onlineUsers[u.uid] ? 'background:var(--online)' : ''}"></div>
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:700;">${u.displayName}</div>
                            <div style="font-size:12px; color:var(--text-sec);">@${u.usernameDisplay||u.username}</div>
                        </div>
                        <button class="btn btn-primary" style="width:auto; padding:8px 10px;" onclick="uiAction.selectGroupMember('${escapeHtml(u.uid)}', '${escapeHtml(u.displayName)}', '${escapeHtml(u.photoURL||'')}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                    `;
                    results.appendChild(row);
                });
            });
        }

        function escapeHtml(s) { 
            if (!s) return '';
            return s.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        /* ==================== CHAT ENGINE ==================== */
        window.chatEngine = {
            sendMessage: async function() {
                const input = document.getElementById('main-input');
                const text = input.value.trim();
                if (!text) return;
                
                const chat = window.state.currentChat;
                onlineManager.setTyping(chat.type, chat.id, false);
                
                let path;
                if (chat.type === 'global') path = 'messages';
                else if (chat.type === 'dm') path = `dms/${chat.id}/messages`;
                else if (chat.type === 'group') path = `groups/${chat.id}/messages`;
                
                const messageData = {
                    uid: window.state.user.uid,
                    displayName: window.state.profile.displayName,
                    username: window.state.profile.usernameDisplay,
                    photoURL: window.state.profile.photoURL,
                    text,
                    createdAt: Date.now()
                };
                
                if (window.state.activeAction === 'reply' && window.state.targetMessage) {
                    messageData.replyTo = { 
                        author: window.state.targetMessage.displayName, 
                        content: window.state.targetMessage.text,
                        uid: window.state.targetMessage.uid
                    };
                }
                
                await push(ref(db, path), messageData);
                this.cancelAction();
            },

            openChatListener: function(path, chatType, chatId) {
                const messagesContainer = document.getElementById('messages-view');
                messagesContainer.innerHTML = '<div class="muted-xs" style="padding:12px; opacity:0.6;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
                
                unreadTracker.markAsRead(chatType, chatId);
                onlineManager.setupTypingListener(chatType, chatId);
                
                const messagesRef = ref(db, path);
                currentMessagesUnsub = onValue(messagesRef, (snapshot) => {
                    messagesContainer.innerHTML = '';
                    const data = snapshot.val();
                    if (!data) { 
                        messagesContainer.innerHTML = '<div class="muted-xs" style="padding:12px; opacity:0.6;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>'; 
                        return; 
                    }
                    
                    Object.entries(data)
                        .sort((a,b)=>a[1].createdAt - b[1].createdAt)
                        .forEach(([msgId, msg]) => {
                        const isMyMessage = msg.uid === window.state.user.uid;
                        const wrapper = document.createElement('div');
                        wrapper.className = `msg-wrapper ${isMyMessage ? 'my-msg' : 'other-msg'}`;

                        const senderProfile = usersCache[msg.uid] || {};
                        const avatarURL = msg.photoURL || senderProfile.photoURL || 'https://via.placeholder.com/150';
                        const displayName = msg.displayName || senderProfile.displayName || 'User';
                        const usernameDisplay = (senderProfile.usernameDisplay || senderProfile.username || msg.username || '').toString();

                        let processedText = (msg.text || '').replace(/</g, "&lt;").replace(/>/g,"&gt;");
                        if (processedText.match(/\.(jpg|jpeg|png|gif|webp|bmp)(\?|$)/i)) {
                            const url = processedText;
                            processedText = `<div style="margin-top:5px;"><img src="${url}" style="max-width:100%; max-height:300px; border-radius:8px; cursor:pointer;" onclick="window.open(this.src)"></div>`;
                        } else {
                            processedText = processedText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                        }

                        const replyMarkup = msg.replyTo ? 
                            `<div style="font-size:12px; border-left:3px solid var(--primary); padding-left:10px; margin-bottom:8px; opacity:0.8; cursor:pointer;" onclick="chatEngine.scrollToMessage('${msg.replyTo.uid}')">
                                <b>${msg.replyTo.author}</b><br>
                                ${(msg.replyTo.content||'').substring(0,80)}${(msg.replyTo.content && msg.replyTo.content.length>80)?'...':''}
                            </div>` : '';

                        const avatarHTML = `
                            <div style="position:relative;">
                                <img src="${avatarURL}" class="msg-avatar" onclick="uiAction.openProfile('${msg.uid}')" title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                                <div class="online-dot" style="${window.state.onlineUsers[msg.uid] ? 'background:var(--online)' : ''}"></div>
                            </div>
                        `;
                        
                        const bubbleHTML = `<div class="msg-bubble" id="msg-${msgId}">
                            <span class="author-tag">${displayName} ${usernameDisplay.toLowerCase()==='admin' ? 'üëë' : ''}</span>
                            ${replyMarkup}
                            <div class="msg-content-body">${processedText}</div>
                            <span class="time-stamp">${msg.isEdited ? '–∏–∑–º. ' : ''} ${new Date(msg.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>`;
                        
                        if (isMyMessage) wrapper.innerHTML = bubbleHTML + avatarHTML;
                        else wrapper.innerHTML = avatarHTML + bubbleHTML;

                        wrapper.style.justifyContent = isMyMessage ? 'flex-end' : 'flex-start';
                        wrapper.oncontextmenu = (e) => { 
                            e.preventDefault(); 
                            window.chatEngine.openContextMenu(e, msgId, { key: msgId, ...msg }); 
                        };
                        messagesContainer.appendChild(wrapper);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            },

            openContextMenu: function(e, key, data) {
                window.state.contextTarget = { key, ...data };
                const popupId = 'context-popup';
                let popup = document.getElementById(popupId);
                
                if (!popup) {
                    popup = document.createElement('div');
                    popup.id = popupId;
                    popup.style.position = 'fixed';
                    popup.style.zIndex = 10000;
                    popup.style.background = '#fff';
                    popup.style.border = '1px solid var(--border)';
                    popup.style.padding = '8px';
                    popup.style.borderRadius = '10px';
                    popup.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
                    popup.innerHTML = `
                        <div style="padding:8px; cursor:pointer; border-radius:6px;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'" onclick="chatEngine.handleAction('reply')">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
                        <div style="padding:8px; cursor:pointer; border-radius:6px;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'" onclick="chatEngine.handleAction('copy')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
                        <div id="popup-edit-btn" style="padding:8px; cursor:pointer; border-radius:6px;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'" onclick="chatEngine.handleAction('edit')">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                        <div id="popup-delete-btn" style="padding:8px; cursor:pointer; color:#ff3b30; border-radius:6px;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'" onclick="chatEngine.handleAction('delete')">üóë –£–¥–∞–ª–∏—Ç—å</div>
                    `;
                    document.body.appendChild(popup);
                }
                
                const popupEl = document.getElementById(popupId);
                popupEl.style.display = 'block';
                let x = e.clientX, y = e.clientY;
                if (x + 220 > window.innerWidth) x -= 220;
                if (y + 150 > window.innerHeight) y -= 150;
                popupEl.style.left = x + 'px'; 
                popupEl.style.top = y + 'px';
                
                const isMine = data.uid === window.state.user.uid;
                const editBtn = document.getElementById('popup-edit-btn');
                const delBtn = document.getElementById('popup-delete-btn');
                if (editBtn) editBtn.style.display = isMine ? 'block' : 'none';
                if (delBtn) delBtn.style.display = (isMine || window.state.isAdmin) ? 'block' : 'none';
            },

            handleAction: function(type) {
                const popup = document.getElementById('context-popup');
                if (popup) popup.style.display = 'none';
                
                if (type === 'reply' || type === 'edit') {
                    window.state.activeAction = type;
                    window.state.targetMessage = window.state.contextTarget;
                    document.getElementById('reply-preview').style.display = 'block';
                    document.getElementById('reply-author-name').innerText = type === 'edit' ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" : window.state.targetMessage.displayName;
                    document.getElementById('reply-author-text').innerText = window.state.targetMessage.text;
                    if (type === 'edit') document.getElementById('main-input').value = window.state.targetMessage.text;
                    document.getElementById('main-input').focus();
                } else if (type === 'copy') {
                    navigator.clipboard.writeText(window.state.contextTarget.text || '')
                        .then(() => {
                            const btn = document.getElementById('send-msg-btn');
                            const original = btn.innerHTML;
                            btn.innerHTML = '‚úì';
                            setTimeout(() => btn.innerHTML = original, 1000);
                        });
                } else if (type === 'delete') {
                    if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;
                    const chat = window.state.currentChat;
                    let path;
                    if (chat.type === 'global') path = `messages/${window.state.contextTarget.key}`;
                    else if (chat.type === 'dm') path = `dms/${chat.id}/messages/${window.state.contextTarget.key}`;
                    else if (chat.type === 'group') path = `groups/${chat.id}/messages/${window.state.contextTarget.key}`;
                    remove(ref(db, path));
                }
            },

            cancelAction: function() {
                window.state.activeAction = null; 
                window.state.targetMessage = null;
                document.getElementById('reply-preview').style.display = 'none';
                document.getElementById('main-input').value = '';
            },

            scrollToMessage: function(msgUid) {
                const msgEl = document.querySelector(`[id^="msg-"]`);
                if (msgEl) msgEl.scrollIntoView({ behavior: 'smooth' });
            }
        };

        /* ==================== UI ACTIONS ==================== */
        window.uiAction = {
            openGlobal: () => {
                document.querySelectorAll('.chat-row').forEach(r => r.classList.remove('active'));
                document.getElementById('row-global').classList.add('active');
                
                window.state.currentChat = { type: 'global', id: 'global', title: 'Global Chat Room' };
                document.getElementById('chat-top-title').innerText = 'Global Chat Room';
                document.getElementById('chat-top-sub').innerText = '–û–±—â–∏–π —á–∞—Ç';
                document.getElementById('chat-top-avatar').src = 'https://cdn-icons-png.flaticon.com/512/1041/1041916.png';
                document.getElementById('chat-online-status').textContent = 'v0.1.7';
                
                chatEngine.openChatListener('messages', 'global', 'global');
                unreadTracker.markAsRead('global', 'global');
            },

            createOrOpenDM: async (otherUid) => {
                if (!otherUid) return;
                if (otherUid === window.state.user.uid) {
                    uiAction.openProfile(otherUid);
                    return;
                }
                
                const u1 = window.state.user.uid;
                const u2 = otherUid;
                const chatId = ['dm', ...[u1, u2].sort()].join('_');
                const metaRef = ref(db, `dms/${chatId}/meta`);
                const metaSnap = await get(metaRef);
                
                if (!metaSnap.exists()) {
                    const meta = { 
                        members: { [u1]: true, [u2]: true }, 
                        createdAt: Date.now(),
                        lastActivity: Date.now()
                    };
                    await set(metaRef, meta);
                }
                
                addConversationToList({ 
                    type: 'dm', 
                    id: chatId, 
                    title: usersCache[otherUid]?.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç', 
                    avatar: usersCache[otherUid]?.photoURL || 'https://via.placeholder.com/150', 
                    otherUid,
                    members: { [u1]: true, [u2]: true }
                });
                
                uiAction.openDMById(chatId, otherUid);
            },

            openDMById: async (chatId, otherUid) => {
                const other = usersCache[otherUid] || {};
                window.state.currentChat = { 
                    type: 'dm', 
                    id: chatId, 
                    title: other.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç', 
                    photo: other.photoURL || '', 
                    otherUid 
                };
                
                document.getElementById('chat-top-title').innerText = other.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç';
                document.getElementById('chat-top-sub').innerText = '@' + (other.usernameDisplay || other.username || '');
                document.getElementById('chat-top-avatar').src = other.photoURL || 'https://via.placeholder.com/150';
                
                chatEngine.openChatListener(`dms/${chatId}/messages`, 'dm', chatId);
                unreadTracker.markAsRead('dm', chatId);
                onlineManager.updateUI();
            },

            openDM: async (otherUid) => {
                await uiAction.createOrOpenDM(otherUid);
            },

            openProfile: (uid) => {
                if (!uid) return;
                const user = usersCache[uid] || (window.state.user && uid === window.state.user.uid ? window.state.profile : null);
                if (!user) { alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
                
                uiAction._profileShownUid = uid;
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                overlay.classList.add('active'); 
                modal.classList.add('active'); 
                modal.setAttribute('aria-hidden','false');

                document.getElementById('p-avatar').src = user.photoURL || 'https://via.placeholder.com/150';
                document.getElementById('p-displayname').innerText = user.displayName || 'User';
                document.getElementById('p-username').innerText = '@' + (user.usernameDisplay || user.username || '');
                document.getElementById('p-about').innerText = user.about || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.';
                
                const onlineStatus = document.getElementById('p-online-status');
                if (onlineStatus) {
                    onlineStatus.classList.toggle('active', window.state.onlineUsers[uid] || false);
                }

                if (window.state.user && uid === window.state.user.uid) {
                    document.getElementById('profile-edit-area').style.display = 'block';
                    document.getElementById('p-avatar-input').value = user.photoURL || '';
                    document.getElementById('p-about-input').value = user.about || '';
                    document.getElementById('btn-edit-profile').style.display = 'inline-flex';
                    document.getElementById('btn-save-profile').style.display = 'none';
                    document.getElementById('btn-upgrade').style.display = (auth.currentUser && auth.currentUser.isAnonymous) ? 'inline-flex' : 'none';
                    document.getElementById('btn-write').style.display = 'none';
                } else {
                    document.getElementById('profile-edit-area').style.display = 'none';
                    document.getElementById('btn-edit-profile').style.display = 'none';
                    document.getElementById('btn-save-profile').style.display = 'none';
                    document.getElementById('btn-upgrade').style.display = 'none';
                    document.getElementById('btn-write').style.display = 'inline-flex';
                }
            },

            closeProfile: () => {
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                overlay.classList.remove('active'); 
                modal.classList.remove('active'); 
                modal.setAttribute('aria-hidden','true');
            },

            startEditProfile: () => {
                document.getElementById('profile-edit-area').style.display = 'block';
                document.getElementById('btn-edit-profile').style.display = 'none';
                document.getElementById('btn-save-profile').style.display = 'inline-flex';
            },

            saveProfile: async () => {
                if (!window.state.user) return;
                const newAva = document.getElementById('p-avatar-input').value.trim();
                const newAbout = document.getElementById('p-about-input').value.trim();
                
                if (newAva && !/^https?:\/\//i.test(newAva)) {
                    alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http/https');
                    return;
                }
                
                const updates = {};
                if (newAva) updates.photoURL = newAva;
                updates.about = newAbout || '';
                
                try {
                    await update(ref(db, `users/${window.state.user.uid}`), updates);
                    
                    if (updates.photoURL) {
                        document.getElementById('p-avatar').src = updates.photoURL;
                        document.getElementById('user-profile-img').src = updates.photoURL;
                    }
                    
                    document.getElementById('p-about').innerText = updates.about;
                    window.state.profile = Object.assign(window.state.profile || {}, updates);
                    document.getElementById('profile-edit-area').style.display = 'none';
                    document.getElementById('btn-edit-profile').style.display = 'inline-flex';
                    document.getElementById('btn-save-profile').style.display = 'none';
                    
                    const notice = document.createElement('div');
                    notice.className = 'notice success';
                    notice.textContent = '–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω';
                    document.body.appendChild(notice);
                    setTimeout(() => notice.remove(), 3000);
                    
                } catch (err) {
                    console.error(err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
                }
            },

            upgradeToGoogle: async () => {
                if (!auth.currentUser) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                if (!auth.currentUser.isAnonymous) return alert('–£–∂–µ –Ω–µ –≥–æ—Å—Ç–µ–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç');
                
                try {
                    const result = await linkWithPopup(auth.currentUser, provider);
                    const pd = (result.user.providerData && result.user.providerData[0]) || {};
                    const updates = {};
                    if (pd.displayName) updates.displayName = pd.displayName;
                    if (pd.photoURL) updates.photoURL = pd.photoURL;
                    
                    await update(ref(db, `users/${result.user.uid}`), updates);
                    alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ Google');
                    uiAction.closeProfile();
                } catch (err) {
                    console.error(err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏: ' + (err.message || err));
                }
            },

            openSettings: () => {
                document.getElementById('settings-modal').classList.add('active');
                document.getElementById('settings-modal').setAttribute('aria-hidden','false');
                
                const root = document.documentElement.style;
                document.getElementById('ui-color-primary').value = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()) || '#3390ec';
                document.getElementById('ui-color-me').value = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--msg-me').trim()) || '#eeffde';
                document.getElementById('ui-bg-color').value = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--bg-body').trim()) || '#ffffff';
                document.getElementById('ui-font-range').value = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size')) || 16;
                document.getElementById('ui-radius-range').value = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--radius')) || 12;
            },

            closeSettings: () => {
                document.getElementById('settings-modal').classList.remove('active');
                document.getElementById('settings-modal').setAttribute('aria-hidden','true');
            },

            openCreateGroup: () => {
                document.getElementById('group-overlay').classList.add('active');
                document.getElementById('group-modal').classList.add('active');
                document.getElementById('group-name').value = '';
                document.getElementById('group-image-url').value = '';
                document.getElementById('group-add-search').value = '';
                document.getElementById('group-search-results').innerHTML = '';
                document.getElementById('group-selected').innerHTML = '';
                
                uiAction._groupSelected = { 
                    [window.state.user.uid]: { 
                        uid: window.state.user.uid, 
                        name: window.state.profile.displayName, 
                        photo: window.state.profile.photoURL 
                    } 
                };
                renderGroupSelected();
            },

            closeCreateGroup: () => {
                document.getElementById('group-overlay').classList.remove('active');
                document.getElementById('group-modal').classList.remove('active');
                uiAction._groupSelected = {};
            },

            selectGroupMember: (uid, name, photo) => {
                uiAction._groupSelected = uiAction._groupSelected || {};
                uiAction._groupSelected[uid] = { uid, name, photo };
                renderGroupSelected();
            },

            removeGroupMember: (uid) => {
                if (!uiAction._groupSelected) return;
                delete uiAction._groupSelected[uid];
                renderGroupSelected();
            },

            createGroup: async () => {
                const name = (document.getElementById('group-name').value || '').trim();
                if (!name || name.length < 2) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–º–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞)');
                    return;
                }
                
                const image = (document.getElementById('group-image-url').value || '').trim();
                const selected = uiAction._groupSelected || {};
                const members = Object.keys(selected);
                
                if (members.length < 2) {
                    alert('–î–æ–±–∞–≤—å—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∫—Ä–æ–º–µ –≤–∞—Å');
                    return;
                }
                
                try {
                    const gRef = push(ref(db, 'groups'));
                    const groupId = gRef.key;
                    const membersObj = {};
                    members.forEach(uid => membersObj[uid] = true);
                    
                    const meta = { 
                        id: groupId, 
                        name, 
                        owner: window.state.user.uid, 
                        members: membersObj, 
                        createdAt: Date.now(), 
                        image: image || '',
                        lastActivity: Date.now()
                    };
                    
                    await set(ref(db, `groups/${groupId}`), meta);
                    uiAction.closeCreateGroup();
                    
                    addConversationToList({ 
                        type: 'group', 
                        id: groupId, 
                        title: name, 
                        avatar: image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png',
                        members: membersObj
                    });
                    
                    uiAction.openGroupChat(groupId, meta);
                } catch (err) {
                    console.error(err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã');
                }
            },

            openGroupChat: async (groupId, meta) => {
                let groupMeta = meta;
                if (!groupMeta) {
                    const snap = await get(ref(db, `groups/${groupId}`));
                    if (!snap.exists()) return alert('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    groupMeta = snap.val();
                }
                
                window.state.currentChat = { 
                    type: 'group', 
                    id: groupId, 
                    title: groupMeta.name, 
                    ownerUid: groupMeta.owner || '', 
                    members: groupMeta.members || {} 
                };
                
                document.getElementById('chat-top-title').innerText = groupMeta.name;
                document.getElementById('chat-top-sub').innerText = `–ì—Ä—É–ø–ø–∞ ‚Ä¢ ${Object.keys(groupMeta.members||{}).length} —É—á–∞—Å—Ç–Ω–∏–∫(–æ–≤)`;
                document.getElementById('chat-top-avatar').src = groupMeta.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
                
                chatEngine.openChatListener(`groups/${groupId}/messages`, 'group', groupId);
                unreadTracker.markAsRead('group', groupId);
            },

            openGroupInfo: async (groupId) {
                const snap = await get(ref(db, `groups/${groupId}`));
                if (!snap.exists()) return alert('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                const group = snap.val();
                
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                overlay.classList.add('active'); 
                modal.classList.add('active'); 
                modal.setAttribute('aria-hidden','false');

                document.getElementById('p-avatar').src = group.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
                document.getElementById('p-displayname').innerText = group.name;
                document.getElementById('p-username').innerText = `${Object.keys(group.members||{}).length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                
                const memberList = Object.keys(group.members||{}).map(uid => {
                    const u = usersCache[uid] || {};
                    return `‚Ä¢ ${u.displayName || 'User'} @${u.usernameDisplay||u.username||''}`;
                }).join('\n');
                
                document.getElementById('p-about').innerText = memberList || '–ü—É—Å—Ç–æ';
                document.getElementById('profile-edit-area').style.display = 'none';
                document.getElementById('btn-edit-profile').style.display = 'none';
                document.getElementById('btn-save-profile').style.display = 'none';
                document.getElementById('btn-upgrade').style.display = 'none';
                document.getElementById('btn-write').style.display = 'none';
            },
            
            showRules: () => {
                alert(`üìú –ü—Ä–∞–≤–∏–ª–∞ Narrators Messenger:\n\n1. –£–≤–∞–∂–∞–π—Ç–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n2. –ù–µ —Å–ø–∞–º—å—Ç–µ\n3. –ù–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç\n4. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è\n\n–í–µ—Ä—Å–∏—è 0.1.7`);
            }
        };

        function renderGroupSelected() {
            const container = document.getElementById('group-selected');
            container.innerHTML = '';
            const selected = uiAction._groupSelected || {};
            
            Object.values(selected).forEach(s => {
                const el = document.createElement('div');
                el.className = 'chip';
                el.innerHTML = `
                    <img src="${s.photo||'https://via.placeholder.com/150'}" style="width:28px;height:28px;border-radius:6px;object-fit:cover;">
                    <span>${s.name}</span>
                    ${s.uid !== window.state.user?.uid ? 
                        `<button onclick="uiAction.removeGroupMember('${s.uid}')" style="background:transparent;border:none;cursor:pointer;padding:2px 6px;">‚úï</button>` : 
                        `<span style="opacity:0.5; font-size:11px;">(–≤—ã)</span>`
                    }
                `;
                container.appendChild(el);
            });
        }

        /* ==================== –¢–ï–ú–ê ==================== */
        window.themeCore = {
            preview: function() {
                const root = document.documentElement.style;
                root.setProperty('--primary', document.getElementById('ui-color-primary').value);
                root.setProperty('--msg-me', document.getElementById('ui-color-me').value);
                root.setProperty('--bg-body', document.getElementById('ui-bg-color').value);
                root.setProperty('--font-size', document.getElementById('ui-font-range').value + 'px');
                root.setProperty('--radius', document.getElementById('ui-radius-range').value + 'px');
            },
            save: function() {
                const settings = {
                    pr: document.getElementById('ui-color-primary').value,
                    me: document.getElementById('ui-color-me').value,
                    bg: document.getElementById('ui-bg-color').value,
                    fz: document.getElementById('ui-font-range').value,
                    rd: document.getElementById('ui-radius-range').value
                };
                localStorage.setItem('narrators_custom_ui', JSON.stringify(settings));
                this.apply(settings);
                uiAction.closeSettings();
            },
            load: function() {
                const saved = localStorage.getItem('narrators_custom_ui');
                if (saved) {
                    const t = JSON.parse(saved);
                    this.apply(t);
                }
            },
            apply: function(t) {
                if (!t) return;
                const root = document.documentElement.style;
                if (t.pr) root.setProperty('--primary', t.pr);
                if (t.me) root.setProperty('--msg-me', t.me);
                if (t.bg) root.setProperty('--bg-body', t.bg);
                if (t.fz) root.setProperty('--font-size', t.fz + 'px');
                if (t.rd) root.setProperty('--radius', t.rd + 'px');
            },
            reset: function() {
                localStorage.removeItem('narrators_custom_ui');
                document.documentElement.style.removeProperty('--primary');
                document.documentElement.style.removeProperty('--msg-me');
                document.documentElement.style.removeProperty('--bg-body');
                document.documentElement.style.removeProperty('--font-size');
                document.documentElement.style.removeProperty('--radius');
                uiAction.closeSettings();
            }
        };

        function rgbToHex(rgb) {
            if (!rgb) return '#000000';
            rgb = rgb.replace(/\s+/g,'');
            if (rgb[0] === '#') return rgb;
            const m = rgb.match(/rgba?\((\d+),(\d+),(\d+)/i);
            if (!m) return '#000000';
            return '#' + [1,2,3].map(i => parseInt(m[i]).toString(16).padStart(2,'0')).join('');
        }

        /* ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==================== */
        initGroupSearch();

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('chat-top-menu');
            if (menu && menu.classList.contains('active') && !e.target.closest('#chat-top-menu') && !e.target.closest('#chat-top-menu-btn')) {
                menu.classList.remove('active');
            }
            
            if (!e.target.closest('#context-popup')) {
                const p = document.getElementById('context-popup');
                if (p) p.style.display = 'none';
            }
        });

        document.getElementById('main-input').addEventListener('keydown', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                chatEngine.sendMessage(); 
            } 
        });

        document.getElementById('main-input').addEventListener('input', (e) => {
            const chat = window.state.currentChat;
            if (chat && e.target.value.trim().length > 0) {
                onlineManager.setTyping(chat.type, chat.id, true);
            } else if (chat) {
                onlineManager.setTyping(chat.type, chat.id, false);
            }
        });

        ['ui-color-primary','ui-color-me','ui-bg-color','ui-font-range','ui-radius-range'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', () => themeCore.preview());
        });

        document.getElementById('chat-top-avatar').addEventListener('click', () => {
            const c = window.state.currentChat || {};
            if (c.type === 'dm') uiAction.openProfile(c.otherUid);
            else if (c.type === 'group') uiAction.openGroupInfo(c.id);
            else uiAction.openProfile(window.state.user.uid);
        });

        function addConversationIfMissing(type, id, title, avatar, otherUid) {
            addConversationToList({ type, id, title, avatar, otherUid });
        }

        window.uiAction = window.uiAction;
        window.chatEngine = window.chatEngine;
        window.themeCore = window.themeCore;

        themeCore.load();

        /* ==================== –î–ï–ë–ê–ì ==================== */
        console.log('Narrators Messenger v0.1.7 loaded');
        console.log('Firebase project:', firebaseConfig.projectId);
        console.log('Google Auth configured:', !!provider);

    </script>
</body>
</html>
