<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Narrators Messenger v0.1.2 | Full Source</title>

    <style>
        :root {
            /* –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
            --primary: #3390ec;
            --primary-soft: rgba(51, 144, 236, 0.1);
            --bg-body: #ffffff;
            
            /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞ */
            --bg-chat-img: none;
            --bg-chat-color: #ffffff;
            
            /* –ü—É–∑—ã—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
            --msg-me: #eeffde;
            --msg-me-text: #000000;
            --msg-other: #f4f4f5;
            --msg-other-text: #000000;
            
            /* –ì–µ–æ–º–µ—Ç—Ä–∏—è –∏ —à—Ä–∏—Ñ—Ç—ã */
            --radius: 12px;
            --font-size: 16px;
            --bubble-opacity: 1;

            /* –°–ª—É–∂–µ–±–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
            --bg-sidebar: #ffffff;
            --border: #e4e4e4;
            --text-main: #000000;
            --text-sec: #707579;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --ease: cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* –ë–∞–∑–æ–≤—ã–π —Å–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; 
            padding: 0;
            outline: none;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            height: 100vh; 
            width: 100vw; 
            display: flex; 
            overflow: hidden; 
            background: var(--bg-body); 
            color: var(--text-main);
            font-size: var(--font-size);
            line-height: 1.5;
        }

        /* –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ñ–æ—Ä–º */
        button { 
            cursor: pointer; 
            border: none; 
            transition: all 0.2s ease; 
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:active { 
            transform: scale(0.95); 
            opacity: 0.8; 
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        .panel { 
            position: fixed; 
            inset: 0; 
            background: #ffffff; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            padding: 30px;
            text-align: center;
        }
        
        .auth-card {
            width: 100%; 
            max-width: 360px;
            padding: 20px;
        }

        .input-field { 
            padding: 15px; 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            width: 100%; 
            font-size: 16px; 
            background: #fdfdfd;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: var(--primary);
        }

        .btn-main { 
            padding: 16px; 
            background: var(--primary); 
            color: #ffffff; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 16px; 
            width: 100%;
            box-shadow: 0 4px 15px rgba(51, 144, 236, 0.2);
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        #app { 
            display: none; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            transition: opacity 0.6s var(--ease); 
        }

        #app.visible { 
            display: flex; 
            opacity: 1; 
        }

        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (–°–ø–∏—Å–∫–æ —á–∞—Ç–æ–≤) */
        #sidebar { 
            width: 380px; 
            flex-shrink: 0; 
            background: var(--bg-sidebar); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            z-index: 500;
        }

        .sidebar-top { 
            padding: 15px 20px; 
            display: flex; 
            align-items: center; 
            gap: 15px;
            border-bottom: 1px solid var(--border);
        }

        .chat-list-container { 
            flex: 1; 
            overflow-y: auto; 
        }

        .chat-row { 
            padding: 12px 20px; 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            cursor: pointer; 
            border-bottom: 1px solid #f9f9f9;
        }

        .chat-row:hover { background: #f7f9fb; }
        .chat-row.active { background: var(--primary-soft); }

        .user-avatar { 
            width: 55px; 
            height: 55px; 
            border-radius: 50%; 
            background: #f0f0f0; 
            object-fit: cover;
            flex-shrink: 0;
        }

        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–û–∫–Ω–æ —á–∞—Ç–∞) */
        #chat-window { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background-color: var(--bg-chat-color); 
            background-image: var(--bg-chat-img); 
            background-size: cover; 
            position: relative;
        }

        .chat-top-bar { 
            height: 65px; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            padding: 0 25px; 
            z-index: 100;
        }

        #messages-view { 
            flex: 1; 
            overflow-y: auto; 
            padding: 25px 8%; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            scroll-behavior: smooth;
        }

        /* –ü—É–∑—ã—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .msg-wrapper { 
            display: flex; 
            width: 100%; 
            animation: slideIn 0.35s var(--ease); 
        }

        .msg-wrapper.my-msg { justify-content: flex-end; }

        .msg-bubble { 
            padding: 12px 16px; 
            border-radius: var(--radius); 
            max-width: 70%; 
            position: relative; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            word-wrap: break-word;
        }

        .msg-wrapper.other-msg .msg-bubble { 
            background: var(--msg-other); 
            color: var(--msg-other-text); 
            border-bottom-left-radius: 4px; 
        }

        .msg-wrapper.my-msg .msg-bubble { 
            background: var(--msg-me); 
            color: var(--msg-me-text); 
            border-bottom-right-radius: 4px; 
        }

        .author-tag { 
            font-size: 13px; 
            font-weight: 700; 
            color: var(--primary); 
            margin-bottom: 5px; 
            display: block;
        }

        .time-stamp { 
            font-size: 11px; 
            opacity: 0.5; 
            text-align: right; 
            margin-top: 5px; 
            display: block; 
        }

        /* –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å —á–∞—Ç–∞ (–≤–≤–æ–¥) */
        .bottom-controls { 
            background: #ffffff; 
            padding: 15px 25px; 
            border-top: 1px solid var(--border); 
        }

        .input-group { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }

        #main-input { 
            flex: 1; 
            border: none; 
            font-size: 16px; 
            padding: 5px 0;
            resize: none; 
            max-height: 120px; 
            background: transparent; 
        }

        /* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é (Drawer) */
        #side-menu { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 320px; 
            height: 100%; 
            background: #ffffff; 
            z-index: 2000; 
            transform: translateX(-100%); 
            transition: transform 0.4s var(--ease); 
            display: flex; 
            flex-direction: column; 
            box-shadow: 10px 0 30px rgba(0,0,0,0.1);
        }

        #side-menu.active { transform: translateX(0); }

        .menu-header { 
            padding: 40px 25px; 
            background: var(--primary); 
            color: #ffffff; 
        }

        .menu-items { padding: 15px; flex: 1; }

        .menu-link { 
            padding: 14px 18px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 15px; 
            margin-bottom: 5px;
        }

        .menu-link:hover { background: #f5f5f5; }

        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
        #context-popup { 
            position: fixed; 
            background: #ffffff; 
            width: 200px; 
            border-radius: 14px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            z-index: 10000; 
            display: none; 
            padding: 8px; 
        }

        .popup-item { 
            padding: 12px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
        }

        .popup-item:hover { background: #f0f0f0; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes slideIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
        @media (max-width: 850px) {
            #sidebar { width: 100%; }
            #chat-window { 
                display: none; 
                position: fixed; 
                inset: 0; 
                z-index: 600; 
            }
            body.is-chatting #chat-window { display: flex; }
            .mobile-back-btn { display: flex !important; }
        }

        .mobile-back-btn { display: none; font-size: 24px; margin-right: 15px; }

        /* –û–≤–µ—Ä–ª–µ–π */
        .blur-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 1999;
            display: none;
            backdrop-filter: blur(2px);
        }
        .blur-overlay.active { display: block; }
    </style>
</head>
<body>

    <div id="screen-auth" class="panel">
        <div class="auth-card">
            <h1 style="color:var(--primary); font-size:48px; letter-spacing:-1px; margin-bottom:5px;">Narrators</h1>
            <p style="color:var(--text-sec); margin-bottom:40px; font-size:14px;">Product Version 0.1.2 Production</p>
            
            <button id="auth-google-trigger" class="btn-main" style="background:#fff; color:#444; border:1px solid #ddd; box-shadow:none;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" style="margin-right:12px;">
                –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç Google
            </button>
            <p style="margin-top:25px; font-size:12px; color:#aaa; line-height:1.6;">
                –í—Ö–æ–¥—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ Narrators.
            </p>
        </div>
    </div>

    <div id="screen-reg" class="panel" style="display:none;">
        <div class="auth-card">
            <h2 style="margin-bottom:10px; font-size:28px;">–ó–∞–≤–µ—Ä—à–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É</h2>
            <p style="color:var(--text-sec); margin-bottom:30px;">–ö–∞–∫ –≤–∞—Å –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏?</p>
            
            <div style="text-align:left;">
                <label style="font-size:12px; font-weight:700; color:var(--primary); margin-left:10px; margin-bottom:5px; display:block;">–í–ê–®–ï –ò–ú–Ø</label>
                <input id="reg-nickname" class="input-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                
                <label style="font-size:12px; font-weight:700; color:var(--primary); margin-left:10px; margin-bottom:5px; display:block;">–£–ù–ò–ö–ê–õ–¨–ù–´–ô –¢–ï–ì</label>
                <input id="reg-username" class="input-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ivan_cool">
                
                <label style="font-size:12px; font-weight:700; color:var(--primary); margin-left:10px; margin-bottom:5px; display:block;">–°–°–´–õ–ö–ê –ù–ê –ê–í–ê–¢–ê–† (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)</label>
                <input id="reg-avatar-url" class="input-field" placeholder="https://image.com/my-photo.jpg">
            </div>

            <button id="reg-confirm-btn" class="btn-main" style="margin-top:10px;">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
        </div>
    </div>

    <div id="app">
        <div id="app-overlay" class="blur-overlay" onclick="uiAction.closeMenu()"></div>
        
        <div id="side-menu">
            <div class="menu-header">
                <img id="user-profile-img" class="user-avatar" style="width:80px; height:80px; border:4px solid rgba(255,255,255,0.2); margin-bottom:15px;">
                <div id="user-display-name" style="font-weight:700; font-size:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div id="user-display-tag" style="opacity:0.7; font-size:14px;">@username</div>
            </div>
            
            <div class="menu-items">
                <div id="menu-view-main">
                    <div class="menu-link" onclick="uiAction.showSettings()">üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞</div>
                    <div class="menu-link" onclick="uiAction.logout()" style="color:#ff3b30; margin-top:20px;">üö™ –í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è</div>
                </div>

                <div id="menu-view-settings" style="display:none;">
                    <button onclick="uiAction.hideSettings()" style="color:var(--primary); font-weight:700; margin-bottom:20px; font-size:13px;">‚¨Ö –ù–ê–ó–ê–î –í –ú–ï–ù–Æ</button>
                    <div style="display:flex; flex-direction:column; gap:20px;">
                        <div class="setting-item">
                            <label style="display:block; font-size:12px; margin-bottom:8px;">–†–ê–ó–ú–ï–† –®–†–ò–§–¢–ê (px)</label>
                            <input type="range" id="ui-font-range" min="12" max="22" value="16" style="width:100%;" oninput="themeCore.preview()">
                        </div>
                        <div class="setting-item">
                            <label style="display:block; font-size:12px; margin-bottom:8px;">–°–ö–†–£–ì–õ–ï–ù–ò–ï –£–ì–õ–û–í (px)</label>
                            <input type="range" id="ui-radius-range" min="0" max="25" value="12" style="width:100%;" oninput="themeCore.preview()">
                        </div>
                        <div class="setting-item">
                            <label style="display:block; font-size:12px; margin-bottom:8px;">–û–°–ù–û–í–ù–û–ô –¶–í–ï–¢</label>
                            <input type="color" id="ui-color-primary" value="#3390ec" style="width:100%; height:40px; border:none; cursor:pointer;" oninput="themeCore.preview()">
                        </div>
                        <div class="setting-item">
                            <label style="display:block; font-size:12px; margin-bottom:8px;">–¶–í–ï–¢ –ú–û–ò–• –°–û–û–ë–©–ï–ù–ò–ô</label>
                            <input type="color" id="ui-color-me" value="#eeffde" style="width:100%; height:40px; border:none;" oninput="themeCore.preview()">
                        </div>
                    </div>
                    <button class="btn-main" onclick="themeCore.save()" style="margin-top:40px; padding:12px;">–ü–†–ò–ú–ï–ù–ò–¢–¨ –ò –°–û–•–†–ê–ù–ò–¢–¨</button>
                </div>
            </div>
        </div>

        <div id="sidebar">
            <div class="sidebar-top">
                <button onclick="uiAction.openMenu()" style="font-size:24px; color:var(--text-sec);">‚ò∞</button>
                <div style="font-weight:800; font-size:20px; flex:1; text-align:center; letter-spacing:-0.5px;">Narrators</div>
            </div>
            
            <div class="chat-list-container">
                <div class="chat-row active" onclick="uiAction.openChatRoom()">
                    <div style="position:relative;">
                        <img src="https://cdn-icons-png.flaticon.com/512/1041/1041916.png" class="user-avatar">
                    </div>
                    <div style="flex:1; overflow:hidden;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b style="font-size:16px;">Global Chat Room</b>
                            <span style="font-size:11px; color:#aaa;">online</span>
                        </div>
                        <div style="font-size:13px; color:var(--text-sec); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ–±—â–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ!
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-window">
            <div class="chat-top-bar">
                <button class="mobile-back-btn" onclick="uiAction.closeChatRoom()">‚¨Ö</button>
                <div style="display:flex; align-items:center; gap:12px;">
                    <div>
                        <div style="font-weight:700; font-size:17px;">Global Chat Room</div>
                        <div style="font-size:12px; color:var(--primary);">v0.1.2 Production Channel</div>
                    </div>
                </div>
            </div>

            <div id="messages-view"></div>

            <div class="bottom-controls">
                <div id="reply-preview" style="display:none; background:#f5f5f5; padding:10px; border-left:4px solid var(--primary); margin-bottom:12px; border-radius:5px; align-items:center; justify-content:space-between;">
                    <div style="overflow:hidden;">
                        <b id="reply-author-name" style="color:var(--primary); font-size:13px;"></b><br>
                        <span id="reply-author-text" style="font-size:13px; opacity:0.7;"></span>
                    </div>
                    <button onclick="chatEngine.cancelAction()" style="padding:5px;">‚úï</button>
                </div>

                <div class="input-group">
                    <button onclick="chatEngine.attachImage()" style="font-size:22px; color:#999;">üì∑</button>
                    <textarea id="main-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..." rows="1"></textarea>
                    <button id="send-msg-btn" onclick="chatEngine.sendMessage()" style="color:var(--primary); font-size:26px;">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="context-popup">
        <div class="popup-item" onclick="chatEngine.handleAction('reply')">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="popup-item" onclick="chatEngine.handleAction('copy')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</div>
        <div id="popup-edit-btn" class="popup-item" onclick="chatEngine.handleAction('edit')">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        <div id="popup-delete-btn" class="popup-item" onclick="chatEngine.handleAction('delete')" style="color:#ff3b30;">üóë –£–¥–∞–ª–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö</div>
    </div>

    <script type="module">
        /* –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π Firebase */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithRedirect, 
            getRedirectResult, 
            GoogleAuthProvider, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            push, 
            onValue, 
            get, 
            child, 
            update, 
            remove 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        /* --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE --- */
        const firebaseConfig = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677"
        };

        /* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ */
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        /* –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        let state = {
            user: null,
            profile: null,
            isAdmin: false,
            activeAction: null, // 'reply' –∏–ª–∏ 'edit'
            targetMessage: null,
            contextTarget: null
        };

        /* --- –Ø–î–†–û –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò --- */
        document.getElementById('auth-google-trigger').addEventListener('click', () => {
            signInWithRedirect(auth, provider);
        });

        onAuthStateChanged(auth, (firebaseUser) => {
            if (firebaseUser) {
                state.user = firebaseUser;
                validateUserProfile();
            } else {
                toggleScreen('screen-auth');
            }
        });

        async function validateUserProfile() {
            const userRef = ref(db);
            try {
                const snapshot = await get(child(userRef, `users/${state.user.uid}`));
                if (snapshot.exists()) {
                    state.profile = snapshot.val();
                    launchMainApp();
                } else {
                    toggleScreen('screen-reg');
                    document.getElementById('reg-nickname').value = state.user.displayName || "";
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ—Ñ–∏–ª—è:", error);
            }
        }

        document.getElementById('reg-confirm-btn').addEventListener('click', async () => {
            const nick = document.getElementById('reg-nickname').value.trim();
            const tag = document.getElementById('reg-username').value.trim().replace('@', '');
            const ava = document.getElementById('reg-avatar-url').value.trim();

            if (nick.length < 2 || tag.length < 2) {
                alert("–ò–º—è –∏ —Ç–µ–≥ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞.");
                return;
            }

            state.profile = {
                uid: state.user.uid,
                displayName: nick,
                username: tag.toLowerCase(),
                usernameDisplay: tag,
                photoURL: ava || state.user.photoURL || 'https://via.placeholder.com/150'
            };

            await set(ref(db, `users/${state.user.uid}`), state.profile);
            launchMainApp();
        });

        /* --- –ó–ê–ü–£–°–ö –ì–õ–ê–í–ù–û–ì–û –ò–ù–¢–ï–†–§–ï–ô–°–ê --- */
        function launchMainApp() {
            toggleScreen('app');
            const mainAppElement = document.getElementById('app');
            setTimeout(() => mainAppElement.classList.add('visible'), 50);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é
            document.getElementById('user-profile-img').src = state.profile.photoURL;
            document.getElementById('user-display-name').innerText = state.profile.displayName;
            document.getElementById('user-display-tag').innerText = '@' + state.profile.usernameDisplay;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            if (state.profile.usernameDisplay.toLowerCase() === 'admin') {
                state.isAdmin = true;
            }

            themeCore.load();
            chatEngine.listen();
        }

        /* --- –î–í–ò–ñ–û–ö –ß–ê–¢–ê --- */
        window.chatEngine = {
            sendMessage: function() {
                const input = document.getElementById('main-input');
                const text = input.value.trim();
                
                if (!text) return;

                if (state.activeAction === 'edit' && state.targetMessage) {
                    update(ref(db, `messages/${state.targetMessage.key}`), {
                        text: text,
                        isEdited: true
                    });
                } else {
                    const messageData = {
                        uid: state.user.uid,
                        displayName: state.profile.displayName,
                        username: state.profile.usernameDisplay,
                        text: text,
                        createdAt: Date.now()
                    };

                    if (state.activeAction === 'reply' && state.targetMessage) {
                        messageData.replyTo = {
                            author: state.targetMessage.displayName,
                            content: state.targetMessage.text
                        };
                    }

                    push(ref(db, 'messages'), messageData);
                }

                this.cancelAction();
            },

            listen: function() {
                const messagesContainer = document.getElementById('messages-view');
                onValue(ref(db, 'messages'), (snapshot) => {
                    messagesContainer.innerHTML = '';
                    const data = snapshot.val();
                    if (!data) return;

                    const sortedEntries = Object.entries(data).sort((a, b) => a[1].createdAt - b[1].createdAt);

                    sortedEntries.forEach(([msgId, msg]) => {
                        const isMyMessage = msg.uid === state.user.uid;
                        const wrapper = document.createElement('div');
                        wrapper.className = `msg-wrapper ${isMyMessage ? 'my-msg' : 'other-msg'}`;

                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS –∏ –¥–µ—Ç–µ–∫—Ç –∫–∞—Ä—Ç–∏–Ω–æ–∫)
                        let processedText = msg.text.replace(/</g, "&lt;");
                        if (processedText.match(/\.(jpg|jpeg|png|gif|webp)/i)) {
                            processedText = `<img src="${processedText}" style="max-width:100%; border-radius:8px; margin-top:5px; cursor:pointer;" onclick="window.open(this.src)">`;
                        }

                        // –ë–ª–æ–∫ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
                        const replyMarkup = msg.replyTo ? `
                            <div style="font-size:12px; border-left:3px solid var(--primary); padding-left:10px; margin-bottom:8px; opacity:0.7;">
                                <b>${msg.replyTo.author}</b><br>${msg.replyTo.content.substring(0, 50)}...
                            </div>
                        ` : '';

                        wrapper.innerHTML = `
                            <div class="msg-bubble" id="msg-${msgId}">
                                <span class="author-tag">${msg.displayName} ${msg.username === 'admin' ? 'üëë' : ''}</span>
                                ${replyMarkup}
                                <div class="msg-content-body">${processedText}</div>
                                <span class="time-stamp">
                                    ${msg.isEdited ? '–∏–∑–º. ' : ''} 
                                    ${new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                </span>
                            </div>
                        `;

                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞ (–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é)
                        wrapper.oncontextmenu = (event) => {
                            event.preventDefault();
                            this.openContextMenu(event, msgId, msg);
                        };

                        messagesContainer.appendChild(wrapper);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            },

            openContextMenu: function(e, key, data) {
                state.contextTarget = { key, ...data };
                const popup = document.getElementById('context-popup');
                popup.style.display = 'block';
                
                let posX = e.clientX;
                let posY = e.clientY;

                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏, —á—Ç–æ–±—ã –º–µ–Ω—é –Ω–µ —É—Ö–æ–¥–∏–ª–æ –∑–∞ —ç–∫—Ä–∞–Ω
                if (posX + 200 > window.innerWidth) posX -= 200;
                if (posY + 150 > window.innerHeight) posY -= 150;

                popup.style.left = posX + 'px';
                popup.style.top = posY + 'px';

                const isMine = data.uid === state.user.uid;
                document.getElementById('popup-edit-btn').style.display = isMine ? 'block' : 'none';
                document.getElementById('popup-delete-btn').style.display = (isMine || state.isAdmin) ? 'block' : 'none';
            },

            handleAction: function(type) {
                const popup = document.getElementById('context-popup');
                popup.style.display = 'none';

                if (type === 'reply') {
                    state.activeAction = 'reply';
                    state.targetMessage = state.contextTarget;
                    const bar = document.getElementById('reply-preview');
                    bar.style.display = 'flex';
                    document.getElementById('reply-author-name').innerText = state.targetMessage.displayName;
                    document.getElementById('reply-author-text').innerText = state.targetMessage.text;
                    document.getElementById('main-input').focus();
                } 
                else if (type === 'edit') {
                    state.activeAction = 'edit';
                    state.targetMessage = state.contextTarget;
                    const bar = document.getElementById('reply-preview');
                    bar.style.display = 'flex';
                    document.getElementById('reply-author-name').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
                    document.getElementById('reply-author-text').innerText = state.targetMessage.text;
                    document.getElementById('main-input').value = state.targetMessage.text;
                    document.getElementById('main-input').focus();
                }
                else if (type === 'copy') {
                    navigator.clipboard.writeText(state.contextTarget.text);
                }
                else if (type === 'delete') {
                    if (confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
                        remove(ref(db, `messages/${state.contextTarget.key}`));
                    }
                }
            },

            cancelAction: function() {
                state.activeAction = null;
                state.targetMessage = null;
                document.getElementById('reply-preview').style.display = 'none';
                document.getElementById('main-input').value = '';
            },

            attachImage: function() {
                const url = prompt("–í–≤–µ–¥–∏—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPG, PNG, GIF):");
                if (url && url.startsWith('http')) {
                    document.getElementById('main-input').value = url;
                    this.sendMessage();
                }
            }
        };

        /* --- –Ø–î–†–û –¢–ï–ú–´ (UI CUSTOMIZATION) --- */
        window.themeCore = {
            preview: function() {
                const root = document.documentElement.style;
                const fz = document.getElementById('ui-font-range').value;
                const rd = document.getElementById('ui-radius-range').value;
                const pr = document.getElementById('ui-color-primary').value;
                const me = document.getElementById('ui-color-me').value;

                root.setProperty('--font-size', fz + 'px');
                root.setProperty('--radius', rd + 'px');
                root.setProperty('--primary', pr);
                root.setProperty('--msg-me', me);
            },

            save: function() {
                const settings = {
                    fz: document.getElementById('ui-font-range').value,
                    rd: document.getElementById('ui-radius-range').value,
                    pr: document.getElementById('ui-color-primary').value,
                    me: document.getElementById('ui-color-me').value
                };
                localStorage.setItem('narrators_custom_ui', JSON.stringify(settings));
                uiAction.closeMenu();
            },

            load: function() {
                const saved = localStorage.getItem('narrators_custom_ui');
                if (saved) {
                    const t = JSON.parse(saved);
                    document.getElementById('ui-font-range').value = t.fz;
                    document.getElementById('ui-radius-range').value = t.rd;
                    document.getElementById('ui-color-primary').value = t.pr;
                    document.getElementById('ui-color-me').value = t.me;
                    this.preview();
                }
            }
        };

        /* --- UI ACTIONS --- */
        window.uiAction = {
            openMenu: function() {
                document.getElementById('side-menu').classList.add('active');
                document.getElementById('app-overlay').classList.add('active');
            },
            closeMenu: function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('app-overlay').classList.remove('active');
                this.hideSettings();
            },
            showSettings: function() {
                document.getElementById('menu-view-main').style.display = 'none';
                document.getElementById('menu-view-settings').style.display = 'block';
            },
            hideSettings: function() {
                document.getElementById('menu-view-settings').style.display = 'none';
                document.getElementById('menu-view-main').style.display = 'block';
            },
            logout: function() {
                if (confirm("–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?")) signOut(auth);
            },
            openChatRoom: function() {
                document.body.classList.add('is-chatting');
            },
            closeChatRoom: function() {
                document.body.classList.remove('is-chatting');
            }
        };

        /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ */
        function toggleScreen(screenId) {
            const screens = ['screen-auth', 'screen-reg', 'app'];
            screens.forEach(id => {
                document.getElementById(id).style.display = (id === screenId) ? 'flex' : 'none';
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ
        document.addEventListener('click', (e) => {
            const popup = document.getElementById('context-popup');
            if (!e.target.closest('#context-popup')) {
                popup.style.display = 'none';
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        document.getElementById('main-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatEngine.sendMessage();
            }
        });

    </script>
</body>
</html>
