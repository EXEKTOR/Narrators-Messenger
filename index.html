<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARRATORS // REALTIME</title>
    <style>
        :root {
            --bg-body: #ffffff;
            --bg-sidebar: #f7f7f7;
            --bg-chat: #ffffff;
            --primary: #ff0033; /* –ö—Ä–∞—Å–Ω—ã–π Mirror's Edge */
            --text-main: #222;
            --border: #ddd;
            --msg-me: #ff0033;
            --msg-me-text: #fff;
            --msg-other: #f0f0f0;
            --msg-other-text: #000;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: sans-serif; height: 100vh; display: flex; overflow: hidden; color: var(--text-main); }

        /* –≠–∫—Ä–∞–Ω—ã */
        .panel { position: fixed; top:0; left:0; width:100%; height:100%; background:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:999; }
        
        button { padding:12px 24px; background:var(--primary); color:#fff; border:none; border-radius:4px; font-weight:bold; cursor:pointer; text-transform:uppercase; }
        input { padding:12px; border:1px solid var(--border); width:300px; margin-bottom:15px; border-radius:4px; outline:none; }
        input:focus { border-color: var(--primary); }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #app { display:none; width:100%; height:100%; }
        
        #sidebar { width:350px; background:var(--bg-sidebar); border-right:1px solid var(--border); display:flex; flex-direction:column; }
        .sidebar-header { padding:15px; border-bottom:1px solid var(--border); }
        .chat-list { flex:1; overflow-y:auto; }
        .chat-item { padding:15px; display:flex; gap:10px; cursor:pointer; align-items:center; transition:0.2s; }
        .chat-item:hover { background:#fff; }
        .chat-item.active { background:#fff; border-right:4px solid var(--primary); }
        .avatar { width:45px; height:45px; background:#ddd; border-radius:50%; display:flex; justify-content:center; align-items:center; font-weight:bold; color:#fff; }
        .avatar.red { background:var(--primary); }

        #chat { flex:1; display:flex; flex-direction:column; background:var(--bg-chat); }
        .chat-header { height:60px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; padding:0 20px; }
        #messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px; }
        
        .msg { max-width:70%; padding:10px 15px; border-radius:10px; font-size:0.95rem; word-wrap:break-word; }
        .msg.me { align-self:flex-end; background:var(--msg-me); color:var(--msg-me-text); border-bottom-right-radius:2px; }
        .msg.other { align-self:flex-start; background:var(--msg-other); color:var(--msg-other-text); border-bottom-left-radius:2px; }
        .msg-name { font-size:0.75rem; font-weight:bold; margin-bottom:3px; opacity:0.8; display:block; cursor:pointer;}

        .input-box { padding:15px; border-top:1px solid var(--border); display:flex; gap:10px; }
        #msg-in { flex:1; margin:0; }

        @media (max-width: 700px) {
            #sidebar { width:100%; }
            #chat { display:none; width:100%; }
            body.chat-open #sidebar { display:none; }
            body.chat-open #chat { display:flex; }
            #btn-back { display:block !important; }
        }
    </style>
</head>
<body>

    <!-- –í–•–û–î -->
    <div id="login-screen" class="panel">
        <h1 style="color:var(--primary)">NARRATORS</h1>
        <button id="btn-login">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    </div>

    <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
    <div id="reg-screen" class="panel" style="display:none;">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <p>–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏ ID</p>
        <input id="reg-nick" placeholder="–ù–∏–∫–Ω–µ–π–º (Nick)">
        <input id="reg-tag" placeholder="@username (ID)">
        <button id="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="app">
        <div id="sidebar">
            <div class="sidebar-header">
                <div style="font-weight:bold; color:var(--primary)">NARRATORS // RTDB</div>
            </div>
            <div class="chat-list">
                <div class="chat-item active" onclick="openChat()">
                    <div class="avatar red">G</div>
                    <div>
                        <div style="font-weight:bold">Global Chat</div>
                        <div style="font-size:0.8rem; color:#777">–û–±—â–∏–π –∫–∞–Ω–∞–ª</div>
                    </div>
                </div>
            </div>
            <div style="padding:15px; text-align:center; font-size:0.9rem; color:#777" id="my-profile">...</div>
        </div>

        <div id="chat">
            <div class="chat-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="btn-back" style="display:none; background:none; color:#000; font-size:1.5rem; padding:0;">‚¨Ö</button>
                    <span style="font-weight:bold">GLOBAL CHAT</span>
                </div>
                <button id="btn-logout" style="background:#ccc; font-size:0.8rem; padding:5px 10px;">–í—ã—Ö–æ–¥</button>
            </div>
            <div id="messages"></div>
            <div class="input-box">
                <button id="btn-img" style="background:none; color:#000; font-size:1.5rem; padding:0 10px;">üì∑</button>
                <input id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button id="btn-send" style="background:none; color:var(--primary); font-size:1.5rem; padding:0 10px;">‚û§</button>
            </div>
        </div>
    </div>

    <script type="module">
        // –ò–ú–ü–û–†–¢–´ –î–õ–Ø REALTIME DATABASE (–í–ê–ñ–ù–û!)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const config = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com", // –≠–¢–û –ì–õ–ê–í–ù–û–ï –î–õ–Ø –¢–ï–ë–Ø
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677",
            measurementId: "G-XN1B0KZ5ML"
        };

        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getDatabase(app); // –ü–û–î–ö–õ–Æ–ß–ò–õ–ò REALTIME DB
        
        let user = null;
        let profile = null;

        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const ui = {
            login: document.getElementById('login-screen'),
            reg: document.getElementById('reg-screen'),
            app: document.getElementById('app'),
            list: document.getElementById('messages'),
            in: document.getElementById('msg-in'),
            myProfile: document.getElementById('my-profile')
        };

        // 1. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('btn-logout').onclick = () => signOut(auth);

        onAuthStateChanged(auth, async (u) => {
            user = u;
            if (user) {
                ui.login.style.display = 'none';
                
                // –ü–†–û–í–ï–†–ö–ê –ü–†–û–§–ò–õ–Ø –í REALTIME DB
                const dbRef = ref(db);
                get(child(dbRef, `users/${user.uid}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        profile = snapshot.val();
                        startApp();
                    } else {
                        ui.reg.style.display = 'flex';
                        document.getElementById('reg-nick').value = user.displayName;
                    }
                }).catch((error) => {
                    console.error(error);
                });
            } else {
                ui.login.style.display = 'flex';
                ui.reg.style.display = 'none';
                ui.app.style.display = 'none';
            }
        });

        // 2. –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
        document.getElementById('btn-save').onclick = () => {
            const nick = document.getElementById('reg-nick').value.trim();
            const tag = document.getElementById('reg-tag').value.trim().replace('@','');
            
            if(!nick || !tag) return alert('–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!');

            const newData = {
                displayName: nick,
                username: tag.toLowerCase(),
                usernameDisplay: tag,
                uid: user.uid
            };

            // –°–û–•–†–ê–ù–Ø–ï–ú –í USERS
            set(ref(db, 'users/' + user.uid), newData).then(() => {
                profile = newData;
                ui.reg.style.display = 'none';
                startApp();
            });
        };

        function startApp() {
            ui.app.style.display = 'flex';
            ui.myProfile.innerText = '@' + profile.usernameDisplay;
            loadMessages();
        }

        // 3. –û–¢–ü–†–ê–í–ö–ê (PUSH –≤ Realtime)
        function send(txt) {
            if(!txt || !user) return;
            const msgListRef = ref(db, 'messages');
            const newMsgRef = push(msgListRef);
            set(newMsgRef, {
                text: txt,
                uid: user.uid,
                displayName: profile.displayName,
                username: profile.usernameDisplay,
                createdAt: Date.now()
            });
        }

        document.getElementById('btn-send').onclick = () => {
            if(ui.in.value.trim()) { send(ui.in.value.trim()); ui.in.value=''; }
        };
        ui.in.onkeypress = (e) => {
             if(e.key==='Enter' && ui.in.value.trim()) { send(ui.in.value.trim()); ui.in.value=''; }
        };
        document.getElementById('btn-img').onclick = () => {
            const url = prompt("URL –∫–∞—Ä—Ç–∏–Ω–∫–∏:");
            if(url) send(url);
        };

        // 4. –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–ê (REALTIME LISTENER)
        function loadMessages() {
            const messagesRef = ref(db, 'messages');
            onValue(messagesRef, (snapshot) => {
                ui.list.innerHTML = '';
                const data = snapshot.val();
                
                if(!data) return;

                // Realtime DB –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç, –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –º–∞—Å—Å–∏–≤
                const msgs = Object.values(data);
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É)
                msgs.sort((a, b) => a.createdAt - b.createdAt);

                msgs.forEach(m => {
                    const isMe = m.uid === user.uid;
                    const div = document.createElement('div');
                    div.className = `msg ${isMe ? 'me' : 'other'}`;
                    
                    let txt = m.text;
                    if(txt.startsWith('http')) txt = `<img src="${txt}" style="max-width:100%; border-radius:5px;">`;

                    div.innerHTML = `<span class="msg-name" onclick="alert('@${m.username}')">${m.displayName}</span>${txt}`;
                    ui.list.appendChild(div);
                });
                ui.list.scrollTop = ui.list.scrollHeight;
            });
        }

        // –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
        window.openChat = () => { if(window.innerWidth<=700) { document.body.classList.add('chat-open'); } };
        document.getElementById('btn-back').onclick = () => document.body.classList.remove('chat-open');
    </script>
</body>
</html>
