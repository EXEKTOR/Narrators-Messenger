<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Narrators Messenger v0.1.5</title>

    <style>
        :root {
            --primary: #3390ec;
            --primary-soft: rgba(51, 144, 236, 0.1);
            --bg-body: #ffffff;
            --msg-me: #eeffde;
            --msg-other: #f4f4f5;
            --radius: 12px;
            --font-size: 16px;
            --border: #e4e4e4;
            --text-main: #000000;
            --text-sec: #707579;
            --ease: cubic-bezier(0.25, 1, 0.5, 1);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin:0; padding:0; outline:none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height:100vh; width:100vw; display:flex; overflow:hidden; background:var(--bg-body); color:var(--text-main); font-size:var(--font-size); line-height:1.5; }

        /* Common inputs/buttons */
        .panel { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:20px; background:var(--bg-body); }
        .card { width:100%; max-width:420px; border-radius:14px; padding:20px; border:1px solid var(--border); background:#fff; box-shadow:0 6px 30px rgba(0,0,0,0.06); }
        .logo { color:var(--primary); font-weight:800; font-size:28px; margin-bottom:6px; }
        .muted { color:var(--text-sec); font-size:13px; margin-bottom:12px; }
        .input-field { width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border); margin-bottom:10px; font-size:14px; }
        .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px; cursor:pointer; border:none; }
        .btn-primary { background:var(--primary); color:#fff; }
        .btn-ghost { background:#f6f7fb; color:#222; border:1px solid #efefef; }
        .small-link { color:var(--primary); cursor:pointer; font-size:13px; text-decoration:underline; }

        /* Error / notice */
        .notice { padding:10px; border-radius:8px; margin:10px 0; font-size:13px; }
        .notice.error { background:#fff4f4; border:1px solid #ffd2d2; color:#8b1d1d; }
        .notice.info { background:#f0f8ff; border:1px solid #cfe9ff; color:#045; }

        /* App layout (kept from previous version) */
        #app { display:none; width:100%; height:100%; opacity:0; transition:opacity 0.45s var(--ease); }
        #app.visible { display:flex; opacity:1; }
        #sidebar { width:380px; flex-shrink:0; background:#fff; border-right:1px solid var(--border); display:flex; flex-direction:column; z-index:500; }
        .sidebar-top { padding:12px 16px; display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--border); }
        .chat-list-container { flex:1; overflow-y:auto; }
        .chat-row { padding:12px 16px; display:flex; gap:12px; align-items:center; cursor:pointer; border-bottom:1px solid #f9f9f9; }
        .chat-row:hover { background:#f7f9fb; }
        .user-avatar { width:55px; height:55px; border-radius:50%; object-fit:cover; }
        #chat-window { flex:1; display:flex; flex-direction:column; background:var(--bg-body); position:relative; }
        .chat-top-bar { height:65px; display:flex; align-items:center; gap:12px; padding:0 18px; border-bottom:1px solid var(--border); }
        #messages-view { flex:1; overflow-y:auto; padding:20px 6%; display:flex; flex-direction:column; gap:10px; }
        /* Message layout */
        .msg-wrapper {
            display:flex;
            align-items:flex-end;
            gap:10px;
            width:100%;
            justify-content:flex-start; /* default: left */
        }

        /* Force alignment: my messages -> right, others -> left */
        .msg-wrapper.my-msg { justify-content: flex-end !important; }
        .msg-wrapper.other-msg { justify-content: flex-start !important; }

        /* Order inside wrapper: other -> avatar left, bubble right; my -> bubble left, avatar right */
        .msg-wrapper.other-msg .msg-avatar { order: 0; margin-right:8px; }
        .msg-wrapper.other-msg .msg-bubble { order: 1; }

        .msg-wrapper.my-msg .msg-avatar { order: 1; margin-left:8px; }
        .msg-wrapper.my-msg .msg-bubble { order: 0; }

        .msg-bubble { padding:12px 16px; border-radius:var(--radius); max-width:70%; box-shadow:0 2px 5px rgba(0,0,0,0.05); word-wrap:break-word; background:var(--msg-other); }
        .msg-wrapper.my-msg .msg-bubble { background:var(--msg-me); color:var(--msg-me-text); }

        .author-tag { font-size:13px; font-weight:700; color:var(--primary); margin-bottom:6px; display:block; }
        .time-stamp { font-size:11px; opacity:0.6; display:block; margin-top:6px; text-align:right; }

        .msg-avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; cursor:pointer; }

        .bottom-controls { padding:12px 18px; border-top:1px solid var(--border); background:#fff; }
        .input-group { display:flex; gap:10px; align-items:center; }
        #main-input { flex:1; padding:10px; border-radius:10px; border:1px solid var(--border); }

        /* profile modal */
        .profile-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:10001; display:none; backdrop-filter:blur(3px); }
        .profile-overlay.active { display:block; }
        .profile-modal { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(0.95); width:92%; max-width:520px; background:#fff; border-radius:14px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,0.3); z-index:10002; display:none; transition:all 0.18s var(--ease); opacity:0; }
        .profile-modal.active { display:block; transform:translate(-50%,-50%) scale(1); opacity:1; }

        /* small */
        .muted-xs { font-size:12px; color:var(--text-sec); }

        @media (max-width:850px) {
            #sidebar { width:100%; }
            #chat-window { display:none; position:fixed; inset:0; z-index:600; }
            body.is-chatting #chat-window { display:flex; }
        }
    </style>
</head>
<body>

    <!-- AUTH PANELS -->
    <div id="auth-screen" class="panel">
        <div class="card" id="auth-card">
            <div class="logo">Narrators</div>
            <div class="muted">–í–µ—Ä—Å–∏—è 0.1.5 ‚Äî –≤—Ö–æ–¥ –ø–æ email/–ø–∞—Ä–æ–ª—é (–æ—Å–Ω–æ–≤–Ω–æ–π). Google ‚Äî –æ–ø—Ü–∏—è –≤–Ω–∏–∑—É.</div>

            <!-- Error / info -->
            <div id="auth-error" class="notice error" style="display:none;"></div>
            <div id="auth-info" class="notice info" style="display:none;"></div>

            <!-- LOGIN FORM -->
            <div id="login-view">
                <input id="login-email" class="input-field" placeholder="Email" type="email" autocomplete="email">
                <input id="login-password" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å" type="password" autocomplete="current-password">
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <button id="login-btn" class="btn btn-primary" style="flex:1;">–í–æ–π—Ç–∏</button>
                    <button id="to-register" class="btn btn-ghost" style="width:120px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="small-link" id="forgot-password">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</div>
                    <div class="muted-xs">–ò–ª–∏ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google –Ω–∏–∂–µ</div>
                </div>
            </div>

            <!-- REGISTER FORM -->
            <div id="register-view" style="display:none; margin-top:10px;">
                <input id="reg-displayname" class="input-field" placeholder="–í–∞—à–µ –∏–º—è">
                <input id="reg-username" class="input-field" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–≥ (–±–µ–∑ @)">
                <input id="reg-email" class="input-field" placeholder="Email" type="email">
                <input id="reg-password" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" type="password">
                <input id="reg-avatar-url" class="input-field" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                <div style="display:flex; gap:8px; margin-top:6px;">
                    <button id="register-btn" class="btn btn-primary" style="flex:1;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                    <button id="to-login" class="btn btn-ghost" style="width:120px;">–ù–∞–∑–∞–¥</button>
                </div>
            </div>

            <hr style="margin:14px 0; border:none; border-top:1px solid #f0f0f0;">
            <!-- Google login as secondary -->
            <button id="google-btn" class="btn btn-ghost" style="width:100%; gap:12px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="Google">
                –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
            </button>
        </div>
    </div>

    <!-- MAIN APP (kept simplified layout) -->
    <div id="app">
        <div id="app-overlay" style="display:none;"></div>

        <div id="side-menu" style="display:none;">
            <!-- Could keep previous side menu if needed, hidden for brevity here -->
        </div>

        <div id="sidebar">
            <div class="sidebar-top">
                <div style="display:flex; align-items:center; gap:12px;">
                    <img id="user-profile-img" class="user-avatar" src="https://via.placeholder.com/150">
                    <div>
                        <div id="user-display-name" style="font-weight:700;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        <div id="user-display-tag" class="muted-xs">@...</div>
                    </div>
                </div>
            </div>

            <div style="padding:12px;">
                <input id="user-search-input" class="input-field" placeholder="–ü–æ–∏—Å–∫ –ø–æ @—Ç–µ–≥—É –∏–ª–∏ –∏–º–µ–Ω–∏...">
            </div>

            <div class="chat-list-container" id="conversations-list">
                <div class="chat-row" onclick="uiAction.openGlobal()">
                    <img class="user-avatar" src="https://cdn-icons-png.flaticon.com/512/1041/1041916.png" style="width:46px; height:46px;">
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b>Global Chat Room</b>
                            <span class="muted-xs" style="color:#aaa;">online</span>
                        </div>
                        <div class="muted-xs" style="color:var(--text-sec);">–û–±—â–∏–π —á–∞—Ç</div>
                    </div>
                </div>
                <!-- Additional conversations (DMs/groups) will be listed here -->
            </div>
        </div>

        <div id="chat-window">
            <div class="chat-top-bar">
                <div id="chat-top-info" style="display:flex; gap:12px; align-items:center;">
                    <img id="chat-top-avatar" src="https://via.placeholder.com/100" style="width:42px; height:42px; border-radius:10px; object-fit:cover; cursor:pointer;" onclick="uiAction.openCurrentTargetInfo()">
                    <div>
                        <div id="chat-top-title" style="font-weight:700;">Global Chat Room</div>
                        <div id="chat-top-sub" class="muted-xs">v0.1.5</div>
                    </div>
                </div>
                <div style="margin-left:auto;">
                    <button id="signout-btn" class="btn btn-ghost">–í—ã–π—Ç–∏</button>
                </div>
            </div>

            <div id="messages-view"></div>

            <div class="bottom-controls">
                <div id="reply-preview" style="display:none; background:#f5f5f5; padding:10px; border-left:4px solid var(--primary); margin-bottom:12px; border-radius:6px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <b id="reply-author-name" style="color:var(--primary);"></b><br>
                            <span id="reply-author-text" class="muted-xs"></span>
                        </div>
                        <button onclick="chatEngine.cancelAction()" class="btn btn-ghost">‚úï</button>
                    </div>
                </div>

                <div class="input-group">
                    <textarea id="main-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..." rows="1" style="flex:1; padding:10px; border-radius:10px; border:1px solid var(--border);"></textarea>
                    <button id="send-msg-btn" class="btn btn-primary" onclick="chatEngine.sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile modal (reused) -->
    <div id="profile-overlay" class="profile-overlay" onclick="uiAction.closeProfile()"></div>
    <div id="profile-modal" class="profile-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:800;">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <button onclick="uiAction.closeProfile()" style="background:transparent; font-size:18px; padding:6px;">‚úï</button>
        </div>

        <div class="profile-top">
            <img id="p-avatar" src="https://via.placeholder.com/150" alt="avatar">
            <div style="flex:1;">
                <div class="profile-name" id="p-displayname">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                <div class="profile-username" id="p-username">@username</div>
                <div style="margin-top:6px;">
                    <small class="muted-xs">–û —Å–µ–±–µ:</small>
                    <div class="profile-about muted-xs" id="p-about">–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.</div>
                </div>
            </div>
        </div>

        <div id="profile-edit-area" style="display:none; margin-top:8px;">
            <label style="font-size:13px; color:var(--text-sec); margin-bottom:6px; display:block;">–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä</label>
            <input id="p-avatar-input" class="input-field" placeholder="https://...">
            <label style="font-size:13px; color:var(--text-sec); margin:8px 0 6px 0; display:block;">–û —Å–µ–±–µ</label>
            <textarea id="p-about-input" class="input-field" rows="4" style="resize:vertical;"></textarea>
        </div>

        <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
            <button id="btn-edit-profile" class="btn btn-primary" onclick="uiAction.startEditProfile()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="btn-save-profile" class="btn btn-primary" style="display:none;" onclick="uiAction.saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="btn-upgrade" class="btn btn-ghost" style="display:none;" onclick="uiAction.upgradeToGoogle()">üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å Google</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signInWithRedirect,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            sendPasswordResetEmail,
            onAuthStateChanged,
            signOut,
            linkWithPopup
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        import {
            getDatabase,
            ref,
            set,
            push,
            onValue,
            get,
            child,
            update,
            remove
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // global state
        window.state = {
            user: null,
            profile: null,
            isAdmin: false,
            activeAction: null,
            targetMessage: null,
            contextTarget: null,
            currentChat: { type: 'global', id: 'global', title: 'Global Chat Room' }
        };

        const usersCache = {};
        let currentMessagesUnsub = null;

        /* UI elements */
        const authErrorEl = document.getElementById('auth-error');
        const authInfoEl = document.getElementById('auth-info');

        function showAuthError(msg) { authErrorEl.style.display = 'block'; authErrorEl.innerText = msg; }
        function clearAuthMessages() { authErrorEl.style.display = 'none'; authErrorEl.innerText = ''; authInfoEl.style.display = 'none'; authInfoEl.innerText = ''; }

        /* AUTH UI wiring */
        document.getElementById('to-register').addEventListener('click', () => {
            clearAuthMessages();
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('register-view').style.display = 'block';
        });
        document.getElementById('to-login').addEventListener('click', () => {
            clearAuthMessages();
            document.getElementById('register-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'block';
        });

        // Email/password login
        document.getElementById('login-btn').addEventListener('click', async () => {
            clearAuthMessages();
            const email = document.getElementById('login-email').value.trim();
            const pwd = document.getElementById('login-password').value;
            if (!email || !pwd) { showAuthError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
            try {
                await signInWithEmailAndPassword(auth, email, pwd);
                // onAuthStateChanged will handle post-login flow
            } catch (err) {
                console.error(err);
                showAuthError(err.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
            }
        });

        // registration
        document.getElementById('register-btn').addEventListener('click', async () => {
            clearAuthMessages();
            const displayName = document.getElementById('reg-displayname').value.trim();
            const username = document.getElementById('reg-username').value.trim().replace('@','');
            const email = document.getElementById('reg-email').value.trim();
            const pwd = document.getElementById('reg-password').value;
            const avatar = document.getElementById('reg-avatar-url').value.trim();
            if (!displayName || !username || !email || !pwd) { showAuthError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è'); return; }
            if (pwd.length < 6) { showAuthError('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pwd);
                // create profile in DB
                const profile = {
                    uid: cred.user.uid,
                    displayName,
                    username: username.toLowerCase(),
                    usernameDisplay: username,
                    photoURL: avatar || cred.user.photoURL || 'https://via.placeholder.com/150',
                    about: ''
                };
                await set(ref(db, `users/${cred.user.uid}`), profile);
                // onAuthStateChanged will pick it up
            } catch (err) {
                console.error(err);
                showAuthError(err.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
            }
        });

        // password reset
        document.getElementById('forgot-password').addEventListener('click', async () => {
            clearAuthMessages();
            const email = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:');
            if (!email) return;
            try {
                await sendPasswordResetEmail(auth, email);
                authInfoEl.style.display = 'block';
                authInfoEl.innerText = '–ü–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É).';
            } catch (err) {
                console.error(err);
                showAuthError(err.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞');
            }
        });

        // Google button (secondary)
        document.getElementById('google-btn').addEventListener('click', async () => {
            clearAuthMessages();
            try {
                // try popup, fallback to redirect if fails
                await signInWithPopup(auth, provider);
            } catch (err) {
                console.warn('Popup failed ‚Äî falling back to redirect', err);
                try { await signInWithRedirect(auth, provider); }
                catch (e) { console.error(e); showAuthError(e.message || '–û—à–∏–±–∫–∞ Google –≤—Ö–æ–¥–∞'); }
            }
        });

        // sign out
        document.getElementById('signout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (err) {
                console.error('Sign out failed', err);
                alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + (err.message || err));
            }
        });

        /* AUTH STATE & PROFILE CREATION */
        onAuthStateChanged(auth, async (firebaseUser) => {
            console.log('onAuthStateChanged', firebaseUser);
            clearAuthMessages();
            if (!firebaseUser) {
                // not logged in, show auth screen
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app').classList.remove('visible');
                document.getElementById('app').style.display = 'none';
                return;
            }

            // user signed in
            window.state.user = firebaseUser;
            // ensure /users/{uid} exists
            try {
                const snap = await get(child(ref(db), `users/${firebaseUser.uid}`));
                if (snap.exists()) {
                    window.state.profile = snap.val();
                } else {
                    // create minimal profile from auth data
                    const displayName = firebaseUser.displayName || (firebaseUser.email ? firebaseUser.email.split('@')[0] : 'User');
                    const username = (displayName.split(' ')[0] || displayName).toLowerCase();
                    const profile = {
                        uid: firebaseUser.uid,
                        displayName,
                        username: username,
                        usernameDisplay: username,
                        photoURL: firebaseUser.photoURL || 'https://via.placeholder.com/150',
                        about: ''
                    };
                    await set(ref(db, `users/${firebaseUser.uid}`), profile);
                    window.state.profile = profile;
                }

                // Set admin flag if username admin
                if ((window.state.profile.usernameDisplay || '').toLowerCase() === 'admin') window.state.isAdmin = true;

                // Hide auth and show app
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                setTimeout(()=>document.getElementById('app').classList.add('visible'), 20);

                // populate top user info
                document.getElementById('user-profile-img').src = window.state.profile.photoURL || 'https://via.placeholder.com/150';
                document.getElementById('user-display-name').innerText = window.state.profile.displayName || '';
                document.getElementById('user-display-tag').innerText = '@' + (window.state.profile.usernameDisplay || '');

                // start app features
                themeCore.load();
                initUsersCacheListener();
                initSearch();
                initGroupSearch();
                uiAction.openGlobal();

                // show upgrade button (link anonymous to Google) if applicable
                document.getElementById('btn-upgrade').style.display = (firebaseUser.isAnonymous ? 'inline-flex' : 'none');
            } catch (err) {
                console.error('Error during post-auth flow', err);
                showAuthError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è: ' + (err.message || err));
            }
        });

        /* USERS CACHE */
        function initUsersCacheListener() {
            onValue(ref(db, 'users'), (snapshot) => {
                const val = snapshot.val() || {};
                Object.keys(val).forEach(k => usersCache[k] = val[k]);
                // update self-profile display if changed
                if (window.state.user && val[window.state.user.uid]) {
                    window.state.profile = val[window.state.user.uid];
                    document.getElementById('user-profile-img').src = window.state.profile.photoURL || 'https://via.placeholder.com/150';
                    document.getElementById('user-display-name').innerText = window.state.profile.displayName || '';
                    document.getElementById('user-display-tag').innerText = '@' + (window.state.profile.usernameDisplay || '');
                }
            });
        }

        /* SEARCH (for opening DM) */
        function initSearch() {
            const searchInput = document.getElementById('user-search-input');
            const resultsBox = document.createElement('div');
            resultsBox.style.position = 'relative';
            // minimal inline results (appending under search input)
            searchInput.parentNode.appendChild(resultsBox);
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim().toLowerCase().replace('@','');
                resultsBox.innerHTML = '';
                if (query.length < 2) return;
                const users = Object.values(usersCache || {});
                const found = users.filter(u => (u.username || '').includes(query) || (u.displayName || '').toLowerCase().includes(query));
                if (found.length === 0) return;
                const box = document.createElement('div');
                box.style.position = 'absolute';
                box.style.left = '0';
                box.style.right = '0';
                box.style.background = '#fff';
                box.style.border = '1px solid var(--border)';
                box.style.borderRadius = '10px';
                box.style.marginTop = '6px';
                box.style.maxHeight = '220px';
                box.style.overflowY = 'auto';
                found.forEach(u => {
                    const row = document.createElement('div');
                    row.className = 'chat-row';
                    row.style.padding = '8px 12px';
                    row.innerHTML = `<img src="${u.photoURL||'https://via.placeholder.com/150'}" class="user-avatar" style="width:36px;height:36px;">
                        <div style="flex:1;">
                            <div style="font-weight:700;">${u.displayName}</div>
                            <div class="muted-xs" style="color:var(--primary);">@${u.usernameDisplay||u.username}</div>
                        </div>`;
                    row.onclick = async () => {
                        if (u.uid === window.state.user.uid) { uiAction.openProfile(u.uid); return; }
                        await uiAction.openDM(u.uid);
                        resultsBox.innerHTML = '';
                        searchInput.value = '';
                    };
                    box.appendChild(row);
                });
                resultsBox.appendChild(box);
            });
        }

        /* GROUP SEARCH for create modal */
        function initGroupSearch() {
            const input = document.getElementById('group-add-search');
            if (!input) return;
            const results = document.getElementById('group-search-results');
            input.addEventListener('input', async (e) => {
                const q = e.target.value.trim().toLowerCase().replace('@','');
                results.innerHTML = '';
                if (q.length < 2) return;
                const users = Object.values(usersCache || {});
                const found = users.filter(u => (u.username || '').includes(q) || (u.displayName || '').toLowerCase().includes(q));
                found.forEach(u => {
                    const row = document.createElement('div');
                    row.className = 'user-select-row';
                    row.style.display = 'flex';
                    row.style.gap = '8px';
                    row.style.alignItems = 'center';
                    row.style.padding = '8px';
                    row.style.borderRadius = '8px';
                    row.style.border = '1px solid var(--border)';
                    row.style.marginBottom = '8px';
                    row.innerHTML = `<img src="${u.photoURL || 'https://via.placeholder.com/150'}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-weight:700;">${u.displayName}</div>
                            <div style="font-size:12px; color:var(--text-sec);">@${u.usernameDisplay||u.username}</div>
                        </div>
                        <button class="btn btn-primary" style="width:auto; padding:8px 10px;" onclick="uiAction.selectGroupMember('${u.uid}', '${escapeHtml(u.displayName)}', '${escapeHtml(u.photoURL||'')}')">–î–æ–±–∞–≤–∏—Ç—å</button>`;
                    results.appendChild(row);
                });
            });
        }

        function escapeHtml(s) { return (s||'').replace(/'/g, "\\'").replace(/"/g,'\\"'); }

        /* CHAT ENGINE (basic, supports global/dm/group paths) */
        window.chatEngine = {
            sendMessage: async function() {
                const input = document.getElementById('main-input');
                const text = input.value.trim();
                if (!text) return;
                const chat = window.state.currentChat || { type:'global', id:'global' };
                let path;
                if (chat.type === 'global') path = 'messages';
                else if (chat.type === 'dm') path = `dms/${chat.id}/messages`;
                else if (chat.type === 'group') path = `groups/${chat.id}/messages`;
                const messageData = {
                    uid: window.state.user.uid,
                    displayName: window.state.profile.displayName,
                    username: window.state.profile.usernameDisplay,
                    text,
                    createdAt: Date.now()
                };
                if (window.state.activeAction === 'reply' && window.state.targetMessage) {
                    messageData.replyTo = { author: window.state.targetMessage.displayName, content: window.state.targetMessage.text };
                }
                await push(ref(db, path), messageData);
                this.cancelAction();
            },

            openChatListener: function(path) {
                // detach previous listener by using a flag (onValue returns nothing here but still we keep reference)
                // NOTE: for proper unlisten you'd use off(ref, 'value', handler) with saved handler ‚Äî keeping simple here.
                const messagesContainer = document.getElementById('messages-view');
                messagesContainer.innerHTML = '<div class="muted-xs" style="padding:12px; opacity:0.6;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
                const messagesRef = ref(db, path);
                // Use onValue to listen live
                currentMessagesUnsub = onValue(messagesRef, (snapshot) => {
                    messagesContainer.innerHTML = '';
                    const data = snapshot.val();
                    if (!data) { messagesContainer.innerHTML = '<div class="muted-xs" style="padding:12px; opacity:0.6;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>'; return; }
                    Object.entries(data).sort((a,b)=>a[1].createdAt - b[1].createdAt).forEach(([msgId, msg]) => {
                        const isMyMessage = msg.uid === window.state.user.uid;
                        const wrapper = document.createElement('div');
                        wrapper.className = `msg-wrapper ${isMyMessage ? 'my-msg' : 'other-msg'}`;

                        const senderProfile = usersCache[msg.uid] || {};
                        const avatarURL = senderProfile.photoURL || msg.photoURL || 'https://via.placeholder.com/150';
                        const displayName = msg.displayName || senderProfile.displayName || 'User';
                        const usernameDisplay = (senderProfile.usernameDisplay || senderProfile.username || msg.username || '').toString();

                        let processedText = (msg.text || '').replace(/</g, "&lt;").replace(/>/g,"&gt;");
                        if (processedText.match(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i)) {
                            const url = processedText;
                            processedText = `<img src="${url}" style="max-width:100%; border-radius:8px; margin-top:5px; cursor:pointer;" onclick="window.open(this.src)">`;
                        } else {
                            processedText = processedText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                        }

                        const replyMarkup = msg.replyTo ? `<div style="font-size:12px; border-left:3px solid var(--primary); padding-left:10px; margin-bottom:8px; opacity:0.8;"><b>${msg.replyTo.author}</b><br>${(msg.replyTo.content||'').substring(0,80)}${(msg.replyTo.content && msg.replyTo.content.length>80)?'...':''}</div>` : '';

                        const avatarHTML = `<img src="${avatarURL}" class="msg-avatar" onclick="uiAction.openProfile('${msg.uid}')" title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">`;
                        const bubbleHTML = `<div class="msg-bubble" id="msg-${msgId}">
                            <span class="author-tag">${displayName} ${usernameDisplay.toLowerCase()==='admin' ? 'üëë' : ''}</span>
                            ${replyMarkup}
                            <div class="msg-content-body">${processedText}</div>
                            <span class="time-stamp">${msg.isEdited ? '–∏–∑–º. ' : ''} ${new Date(msg.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>`;
                        if (isMyMessage) wrapper.innerHTML = bubbleHTML + avatarHTML;
                        else wrapper.innerHTML = avatarHTML + bubbleHTML;

                        // --- SAFETY: force justify as a fallback to CSS (handles cases where css not applied immediately) ---
                        try {
                            wrapper.style.justifyContent = isMyMessage ? 'flex-end' : 'flex-start';
                        } catch (e) { /* ignore */ }

                        wrapper.oncontextmenu = (e) => { e.preventDefault(); window.chatEngine.openContextMenu(e, msgId, { key: msgId, ...msg }); };
                        messagesContainer.appendChild(wrapper);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            },

            openContextMenu: function(e, key, data) {
                window.state.contextTarget = { key, ...data };
                const popup = document.getElementById('context-popup');
                if (!popup) {
                    const p = document.createElement('div');
                    p.id = 'context-popup';
                    p.style.position = 'fixed';
                    p.style.zIndex = 10000;
                    p.style.background = '#fff';
                    p.style.border = '1px solid var(--border)';
                    p.style.padding = '8px';
                    p.style.borderRadius = '10px';
                    p.innerHTML = `<div style="padding:8px; cursor:pointer;" onclick="chatEngine.handleAction('reply')">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
                                   <div style="padding:8px; cursor:pointer;" onclick="chatEngine.handleAction('copy')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
                                   <div id="popup-edit-btn" style="padding:8px; cursor:pointer;" onclick="chatEngine.handleAction('edit')">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                                   <div id="popup-delete-btn" style="padding:8px; cursor:pointer; color:#ff3b30;" onclick="chatEngine.handleAction('delete')">üóë –£–¥–∞–ª–∏—Ç—å</div>`;
                    document.body.appendChild(p);
                }
                const popupEl = document.getElementById('context-popup');
                popupEl.style.display = 'block';
                let x = e.clientX, y = e.clientY;
                if (x + 220 > window.innerWidth) x -= 220;
                if (y + 150 > window.innerHeight) y -= 150;
                popupEl.style.left = x + 'px'; popupEl.style.top = y + 'px';
                const isMine = data.uid === window.state.user.uid;
                const editBtn = document.getElementById('popup-edit-btn');
                const delBtn = document.getElementById('popup-delete-btn');
                if (editBtn) editBtn.style.display = isMine ? 'block' : 'none';
                if (delBtn) delBtn.style.display = (isMine || window.state.isAdmin) ? 'block' : 'none';
            },

            handleAction: function(type) {
                const popup = document.getElementById('context-popup');
                if (popup) popup.style.display = 'none';
                if (type === 'reply' || type === 'edit') {
                    window.state.activeAction = type;
                    window.state.targetMessage = window.state.contextTarget;
                    document.getElementById('reply-preview').style.display = 'block';
                    document.getElementById('reply-author-name').innerText = type === 'edit' ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" : window.state.targetMessage.displayName;
                    document.getElementById('reply-author-text').innerText = window.state.targetMessage.text;
                    if (type === 'edit') document.getElementById('main-input').value = window.state.targetMessage.text;
                    document.getElementById('main-input').focus();
                } else if (type === 'copy') {
                    navigator.clipboard.writeText(window.state.contextTarget.text || '');
                } else if (type === 'delete') {
                    if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;
                    const chat = window.state.currentChat;
                    let path;
                    if (chat.type === 'global') path = `messages/${window.state.contextTarget.key}`;
                    else if (chat.type === 'dm') path = `dms/${chat.id}/messages/${window.state.contextTarget.key}`;
                    else if (chat.type === 'group') path = `groups/${chat.id}/messages/${window.state.contextTarget.key}`;
                    remove(ref(db, path));
                }
            },

            cancelAction: function() {
                window.state.activeAction = null; window.state.targetMessage = null;
                document.getElementById('reply-preview').style.display = 'none';
                document.getElementById('main-input').value = '';
            },

            attachImage: function() {
                const url = prompt("–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É:");
                if (url && url.startsWith('http')) { document.getElementById('main-input').value = url; this.sendMessage(); }
            }
        };

        /* THEME (kept simple) */
        window.themeCore = {
            load: function() {
                // placeholder for UI prefs
            }
        };

        /* UI ACTIONS (auth/profile/dm/group) */
        window.uiAction = {
            openGlobal: () => {
                window.state.currentChat = { type: 'global', id: 'global', title: 'Global Chat Room' };
                document.getElementById('chat-top-title').innerText = 'Global Chat Room';
                document.getElementById('chat-top-sub').innerText = '–û–±—â–∏–π —á–∞—Ç';
                document.getElementById('chat-top-avatar').src = 'https://cdn-icons-png.flaticon.com/512/1041/1041916.png';
                chatEngine.openChatListener('messages');
            },

            openDM: async (otherUid) => {
                const u1 = window.state.user.uid;
                const u2 = otherUid;
                const chatId = ['dm', ...[u1, u2].sort()].join('_');
                const metaRef = ref(db, `dms/${chatId}/meta`);
                const metaSnap = await get(metaRef);
                if (!metaSnap.exists()) {
                    const meta = { members: { [u1]: true, [u2]: true }, createdAt: Date.now() };
                    await set(metaRef, meta);
                }
                const other = usersCache[otherUid] || {};
                window.state.currentChat = { type:'dm', id:chatId, title: other.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç', photo: other.photoURL || '', otherUid };
                document.getElementById('chat-top-title').innerText = other.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç';
                document.getElementById('chat-top-sub').innerText = '@' + (other.usernameDisplay || other.username || '');
                document.getElementById('chat-top-avatar').src = other.photoURL || 'https://via.placeholder.com/150';
                chatEngine.openChatListener(`dms/${chatId}/messages`);
            },

            openProfile: (uid) => {
                if (!uid) return;
                const user = usersCache[uid] || (window.state.user && uid === window.state.user.uid ? window.state.profile : null);
                if (!user) { alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                overlay.classList.add('active'); modal.classList.add('active'); modal.setAttribute('aria-hidden','false');

                document.getElementById('p-avatar').src = user.photoURL || 'https://via.placeholder.com/150';
                document.getElementById('p-displayname').innerText = user.displayName || 'User';
                document.getElementById('p-username').innerText = '@' + (user.usernameDisplay || user.username || '');
                document.getElementById('p-about').innerText = user.about || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.';

                if (window.state.user && uid === window.state.user.uid) {
                    document.getElementById('profile-edit-area').style.display = 'block';
                    document.getElementById('p-avatar-input').value = user.photoURL || '';
                    document.getElementById('p-about-input').value = user.about || '';
                    document.getElementById('btn-edit-profile').style.display = 'inline-flex';
                    document.getElementById('btn-save-profile').style.display = 'none';
                    // show upgrade option if anonymous
                    document.getElementById('btn-upgrade').style.display = (auth.currentUser && auth.currentUser.isAnonymous) ? 'inline-flex' : 'none';
                } else {
                    document.getElementById('profile-edit-area').style.display = 'none';
                    document.getElementById('btn-edit-profile').style.display = 'none';
                    document.getElementById('btn-save-profile').style.display = 'none';
                    document.getElementById('btn-upgrade').style.display = 'none';
                }
            },

            closeProfile: () => {
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                overlay.classList.remove('active'); modal.classList.remove('active'); modal.setAttribute('aria-hidden','true');
            },

            startEditProfile: () => {
                document.getElementById('profile-edit-area').style.display = 'block';
                document.getElementById('btn-edit-profile').style.display = 'none';
                document.getElementById('btn-save-profile').style.display = 'inline-flex';
            },

            saveProfile: async () => {
                if (!window.state.user) return;
                const newAva = document.getElementById('p-avatar-input').value.trim();
                const newAbout = document.getElementById('p-about-input').value.trim();
                if (newAva && !/^https?:\/\//i.test(newAva)) return alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http/https');
                const updates = {};
                if (newAva) updates.photoURL = newAva;
                updates.about = newAbout || '';
                try {
                    await update(ref(db, `users/${window.state.user.uid}`), updates);
                    if (updates.photoURL) {
                        document.getElementById('p-avatar').src = updates.photoURL;
                        document.getElementById('user-profile-img').src = updates.photoURL;
                    }
                    document.getElementById('p-about').innerText = updates.about;
                    window.state.profile = Object.assign(window.state.profile || {}, updates);
                    document.getElementById('profile-edit-area').style.display = 'none';
                    document.getElementById('btn-edit-profile').style.display = 'inline-flex';
                    document.getElementById('btn-save-profile').style.display = 'none';
                    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
                } catch (err) {
                    console.error(err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
                }
            },

            upgradeToGoogle: async () => {
                // Link anonymous account to Google
                if (!auth.currentUser) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                if (!auth.currentUser.isAnonymous) return alert('–£–∂–µ –Ω–µ –≥–æ—Å—Ç–µ–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç');
                try {
                    const result = await linkWithPopup(auth.currentUser, provider);
                    // merge profile data from Google
                    const pd = (result.user.providerData && result.user.providerData[0]) || {};
                    const updates = {};
                    if (pd.displayName) updates.displayName = pd.displayName;
                    if (pd.photoURL) updates.photoURL = pd.photoURL;
                    await update(ref(db, `users/${result.user.uid}`), updates);
                    alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ Google');
                    uiAction.closeProfile();
                } catch (err) {
                    console.error(err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏: ' + (err.message || err));
                }
            },

            /* GROUP creation helpers (kept minimal reusing previous logic) */
            openCreateGroup: () => {
                // placeholder if you add group modal
            },

            selectGroupMember: (uid, name, photo) => {
                // placeholder
            }
        };

        /* helper - open current chat info */
        uiAction.openCurrentTargetInfo = () => {
            const c = window.state.currentChat;
            if (c.type === 'dm') uiAction.openProfile(c.otherUid);
            else if (c.type === 'group') uiAction.openProfile(window.state.user.uid); // placeholder
            else uiAction.openProfile(window.state.user.uid);
        };

        // simple click-away to hide context popup
        document.addEventListener('click', (e) => { const p = document.getElementById('context-popup'); if (p && !e.target.closest('#context-popup')) p.style.display = 'none'; });

        // Enter to send
        document.getElementById('main-input').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); chatEngine.sendMessage(); } });

        // init empty cache listener to keep usersCache updated
        function initDummyUsersListener() {
            // already used in initUsersCacheListener which uses onValue('users')
        }

        /* Group search init (if group modal exists) */
        // call initGroupSearch inside post-auth flow if needed

        // End of main script
    </script>
</body>
</html>
