<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Narrators Messenger v0.1.3 | Integrated Search</title>

    <style>
        :root {
            /* –¢–≤–æ—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
            --primary: #3390ec;
            --primary-soft: rgba(51, 144, 236, 0.1);
            --bg-body: #ffffff;
            --bg-chat-img: none;
            --bg-chat-color: #ffffff;
            --msg-me: #eeffde;
            --msg-me-text: #000000;
            --msg-other: #f4f4f5;
            --msg-other-text: #000000;
            --radius: 12px;
            --font-size: 16px;
            --bubble-opacity: 1;
            --bg-sidebar: #ffffff;
            --border: #e4e4e4;
            --text-main: #000000;
            --text-sec: #707579;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --ease: cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; 
            padding: 0;
            outline: none;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            height: 100vh; 
            width: 100vw; 
            display: flex; 
            overflow: hidden; 
            background: var(--bg-body); 
            color: var(--text-main);
            font-size: var(--font-size);
            line-height: 1.5;
        }

        button { 
            cursor: pointer; 
            border: none; 
            transition: all 0.2s ease; 
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:active { 
            transform: scale(0.95); 
            opacity: 0.8; 
        }

        .panel { 
            position: fixed; 
            inset: 0; 
            background: #ffffff; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            padding: 30px;
            text-align: center;
        }
        
        .auth-card {
            width: 100%; 
            max-width: 360px;
            padding: 20px;
        }

        .input-field { 
            padding: 15px; 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            width: 100%; 
            font-size: 16px; 
            background: #fdfdfd;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: var(--primary);
        }

        .btn-main { 
            padding: 16px; 
            background: var(--primary); 
            color: #ffffff; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 16px; 
            width: 100%;
            box-shadow: 0 4px 15px rgba(51, 144, 236, 0.2);
        }

        #app { 
            display: none; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            transition: opacity 0.6s var(--ease); 
        }

        #app.visible { 
            display: flex; 
            opacity: 1; 
        }

        #sidebar { 
            width: 380px; 
            flex-shrink: 0; 
            background: var(--bg-sidebar); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            z-index: 500;
        }

        .sidebar-top { 
            padding: 15px 20px; 
            display: flex; 
            align-items: center; 
            gap: 15px;
            border-bottom: 1px solid var(--border);
        }

        .chat-list-container { 
            flex: 1; 
            overflow-y: auto; 
        }

        .chat-row { 
            padding: 12px 20px; 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            cursor: pointer; 
            border-bottom: 1px solid #f9f9f9;
        }

        .chat-row:hover { background: #f7f9fb; }
        .chat-row.active { background: var(--primary-soft); }

        .user-avatar { 
            width: 55px; 
            height: 55px; 
            border-radius: 50%; 
            background: #f0f0f0; 
            object-fit: cover;
            flex-shrink: 0;
        }

        #chat-window { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background-color: var(--bg-chat-color); 
            background-image: var(--bg-chat-img); 
            background-size: cover; 
            position: relative;
        }

        .chat-top-bar { 
            height: 65px; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            padding: 0 25px; 
            z-index: 100;
        }

        #messages-view { 
            flex: 1; 
            overflow-y: auto; 
            padding: 25px 8%; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            scroll-behavior: smooth;
        }

        .msg-wrapper { 
            display: flex; 
            width: 100%; 
            animation: slideIn 0.35s var(--ease); 
            align-items: flex-end;
            gap: 10px;
        }

        .msg-wrapper.my-msg { justify-content: flex-end; }

        .msg-bubble { 
            padding: 12px 16px; 
            border-radius: var(--radius); 
            max-width: 70%; 
            position: relative; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            word-wrap: break-word;
        }

        .msg-wrapper.other-msg .msg-bubble { 
            background: var(--msg-other); 
            color: var(--msg-other-text); 
            border-bottom-left-radius: 4px; 
        }

        .msg-wrapper.my-msg .msg-bubble { 
            background: var(--msg-me); 
            color: var(--msg-me-text); 
            border-bottom-right-radius: 4px; 
        }

        .author-tag { 
            font-size: 13px; 
            font-weight: 700; 
            color: var(--primary); 
            margin-bottom: 5px; 
            display: block;
        }

        .time-stamp { 
            font-size: 11px; 
            opacity: 0.5; 
            text-align: right; 
            margin-top: 5px; 
            display: block; 
        }

        .bottom-controls { 
            background: #ffffff; 
            padding: 15px 25px; 
            border-top: 1px solid var(--border); 
        }

        .input-group { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }

        #main-input { 
            flex: 1; 
            border: none; 
            font-size: 16px; 
            padding: 5px 0;
            resize: none; 
            max-height: 120px; 
            background: transparent; 
        }

        #side-menu { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 320px; 
            height: 100%; 
            background: #ffffff; 
            z-index: 2000; 
            transform: translateX(-100%); 
            transition: transform 0.4s var(--ease); 
            display: flex; 
            flex-direction: column; 
            box-shadow: 10px 0 30px rgba(0,0,0,0.1);
        }

        #side-menu.active { transform: translateX(0); }

        .menu-header { 
            padding: 40px 25px; 
            background: var(--primary); 
            color: #ffffff; 
        }

        .menu-items { padding: 15px; flex: 1; }

        .menu-link { 
            padding: 14px 18px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 15px; 
            margin-bottom: 5px;
        }

        .menu-link:hover { background: #f5f5f5; }

        #context-popup { 
            position: fixed; 
            background: #ffffff; 
            width: 200px; 
            border-radius: 14px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            z-index: 10000; 
            display: none; 
            padding: 8px; 
        }

        .popup-item { 
            padding: 12px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
        }

        .popup-item:hover { background: #f0f0f0; }

        /* Avatar next to message */
        .msg-avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; cursor:pointer; flex-shrink:0; }
        .msg-wrapper.other-msg .msg-avatar { order: 0; margin-right:8px; }
        .msg-wrapper.other-msg .msg-bubble { order: 1; }
        .msg-wrapper.my-msg .msg-avatar { order: 1; margin-left:8px; }
        .msg-wrapper.my-msg .msg-bubble { order: 0; }

        /* Profile modal */
        .profile-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            z-index: 10001;
            display: none;
            backdrop-filter: blur(3px);
        }
        .profile-overlay.active { display:block; }

        .profile-modal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: #fff;
            z-index: 10002;
            width: 92%;
            max-width: 520px;
            border-radius: 14px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35);
            padding: 22px;
            display: none;
            transition: transform 0.22s var(--ease), opacity 0.2s var(--ease);
            opacity: 0;
        }
        .profile-modal.active { display:block; transform: translate(-50%,-50%) scale(1); opacity: 1; }

        .profile-top { display:flex; gap:16px; align-items:center; margin-bottom:12px; }
        .profile-top img { width:96px; height:96px; border-radius:14px; object-fit:cover; border:4px solid rgba(0,0,0,0.04); }
        .profile-name { font-size:20px; font-weight:800; }
        .profile-username { color:var(--text-sec); font-size:13px; }

        .profile-about { margin-top:8px; color:var(--text-sec); font-size:14px; white-space:pre-wrap; }

        .profile-controls { display:flex; gap:10px; margin-top:18px; justify-content:flex-end; }

        .input-plain { width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); font-size:14px; }

        @keyframes slideIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        @media (max-width: 850px) {
            #sidebar { width: 100%; }
            #chat-window { 
                display: none; 
                position: fixed; 
                inset: 0; 
                z-index: 600; 
            }
            body.is-chatting #chat-window { display: flex; }
            .mobile-back-btn { display: flex !important; }
        }

        .mobile-back-btn { display: none; font-size: 24px; margin-right: 15px; }

        .blur-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 1999;
            display: none;
            backdrop-filter: blur(2px);
        }
        .blur-overlay.active { display: block; }
    </style>
</head>
<body>

    <div id="screen-auth" class="panel">
        <div class="auth-card">
            <h1 style="color:var(--primary); font-size:48px; letter-spacing:-1px; margin-bottom:5px;">Narrators</h1>
            <p style="color:var(--text-sec); margin-bottom:40px; font-size:14px;">Product Version 0.1.3 Production</p>
            
            <button id="auth-google-trigger" class="btn-main" style="background:#fff; color:#444; border:1px solid #ddd; box-shadow:none;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" style="margin-right:12px;">
                –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç Google
            </button>
            <p style="margin-top:25px; font-size:12px; color:#aaa; line-height:1.6;">
                –í—Ö–æ–¥—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ Narrators.
            </p>
        </div>
    </div>

    <div id="screen-reg" class="panel" style="display:none;">
        <div class="auth-card">
            <h2 style="margin-bottom:10px; font-size:28px;">–ó–∞–≤–µ—Ä—à–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É</h2>
            <p style="color:var(--text-sec); margin-bottom:30px;">–ö–∞–∫ –≤–∞—Å –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏?</p>
            
            <div style="text-align:left;">
                <label style="font-size:12px; font-weight:700; color:var(--primary); margin-left:10px; margin-bottom:5px; display:block;">–í–ê–®–ï –ò–ú–Ø</label>
                <input id="reg-nickname" class="input-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                
                <label style="font-size:12px; font-weight:700; color:var(--primary); margin-left:10px; margin-bottom:5px; display:block;">–£–ù–ò–ö–ê–õ–¨–ù–´–ô –¢–ï–ì</label>
                <input id="reg-username" class="input-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ivan_cool">
                
                <label style="font-size:12px; font-weight:700; color:var(--primary); margin-left:10px; margin-bottom:5px; display:block;">–°–°–´–õ–ö–ê –ù–ê –ê–í–ê–¢–ê–† (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)</label>
                <input id="reg-avatar-url" class="input-field" placeholder="https://image.com/my-photo.jpg">
            </div>

            <button id="reg-confirm-btn" class="btn-main" style="margin-top:10px;">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
        </div>
    </div>

    <div id="app">
        <div id="app-overlay" class="blur-overlay" onclick="uiAction.closeMenu()"></div>
        
        <div id="side-menu">
            <div class="menu-header">
                <img id="user-profile-img" class="user-avatar" style="width:80px; height:80px; border:4px solid rgba(255,255,255,0.2); margin-bottom:15px;">
                <div id="user-display-name" style="font-weight:700; font-size:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div id="user-display-tag" style="opacity:0.7; font-size:14px;">@username</div>
            </div>
            
            <div class="menu-items">
                <div id="menu-view-main">
                    <div class="menu-link" onclick="uiAction.showSettings()">üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞</div>
                    <div class="menu-link" onclick="uiAction.openProfile(window.state?.user?.uid || '')">üë§ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
                    <div class="menu-link" onclick="uiAction.logout()" style="color:#ff3b30; margin-top:20px;">üö™ –í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è</div>
                </div>

                <div id="menu-view-settings" style="display:none;">
                    <button onclick="uiAction.hideSettings()" style="color:var(--primary); font-weight:700; margin-bottom:20px; font-size:13px;">‚¨Ö –ù–ê–ó–ê–î –í –ú–ï–ù–Æ</button>
                    <div style="display:flex; flex-direction:column; gap:20px;">
                        <div class="setting-item">
                            <label style="display:block; font-size:12px; margin-bottom:8px;">–†–ê–ó–ú–ï–† –®–†–ò–§–¢–ê (px)</label>
                            <input type="range" id="ui-font-range" min="12" max="22" value="16" style="width:100%;" oninput="themeCore.preview()">
                        </div>
                        <div class="setting-item">
                            <label style="display:block; font-size:12px; margin-bottom:8px;">–°–ö–†–£–ì–õ–ï–ù–ò–ï –£–ì–õ–û–í (px)</label>
                            <input type="range" id="ui-radius-range" min="0" max="25" value="12" style="width:100%;" oninput="themeCore.preview()">
                        </div>
                        <div class="setting-item">
                            <label style="display:block; font-size:12px; margin-bottom:8px;">–û–°–ù–û–í–ù–û–ô –¶–í–ï–¢</label>
                            <input type="color" id="ui-color-primary" value="#3390ec" style="width:100%; height:40px; border:none; cursor:pointer;" oninput="themeCore.preview()">
                        </div>
                        <div class="setting-item">
                            <label style="display:block; font-size:12px; margin-bottom:8px;">–¶–í–ï–¢ –ú–û–ò–• –°–û–û–ë–©–ï–ù–ò–ô</label>
                            <input type="color" id="ui-color-me" value="#eeffde" style="width:100%; height:40px; border:none;" oninput="themeCore.preview()">
                        </div>
                    </div>
                    <button class="btn-main" onclick="themeCore.save()" style="margin-top:40px; padding:12px;">–ü–†–ò–ú–ï–ù–ò–¢–¨ –ò –°–û–•–†–ê–ù–ò–¢–¨</button>
                </div>
            </div>
        </div>

        <div id="sidebar">
            <div class="sidebar-top">
                <button onclick="uiAction.openMenu()" style="font-size:24px; color:var(--text-sec);">‚ò∞</button>
                <div style="font-weight:800; font-size:20px; flex:1; text-align:center; letter-spacing:-0.5px;">Narrators</div>
            </div>

            <div style="padding: 10px 15px; border-bottom: 1px solid var(--border);">
                <input id="user-search-input" class="input-field" placeholder="–ü–æ–∏—Å–∫ –ø–æ @—Ç–µ–≥—É..." style="margin-bottom:0; padding:10px; font-size:14px; border-radius: 8px;">
            </div>
            <div id="search-results" style="display:none; max-height: 200px; overflow-y: auto; background: #fafafa; border-bottom: 2px solid var(--primary-soft);">
                </div>
            
            <div class="chat-list-container">
                <div class="chat-row active" onclick="uiAction.openChatRoom()">
                    <div style="position:relative;">
                        <img src="https://cdn-icons-png.flaticon.com/512/1041/1041916.png" class="user-avatar">
                    </div>
                    <div style="flex:1; overflow:hidden;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b style="font-size:16px;">Global Chat Room</b>
                            <span style="font-size:11px; color:#aaa;">online</span>
                        </div>
                        <div style="font-size:13px; color:var(--text-sec); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ–±—â–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ!
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-window">
            <div class="chat-top-bar">
                <button class="mobile-back-btn" onclick="uiAction.closeChatRoom()">‚¨Ö</button>
                <div style="display:flex; align-items:center; gap:12px;">
                    <div>
                        <div style="font-weight:700; font-size:17px;">Global Chat Room</div>
                        <div style="font-size:12px; color:var(--primary);">v0.1.3 Production Channel</div>
                    </div>
                </div>
            </div>

            <div id="messages-view"></div>

            <div class="bottom-controls">
                <div id="reply-preview" style="display:none; background:#f5f5f5; padding:10px; border-left:4px solid var(--primary); margin-bottom:12px; border-radius:5px; align-items:center; justify-content:space-between;">
                    <div style="overflow:hidden;">
                        <b id="reply-author-name" style="color:var(--primary); font-size:13px;"></b><br>
                        <span id="reply-author-text" style="font-size:13px; opacity:0.7;"></span>
                    </div>
                    <button onclick="chatEngine.cancelAction()" style="padding:5px;">‚úï</button>
                </div>

                <div class="input-group">
                    <button onclick="chatEngine.attachImage()" style="font-size:22px; color:#999;">üì∑</button>
                    <textarea id="main-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..." rows="1"></textarea>
                    <button id="send-msg-btn" onclick="chatEngine.sendMessage()" style="color:var(--primary); font-size:26px;">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="context-popup">
        <div class="popup-item" onclick="chatEngine.handleAction('reply')">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="popup-item" onclick="chatEngine.handleAction('copy')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</div>
        <div id="popup-edit-btn" class="popup-item" onclick="chatEngine.handleAction('edit')">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        <div id="popup-delete-btn" class="popup-item" onclick="chatEngine.handleAction('delete')" style="color:#ff3b30;">üóë –£–¥–∞–ª–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö</div>
    </div>

    <!-- PROFILE MODAL & OVERLAY -->
    <div id="profile-overlay" class="profile-overlay" onclick="uiAction.closeProfile()"></div>
    <div id="profile-modal" class="profile-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:800;">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <button onclick="uiAction.closeProfile()" style="background:transparent; font-size:18px; padding:6px;">‚úï</button>
        </div>

        <div class="profile-top">
            <img id="p-avatar" src="https://via.placeholder.com/150" alt="avatar">
            <div style="flex:1;">
                <div class="profile-name" id="p-displayname">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                <div class="profile-username" id="p-username">@username</div>
                <div style="margin-top:6px;">
                    <small style="color:var(--text-sec);">–û —Å–µ–±–µ:</small>
                    <div class="profile-about" id="p-about">–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.</div>
                </div>
            </div>
        </div>

        <div id="profile-edit-area" style="display:none; margin-top:8px;">
            <label style="font-size:13px; color:var(--text-sec); margin-bottom:6px; display:block;">–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä</label>
            <input id="p-avatar-input" class="input-plain" placeholder="https://...">
            <label style="font-size:13px; color:var(--text-sec); margin:8px 0 6px 0; display:block;">–û —Å–µ–±–µ</label>
            <textarea id="p-about-input" class="input-plain" rows="4" style="resize:vertical;"></textarea>
        </div>

        <div class="profile-controls">
            <button id="btn-edit-profile" class="btn-main" style="background:var(--primary); padding:8px 12px;" onclick="uiAction.startEditProfile()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="btn-save-profile" class="btn-main" style="display:none; background:var(--primary); padding:8px 12px;" onclick="uiAction.saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithRedirect, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, get, child, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // Global state accessible from inline handlers
        window.state = {
            user: null,
            profile: null,
            isAdmin: false,
            activeAction: null,
            targetMessage: null,
            contextTarget: null
        };

        // Cache of users for quick profile lookup
        const usersCache = {};

        document.getElementById('auth-google-trigger').addEventListener('click', () => {
            signInWithRedirect(auth, provider);
        });

        onAuthStateChanged(auth, (firebaseUser) => {
            if (firebaseUser) {
                window.state.user = firebaseUser;
                validateUserProfile();
            } else {
                toggleScreen('screen-auth');
            }
        });

        async function validateUserProfile() {
            const userRef = ref(db);
            try {
                const snapshot = await get(child(userRef, `users/${window.state.user.uid}`));
                if (snapshot.exists()) {
                    window.state.profile = snapshot.val();
                    launchMainApp();
                } else {
                    toggleScreen('screen-reg');
                    document.getElementById('reg-nickname').value = window.state.user.displayName || "";
                }
            } catch (error) { console.error(error); }
        }

        document.getElementById('reg-confirm-btn').addEventListener('click', async () => {
            const nick = document.getElementById('reg-nickname').value.trim();
            const tag = document.getElementById('reg-username').value.trim().replace('@', '');
            const ava = document.getElementById('reg-avatar-url').value.trim();

            if (nick.length < 2 || tag.length < 2) return alert("–ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞");

            window.state.profile = {
                uid: window.state.user.uid,
                displayName: nick,
                username: tag.toLowerCase(),
                usernameDisplay: tag,
                photoURL: ava || window.state.user.photoURL || 'https://via.placeholder.com/150',
                about: ''
            };

            await set(ref(db, `users/${window.state.user.uid}`), window.state.profile);
            launchMainApp();
        });

        function launchMainApp() {
            toggleScreen('app');
            document.getElementById('app').classList.add('visible');
            document.getElementById('user-profile-img').src = window.state.profile.photoURL || 'https://via.placeholder.com/150';
            document.getElementById('user-display-name').innerText = window.state.profile.displayName;
            document.getElementById('user-display-tag').innerText = '@' + window.state.profile.usernameDisplay;

            if ((window.state.profile.usernameDisplay || '').toLowerCase() === 'admin') window.state.isAdmin = true;

            themeCore.load();
            initUsersCacheListener(); // —Å–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π
            chatEngine.listen();
            initSearch(); // –ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞
        }

        /* --- USERS CACHE --- */
        function initUsersCacheListener() {
            onValue(ref(db, 'users'), (snapshot) => {
                const val = snapshot.val() || {};
                // shallow copy
                Object.keys(val).forEach(k => usersCache[k] = val[k]);
                // If our profile changed remotely, update local UI/state
                if (window.state.user && val[window.state.user.uid]) {
                    window.state.profile = val[window.state.user.uid];
                    document.getElementById('user-profile-img').src = window.state.profile.photoURL || 'https://via.placeholder.com/150';
                    document.getElementById('user-display-name').innerText = window.state.profile.displayName || '';
                    document.getElementById('user-display-tag').innerText = '@' + (window.state.profile.usernameDisplay || '');
                }
            });
        }

        /* --- –õ–û–ì–ò–ö–ê –ü–û–ò–°–ö–ê --- */
        function initSearch() {
            const searchInput = document.getElementById('user-search-input');
            const resultsBox = document.getElementById('search-results');

            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim().toLowerCase().replace('@', '');
                if (query.length < 2) {
                    resultsBox.style.display = 'none';
                    return;
                }

                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const found = Object.values(users).filter(u => 
                        (u.username || '').includes(query) || (u.displayName || '').toLowerCase().includes(query)
                    );

                    resultsBox.innerHTML = '';
                    if (found.length > 0) {
                        resultsBox.style.display = 'block';
                        found.forEach(user => {
                            const div = document.createElement('div');
                            div.className = 'chat-row';
                            div.style.padding = '8px 15px';
                            div.innerHTML = `
                                <img src="${user.photoURL || 'https://via.placeholder.com/150'}" class="user-avatar" style="width:35px; height:35px;">
                                <div>
                                    <div style="font-size:14px; font-weight:700;">${user.displayName}</div>
                                    <div style="font-size:11px; color:var(--primary);">@${user.usernameDisplay || user.username}</div>
                                </div>
                            `;
                            div.onclick = () => {
                                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ —Ü–µ–Ω—Ç—Ä–µ) –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –ø–æ–∏—Å–∫–∞
                                uiAction.openProfile(user.uid);
                            };
                            resultsBox.appendChild(div);
                        });
                    } else { resultsBox.style.display = 'none'; }
                }
            });
        }

        window.chatEngine = {
            sendMessage: function() {
                const input = document.getElementById('main-input');
                const text = input.value.trim();
                if (!text) return;

                if (window.state.activeAction === 'edit' && window.state.targetMessage) {
                    update(ref(db, `messages/${window.state.targetMessage.key}`), { text: text, isEdited: true });
                } else {
                    const messageData = {
                        uid: window.state.user.uid,
                        displayName: window.state.profile.displayName,
                        username: window.state.profile.usernameDisplay,
                        text: text,
                        createdAt: Date.now()
                    };
                    if (window.state.activeAction === 'reply' && window.state.targetMessage) {
                        messageData.replyTo = { author: window.state.targetMessage.displayName, content: window.state.targetMessage.text };
                    }
                    push(ref(db, 'messages'), messageData);
                }
                this.cancelAction();
            },

            listen: function() {
                const messagesContainer = document.getElementById('messages-view');
                onValue(ref(db, 'messages'), (snapshot) => {
                    messagesContainer.innerHTML = '';
                    const data = snapshot.val();
                    if (!data) return;

                    Object.entries(data).sort((a,b) => a[1].createdAt - b[1].createdAt).forEach(([msgId, msg]) => {
                        const isMyMessage = msg.uid === window.state.user.uid;
                        const wrapper = document.createElement('div');
                        wrapper.className = `msg-wrapper ${isMyMessage ? 'my-msg' : 'other-msg'}`;

                        // Resolve avatar from users cache (fallbacks if not present)
                        const senderProfile = usersCache[msg.uid] || {};
                        const avatarURL = senderProfile.photoURL || msg.photoURL || 'https://via.placeholder.com/150';
                        const displayName = msg.displayName || senderProfile.displayName || 'User';
                        const usernameDisplay = (senderProfile.usernameDisplay || senderProfile.username || msg.username || '').toString();

                        // Sanitize text
                        let processedText = (msg.text || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        if (processedText.match(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i)) {
                            const url = processedText;
                            processedText = `<img src="${url}" style="max-width:100%; border-radius:8px; margin-top:5px; cursor:pointer;" onclick="window.open(this.src)">`;
                        } else {
                            // convert simple URLs to links
                            processedText = processedText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                        }

                        const replyMarkup = msg.replyTo ? `<div style="font-size:12px; border-left:3px solid var(--primary); padding-left:10px; margin-bottom:8px; opacity:0.8;"><b>${msg.replyTo.author}</b><br>${(msg.replyTo.content || '').substring(0, 80)}${(msg.replyTo.content && msg.replyTo.content.length>80)?'...':''}</div>` : '';

                        // Build HTML with avatar + bubble
                        const avatarHTML = `<img src="${avatarURL}" class="msg-avatar" onclick="uiAction.openProfile('${msg.uid}')" title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">`;
                        const bubbleHTML = `
                            <div class="msg-bubble" id="msg-${msgId}">
                                <span class="author-tag">${displayName} ${usernameDisplay.toLowerCase() === 'admin' ? 'üëë' : ''}</span>
                                ${replyMarkup}
                                <div class="msg-content-body">${processedText}</div>
                                <span class="time-stamp">${msg.isEdited ? '–∏–∑–º. ' : ''} ${new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>
                        `;

                        // Order avatar and bubble depending on author
                        if (isMyMessage) {
                            wrapper.innerHTML = bubbleHTML + avatarHTML;
                        } else {
                            wrapper.innerHTML = avatarHTML + bubbleHTML;
                        }

                        // attach context menu on bubble
                        const bubbleEl = wrapper.querySelector('.msg-bubble');
                        wrapper.oncontextmenu = (e) => { e.preventDefault(); window.chatEngine.openContextMenu(e, msgId, { key: msgId, ...msg }); };
                        // also allow clicking avatar to open profile (already inline)
                        messagesContainer.appendChild(wrapper);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            },

            openContextMenu: function(e, key, data) {
                window.state.contextTarget = { key, ...data };
                const popup = document.getElementById('context-popup');
                popup.style.display = 'block';
                let x = e.clientX, y = e.clientY;
                if (x + 200 > window.innerWidth) x -= 200;
                if (y + 150 > window.innerHeight) y -= 150;
                popup.style.left = x + 'px'; popup.style.top = y + 'px';
                const isMine = data.uid === window.state.user.uid;
                document.getElementById('popup-edit-btn').style.display = isMine ? 'block' : 'none';
                document.getElementById('popup-delete-btn').style.display = (isMine || window.state.isAdmin) ? 'block' : 'none';
            },

            handleAction: function(type) {
                document.getElementById('context-popup').style.display = 'none';
                if (type === 'reply' || type === 'edit') {
                    window.state.activeAction = type;
                    window.state.targetMessage = window.state.contextTarget;
                    document.getElementById('reply-preview').style.display = 'flex';
                    document.getElementById('reply-author-name').innerText = type === 'edit' ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" : window.state.targetMessage.displayName;
                    document.getElementById('reply-author-text').innerText = window.state.targetMessage.text;
                    if (type === 'edit') document.getElementById('main-input').value = window.state.targetMessage.text;
                    document.getElementById('main-input').focus();
                } else if (type === 'copy') {
                    navigator.clipboard.writeText(window.state.contextTarget.text || '');
                } else if (type === 'delete') {
                    if (confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) remove(ref(db, `messages/${window.state.contextTarget.key}`));
                }
            },

            cancelAction: function() {
                window.state.activeAction = null; window.state.targetMessage = null;
                document.getElementById('reply-preview').style.display = 'none';
                document.getElementById('main-input').value = '';
            },

            attachImage: function() {
                const url = prompt("–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É:");
                if (url && url.startsWith('http')) { document.getElementById('main-input').value = url; this.sendMessage(); }
            }
        };

        window.themeCore = {
            preview: function() {
                const root = document.documentElement.style;
                root.setProperty('--font-size', document.getElementById('ui-font-range').value + 'px');
                root.setProperty('--radius', document.getElementById('ui-radius-range').value + 'px');
                root.setProperty('--primary', document.getElementById('ui-color-primary').value);
                root.setProperty('--msg-me', document.getElementById('ui-color-me').value);
            },
            save: function() {
                const settings = { fz: document.getElementById('ui-font-range').value, rd: document.getElementById('ui-radius-range').value, pr: document.getElementById('ui-color-primary').value, me: document.getElementById('ui-color-me').value };
                localStorage.setItem('narrators_custom_ui', JSON.stringify(settings));
                uiAction.closeMenu();
            },
            load: function() {
                const saved = localStorage.getItem('narrators_custom_ui');
                if (saved) {
                    const t = JSON.parse(saved);
                    document.getElementById('ui-font-range').value = t.fz;
                    document.getElementById('ui-radius-range').value = t.rd;
                    document.getElementById('ui-color-primary').value = t.pr;
                    document.getElementById('ui-color-me').value = t.me;
                    this.preview();
                }
            }
        };

        window.uiAction = {
            openMenu: () => { document.getElementById('side-menu').classList.add('active'); document.getElementById('app-overlay').classList.add('active'); },
            closeMenu: () => { document.getElementById('side-menu').classList.remove('active'); document.getElementById('app-overlay').classList.remove('active'); uiAction.hideSettings(); },
            showSettings: () => { document.getElementById('menu-view-main').style.display = 'none'; document.getElementById('menu-view-settings').style.display = 'block'; },
            hideSettings: () => { document.getElementById('menu-view-settings').style.display = 'none'; document.getElementById('menu-view-main').style.display = 'block'; },
            logout: () => { if (confirm("–í—ã–π—Ç–∏?")) signOut(auth); },
            openChatRoom: () => document.body.classList.add('is-chatting'),
            closeChatRoom: () => document.body.classList.remove('is-chatting'),

            // Profile modal controls
            openProfile: (uid) => {
                if (!uid) return;
                const user = usersCache[uid] || (window.state.user && uid === window.state.user.uid ? window.state.profile : null);
                if (!user) {
                    alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                overlay.classList.add('active');
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');

                // Fill data
                document.getElementById('p-avatar').src = user.photoURL || 'https://via.placeholder.com/150';
                document.getElementById('p-displayname').innerText = user.displayName || 'User';
                document.getElementById('p-username').innerText = '@' + (user.usernameDisplay || user.username || '');
                document.getElementById('p-about').innerText = user.about || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.';

                // If it's my profile, show edit controls
                if (window.state.user && uid === window.state.user.uid) {
                    document.getElementById('profile-edit-area').style.display = 'block';
                    document.getElementById('p-avatar-input').value = user.photoURL || '';
                    document.getElementById('p-about-input').value = user.about || '';
                    document.getElementById('btn-edit-profile').style.display = 'none';
                    document.getElementById('btn-save-profile').style.display = 'inline-flex';
                } else {
                    document.getElementById('profile-edit-area').style.display = 'none';
                    document.getElementById('btn-edit-profile').style.display = 'none';
                    document.getElementById('btn-save-profile').style.display = 'none';
                }
            },

            closeProfile: () => {
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                overlay.classList.remove('active');
                modal.classList.remove('active');
                modal.setAttribute('aria-hidden', 'true');
                // ensure controls reset
                document.getElementById('btn-edit-profile').style.display = 'inline-flex';
                document.getElementById('btn-save-profile').style.display = 'none';
                document.getElementById('profile-edit-area').style.display = 'none';
            },

            startEditProfile: () => {
                // show editable inputs if not visible
                document.getElementById('profile-edit-area').style.display = 'block';
                document.getElementById('btn-edit-profile').style.display = 'none';
                document.getElementById('btn-save-profile').style.display = 'inline-flex';
            },

            saveProfile: async () => {
                if (!window.state.user) return;
                const newAva = document.getElementById('p-avatar-input').value.trim();
                const newAbout = document.getElementById('p-about-input').value.trim();
                // minimal validation
                if (newAva && !/^https?:\/\//i.test(newAva)) return alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http/https');
                const updates = {};
                if (newAva) updates.photoURL = newAva;
                updates.about = newAbout || '';

                try {
                    await update(ref(db, `users/${window.state.user.uid}`), updates);
                    // local update will be handled by users cache listener, but update immediate UI:
                    if (updates.photoURL) {
                        document.getElementById('p-avatar').src = updates.photoURL;
                        document.getElementById('user-profile-img').src = updates.photoURL;
                    }
                    document.getElementById('p-about').innerText = updates.about;
                    // update local state
                    window.state.profile = Object.assign(window.state.profile || {}, updates);
                    // close edit UI
                    document.getElementById('profile-edit-area').style.display = 'none';
                    document.getElementById('btn-edit-profile').style.display = 'inline-flex';
                    document.getElementById('btn-save-profile').style.display = 'none';
                    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
                } catch (err) {
                    console.error(err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
                }
            }
        };

        function toggleScreen(screenId) {
            ['screen-auth', 'screen-reg', 'app'].forEach(id => document.getElementById(id).style.display = (id === screenId) ? 'flex' : 'none');
        }

        document.addEventListener('click', (e) => { 
            if (!e.target.closest('#context-popup')) document.getElementById('context-popup').style.display = 'none';
        });
        document.getElementById('main-input').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); chatEngine.sendMessage(); } });

        // Expose uiAction for inline handlers
        window.uiAction = window.uiAction;

    </script>
</body>
</html>
