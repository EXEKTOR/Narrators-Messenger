<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Narrators Messenger v1.7</title>
    
    <link rel="icon" href="https://via.placeholder.com/64" type="image/x-icon">

    <style>
        :root{
            --primary:#3390ec;
            --primary-soft:rgba(51,144,236,0.08);
            --bg:#ffffff;
            --muted:#707579;
            --border:#e6e6e9;
            --radius:12px;
            --shadow-sm: 0 6px 18px rgba(18,38,63,0.08);
            --ease: cubic-bezier(.2,.9,.3,1);
            --msg-me: #eeffde;
            --msg-me-text: #000000;
            --msg-other: #f4f4f5;
            --msg-other-text: #000000;
            --font-size:16px;
            --message-border-radius: 14px;
        }

        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%}
        body{
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background:var(--bg);
            color:#111;
            height:100vh;
            display:flex;
            overflow:hidden;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            font-size:var(--font-size);
        }

        .fade-in { animation: fadeIn .18s var(--ease) both; }
        @keyframes fadeIn { from{opacity:0; transform: translateY(4px)} to{opacity:1; transform:none} }

        /* Mobile-first layout */
        #app{
            display:flex;
            flex-direction:column;
            width:100%;
            height:100%;
        }
        
        #sidebar{
            width:100%;
            flex-shrink:0;
            border-bottom:1px solid var(--border);
            display:flex;
            flex-direction:column;
            background:linear-gradient(180deg,var(--bg),#fafbfd);
            position:relative;
            padding-bottom:0;
            height:70px;
            overflow:hidden;
            transition: height 0.3s var(--ease);
        }
        
        #sidebar.expanded {
            height:300px;
        }

        .sidebar-top{
            padding:12px 16px;
            display:flex;
            gap:12px;
            align-items:center;
            border-bottom:1px solid var(--border);
            position:relative;
            min-height:70px;
        }

        .user-avatar{
            width:44px;
            height:44px;
            border-radius:10px;
            object-fit:cover;
            cursor:pointer;
            box-shadow:var(--shadow-sm);
            transition:transform .18s var(--ease);
        }
        .user-avatar:hover{ transform:translateY(-2px) scale(1.03) }

        .sidebar-meta { 
            flex:1; 
            overflow:hidden;
        }
        .sidebar-meta .name{ 
            font-weight:800; 
            font-size:16px;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }
        .sidebar-meta .tag{ 
            color:var(--muted); 
            font-size:13px; 
            margin-top:2px;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }

        #sidebar-menu-btn{
            background:transparent;
            border:none;
            padding:10px;
            border-radius:10px;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            transition:transform .18s var(--ease), background .18s var(--ease);
            font-size:22px;
            min-width:44px;
            min-height:44px;
        }
        #sidebar-menu-btn:hover{ background:var(--primary-soft) }

        #sidebar-menu {
            position: absolute;
            left: 16px;
            top: 70px;
            width: calc(100% - 32px);
            background: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            overflow: hidden;
            z-index: 100;
            display: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        
        #sidebar-menu.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        #sidebar-menu .item {
            padding: 16px 14px;
            cursor: pointer;
            font-weight: 600;
            color: #123;
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            transition: background .12s var(--ease);
            border: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: 15px;
            min-height:44px;
        }
        
        #sidebar-menu .item:hover {
            background: linear-gradient(90deg, var(--primary-soft), transparent);
        }
        
        #sidebar-menu .divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        .search-wrap { 
            padding:12px; 
            display:none;
        }
        
        #sidebar.expanded .search-wrap {
            display:block;
        }

        .input-field{
            width:100%; 
            padding:14px 12px; 
            border-radius:10px; 
            border:1px solid var(--border); 
            background:#fff;
            transition:box-shadow .12s var(--ease), border-color .12s var(--ease);
            font-size:16px;
            min-height:44px;
        }
        .input-field:focus{ 
            box-shadow:0 8px 20px rgba(17,24,39,0.04); 
            border-color:var(--primary);
            outline:none;
        }

        .chat-list-container{ 
            flex:1; 
            overflow:auto; 
            padding:8px 12px;
            display:none;
        }
        
        #sidebar.expanded .chat-list-container {
            display:block;
        }

        .chat-row{
            display:flex; 
            align-items:center; 
            gap:12px; 
            padding:14px 12px; 
            border-radius:10px;
            transition: background .12s var(--ease), transform .12s var(--ease);
            min-height:60px;
        }
        .chat-row:hover{ background:var(--primary-soft); transform:translateX(4px) }

        #chat-window{ 
            flex:1; 
            display:flex; 
            flex-direction:column; 
            background:var(--bg);
            height:calc(100vh - 70px);
        }
        
        .chat-top-bar{
            display:flex;
            align-items:center;
            gap:12px;
            padding:12px 16px;
            border-bottom:1px solid var(--border);
            background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));
            position:relative;
            min-height:64px;
        }
        
        #chat-top-avatar{ 
            width:40px;
            height:40px;
            border-radius:10px;
            object-fit:cover;
            cursor:pointer; 
            transition:transform .15s var(--ease);
            flex-shrink:0;
        }
        #chat-top-avatar:hover{ transform:translateY(-2px) }

        #messages-view{ 
            flex:1; 
            overflow:auto; 
            padding:16px; 
            display:flex; 
            flex-direction:column; 
            gap:12px; 
            scroll-behavior:smooth; 
            background:linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.00)); 
            -webkit-overflow-scrolling: touch;
        }

        .msg-wrapper{ 
            display:flex; 
            gap:10px; 
            align-items:flex-end; 
            width:100%; 
            animation:msgIn .18s var(--ease); 
        }
        @keyframes msgIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

        .msg-wrapper.my-msg{ justify-content:flex-end }
        .msg-wrapper.other-msg{ justify-content:flex-start }

        .msg-bubble{
            background:var(--msg-other); 
            padding:14px 16px; 
            border-radius:var(--message-border-radius, 14px); 
            max-width:85%; 
            box-shadow:0 6px 20px rgba(11,22,39,0.04);
            transition: transform .12s var(--ease), box-shadow .12s var(--ease);
            word-wrap:break-word;
            overflow-wrap:break-word;
        }
        .msg-bubble:hover{ transform:translateY(-3px); box-shadow:0 10px 30px rgba(11,22,39,0.06) }
        .msg-wrapper.my-msg .msg-bubble{ background:var(--msg-me); color:var(--msg-me-text); }

        .msg-avatar{ 
            width:36px;
            height:36px;
            border-radius:50%; 
            object-fit:cover; 
            cursor:pointer; 
            transition:transform .12s var(--ease);
            flex-shrink:0;
        }
        .msg-avatar:hover{ transform:scale(1.06) }

        #reply-preview{ 
            display:none; 
            padding:12px; 
            border-left:4px solid var(--primary); 
            background:#fff; 
            border-radius:10px; 
            margin-bottom:10px; 
            box-shadow:var(--shadow-sm);
            margin:0 12px 10px 12px;
        }

        .profile-overlay { 
            position:fixed; 
            inset:0; 
            background:rgba(0,0,0,0.45); 
            z-index:10001; 
            display:none; 
            backdrop-filter:blur(3px); 
        }
        .profile-overlay.active { display:block; }
        
        .profile-modal, 
        .settings-modal, 
        .group-modal, 
        .notifications-modal{ 
            transition:opacity .22s var(--ease), transform .22s var(--ease), visibility .22s var(--ease); 
            will-change:transform,opacity; 
            max-height:90vh;
            overflow-y:auto;
            -webkit-overflow-scrolling: touch;
        }

        .profile-modal{ 
            position:fixed; 
            left:50%; 
            top:50%; 
            transform:translate(-50%,-50%) scale(0.95); 
            width:95%; 
            max-width:520px; 
            background:#fff; 
            border-radius:14px; 
            padding:18px; 
            box-shadow:0 20px 60px rgba(0,0,0,0.3); 
            z-index:10002; 
            display:none; 
            opacity:0; 
        }
        .profile-modal.active{ display:block; transform:translate(-50%,-50%) scale(1); opacity:1; }

        .settings-modal{ 
            position:fixed; 
            left:50%; 
            top:50%; 
            transform:translate(-50%,-50%) scale(0.95); 
            width:95%; 
            max-width:560px; 
            background:#fff; 
            border-radius:12px; 
            padding:18px; 
            box-shadow:0 30px 80px rgba(0,0,0,0.25); 
            z-index:10003; 
            display:none; 
            opacity:0; 
        }
        .settings-modal.active{ display:block; transform:translate(-50%,-50%) scale(1); opacity:1; }

        .group-modal{ 
            position:fixed; 
            left:50%; 
            top:50%; 
            transform:translate(-50%,-50%) scale(0.95); 
            background:#fff; 
            z-index:10004; 
            width:95%; 
            max-width:620px; 
            border-radius:12px; 
            padding:16px; 
            display:none; 
            box-shadow:0 20px 60px rgba(0,0,0,0.25); 
        }
        .group-modal.active{ display:block; transform:translate(-50%,-50%) scale(1); opacity:1; }

        .notifications-modal{ 
            position:fixed; 
            left:50%; 
            top:50%; 
            transform:translate(-50%,-50%) scale(0.95); 
            background:#fff; 
            z-index:10005; 
            width:95%; 
            max-width:500px; 
            border-radius:12px; 
            padding:16px; 
            display:none; 
            box-shadow:0 20px 60px rgba(0,0,0,0.25); 
        }
        .notifications-modal.active{ display:block; transform:translate(-50%,-50%) scale(1); opacity:1; }

        .btn{ 
            border-radius:10px; 
            padding:12px 16px; 
            transition:transform .12s var(--ease), box-shadow .12s var(--ease);
            border:none;
            font-size:15px;
            font-weight:600;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            min-height:44px;
            min-width:44px;
        }
        .btn:active{ transform:scale(.98) }
        .btn-primary{ background:var(--primary); color:#fff; }
        .btn-ghost{ background:#f6f7fb; border:1px solid #efefef; color:#123; }

        .muted-xs{ font-size:13px; color:var(--muted) }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--primary-soft);
            border-radius: 8px;
            font-size: 14px;
            border: 1px solid var(--border);
            min-height:36px;
        }

        .input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            position: relative;
            padding:12px;
            background:var(--bg);
            border-top:1px solid var(--border);
        }

        #main-input {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 16px;
            resize: none;
            min-height: 48px;
            max-height: 120px;
            line-height:1.4;
            -webkit-appearance: none;
        }

        .time-stamp {
            font-size: 11px;
            opacity: 0.6;
            display: block;
            margin-top: 4px;
            text-align: right;
        }

        .author-tag {
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
            font-size:15px;
        }

        .msg-content-body {
            word-break: break-word;
            font-size:15px;
            line-height:1.4;
        }

        .msg-content-body a {
            color: var(--primary);
            text-decoration: none;
        }

        .msg-content-body a:hover {
            text-decoration: underline;
        }

        .msg-content-body img {
            max-width:100%;
            border-radius:8px;
            margin-top:8px;
            cursor:pointer;
        }

        .notification-permission-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 14px 20px;
            border-radius: var(--radius);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10006;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-width: 90%;
            width: 400px;
            font-size:14px;
        }

        .notification-permission-banner button {
            background: white;
            color: var(--primary);
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-left: auto;
            min-height:36px;
        }

        /* –û–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
        .settings-preview {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg);
        }

        .preview-message {
            margin-bottom: 10px;
            padding: 12px;
            border-radius: var(--message-border-radius, 14px);
            background: var(--msg-other);
            max-width: 80%;
        }

        .preview-message.my {
            background: var(--msg-me);
            margin-left: auto;
            text-align: right;
        }

        /* –ú–µ–Ω—é –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ */
        .attach-menu {
            position: absolute;
            bottom: 75px;
            left: 12px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px;
            z-index: 1000;
            display: none;
            box-shadow: var(--shadow-sm);
            min-width:200px;
        }

        .attach-option {
            display: block;
            width: 100%;
            padding: 14px;
            text-align: left;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 6px;
            transition: background .12s var(--ease);
            font-size:15px;
            min-height:44px;
        }

        .attach-option:hover {
            background: var(--primary-soft);
        }

        /* –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        .notification-history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            margin-top: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .notification-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ */
        .group-info-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .members-list {
            max-height: 150px;
            overflow-y: auto;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid var(--border);
            min-height:44px;
        }

        .member-item:last-child {
            border-bottom: none;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 4px;
            z-index: 1001;
            height:65px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 11px;
            gap: 4px;
            flex: 1;
            padding: 8px 4px;
            border-radius: 8px;
            transition: all 0.2s ease;
            min-height:44px;
        }

        .nav-btn.active {
            color: var(--primary);
            background: var(--primary-soft);
        }

        .nav-btn i {
            font-size: 22px;
            font-style: normal;
        }

        .mobile-back-btn {
            display: none;
            position: absolute;
            left: 12px;
            top: 12px;
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            width:44px;
            height:44px;
            align-items:center;
            justify-content:center;
            border-radius:10px;
        }

        .mobile-back-btn:hover {
            background: var(--primary-soft);
        }

        /* –î–µ—Å–∫—Ç–æ–ø –≤–µ—Ä—Å–∏—è */
        @media (min-width: 769px) {
            #app{
                flex-direction:row;
            }
            
            #sidebar{
                width:320px;
                height:100%;
                border-right:1px solid var(--border);
                border-bottom:none;
                padding-bottom:12px;
                overflow:visible;
            }
            
            .sidebar-top{
                padding:14px 16px;
                border-bottom:1px solid var(--border);
            }
            
            .user-avatar{
                width:56px;
                height:56px;
            }
            
            .search-wrap{
                display:block;
                padding:12px;
            }
            
            .chat-list-container{
                display:block;
                padding:8px 12px;
            }
            
            #chat-window{
                height:100%;
            }
            
            .chat-top-bar{
                padding:12px 18px;
            }
            
            #chat-top-avatar{
                width:44px;
                height:44px;
            }
            
            .msg-bubble{
                max-width:72%;
            }
            
            .msg-avatar{
                width:40px;
                height:40px;
            }
            
            .mobile-nav{
                display:none;
            }
            
            .mobile-back-btn{
                display:none;
            }
            
            #sidebar.expanded {
                height:100%;
            }
        }

        /* –ü–ª–∞–Ω—à–µ—Ç—ã */
        @media (min-width: 481px) and (max-width: 768px) {
            #sidebar{
                width:100%;
            }
            
            .msg-bubble{
                max-width:75%;
            }
            
            .mobile-nav{
                height:70px;
            }
            
            .nav-btn{
                padding:10px 6px;
            }
        }

        /* –ë–æ–ª—å—à–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã */
        @media (min-width: 376px) and (max-width: 480px) {
            #sidebar{
                height:70px;
            }
            
            .sidebar-top{
                padding:10px 14px;
            }
            
            .user-avatar{
                width:48px;
                height:48px;
            }
            
            .msg-bubble{
                max-width:80%;
                padding:12px 14px;
            }
            
            .mobile-nav{
                height:65px;
            }
        }

        /* –ú–∞–ª–µ–Ω—å–∫–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã */
        @media (max-width: 375px) {
            #sidebar{
                height:65px;
            }
            
            .sidebar-top{
                padding:8px 12px;
            }
            
            .user-avatar{
                width:44px;
                height:44px;
            }
            
            .sidebar-meta .name{
                font-size:15px;
            }
            
            .msg-bubble{
                max-width:85%;
                padding:10px 12px;
            }
            
            .msg-avatar{
                width:32px;
                height:32px;
            }
            
            .mobile-nav{
                height:60px;
            }
            
            .nav-btn{
                font-size:10px;
                padding:6px 4px;
            }
            
            .nav-btn i{
                font-size:20px;
            }
            
            .btn{
                padding:10px 14px;
                min-height:40px;
                min-width:40px;
            }
            
            .input-field{
                padding:12px;
                min-height:40px;
            }
        }

        /* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è */
        @media (max-height: 500px) and (orientation: landscape) {
            #sidebar{
                height:60px;
            }
            
            .sidebar-top{
                min-height:60px;
                padding:8px 12px;
            }
            
            .user-avatar{
                width:40px;
                height:40px;
            }
            
            .mobile-nav{
                height:55px;
            }
            
            #chat-window{
                height:calc(100vh - 60px);
            }
            
            .chat-top-bar{
                min-height:50px;
                padding:8px 12px;
            }
            
            #chat-top-avatar{
                width:36px;
                height:36px;
            }
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è) */
        @media (prefers-color-scheme: dark) {
            :root{
                --bg:#0f0f0f;
                --muted:#8a8a8a;
                --border:#2a2a2a;
                --msg-me:#1a3a1a;
                --msg-me-text:#e0e0e0;
                --msg-other:#2a2a2a;
                --msg-other-text:#e0e0e0;
                --primary-soft:rgba(51,144,236,0.15);
            }
            
            body{
                background:var(--bg);
                color:#e0e0e0;
            }
            
            .profile-modal,
            .settings-modal,
            .group-modal,
            .notifications-modal,
            #sidebar-menu{
                background:#1a1a1a;
                color:#e0e0e0;
            }
            
            .input-field{
                background:#2a2a2a;
                border-color:#3a3a3a;
                color:#e0e0e0;
            }
            
            .attach-menu{
                background:#1a1a1a;
                border-color:#3a3a3a;
            }
            
            .attach-option{
                color:#e0e0e0;
            }
            
            .btn-ghost{
                background:#2a2a2a;
                border-color:#3a3a3a;
                color:#e0e0e0;
            }
            
            .chip{
                background:#2a2a2a;
                border-color:#3a3a3a;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .slide-in-right {
            animation: slideInRight 0.3s var(--ease);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .slide-in-left {
            animation: slideInLeft 0.3s var(--ease);
        }
        
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>

    <div id="notification-permission-banner" class="notification-permission-banner">
        <div>üîî –ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö?</div>
        <button onclick="notificationManager.requestPermission()">–í–∫–ª—é—á–∏—Ç—å</button>
        <button onclick="notificationManager.hideBanner()" style="background: transparent; color: white; padding: 0; margin-left: 4px; min-height:auto;">‚úï</button>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="fade-in">
        <div id="sidebar">
            <div class="sidebar-top">
                <button id="mobile-back-btn" class="mobile-back-btn" style="display:none;">‚Üê</button>
                <img id="user-profile-img" class="user-avatar" src="https://via.placeholder.com/150" title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                <div class="sidebar-meta">
                    <div class="name" id="user-display-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="tag muted-xs" id="user-display-tag">@username</div>
                </div>
                <button id="sidebar-menu-btn" aria-expanded="false" title="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">‚ò∞</button>
                
                <div id="sidebar-menu" aria-hidden="true">
                    <button class="item" onclick="uiAction.openSettings(); toggleSidebarMenu()">üé® –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</button>
                    <button class="item" onclick="uiAction.openCreateGroup(); toggleSidebarMenu()">‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                    <button class="item" onclick="uiAction.openNotifications(); toggleSidebarMenu()">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                    <div class="divider"></div>
                    <button class="item" onclick="toggleSidebarExpanded(); toggleSidebarMenu()">üí¨ –í—Å–µ —á–∞—Ç—ã</button>
                    <button class="item" onclick="uiAction.openGlobal(); toggleSidebarMenu()">üåç Global —á–∞—Ç</button>
                </div>
            </div>

            <div class="search-wrap">
                <input id="user-search-input" class="input-field" placeholder="–ü–æ–∏—Å–∫ –ø–æ @—Ç–µ–≥—É –∏–ª–∏ –∏–º–µ–Ω–∏...">
            </div>

            <div class="chat-list-container" id="conversations-list">
                <div class="chat-row" id="row-global" onclick="uiAction.openGlobal(); closeMobileSidebar();">
                    <img class="user-avatar" src="https://cdn-icons-png.flaticon.com/512/1041/1041916.png" style="width:46px;height:46px;border-radius:8px;">
                    <div style="flex:1">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div style="font-weight:700">Global Chat Room</div>
                            <div class="muted-xs" style="color:#aaa">online</div>
                        </div>
                        <div class="muted-xs" style="color:var(--muted)">–û–±—â–∏–π —á–∞—Ç</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-window">
            <div class="chat-top-bar">
                <button id="mobile-chat-back" class="mobile-back-btn" style="display:none;" onclick="showMobileChatList()">‚Üê</button>
                <img id="chat-top-avatar" src="https://via.placeholder.com/100" style="width:44px;height:44px;border-radius:10px;object-fit:cover">
                <div style="flex:1; min-width:0;">
                    <div id="chat-top-title" style="font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Global Chat Room</div>
                    <div id="chat-top-sub" class="muted-xs" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">–û–±—â–∏–π —á–∞—Ç</div>
                </div>
                <button id="signout-btn" class="btn btn-ghost" style="display:none;">–í—ã–π—Ç–∏</button>
            </div>

            <div id="messages-view"></div>

            <div class="bottom-controls">
                <div id="reply-preview"></div>
                <div class="input-group">
                    <div style="position: relative;">
                        <button id="attach-btn" class="btn btn-ghost" style="min-width:44px;">üìé</button>
                        <div id="attach-menu" class="attach-menu">
                            <button class="attach-option" onclick="chatEngine.attachFromURL()">üì∑ –í—Å—Ç–∞–≤–∏—Ç—å URL –∫–∞—Ä—Ç–∏–Ω–∫–∏</button>
                            <button class="attach-option" onclick="chatEngine.attachFromFile()">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                        </div>
                    </div>
                    <textarea id="main-input" rows="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                    <button id="send-msg-btn" class="btn btn-primary" onclick="chatEngine.sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
        
        <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="mobile-nav">
            <button class="nav-btn" onclick="showMobileChatList()">
                <i>üí¨</i>
                <span>–ß–∞—Ç—ã</span>
            </button>
            <button class="nav-btn" onclick="uiAction.openGlobal(); hideMobileSidebar();">
                <i>üåç</i>
                <span>Global</span>
            </button>
            <button class="nav-btn" onclick="uiAction.openCreateGroup(); hideMobileSidebar();">
                <i>‚ûï</i>
                <span>–ì—Ä—É–ø–ø–∞</span>
            </button>
            <button class="nav-btn" onclick="uiAction.openSettings(); hideMobileSidebar();">
                <i>‚öôÔ∏è</i>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </button>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-overlay" class="profile-overlay" onclick="uiAction.closeProfile()"></div>
    <div id="profile-modal" class="profile-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-weight:800;" id="profile-modal-title">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <button onclick="uiAction.closeProfile()" style="background:transparent; font-size:18px; padding:6px; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">‚úï</button>
        </div>

        <div class="profile-top" style="display:flex; gap:12px; align-items:center;">
            <img id="p-avatar" src="https://via.placeholder.com/150" alt="avatar" style="width:96px; height:96px; border-radius:12px; object-fit:cover;">
            <div style="flex:1;">
                <div id="p-displayname" style="font-weight:800; font-size:18px;">–ò–º—è</div>
                <div id="p-username" class="muted-xs">@username</div>
                <div style="margin-top:8px;">
                    <small class="muted-xs">–û —Å–µ–±–µ:</small>
                    <div id="p-about" class="muted-xs" style="margin-top:6px;">–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.</div>
                </div>
            </div>
        </div>

        <div id="group-info-section" class="group-info-section" style="display:none;">
            <div style="font-weight:700; margin-bottom:6px;">–£—á–∞—Å—Ç–Ω–∏–∫–∏:</div>
            <div id="group-members-list" class="members-list">
            </div>
        </div>

        <div id="profile-edit-area" style="display:none; margin-top:12px;">
            <label style="font-size:13px; color:var(--muted); display:block; margin-bottom:4px;">–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä</label>
            <input id="p-avatar-input" class="input-field" placeholder="https://...">
            <label style="font-size:13px; color:var(--muted); display:block; margin-top:12px; margin-bottom:4px;">–û —Å–µ–±–µ</label>
            <textarea id="p-about-input" class="input-field" rows="3"></textarea>
            
            <div id="group-edit-fields" style="display:none;">
                <label style="font-size:13px; color:var(--muted); display:block; margin-top:12px; margin-bottom:4px;">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                <input id="group-name-input" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                <label style="font-size:13px; color:var(--muted); display:block; margin-top:12px; margin-bottom:4px;">–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                <textarea id="group-description-input" class="input-field" rows="2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"></textarea>
            </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:20px; justify-content:flex-end; flex-wrap:wrap;">
            <button id="btn-write" class="btn btn-primary" style="display:none;" onclick="uiAction.createOrOpenDM(uiAction._profileShownUid)">‚úâ –ù–∞–ø–∏—Å–∞—Ç—å</button>
            <button id="btn-edit-profile" class="btn btn-primary" onclick="uiAction.startEditProfile()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="btn-save-profile" class="btn btn-primary" style="display:none;" onclick="uiAction.saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="btn-upgrade" class="btn btn-ghost" style="display:none;" onclick="uiAction.upgradeToGoogle()">üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å Google</button>
        </div>
    </div>

    <!-- SETTINGS MODAL —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º -->
    <div id="settings-modal" class="settings-modal" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-weight:800;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</div>
            <button onclick="uiAction.closeSettings()" style="background:transparent; font-size:18px; padding:6px; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">‚úï</button>
        </div>

        <div style="display:flex; flex-direction:column; gap:12px;">
            <div>
                <div style="font-weight:700; margin-bottom:6px;">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</div>
                <label class="muted-xs">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç</label>
                <input id="ui-color-primary" type="color" style="width:100%; height:44px; border:none; margin:8px 0; border-radius:8px; cursor:pointer;">
                <label class="muted-xs">–¶–≤–µ—Ç –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</label>
                <input id="ui-color-me" type="color" style="width:100%; height:44px; border:none; margin:8px 0; border-radius:8px; cursor:pointer;">
                <label class="muted-xs">–§–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</label>
                <input id="ui-bg-color" type="color" style="width:100%; height:44px; border:none; margin:8px 0; border-radius:8px; cursor:pointer;">
                <label class="muted-xs">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px)</label>
                <input id="ui-font-range" type="range" min="12" max="22" value="16" style="width:100%; margin:8px 0; height:24px;">
                <label class="muted-xs">–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (px)</label>
                <input id="ui-radius-range" type="range" min="0" max="30" value="12" style="width:100%; margin:8px 0; height:24px;">
                <div style="display:flex; gap:8px; margin-top:20px;">
                    <button class="btn btn-primary" onclick="themeCore.save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn btn-ghost" onclick="themeCore.reset()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>

            <div>
                <div style="font-weight:700; margin-bottom:6px;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
                <div class="settings-preview" id="settings-preview">
                    <div class="preview-message">
                        <div style="font-weight:600; margin-bottom:4px;">–î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                        <div>–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?</div>
                        <div style="font-size:11px; opacity:0.6; text-align:right; margin-top:4px;">10:00</div>
                    </div>
                    <div class="preview-message my">
                        <div style="font-weight:600; margin-bottom:4px;">–í—ã</div>
                        <div>–í—Å—ë –æ—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ!</div>
                        <div style="font-size:11px; opacity:0.6; text-align:right; margin-top:4px;">10:01</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
    <div id="notifications-overlay" class="profile-overlay" onclick="uiAction.closeNotifications()"></div>
    <div id="notifications-modal" class="notifications-modal" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-weight:800;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
            <button onclick="uiAction.closeNotifications()" style="background:transparent; font-size:18px; padding:6px; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">‚úï</button>
        </div>

        <div style="margin-bottom:15px;">
            <div style="font-weight:700; margin-bottom:6px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <button class="btn btn-primary" onclick="notificationManager.requestPermission()" id="enable-notifications-btn">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                <button class="btn btn-ghost" onclick="notificationManager.testNotification()">–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
                <div id="notification-status" class="muted-xs" style="padding:12px; background:var(--primary-soft); border-radius:8px;">
                    –°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: <span id="notification-status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
            </div>
        </div>

        <div>
            <div style="font-weight:700; margin-bottom:6px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
            <div id="notifications-history" class="notification-history">
                <div class="notification-item">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
            </div>
        </div>
    </div>

    <!-- GROUP MODAL -->
    <div id="group-overlay" class="profile-overlay" onclick="uiAction.closeCreateGroup()"></div>
    <div id="group-modal" class="group-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:800;">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</div>
            <button onclick="uiAction.closeCreateGroup()" style="background:transparent; font-size:18px; padding:6px; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">‚úï</button>
        </div>

        <div style="margin-bottom:8px;">
            <label class="muted-xs" style="display:block; margin-bottom:4px;">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
            <input id="group-name" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            <label class="muted-xs" style="display:block; margin-top:12px; margin-bottom:4px;">–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input id="group-image-url" class="input-field" placeholder="https://...">
            <small class="muted-xs" style="display:block; margin-top:12px; margin-bottom:4px;">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∏—â–∏—Ç–µ –ø–æ —Ç–µ–≥—É –∏–ª–∏ –∏–º–µ–Ω–∏)</small>
            <input id="group-add-search" class="input-field" placeholder="–ò—Å–∫–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
            <div id="group-search-results" style="max-height:160px; overflow-y:auto; margin-top:8px;"></div>
            <div id="group-selected" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;"></div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:20px;">
            <button class="btn btn-ghost" onclick="uiAction.closeCreateGroup()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="uiAction.createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            onAuthStateChanged,
            signOut,
            linkWithPopup
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        import {
            getDatabase,
            ref,
            set,
            push,
            onValue,
            get,
            child,
            update,
            remove
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        window.state = {
            user: null,
            profile: null,
            isAdmin: false,
            activeAction: null,
            targetMessage: null,
            contextTarget: null,
            currentChat: { type: 'global', id: 'global', title: 'Global Chat Room' },
            notificationPermission: null,
            currentGroupInfo: null,
            profileViewMode: 'user'
        };

        const usersCache = {};
        const conversationsIndex = {};
        let dmsListener = null;
        let groupsListener = null;
        let usersListener = null;
        let currentMessagesUnsub = null;
        const notificationHistory = JSON.parse(localStorage.getItem('notificationHistory') || '[]');

        let lastNotificationMessageId = null;
        let lastNotificationTime = 0;
        const NOTIFICATION_COOLDOWN = 3000;

        // –ú–æ–±–∏–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function isMobile() {
            return window.innerWidth <= 768;
        }

        function toggleSidebarExpanded() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('expanded')) {
                sidebar.classList.remove('expanded');
            } else {
                sidebar.classList.add('expanded');
            }
        }

        function closeMobileSidebar() {
            if (isMobile()) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('expanded');
            }
        }

        function hideMobileSidebar() {
            if (isMobile()) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('expanded');
            }
        }

        function showMobileChatList() {
            if (isMobile()) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('expanded');
            }
        }

        /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function rgbToHex(rgb) {
            if (!rgb || typeof rgb !== 'string') return '#3390ec';
            rgb = rgb.replace(/\s+/g, '');
            if (rgb.startsWith('#')) return rgb;
            
            const rgbMatch = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/i);
            const rgbaMatch = rgb.match(/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*[\d.]+\)$/i);
            
            if (rgbMatch) {
                return '#' + 
                    (1 << 24 | parseInt(rgbMatch[1]) << 16 | parseInt(rgbMatch[2]) << 8 | parseInt(rgbMatch[3]))
                    .toString(16).slice(1).toUpperCase();
            } else if (rgbaMatch) {
                return '#' + 
                    (1 << 24 | parseInt(rgbaMatch[1]) << 16 | parseInt(rgbaMatch[2]) << 8 | parseInt(rgbaMatch[3]))
                    .toString(16).slice(1).toUpperCase();
            }
            
            return '#3390ec';
        }

        function toggleSidebarMenu() {
            const menu = document.getElementById('sidebar-menu');
            const button = document.getElementById('sidebar-menu-btn');
            
            if (menu && button) {
                if (menu.classList.contains('active')) {
                    menu.classList.remove('active');
                    button.setAttribute('aria-expanded', 'false');
                    menu.setAttribute('aria-hidden', 'true');
                } else {
                    menu.classList.add('active');
                    button.setAttribute('aria-expanded', 'true');
                    menu.setAttribute('aria-hidden', 'false');
                }
            }
        }
        
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('sidebar-menu');
            const button = document.getElementById('sidebar-menu-btn');
            
            if (menu && button && menu.classList.contains('active')) {
                const isClickInsideMenu = menu.contains(event.target);
                const isClickOnButton = button.contains(event.target);
                
                if (!isClickInsideMenu && !isClickOnButton) {
                    menu.classList.remove('active');
                    button.setAttribute('aria-expanded', 'false');
                    menu.setAttribute('aria-hidden', 'true');
                }
            }
            
            if (!event.target.closest('#context-popup')) {
                const p = document.getElementById('context-popup');
                if (p) p.style.display = 'none';
            }
            
            if (!event.target.closest('#attach-btn') && !event.target.closest('#attach-menu')) {
                const attachMenu = document.getElementById('attach-menu');
                if (attachMenu) attachMenu.style.display = 'none';
            }
        });
        
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const menu = document.getElementById('sidebar-menu');
                const button = document.getElementById('sidebar-menu-btn');
                
                if (menu && menu.classList.contains('active')) {
                    menu.classList.remove('active');
                    button.setAttribute('aria-expanded', 'false');
                    menu.setAttribute('aria-hidden', 'true');
                }
                
                const attachMenu = document.getElementById('attach-menu');
                if (attachMenu) attachMenu.style.display = 'none';
            }
        });

        /* –ú–µ–Ω–µ–¥–∂–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        window.notificationManager = {
            requestPermission: async function() {
                if (!('Notification' in window)) {
                    alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                    return;
                }
                
                try {
                    const permission = await Notification.requestPermission();
                    window.state.notificationPermission = permission;
                    
                    this.updateNotificationStatus();
                    
                    if (permission === 'granted') {
                        this.showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', '–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö');
                        this.hideBanner();
                        localStorage.setItem('notifications_enabled', 'true');
                        this.addToHistory('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', '–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö');
                        this.updateHistoryView();
                    } else if (permission === 'denied') {
                        alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –í—ã –º–æ–∂–µ—Ç–µ –≤–∫–ª—é—á–∏—Ç—å –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
                        localStorage.setItem('notifications_enabled', 'false');
                        this.addToHistory('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã', '–í—ã –Ω–µ –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                        this.updateHistoryView();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:', error);
                }
            },

            checkPermission: function() {
                if (!('Notification' in window)) {
                    return 'unsupported';
                }
                
                window.state.notificationPermission = Notification.permission;
                return Notification.permission;
            },

            updateNotificationStatus: function() {
                const statusElement = document.getElementById('notification-status-text');
                const banner = document.getElementById('notification-permission-banner');
                const enableBtn = document.getElementById('enable-notifications-btn');
                
                if (!statusElement) return;
                
                const permission = this.checkPermission();
                let statusText = '';
                let bannerVisible = false;
                
                switch(permission) {
                    case 'granted':
                        statusText = '‚úÖ –í–∫–ª—é—á–µ–Ω—ã';
                        if (enableBtn) enableBtn.innerText = '–û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
                        bannerVisible = false;
                        break;
                    case 'denied':
                        statusText = '‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
                        if (enableBtn) enableBtn.innerText = '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
                        bannerVisible = false;
                        break;
                    case 'default':
                        statusText = '‚ö†Ô∏è –ù–µ –∑–∞–ø—Ä–æ—à–µ–Ω—ã';
                        if (enableBtn) enableBtn.innerText = '–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
                        bannerVisible = true;
                        break;
                    case 'unsupported':
                        statusText = 'üö´ –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                        if (enableBtn) enableBtn.style.display = 'none';
                        bannerVisible = false;
                        break;
                }
                
                statusElement.textContent = statusText;
                
                if (banner) {
                    if (bannerVisible && localStorage.getItem('notification_banner_hidden') !== 'true') {
                        banner.style.display = 'flex';
                    } else {
                        banner.style.display = 'none';
                    }
                }
            },

            addToHistory: function(title, body) {
                const notification = {
                    id: Date.now(),
                    title: title,
                    body: body,
                    timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    date: new Date().toLocaleDateString()
                };
                
                notificationHistory.unshift(notification);
                if (notificationHistory.length > 20) {
                    notificationHistory.pop();
                }
                
                localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
                this.updateHistoryView();
            },

            updateHistoryView: function() {
                const historyContainer = document.getElementById('notifications-history');
                if (!historyContainer) return;
                
                if (notificationHistory.length === 0) {
                    historyContainer.innerHTML = '<div class="notification-item">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
                    return;
                }
                
                historyContainer.innerHTML = '';
                notificationHistory.slice(0, 10).forEach(notif => {
                    const item = document.createElement('div');
                    item.className = 'notification-item';
                    item.innerHTML = `
                        <div style="font-weight:600;">${escapeHtml(notif.title)}</div>
                        <div>${escapeHtml(notif.body)}</div>
                        <div style="font-size:11px; color:var(--muted); margin-top:4px;">
                            ${notif.date} ${notif.timestamp}
                        </div>
                    `;
                    historyContainer.appendChild(item);
                });
            },

            showNotification: function(title, body, tag = 'new-message') {
                if (window.state.notificationPermission !== 'granted') {
                    return;
                }
                
                const now = Date.now();
                if (now - lastNotificationTime < NOTIFICATION_COOLDOWN) {
                    return;
                }
                
                if (document.hasFocus()) {
                    return;
                }
                
                try {
                    const options = {
                        body: body,
                        icon: 'https://via.placeholder.com/192',
                        tag: tag,
                        renotify: true,
                        requireInteraction: false,
                        silent: false,
                        data: {
                            url: window.location.href,
                            timestamp: Date.now()
                        }
                    };
                    
                    const notification = new Notification(title, options);
                    
                    notification.onclick = function(event) {
                        event.preventDefault();
                        window.focus();
                        notification.close();
                    };
                    
                    lastNotificationTime = now;
                    
                    this.addToHistory(title, body);
                    
                    setTimeout(() => {
                        notification.close();
                    }, 7000);
                    
                    return notification;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
                    return null;
                }
            },

            testNotification: function() {
                const permission = this.checkPermission();
                
                if (permission === 'granted') {
                    this.showNotification(
                        '–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
                        '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç Narrators Messenger',
                        'test-notification'
                    );
                    this.addToHistory('–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç Narrators Messenger');
                } else {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                    this.requestPermission();
                }
            },

            notifyNewMessage: function(message, chatInfo = null) {
                if (window.state.notificationPermission !== 'granted') {
                    return;
                }
                
                if (message.uid === window.state.user?.uid) {
                    return;
                }
                
                const now = Date.now();
                if (now - lastNotificationTime < NOTIFICATION_COOLDOWN) {
                    return;
                }
                
                const sender = usersCache[message.uid] || {};
                const senderName = sender.displayName || message.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                const chatName = chatInfo?.title || '–ß–∞—Ç';
                
                const messageText = message.text || '';
                const truncatedText = messageText.length > 100 
                    ? messageText.substring(0, 100) + '...' 
                    : messageText;
                
                const title = `üí¨ ${senderName}`;
                const body = `${truncatedText}\n\n–≤ ${chatName}`;
                
                this.showNotification(title, body, `message-${message.uid}`);
                this.addToHistory(title, body);
            },

            hideBanner: function() {
                const banner = document.getElementById('notification-permission-banner');
                if (banner) {
                    banner.style.display = 'none';
                }
                localStorage.setItem('notification_banner_hidden', 'true');
            },

            init: function() {
                this.updateNotificationStatus();
                this.updateHistoryView();
                
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã');
                    } else {
                        console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–Ω–∞');
                    }
                });
                
                const notificationsEnabled = localStorage.getItem('notifications_enabled');
                if (notificationsEnabled === 'true') {
                    setTimeout(() => {
                        if (this.checkPermission() === 'default') {
                            this.requestPermission();
                        }
                    }, 2000);
                }
            }
        };

        /* AUTH state handling */
        onAuthStateChanged(auth, async (firebaseUser) => {
            if (!firebaseUser) {
                teardownAfterSignOut();
                document.getElementById('app').style.display = 'flex';
                return;
            }
            window.state.user = firebaseUser;
            try {
                const snap = await get(child(ref(db), `users/${firebaseUser.uid}`));
                if (snap.exists()) window.state.profile = snap.val();
                else {
                    const displayName = firebaseUser.displayName || (firebaseUser.email ? firebaseUser.email.split('@')[0] : 'User');
                    const username = (displayName.split(' ')[0] || displayName).toLowerCase();
                    const profile = { 
                        uid: firebaseUser.uid, 
                        displayName, 
                        username, 
                        usernameDisplay: username, 
                        photoURL: firebaseUser.photoURL || 'https://via.placeholder.com/150', 
                        about: '' 
                    };
                    await set(ref(db, `users/${firebaseUser.uid}`), profile);
                    window.state.profile = profile;
                }

                if ((window.state.profile.usernameDisplay || '').toLowerCase() === 'admin') window.state.isAdmin = true;

                document.getElementById('user-profile-img').src = window.state.profile.photoURL || 'https://via.placeholder.com/150';
                document.getElementById('user-display-name').innerText = window.state.profile.displayName || '';
                document.getElementById('user-display-tag').innerText = '@' + (window.state.profile.usernameDisplay || '');

                document.getElementById('user-profile-img').onclick = () => uiAction.openProfile(window.state.user.uid);

                const sidebarBtn = document.getElementById('sidebar-menu-btn');
                if (sidebarBtn) {
                    sidebarBtn.onclick = function(e) {
                        e.stopPropagation();
                        toggleSidebarMenu();
                    };
                }

                const attachBtn = document.getElementById('attach-btn');
                if (attachBtn) {
                    attachBtn.onclick = function(e) {
                        e.stopPropagation();
                        const menu = document.getElementById('attach-menu');
                        if (menu) {
                            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                        }
                    };
                }

                themeCore.load();
                initUsersCacheListener();
                initConversationsListener();
                initSearch();
                initGroupSearch();
                
                notificationManager.init();
                
                uiAction.openGlobal();

            } catch (err) {
                console.error('post-auth error', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è: ' + (err.message || err));
            }
        });

        function teardownAfterSignOut(){
            document.getElementById('user-profile-img').onclick = null;
            if (usersListener && typeof usersListener === 'function') usersListener();
            if (dmsListener && typeof dmsListener === 'function') dmsListener();
            if (groupsListener && typeof groupsListener === 'function') groupsListener();
            if (currentMessagesUnsub && typeof currentMessagesUnsub === 'function') currentMessagesUnsub();
            
            const convList = document.getElementById('conversations-list');
            if (convList) {
                const rows = convList.querySelectorAll('.chat-row:not(#row-global)');
                rows.forEach(el => el.remove());
            }
            
            Object.keys(conversationsIndex).forEach(k => delete conversationsIndex[k]);
        }

        function initUsersCacheListener(){
            const usersRef = ref(db, 'users');
            usersListener = onValue(usersRef, (snapshot) => {
                const val = snapshot.val() || {};
                const currentUser = window.state.user;
                
                Object.keys(val).forEach(k => usersCache[k] = val[k]);
                
                if (currentUser && val[currentUser.uid]) {
                    window.state.profile = val[currentUser.uid];
                    const avatarEl = document.getElementById('user-profile-img');
                    const nameEl = document.getElementById('user-display-name');
                    const tagEl = document.getElementById('user-display-tag');
                    
                    if (avatarEl && avatarEl.src !== (window.state.profile.photoURL || 'https://via.placeholder.com/150')) {
                        avatarEl.src = window.state.profile.photoURL || 'https://via.placeholder.com/150';
                    }
                    if (nameEl) nameEl.innerText = window.state.profile.displayName || '';
                    if (tagEl) tagEl.innerText = '@' + (window.state.profile.usernameDisplay || '');
                }
            }, { onlyOnce: false });
        }

        function initConversationsListener(){
            const dmsRef = ref(db, 'dms');
            dmsListener = onValue(dmsRef, (snapshot) => {
                const all = snapshot.val() || {};
                Object.entries(all).forEach(([dmId, dm]) => {
                    const members = (dm.meta && dm.meta.members) || dm.members || {};
                    if (window.state.user && members[window.state.user.uid]) {
                        const otherUid = Object.keys(members).find(u => u !== window.state.user.uid);
                        const title = otherUid ? (usersCache[otherUid] ? usersCache[otherUid].displayName : '–õ–∏—á–Ω—ã–π —á–∞—Ç') : '–ß–∞—Ç';
                        const avatar = otherUid ? (usersCache[otherUid] ? usersCache[otherUid].photoURL : '') : '';
                        addConversationToList({ type: 'dm', id: dmId, title, avatar, otherUid });
                        
                        listenForNewMessages(`dms/${dmId}/messages`, { type: 'dm', id: dmId, title });
                    } else {
                        const key = 'dm:' + dmId;
                        if (conversationsIndex[key]) removeConversationFromList(key);
                    }
                });
            });

            const groupsRef = ref(db, 'groups');
            groupsListener = onValue(groupsRef, (snapshot) => {
                const all = snapshot.val() || {};
                Object.entries(all).forEach(([groupId, group]) => {
                    const members = group.members || {};
                    if (window.state.user && members[window.state.user.uid]) {
                        addConversationToList({ type: 'group', id: groupId, title: group.name || '–ì—Ä—É–ø–ø–∞', avatar: group.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png' });
                        
                        listenForNewMessages(`groups/${groupId}/messages`, { type: 'group', id: groupId, title: group.name || '–ì—Ä—É–ø–ø–∞' });
                    } else {
                        const key = 'group:' + groupId;
                        if (conversationsIndex[key]) removeConversationFromList(key);
                    }
                });
            });
            
            listenForNewMessages('messages', { type: 'global', id: 'global', title: 'Global Chat' });
        }
        
        function listenForNewMessages(path, chatInfo) {
            const messagesRef = ref(db, path);
            let lastMessageTime = 0;
            
            onValue(messagesRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                
                const messages = Object.values(data);
                const lastMessage = messages.reduce((latest, msg) => {
                    return (msg.createdAt > latest.createdAt) ? msg : latest;
                }, { createdAt: 0 });
                
                if (lastMessage.createdAt > lastMessageTime && 
                    lastMessage.uid !== window.state.user?.uid) {
                    lastMessageTime = lastMessage.createdAt;
                    
                    if (window.state.currentChat.id !== chatInfo.id || 
                        window.state.currentChat.type !== chatInfo.type) {
                        notificationManager.notifyNewMessage(lastMessage, chatInfo);
                    }
                }
            });
        }

        function addConversationToList({ type, id, title, avatar, otherUid }){
            const key = type + ':' + id;
            if (conversationsIndex[key]) {
                const existing = conversationsIndex[key];
                existing.dom.querySelector('.conv-title').innerText = title;
                if (avatar) existing.dom.querySelector('img').src = avatar;
                return;
            }
            const convList = document.getElementById('conversations-list');
            const row = document.createElement('div');
            row.className = 'chat-row';
            row.dataset.convKey = key;
            row.innerHTML = `<img src="${avatar||'https://via.placeholder.com/150'}" class="user-avatar" style="width:46px; height:46px; border-radius:8px;">
                <div style="flex:1; min-width:0;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="conv-title" style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(title)}</div>
                        <div class="muted-xs" style="color:#aaa; flex-shrink:0;">${type === 'group' ? '–≥—Ä—É–ø–ø–∞' : '–ª–∏—á–Ω—ã–π'}</div>
                    </div>
                </div>`;
            row.onclick = () => { 
                if (type === 'dm') {
                    uiAction.openDMById(id, otherUid); 
                } else if (type === 'group') {
                    uiAction.openGroupChat(id); 
                }
                closeMobileSidebar();
            };
            const globalRow = document.getElementById('row-global');
            if (globalRow && globalRow.nextSibling) convList.insertBefore(row, globalRow.nextSibling);
            else convList.appendChild(row);
            conversationsIndex[key] = { type, id, dom: row };
        }

        function removeConversationFromList(key){
            const it = conversationsIndex[key];
            if (!it) return;
            if (it.dom && it.dom.parentNode) it.dom.parentNode.removeChild(it.dom);
            delete conversationsIndex[key];
        }

        /* Chat engine —Å –§–ò–ö–°–û–ú –∫–∞—Ä—Ç–∏–Ω–æ–∫ */
        window.chatEngine = {
            sendMessage: async function(){
                const input = document.getElementById('main-input');
                const text = input.value.trim();
                if (!text) return;
                
                const chat = window.state.currentChat || { type:'global', id:'global' };
                let path;
                if (chat.type === 'global') path = 'messages';
                else if (chat.type === 'dm') path = `dms/${chat.id}/messages`;
                else if (chat.type === 'group') path = `groups/${chat.id}/messages`;
                
                // –§–ò–ö–°: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É
                let isImage = false;
                const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
                const imageRegex = /(https?:\/\/.*\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?.*)?)/i;
                const dataUrlRegex = /^data:image\/\w+;base64,/;
                
                if (imageRegex.test(text) || dataUrlRegex.test(text)) {
                    isImage = true;
                }
                
                const messageData = {
                    uid: window.state.user.uid,
                    displayName: window.state.profile.displayName,
                    username: window.state.profile.usernameDisplay,
                    text: text,
                    createdAt: Date.now(),
                    isImage: isImage
                };
                
                if (window.state.activeAction === 'reply' && window.state.targetMessage) {
                    messageData.replyTo = { 
                        author: window.state.targetMessage.displayName, 
                        content: window.state.targetMessage.text 
                    };
                }
                
                try {
                    await push(ref(db, path), messageData);
                    this.cancelAction();
                    
                    const attachMenu = document.getElementById('attach-menu');
                    if (attachMenu) attachMenu.style.display = 'none';
                    
                    input.value = '';
                    input.style.height = 'auto';
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                }
            },

            openChatListener: function(path){
                const messagesContainer = document.getElementById('messages-view');
                if (!messagesContainer) return;
                messagesContainer.innerHTML = '<div class="muted-xs" style="padding:12px; opacity:0.6;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
                const messagesRef = ref(db, path);
                currentMessagesUnsub = onValue(messagesRef, (snapshot) => {
                    messagesContainer.innerHTML = '';
                    const data = snapshot.val();
                    if (!data) { 
                        messagesContainer.innerHTML = '<div class="muted-xs" style="padding:12px; opacity:0.6;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>'; 
                        return; 
                    }
                    
                    Object.entries(data)
                        .map(([msgId, msg]) => ({ msgId, ...msg }))
                        .sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0))
                        .forEach(({ msgId, ...msg }) => {
                            const isMyMessage = msg.uid === window.state.user.uid;
                            const wrapper = document.createElement('div');
                            wrapper.className = `msg-wrapper ${isMyMessage ? 'my-msg' : 'other-msg'}`;

                            const senderProfile = usersCache[msg.uid] || {};
                            const avatarURL = senderProfile.photoURL || msg.photoURL || 'https://via.placeholder.com/150';
                            const displayName = escapeHtml(msg.displayName || senderProfile.displayName || 'User');
                            const usernameDisplay = escapeHtml((senderProfile.usernameDisplay || senderProfile.username || msg.username || '').toString());

                            let processedText = escapeHtml(msg.text || '');
                            
                            // –§–ò–ö–°: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫
                            if (msg.isImage) {
                                const imageUrl = msg.text.trim();
                                if (imageUrl.startsWith('data:image/')) {
                                    processedText = `<img src="${imageUrl}" style="max-width:100%; border-radius:8px; margin-top:5px; cursor:pointer;" onclick="window.open(this.src)" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">`;
                                } else {
                                    processedText = `<img src="${imageUrl}" style="max-width:100%; border-radius:8px; margin-top:5px; cursor:pointer;" onclick="window.open(this.src)" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" onerror="this.style.display='none'; this.parentElement.innerHTML='<i>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</i>';">`;
                                }
                            } else {
                                processedText = processedText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                            }

                            const replyMarkup = msg.replyTo ? 
                                `<div style="font-size:12px; border-left:3px solid var(--primary); padding-left:10px; margin-bottom:8px; opacity:0.8;">
                                    <b>${escapeHtml(msg.replyTo.author)}</b><br>
                                    ${escapeHtml((msg.replyTo.content||'').substring(0,80))}
                                    ${(msg.replyTo.content && msg.replyTo.content.length>80)?'...':''}
                                </div>` : '';

                            const avatarHTML = `<img src="${avatarURL}" class="msg-avatar" onclick="uiAction.openProfile('${msg.uid}')" title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">`;
                            const bubbleHTML = `<div class="msg-bubble" id="msg-${msgId}">
                                <span class="author-tag">${displayName} ${usernameDisplay.toLowerCase()==='admin' ? 'üëë' : ''}</span>
                                ${replyMarkup}
                                <div class="msg-content-body">${processedText}</div>
                                <span class="time-stamp">${msg.isEdited ? '–∏–∑–º. ' : ''} ${new Date(msg.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                            </div>`;
                            if (isMyMessage) wrapper.innerHTML = bubbleHTML + avatarHTML;
                            else wrapper.innerHTML = avatarHTML + bubbleHTML;

                            try { wrapper.style.justifyContent = isMyMessage ? 'flex-end' : 'flex-start'; } catch(e){}

                            wrapper.oncontextmenu = (e) => { 
                                e.preventDefault(); 
                                window.chatEngine.openContextMenu(e, msgId, { key: msgId, ...msg }); 
                            };
                            messagesContainer.appendChild(wrapper);
                        });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            },

            attachFromURL: function() {
                const url = prompt("–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:");
                if (url && (url.startsWith('http') || url.startsWith('https'))) { 
                    const mainInput = document.getElementById('main-input');
                    if (mainInput) mainInput.value = url; 
                }
                document.getElementById('attach-menu').style.display = 'none';
            },

            attachFromFile: function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                            alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const mainInput = document.getElementById('main-input');
                            if (mainInput) {
                                mainInput.value = event.target.result;
                                chatEngine.sendMessage();
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
                document.getElementById('attach-menu').style.display = 'none';
            },

            openContextMenu: function(e, key, data){
                const existingPopup = document.getElementById('context-popup');
                if (existingPopup && existingPopup.parentNode) {
                    existingPopup.parentNode.removeChild(existingPopup);
                }
                
                window.state.contextTarget = { key, ...data };
                const popupId = 'context-popup';
                let popup = document.getElementById(popupId);
                if (!popup) {
                    popup = document.createElement('div');
                    popup.id = popupId;
                    popup.style.position = 'fixed';
                    popup.style.zIndex = 10000;
                    popup.style.background = '#fff';
                    popup.style.border = '1px solid var(--border)';
                    popup.style.padding = '8px';
                    popup.style.borderRadius = '10px';
                    popup.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    popup.innerHTML = `<div style="padding:12px; cursor:pointer;" onclick="chatEngine.handleAction('reply')">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
                                       <div style="padding:12px; cursor:pointer;" onclick="chatEngine.handleAction('copy')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
                                       <div id="popup-edit-btn" style="padding:12px; cursor:pointer;" onclick="chatEngine.handleAction('edit')">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                                       <div id="popup-delete-btn" style="padding:12px; cursor:pointer; color:#ff3b30;" onclick="chatEngine.handleAction('delete')">üóë –£–¥–∞–ª–∏—Ç—å</div>`;
                    document.body.appendChild(popup);
                }
                const popupEl = document.getElementById(popupId);
                popupEl.style.display = 'block';
                let x = e.clientX, y = e.clientY;
                if (x + 220 > window.innerWidth) x -= 220;
                if (y + 150 > window.innerHeight) y -= 150;
                popupEl.style.left = x + 'px'; 
                popupEl.style.top = y + 'px';
                const isMine = data.uid === window.state.user.uid;
                const editBtn = document.getElementById('popup-edit-btn');
                const delBtn = document.getElementById('popup-delete-btn');
                if (editBtn) editBtn.style.display = isMine ? 'block' : 'none';
                if (delBtn) delBtn.style.display = (isMine || window.state.isAdmin) ? 'block' : 'none';
            },

            handleAction: function(type){
                const popup = document.getElementById('context-popup');
                if (popup) popup.style.display = 'none';
                if (type === 'reply' || type === 'edit') {
                    window.state.activeAction = type;
                    window.state.targetMessage = window.state.contextTarget;
                    const replyPreview = document.getElementById('reply-preview');
                    if (replyPreview) {
                        replyPreview.style.display = 'block';
                        replyPreview.innerHTML = type === 'edit' 
                            ? '<div><b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</b></div><div>' + escapeHtml(window.state.targetMessage.text) + '</div>'
                            : `<div><b>–û—Ç–≤–µ—Ç ${escapeHtml(window.state.targetMessage.displayName)}</b></div><div>${escapeHtml(window.state.targetMessage.text)}</div>`;
                    }
                    if (type === 'edit') {
                        const mainInput = document.getElementById('main-input');
                        if (mainInput) mainInput.value = window.state.targetMessage.text;
                    }
                    const mainInput = document.getElementById('main-input');
                    if (mainInput) mainInput.focus();
                } else if (type === 'copy') {
                    navigator.clipboard.writeText(window.state.contextTarget.text || '');
                } else if (type === 'delete') {
                    if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;
                    const chat = window.state.currentChat;
                    let path;
                    if (chat.type === 'global') path = `messages/${window.state.contextTarget.key}`;
                    else if (chat.type === 'dm') path = `dms/${chat.id}/messages/${window.state.contextTarget.key}`;
                    else if (chat.type === 'group') path = `groups/${chat.id}/messages/${window.state.contextTarget.key}`;
                    remove(ref(db, path));
                }
            },

            cancelAction: function(){
                window.state.activeAction = null; 
                window.state.targetMessage = null;
                const replyPreview = document.getElementById('reply-preview');
                if (replyPreview) replyPreview.style.display = 'none';
                const mainInput = document.getElementById('main-input');
                if (mainInput) mainInput.value = '';
            }
        };

        /* uiAction —Å –§–ò–ö–°–û–ú —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã */
        window.uiAction = {
            openGlobal: () => {
                window.state.currentChat = { type: 'global', id: 'global', title: 'Global Chat Room' };
                const chatTopTitle = document.getElementById('chat-top-title');
                const chatTopSub = document.getElementById('chat-top-sub');
                const chatTopAvatar = document.getElementById('chat-top-avatar');
                if (chatTopTitle) chatTopTitle.innerText = 'Global Chat Room';
                if (chatTopSub) chatTopSub.innerText = '–û–±—â–∏–π —á–∞—Ç';
                if (chatTopAvatar) chatTopAvatar.src = 'https://cdn-icons-png.flaticon.com/512/1041/1041916.png';
                chatEngine.openChatListener('messages');
                hideMobileSidebar();
            },

            createOrOpenDM: async (otherUid) => {
                if (!otherUid || !window.state.user) return;
                if (otherUid === window.state.user.uid) { 
                    uiAction.openProfile(otherUid); 
                    return; 
                }
                
                const u1 = window.state.user.uid;
                const u2 = otherUid;
                const chatId = ['dm', ...[u1, u2].sort()].join('_');
                
                const chatRef = ref(db, `dms/${chatId}`);
                const chatSnap = await get(chatRef);
                
                if (!chatSnap.exists()) {
                    const meta = { 
                        members: { [u1]: true, [u2]: true }, 
                        createdAt: Date.now(),
                        lastMessageAt: Date.now()
                    };
                    await set(ref(db, `dms/${chatId}/meta`), meta);
                }
                
                const otherUser = usersCache[otherUid] || {};
                addConversationToList({ 
                    type: 'dm', 
                    id: chatId, 
                    title: otherUser.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç', 
                    avatar: otherUser.photoURL || 'https://via.placeholder.com/150', 
                    otherUid 
                });
                uiAction.openDMById(chatId, otherUid);
                hideMobileSidebar();
            },

            openDMById: async (chatId, otherUid) => {
                const other = usersCache[otherUid] || {};
                window.state.currentChat = { 
                    type: 'dm', 
                    id: chatId, 
                    title: other.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç', 
                    photo: other.photoURL || '', 
                    otherUid 
                };
                const chatTopTitle = document.getElementById('chat-top-title');
                const chatTopSub = document.getElementById('chat-top-sub');
                const chatTopAvatar = document.getElementById('chat-top-avatar');
                if (chatTopTitle) chatTopTitle.innerText = other.displayName || '–õ–∏—á–Ω—ã–π —á–∞—Ç';
                if (chatTopSub) chatTopSub.innerText = '@' + (other.usernameDisplay || other.username || '');
                if (chatTopAvatar) chatTopAvatar.src = other.photoURL || 'https://via.placeholder.com/150';
                chatEngine.openChatListener(`dms/${chatId}/messages`);
                hideMobileSidebar();
            },

            openProfile: (uid) => {
                if (!uid) return;
                
                window.state.profileViewMode = 'user';
                
                const user = usersCache[uid] || (window.state.user && uid === window.state.user.uid ? window.state.profile : null);
                if (!user) { alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
                uiAction._profileShownUid = uid;
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                if (overlay) overlay.classList.add('active'); 
                if (modal) {
                    modal.classList.add('active'); 
                    modal.setAttribute('aria-hidden','false');
                }

                const modalTitle = document.getElementById('profile-modal-title');
                if (modalTitle) modalTitle.innerText = '–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';

                const pAvatar = document.getElementById('p-avatar');
                const pDisplayName = document.getElementById('p-displayname');
                const pUsername = document.getElementById('p-username');
                const pAbout = document.getElementById('p-about');
                const pAvatarInput = document.getElementById('p-avatar-input');
                const pAboutInput = document.getElementById('p-about-input');
                
                if (pAvatar) pAvatar.src = user.photoURL || 'https://via.placeholder.com/150';
                if (pDisplayName) pDisplayName.innerText = user.displayName || 'User';
                if (pUsername) pUsername.innerText = '@' + (user.usernameDisplay || user.username || '');
                if (pAbout) pAbout.innerText = user.about || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.';

                const profileEditArea = document.getElementById('profile-edit-area');
                const btnEditProfile = document.getElementById('btn-edit-profile');
                const btnSaveProfile = document.getElementById('btn-save-profile');
                const btnUpgrade = document.getElementById('btn-upgrade');
                const btnWrite = document.getElementById('btn-write');
                const groupInfoSection = document.getElementById('group-info-section');
                const groupEditFields = document.getElementById('group-edit-fields');

                if (groupInfoSection) groupInfoSection.style.display = 'none';
                if (groupEditFields) groupEditFields.style.display = 'none';

                if (window.state.user && uid === window.state.user.uid) {
                    if (profileEditArea) profileEditArea.style.display = 'block';
                    if (pAvatarInput) pAvatarInput.value = user.photoURL || '';
                    if (pAboutInput) pAboutInput.value = user.about || '';
                    if (btnEditProfile) btnEditProfile.style.display = 'inline-flex';
                    if (btnSaveProfile) btnSaveProfile.style.display = 'none';
                    if (btnUpgrade) btnUpgrade.style.display = (auth.currentUser && auth.currentUser.isAnonymous) ? 'inline-flex' : 'none';
                    if (btnWrite) btnWrite.style.display = 'none';
                } else {
                    if (profileEditArea) profileEditArea.style.display = 'none';
                    if (btnEditProfile) btnEditProfile.style.display = 'none';
                    if (btnSaveProfile) btnSaveProfile.style.display = 'none';
                    if (btnUpgrade) btnUpgrade.style.display = 'none';
                    if (btnWrite) btnWrite.style.display = 'inline-flex';
                    
                    if (window.state.currentChat.type === 'dm' && window.state.currentChat.otherUid === uid) {
                        btnWrite.style.display = 'none';
                    }
                }
            },

            openGroupInfo: async (groupId) => {
                const snap = await get(ref(db, `groups/${groupId}`));
                if (!snap.exists()) {
                    alert('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }
                
                const group = snap.val();
                window.state.currentGroupInfo = group;
                window.state.profileViewMode = 'group';
                
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                if (overlay) overlay.classList.add('active'); 
                if (modal) {
                    modal.classList.add('active'); 
                    modal.setAttribute('aria-hidden','false');
                }

                const modalTitle = document.getElementById('profile-modal-title');
                if (modalTitle) modalTitle.innerText = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ';

                const pAvatar = document.getElementById('p-avatar');
                const pDisplayName = document.getElementById('p-displayname');
                const pUsername = document.getElementById('p-username');
                const pAbout = document.getElementById('p-about');
                const groupInfoSection = document.getElementById('group-info-section');
                const groupMembersList = document.getElementById('group-members-list');
                const groupEditFields = document.getElementById('group-edit-fields');
                const groupNameInput = document.getElementById('group-name-input');
                const groupDescriptionInput = document.getElementById('group-description-input');
                
                // –§–ò–ö–°: –£–±—Ä–∞–ª –∞–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const groupImage = group.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
                if (pAvatar) pAvatar.src = groupImage;
                if (pDisplayName) pDisplayName.innerText = group.name || '–ì—Ä—É–ø–ø–∞';
                if (pUsername) pUsername.innerText = `${Object.keys(group.members || {}).length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                if (pAbout) pAbout.innerText = group.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.';

                if (groupInfoSection) groupInfoSection.style.display = 'block';

                if (groupMembersList) {
                    groupMembersList.innerHTML = '';
                    Object.keys(group.members || {}).forEach(uid => {
                        const user = usersCache[uid] || {};
                        const memberItem = document.createElement('div');
                        memberItem.className = 'member-item';
                        memberItem.innerHTML = `
                            <img src="${user.photoURL || 'https://via.placeholder.com/150'}" style="width:36px;height:36px;border-radius:6px;">
                            <div>
                                <div style="font-weight:600;">${escapeHtml(user.displayName || 'User')}</div>
                                <div style="font-size:12px; color:var(--muted);">@${escapeHtml(user.usernameDisplay || user.username || '')}</div>
                            </div>
                        `;
                        groupMembersList.appendChild(memberItem);
                    });
                }

                const profileEditArea = document.getElementById('profile-edit-area');
                const btnEditProfile = document.getElementById('btn-edit-profile');
                const btnSaveProfile = document.getElementById('btn-save-profile');
                const btnUpgrade = document.getElementById('btn-upgrade');
                const btnWrite = document.getElementById('btn-write');

                if (profileEditArea) profileEditArea.style.display = 'none';
                if (btnEditProfile) btnEditProfile.style.display = 'none';
                if (btnSaveProfile) btnSaveProfile.style.display = 'none';
                if (btnUpgrade) btnUpgrade.style.display = 'none';
                if (btnWrite) btnWrite.style.display = 'none';

                const isOwner = group.owner === window.state.user?.uid;
                const isAdmin = window.state.isAdmin;
                
                if (isOwner || isAdmin) {
                    if (btnEditProfile) {
                        btnEditProfile.style.display = 'inline-flex';
                        btnEditProfile.innerText = '‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É';
                    }
                    
                    // –§–ò–ö–°: –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –∞–≤–∞—Ç–∞—Ä–∞
                    const pAvatarInput = document.getElementById('p-avatar-input');
                    if (pAvatarInput) pAvatarInput.value = '';
                    
                    if (groupNameInput) groupNameInput.value = group.name || '';
                    if (groupDescriptionInput) groupDescriptionInput.value = group.description || '';
                }
            },

            closeProfile: () => {
                const overlay = document.getElementById('profile-overlay');
                const modal = document.getElementById('profile-modal');
                if (overlay) overlay.classList.remove('active'); 
                if (modal) {
                    modal.classList.remove('active'); 
                    modal.setAttribute('aria-hidden','true');
                }
                window.state.profileViewMode = 'user';
            },

            startEditProfile: () => {
                const profileEditArea = document.getElementById('profile-edit-area');
                const btnEditProfile = document.getElementById('btn-edit-profile');
                const btnSaveProfile = document.getElementById('btn-save-profile');
                const groupEditFields = document.getElementById('group-edit-fields');
                
                if (window.state.profileViewMode === 'group') {
                    if (profileEditArea) profileEditArea.style.display = 'block';
                    if (groupEditFields) groupEditFields.style.display = 'block';
                    if (btnEditProfile) btnEditProfile.style.display = 'none';
                    if (btnSaveProfile) btnSaveProfile.style.display = 'inline-flex';
                } else {
                    if (profileEditArea) profileEditArea.style.display = 'block';
                    if (groupEditFields) groupEditFields.style.display = 'none';
                    if (btnEditProfile) btnEditProfile.style.display = 'none';
                    if (btnSaveProfile) btnSaveProfile.style.display = 'inline-flex';
                }
            },

            // –§–ò–ö–°: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã –±–µ–∑ –æ—à–∏–±–æ–∫
            saveProfile: async () => {
                if (!window.state.user) return;
                
                if (window.state.profileViewMode === 'group') {
                    const group = window.state.currentGroupInfo;
                    if (!group) return;
                    
                    const groupNameInput = document.getElementById('group-name-input');
                    const groupDescriptionInput = document.getElementById('group-description-input');
                    const pAvatarInput = document.getElementById('p-avatar-input');
                    
                    if (!groupNameInput || !groupDescriptionInput || !pAvatarInput) return;
                    
                    const newName = groupNameInput.value.trim();
                    const newDescription = groupDescriptionInput.value.trim();
                    const newImage = pAvatarInput.value.trim();
                    
                    if (!newName) {
                        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
                        return;
                    }
                    
                    if (newImage && !/^https?:\/\//i.test(newImage)) {
                        alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http/https');
                        return;
                    }
                    
                    const updates = {
                        name: newName,
                        description: newDescription
                    };
                    
                    // –§–ò–ö–°: –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ
                    if (newImage) {
                        updates.image = newImage;
                    } else {
                        // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        updates.image = group.image || '';
                    }
                    
                    try {
                        // –§–ò–ö–°: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                        await update(ref(db, `groups/${group.id}`), updates);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        window.state.currentGroupInfo = { ...window.state.currentGroupInfo, ...updates };
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º UI
                        const pDisplayName = document.getElementById('p-displayname');
                        const pAbout = document.getElementById('p-about');
                        const pAvatar = document.getElementById('p-avatar');
                        
                        if (pDisplayName) pDisplayName.innerText = newName;
                        if (pAbout) pAbout.innerText = newDescription || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.';
                        if (pAvatar) pAvatar.src = updates.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
                        
                        if (window.state.currentChat.id === group.id) {
                            const chatTopTitle = document.getElementById('chat-top-title');
                            const chatTopAvatar = document.getElementById('chat-top-avatar');
                            if (chatTopTitle) chatTopTitle.innerText = newName;
                            if (chatTopAvatar) chatTopAvatar.src = updates.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                        const key = 'group:' + group.id;
                        if (conversationsIndex[key] && conversationsIndex[key].dom) {
                            const titleEl = conversationsIndex[key].dom.querySelector('.conv-title');
                            const avatarEl = conversationsIndex[key].dom.querySelector('img');
                            if (titleEl) titleEl.innerText = newName;
                            if (avatarEl) avatarEl.src = updates.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
                        }
                        
                        // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        this.startEditProfile();
                        alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                    } catch (err) { 
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã:', err);
                        // –§–ò–ö–°: –£–±—Ä–∞–ª –¥—É–±–ª–∏—Ä—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                        alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                    }
                } else {
                    const pAvatarInput = document.getElementById('p-avatar-input');
                    const pAboutInput = document.getElementById('p-about-input');
                    if (!pAvatarInput || !pAboutInput) return;
                    
                    const newAva = pAvatarInput.value.trim();
                    const newAbout = pAboutInput.value.trim();
                    if (newAva && !/^https?:\/\//i.test(newAva)) {
                        alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http/https');
                        return;
                    }
                    
                    const updates = {};
                    if (newAva) updates.photoURL = newAva;
                    updates.about = newAbout || '';
                    
                    try {
                        await update(ref(db, `users/${window.state.user.uid}`), updates);
                        if (updates.photoURL) {
                            const pAvatar = document.getElementById('p-avatar');
                            const userProfileImg = document.getElementById('user-profile-img');
                            if (pAvatar) pAvatar.src = updates.photoURL;
                            if (userProfileImg) userProfileImg.src = updates.photoURL;
                        }
                        
                        const pAbout = document.getElementById('p-about');
                        if (pAbout) pAbout.innerText = updates.about;
                        
                        window.state.profile = Object.assign(window.state.profile || {}, updates);
                        
                        const profileEditArea = document.getElementById('profile-edit-area');
                        const btnEditProfile = document.getElementById('btn-edit-profile');
                        const btnSaveProfile = document.getElementById('btn-save-profile');
                        if (profileEditArea) profileEditArea.style.display = 'none';
                        if (btnEditProfile) btnEditProfile.style.display = 'inline-flex';
                        if (btnSaveProfile) btnSaveProfile.style.display = 'none';
                        
                        alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
                    } catch (err) { 
                        console.error(err); 
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è'); 
                    }
                }
            },

            upgradeToGoogle: async () => {
                if (!auth.currentUser) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                if (!auth.currentUser.isAnonymous) return alert('–£–∂–µ –Ω–µ –≥–æ—Å—Ç–µ–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç');
                try {
                    const result = await linkWithPopup(auth.currentUser, provider);
                    const pd = (result.user.providerData && result.user.providerData[0]) || {};
                    const updates = {};
                    if (pd.displayName) updates.displayName = pd.displayName;
                    if (pd.photoURL) updates.photoURL = pd.photoURL;
                    await update(ref(db, `users/${result.user.uid}`), updates);
                    alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ Google');
                    uiAction.closeProfile();
                } catch (err) { 
                    console.error(err); 
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏: ' + (err.message || err)); 
                }
            },

            // –§–ò–ö–°: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ –º–µ–Ω—è–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            openSettings: () => {
                const settingsModal = document.getElementById('settings-modal');
                if (settingsModal) {
                    settingsModal.classList.add('active');
                    settingsModal.setAttribute('aria-hidden','false');
                    
                    const root = document.documentElement.style;
                    const uiColorPrimary = document.getElementById('ui-color-primary');
                    const uiColorMe = document.getElementById('ui-color-me');
                    const uiBgColor = document.getElementById('ui-bg-color');
                    const uiFontRange = document.getElementById('ui-font-range');
                    const uiRadiusRange = document.getElementById('ui-radius-range');
                    
                    if (uiColorPrimary) uiColorPrimary.value = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()) || '#3390ec';
                    if (uiColorMe) uiColorMe.value = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--msg-me').trim()) || '#eeffde';
                    if (uiBgColor) uiBgColor.value = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()) || '#ffffff';
                    if (uiFontRange) uiFontRange.value = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size')) || 16;
                    if (uiRadiusRange) uiRadiusRange.value = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--message-border-radius')) || 12;
                    
                    themeCore.updatePreview();
                }
                hideMobileSidebar();
            },

            closeSettings: () => {
                const settingsModal = document.getElementById('settings-modal');
                if (settingsModal) {
                    settingsModal.classList.remove('active');
                    settingsModal.setAttribute('aria-hidden','true');
                }
            },

            openNotifications: () => {
                const notificationsModal = document.getElementById('notifications-modal');
                const notificationsOverlay = document.getElementById('notifications-overlay');
                if (notificationsModal) {
                    notificationsModal.classList.add('active');
                    notificationsModal.setAttribute('aria-hidden','false');
                }
                if (notificationsOverlay) {
                    notificationsOverlay.classList.add('active');
                }
                
                notificationManager.updateNotificationStatus();
                notificationManager.updateHistoryView();
                hideMobileSidebar();
            },

            closeNotifications: () => {
                const notificationsModal = document.getElementById('notifications-modal');
                const notificationsOverlay = document.getElementById('notifications-overlay');
                if (notificationsModal) {
                    notificationsModal.classList.remove('active');
                    notificationsModal.setAttribute('aria-hidden','true');
                }
                if (notificationsOverlay) {
                    notificationsOverlay.classList.remove('active');
                }
            },

            openCreateGroup: () => {
                const groupOverlay = document.getElementById('group-overlay');
                const groupModal = document.getElementById('group-modal');
                const groupName = document.getElementById('group-name');
                const groupImageUrl = document.getElementById('group-image-url');
                const groupAddSearch = document.getElementById('group-add-search');
                const groupSearchResults = document.getElementById('group-search-results');
                const groupSelected = document.getElementById('group-selected');
                
                if (groupOverlay) groupOverlay.classList.add('active');
                if (groupModal) groupModal.classList.add('active');
                if (groupName) groupName.value = '';
                if (groupImageUrl) groupImageUrl.value = '';
                if (groupAddSearch) groupAddSearch.value = '';
                if (groupSearchResults) groupSearchResults.innerHTML = '';
                if (groupSelected) groupSelected.innerHTML = '';
                
                if (!uiAction._groupSelected) uiAction._groupSelected = {};
                uiAction._groupSelected[window.state.user.uid] = { 
                    uid: window.state.user.uid, 
                    name: window.state.profile.displayName, 
                    photo: window.state.profile.photoURL 
                };
                renderGroupSelected();
                hideMobileSidebar();
            },

            closeCreateGroup: () => {
                const groupOverlay = document.getElementById('group-overlay');
                const groupModal = document.getElementById('group-modal');
                if (groupOverlay) groupOverlay.classList.remove('active');
                if (groupModal) groupModal.classList.remove('active');
                uiAction._groupSelected = {};
            },

            selectGroupMember: (uid, name, photo) => {
                uiAction._groupSelected = uiAction._groupSelected || {};
                uiAction._groupSelected[uid] = { uid, name, photo };
                renderGroupSelected();
            },

            removeGroupMember: (uid) => { 
                if (!uiAction._groupSelected) return; 
                delete uiAction._groupSelected[uid]; 
                renderGroupSelected(); 
            },

            createGroup: async () => {
                const groupNameInput = document.getElementById('group-name');
                const groupImageUrlInput = document.getElementById('group-image-url');
                if (!groupNameInput || !groupImageUrlInput) return;
                
                const name = (groupNameInput.value || '').trim();
                if (!name || name.length < 2) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–º–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞)');
                    return;
                }
                
                const image = (groupImageUrlInput.value || '').trim();
                const selected = uiAction._groupSelected || {};
                const members = Object.keys(selected);
                if (members.length < 2) {
                    alert('–î–æ–±–∞–≤—å—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∫—Ä–æ–º–µ –≤–∞—Å');
                    return;
                }
                
                try {
                    const gRef = push(ref(db, 'groups'));
                    const groupId = gRef.key;
                    const membersObj = {};
                    members.forEach(uid => membersObj[uid] = true);
                    const meta = { 
                        id: groupId, 
                        name, 
                        owner: window.state.user.uid, 
                        members: membersObj, 
                        createdAt: Date.now(), 
                        image: image || '',
                        description: ''
                    };
                    await set(ref(db, `groups/${groupId}`), meta);
                    uiAction.closeCreateGroup();
                    addConversationToList({ 
                        type: 'group', 
                        id: groupId, 
                        title: name, 
                        avatar: image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png' 
                    });
                    uiAction.openGroupChat(groupId, meta);
                } catch (err) { 
                    console.error(err); 
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã'); 
                }
            },

            openGroupChat: async (groupId, meta) => {
                let groupMeta = meta;
                if (!groupMeta) {
                    const snap = await get(ref(db, `groups/${groupId}`));
                    if (!snap.exists()) {
                        alert('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                        return;
                    }
                    groupMeta = snap.val();
                }
                
                window.state.currentChat = { 
                    type: 'group', 
                    id: groupId, 
                    title: groupMeta.name, 
                    ownerUid: groupMeta.owner || '', 
                    members: groupMeta.members || {} 
                };
                
                const chatTopTitle = document.getElementById('chat-top-title');
                const chatTopSub = document.getElementById('chat-top-sub');
                const chatTopAvatar = document.getElementById('chat-top-avatar');
                
                if (chatTopTitle) chatTopTitle.innerText = groupMeta.name;
                if (chatTopSub) chatTopSub.innerText = `–ì—Ä—É–ø–ø–∞ ‚Ä¢ ${Object.keys(groupMeta.members||{}).length} —É—á–∞—Å—Ç–Ω–∏–∫(–æ–≤)`;
                if (chatTopAvatar) chatTopAvatar.src = groupMeta.image || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
                
                chatEngine.openChatListener(`groups/${groupId}/messages`);
                hideMobileSidebar();
            }
        };

        function renderGroupSelected(){
            const container = document.getElementById('group-selected');
            if (!container) return;
            container.innerHTML = '';
            const selected = uiAction._groupSelected || {};
            Object.values(selected).forEach(s => {
                const el = document.createElement('div');
                el.className = 'chip';
                el.innerHTML = `<img src="${s.photo||'https://via.placeholder.com/150'}" style="width:28px;height:28px;border-radius:6px;object-fit:cover;">
                               <span>${escapeHtml(s.name)}</span>
                               <button onclick="uiAction.removeGroupMember('${s.uid}')" style="background:transparent;border:none;cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center;">‚úï</button>`;
                container.appendChild(el);
            });
        }

        /* themeCore —Å –§–ò–ö–°–û–ú –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        window.themeCore = {
            preview: function(){
                const preview = document.getElementById('settings-preview');
                if (!preview) return;
                
                const pr = document.getElementById('ui-color-primary')?.value;
                const me = document.getElementById('ui-color-me')?.value;
                const bg = document.getElementById('ui-bg-color')?.value;
                const fz = document.getElementById('ui-font-range')?.value;
                const rd = document.getElementById('ui-radius-range')?.value;
                
                // –§–ò–ö–°: –ú–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                if (pr) preview.style.setProperty('--primary', pr);
                if (me) preview.style.setProperty('--msg-me', me);
                if (bg) preview.style.backgroundColor = bg;
                if (fz) preview.style.fontSize = fz + 'px';
                if (rd) {
                    preview.style.borderRadius = rd + 'px';
                    preview.querySelectorAll('.preview-message').forEach(msg => {
                        msg.style.borderRadius = rd + 'px';
                    });
                }
            },
            
            updatePreview: function() {
                this.preview();
            },
            
            save: function(){
                const settings = {
                    pr: document.getElementById('ui-color-primary')?.value,
                    me: document.getElementById('ui-color-me')?.value,
                    bg: document.getElementById('ui-bg-color')?.value,
                    fz: document.getElementById('ui-font-range')?.value,
                    rd: document.getElementById('ui-radius-range')?.value
                };
                localStorage.setItem('narrators_custom_ui', JSON.stringify(settings));
                this.apply(settings);
                uiAction.closeSettings();
            },
            
            load: function(){
                const saved = localStorage.getItem('narrators_custom_ui');
                if (saved) this.apply(JSON.parse(saved));
            },
            
            apply: function(t){
                if (!t) return;
                const root = document.documentElement.style;
                if (t.pr) root.setProperty('--primary', t.pr);
                if (t.me) root.setProperty('--msg-me', t.me);
                if (t.bg) root.setProperty('--bg', t.bg);
                if (t.fz) root.setProperty('--font-size', t.fz + 'px');
                if (t.rd) {
                    root.setProperty('--radius', t.rd + 'px');
                    root.setProperty('--message-border-radius', t.rd + 'px');
                }
            },
            
            reset: function(){
                localStorage.removeItem('narrators_custom_ui');
                const root = document.documentElement.style;
                root.removeProperty('--primary');
                root.removeProperty('--msg-me');
                root.removeProperty('--bg');
                root.removeProperty('--font-size');
                root.removeProperty('--radius');
                root.removeProperty('--message-border-radius');
                uiAction.closeSettings();
                setTimeout(() => location.reload(), 300);
            }
        };

        /* DOMContentLoaded */
        document.addEventListener('DOMContentLoaded', function() {
            const mainInput = document.getElementById('main-input');
            if (mainInput) {
                mainInput.addEventListener('keydown', (e) => { 
                    if (e.key === 'Enter' && !e.shiftKey) { 
                        e.preventDefault(); 
                        if (typeof chatEngine.sendMessage === 'function') {
                            chatEngine.sendMessage(); 
                        }
                    } 
                });
                
                mainInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
            
            ['ui-color-primary','ui-color-me','ui-bg-color','ui-font-range','ui-radius-range'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', () => {
                        if (typeof themeCore.preview === 'function') {
                            themeCore.preview();
                        }
                    });
                }
            });
            
            const chatTopAvatar = document.getElementById('chat-top-avatar');
            if (chatTopAvatar) {
                chatTopAvatar.addEventListener('click', () => {
                    const c = window.state.currentChat || {};
                    if (c.type === 'dm') {
                        uiAction.openProfile(c.otherUid);
                    } else if (c.type === 'group') {
                        uiAction.openGroupInfo(c.id);
                    } else if (window.state.user) {
                        uiAction.openProfile(window.state.user.uid);
                    }
                });
            }
            
            const signoutBtn = document.getElementById('signout-btn');
            if (signoutBtn) {
                signoutBtn.addEventListener('click', async () => {
                    try { 
                        await signOut(auth); 
                    } catch (err) { 
                        console.error(err); 
                        alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + (err.message || err)); 
                    }
                });
            }
            
            // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
            function updateMobileUI() {
                const isMobileView = isMobile();
                const signoutBtn = document.getElementById('signout-btn');
                const mobileBackBtn = document.getElementById('mobile-back-btn');
                const mobileChatBack = document.getElementById('mobile-chat-back');
                
                if (isMobileView) {
                    if (signoutBtn) signoutBtn.style.display = 'none';
                    if (mobileBackBtn) mobileBackBtn.style.display = 'none';
                    if (mobileChatBack) mobileChatBack.style.display = 'none';
                } else {
                    if (signoutBtn) signoutBtn.style.display = 'inline-flex';
                }
            }
            
            updateMobileUI();
            window.addEventListener('resize', updateMobileUI);
        });

        function initGroupSearch(){
            const input = document.getElementById('group-add-search');
            const results = document.getElementById('group-search-results');
            if (!input) return;
            input.addEventListener('input', async (e) => {
                const q = e.target.value.trim().toLowerCase().replace('@','');
                if (results) results.innerHTML = '';
                if (q.length < 2) return;
                const users = Object.values(usersCache || {});
                const found = users.filter(u => (u.username || '').includes(q) || (u.displayName || '').toLowerCase().includes(q));
                found.forEach(u => {
                    const row = document.createElement('div');
                    row.className = 'user-select-row';
                    row.style.display = 'flex';
                    row.style.gap = '8px';
                    row.style.alignItems = 'center';
                    row.style.padding = '12px';
                    row.style.borderRadius = '8px';
                    row.style.border = '1px solid var(--border)';
                    row.style.marginBottom = '8px';
                    row.innerHTML = `<img src="${u.photoURL || 'https://via.placeholder.com/150'}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-weight:700;">${escapeHtml(u.displayName)}</div>
                            <div style="font-size:12px; color:var(--muted);">@${escapeHtml(u.usernameDisplay||u.username)}</div>
                        </div>
                        <button class="btn btn-primary" style="width:auto; padding:10px 14px; min-height:40px;" onclick="uiAction.selectGroupMember('${u.uid}', '${escapeHtml(u.displayName)}', '${escapeHtml(u.photoURL||'')}')">–î–æ–±–∞–≤–∏—Ç—å</button>`;
                    if (results) results.appendChild(row);
                });
            });
        }

        function initSearch(){
            const searchInput = document.getElementById('user-search-input');
            const parent = searchInput.parentNode;
            if (parent && !document.getElementById('search-results-container')) {
                const resultsBox = document.createElement('div');
                resultsBox.id = 'search-results-container';
                resultsBox.style.position = 'relative';
                parent.appendChild(resultsBox);
            }
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim().toLowerCase().replace('@','');
                const resultsBox = document.getElementById('search-results-container');
                if (resultsBox) resultsBox.innerHTML = '';
                if (query.length < 2) return;
                const users = Object.values(usersCache || {});
                const found = users.filter(u => (u.username || '').includes(query) || (u.displayName || '').toLowerCase().includes(query));
                if (found.length === 0) return;
                const box = document.createElement('div');
                box.style.position = 'absolute';
                box.style.left = '0';
                box.style.right = '0';
                box.style.background = '#fff';
                box.style.border = '1px solid var(--border)';
                box.style.borderRadius = '10px';
                box.style.marginTop = '6px';
                box.style.maxHeight = '220px';
                box.style.overflowY = 'auto';
                box.style.zIndex = '1000';
                found.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'chat-row';
                    div.style.padding = '12px';
                    div.innerHTML = `<img src="${u.photoURL||'https://via.placeholder.com/150'}" class="user-avatar" style="width:36px;height:36px;">
                        <div style="flex:1;">
                            <div style="font-weight:700;">${escapeHtml(u.displayName)}</div>
                            <div class="muted-xs" style="color:var(--primary);">@${escapeHtml(u.usernameDisplay||u.username)}</div>
                        </div>`;
                    div.onclick = () => { uiAction.openProfile(u.uid); if(resultsBox) resultsBox.innerHTML = ''; searchInput.value=''; };
                    box.appendChild(div);
                });
                if (resultsBox) resultsBox.appendChild(box);
            });
        }

        const convList = document.getElementById('conversations-list');
        if (convList) {
            const convObserver = new MutationObserver((mutations) => {
                mutations.forEach(m => {
                    m.addedNodes.forEach((node, idx) => {
                        if (node.nodeType === 1 && node.classList.contains('chat-row')) {
                            node.style.opacity = '0';
                            node.style.transform = 'translateX(-6px)';
                            setTimeout(() => { 
                                node.style.transition = `transform .24s ${idx*0.02}s var(--ease), opacity .18s ${idx*0.02}s var(--ease)`; 
                                node.style.opacity = '1'; 
                                node.style.transform = 'none'; 
                            }, 20);
                            setTimeout(() => { 
                                node.style.transition=''; 
                            }, 600);
                        }
                    });
                });
            });
            convObserver.observe(convList, { childList: true });
        }

        initSearch();
        initGroupSearch();

        window.uiAction = window.uiAction;
        window.chatEngine = window.chatEngine;
        window.themeCore = window.themeCore;
        window.notificationManager = notificationManager;
        window.escapeHtml = escapeHtml;
        window.rgbToHex = rgbToHex;
        window.toggleSidebarMenu = toggleSidebarMenu;
        window.toggleSidebarExpanded = toggleSidebarExpanded;
        window.closeMobileSidebar = closeMobileSidebar;
        window.showMobileChatList = showMobileChatList;
        window.hideMobileSidebar = hideMobileSidebar;

        themeCore.load();

    </script>
</body>
</html>
