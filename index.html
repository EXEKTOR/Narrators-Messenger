<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARRATORS // ADMIN V9</title>
    <style>
        :root {
            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã (–º–µ–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) */
            --bg-body: #ffffff;
            --bg-sidebar: #f5f5f5;
            --bg-chat: #ffffff;
            --primary: #ff0033;
            --text-main: #222222;
            --border: #e0e0e0;
            --msg-me: #ff0033;
            --msg-me-text: #ffffff;
            --msg-other: #f2f2f2;
            --msg-other-text: #000000;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; overflow: hidden; color: var(--text-main); background: var(--bg-body); }

        /* --- –≠–ö–†–ê–ù–´ --- */
        .panel { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-chat); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:2000; }
        
        button { cursor: pointer; border: none; outline: none; transition: 0.2s; }
        .btn-primary { padding:12px 24px; background:var(--primary); color:#fff; border-radius:6px; font-weight:bold; text-transform:uppercase; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-primary:active { transform: scale(0.95); }
        
        input { padding:12px; border:1px solid var(--border); width:300px; margin-bottom:15px; border-radius:6px; outline:none; background: #fff; color: #000; }
        input:focus { border-color: var(--primary); }

        /* --- –û–°–ù–û–í–ù–û–ô –õ–ï–ô–ê–£–¢ --- */
        #app { display:none; width:100%; height:100%; }
        
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞!) */
        #sidebar { 
            flex: 0 0 320px; /* –ñ–µ—Å—Ç–∫–æ 320px, –Ω–µ —Å–∂–∏–º–∞—Ç—å—Å—è */
            background:var(--bg-sidebar); 
            border-right:1px solid var(--border); 
            display:flex; flex-direction:column; 
        }
        
        .sidebar-header { padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .chat-list { flex:1; overflow-y:auto; }
        .chat-item { padding:15px 20px; display:flex; gap:15px; cursor:pointer; align-items:center; transition:0.2s; border-bottom: 1px solid transparent; }
        .chat-item:hover { background:rgba(0,0,0,0.05); }
        .chat-item.active { background:#fff; border-left: 4px solid var(--primary); }
        
        .avatar { width:50px; height:50px; background:#ccc; border-radius:50%; display:flex; justify-content:center; align-items:center; font-weight:bold; color:#fff; font-size: 1.2rem; flex-shrink: 0; }
        .avatar.red { background: linear-gradient(135deg, var(--primary), #cc0000); }

        /* –ß–ê–¢ */
        #chat { flex:1; display:flex; flex-direction:column; background:var(--bg-chat); min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è flex */ position: relative; }
        
        .chat-header { 
            height:65px; border-bottom:1px solid var(--border); 
            display:flex; justify-content:space-between; align-items:center; 
            padding:0 20px; background: var(--bg-chat);
        }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .header-btn { background:none; font-size:1.4rem; padding:5px; color: var(--text-main); margin-left: 10px; }
        .header-btn:hover { opacity: 0.7; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        #messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:8px; }
        
        .msg-row { display: flex; flex-direction: column; max-width: 75%; position: relative; }
        .msg-row.me { align-self: flex-end; align-items: flex-end; }
        .msg-row.other { align-self: flex-start; align-items: flex-start; }

        .msg-bubble { 
            padding:10px 16px; border-radius:12px; font-size:0.95rem; word-wrap:break-word; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative;
        }
        
        .msg-row.me .msg-bubble { background:var(--msg-me); color:var(--msg-me-text); border-bottom-right-radius: 2px; }
        .msg-row.other .msg-bubble { background:var(--msg-other); color:var(--msg-other-text); border-bottom-left-radius: 2px; }

        .msg-name { 
            font-size:0.75rem; font-weight:bold; margin-bottom:4px; opacity:0.8; 
            cursor:pointer; display: flex; align-items: center; gap: 5px;
        }
        
        /* –ò–∫–æ–Ω–∫–∞ –ê–¥–º–∏–Ω–∞ */
        .admin-badge { color: gold; font-size: 1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) */
        .btn-delete {
            position: absolute; top: -10px; right: -10px;
            background: red; color: white; width: 20px; height: 20px;
            border-radius: 50%; font-size: 12px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            z-index: 10;
        }
        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å admin-mode */
        body.is-admin .btn-delete { display: flex; }

        /* –í–≤–æ–¥ */
        .input-box { padding:15px; border-top:1px solid var(--border); display:flex; gap:10px; align-items: center; background: var(--bg-chat); }
        #msg-in { flex:1; margin:0; border-radius: 20px; padding: 10px 20px; }
        
        /* –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        #settings-modal {
            display: none; position: absolute; top: 70px; right: 20px;
            background: #fff; border: 1px solid var(--border); padding: 20px;
            border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 250px; z-index: 3000;
        }
        .set-row { margin-bottom: 10px; }
        .set-row label { display: block; font-size: 0.8rem; color: #777; margin-bottom: 5px; }
        .set-row input { width: 100%; height: 35px; padding: 0; border: none; }

        /* –ú–æ–±–∏–ª–∫–∞ */
        @media (max-width: 700px) {
            #sidebar { width:100%; flex: 1; }
            #chat { display:none; width:100%; }
            body.chat-open #sidebar { display:none; }
            body.chat-open #chat { display:flex; }
            #btn-back { display:block !important; }
        }
    </style>
</head>
<body>

    <!-- –í–•–û–î -->
    <div id="login-screen" class="panel">
        <h1 style="color:var(--primary); font-size: 2.5rem;">NARRATORS</h1>
        <p style="color:#888; margin-bottom: 30px;">AUTHORIZATION</p>
        <button id="btn-login" class="btn-primary">–í–û–ô–¢–ò –ß–ï–†–ï–ó GOOGLE</button>
    </div>

    <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø (–í–≤–µ–¥–∏ @admin —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å –∞–¥–º–∏–Ω–æ–º) -->
    <div id="reg-screen" class="panel" style="display:none;">
        <h2>–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
        <p>–î–ª—è –ø—Ä–∞–≤ —Å–æ–∑–¥–∞—Ç–µ–ª—è –≤–≤–µ–¥–∏ —Ç–µ–≥ <b>@admin</b></p>
        <input id="reg-nick" placeholder="–ò–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: EXEKTOR)">
        <input id="reg-tag" placeholder="@username">
        <button id="btn-save" class="btn-primary">–ù–ê–ß–ê–¢–¨</button>
    </div>

    <!-- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="app">
        <!-- –°–õ–ï–í–ê -->
        <div id="sidebar">
            <div class="sidebar-header">
                <div style="font-weight:900; color:var(--primary); font-size: 1.2rem;">NARRATORS V9</div>
                <div style="font-size: 0.8rem; color: #888;">Realtime</div>
            </div>
            <div class="chat-list">
                <div class="chat-item active" onclick="openChat()">
                    <div class="avatar red">G</div>
                    <div>
                        <div style="font-weight:bold">Global Chat</div>
                        <div style="font-size:0.8rem; color:#777">–û–±—â–∏–π —Å–µ—Ä–≤–µ—Ä</div>
                    </div>
                </div>
            </div>
            <div style="padding:15px; text-align:center; font-size:0.8rem; color:#aaa;" id="my-profile">Loading...</div>
        </div>

        <!-- –°–ü–†–ê–í–ê -->
        <div id="chat">
            <div class="chat-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="btn-back" class="header-btn" style="display:none;">‚¨Ö</button>
                    <span style="font-weight:bold">GLOBAL HUB</span>
                </div>
                <div>
                    <button id="btn-settings" class="header-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
                    <button id="btn-logout" class="header-btn" title="–í—ã—Ö–æ–¥">üö™</button>
                </div>
            </div>

            <!-- –ú–û–î–ê–õ–ö–ê –ù–ê–°–¢–†–û–ï–ö -->
            <div id="settings-modal">
                <h3>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                <div class="set-row">
                    <label>–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç</label>
                    <input type="color" id="set-primary" value="#ff0033">
                </div>
                <div class="set-row">
                    <label>–§–æ–Ω (–°–≤–æ–π)</label>
                    <input type="color" id="set-me" value="#ff0033">
                </div>
                <div class="set-row">
                    <label>–§–æ–Ω (–ß—É–∂–æ–π)</label>
                    <input type="color" id="set-other" value="#f2f2f2">
                </div>
                <button onclick="resetTheme()" style="width:100%; padding:5px; background:#444; color:#fff; border-radius:4px;">–°–±—Ä–æ—Å</button>
            </div>

            <div id="messages"></div>

            <div class="input-box">
                <button id="btn-img" class="header-btn">üì∑</button>
                <input id="msg-in" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                <button id="btn-send" class="header-btn" style="color:var(--primary)">‚û§</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, get, child, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const config = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677",
            measurementId: "G-XN1B0KZ5ML"
        };

        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let user = null;
        let profile = null;
        let isAdmin = false; // –§–ª–∞–≥ –∞–¥–º–∏–Ω–∞

        const ui = {
            login: document.getElementById('login-screen'),
            reg: document.getElementById('reg-screen'),
            app: document.getElementById('app'),
            list: document.getElementById('messages'),
            in: document.getElementById('msg-in'),
            myProfile: document.getElementById('my-profile'),
            settings: document.getElementById('settings-modal')
        };

        // --- AUTH ---
        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('btn-logout').onclick = () => signOut(auth);

        onAuthStateChanged(auth, async (u) => {
            user = u;
            if (user) {
                ui.login.style.display = 'none';
                get(child(ref(db), `users/${user.uid}`)).then((snap) => {
                    if (snap.exists()) {
                        profile = snap.val();
                        loginSuccess();
                    } else {
                        ui.reg.style.display = 'flex';
                        document.getElementById('reg-nick').value = "EXEKTOR"; // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è —Ç–µ–±—è
                    }
                });
            } else {
                ui.login.style.display = 'flex';
                ui.reg.style.display = 'none';
                ui.app.style.display = 'none';
                document.body.classList.remove('is-admin');
            }
        });

        // --- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ---
        document.getElementById('btn-save').onclick = () => {
            const nick = document.getElementById('reg-nick').value.trim();
            const tag = document.getElementById('reg-tag').value.trim().replace('@','');
            
            if(!nick || !tag) return alert('–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!');

            const newData = {
                displayName: nick,
                username: tag.toLowerCase(),
                usernameDisplay: tag,
                uid: user.uid
            };

            set(ref(db, 'users/' + user.uid), newData).then(() => {
                profile = newData;
                ui.reg.style.display = 'none';
                loginSuccess();
            });
        };

        function loginSuccess() {
            ui.app.style.display = 'flex';
            ui.myProfile.innerText = `${profile.displayName} (@${profile.usernameDisplay})`;
            
            // –ü–†–û–í–ï–†–ö–ê –ù–ê –ê–î–ú–ò–ù–ê
            if (profile.usernameDisplay === 'admin') {
                isAdmin = true;
                document.body.classList.add('is-admin'); // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –≤ CSS
                alert("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –°–æ–∑–¥–∞—Ç–µ–ª—å. –†–µ–∂–∏–º –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.");
            }

            loadMessages();
        }

        // --- –ß–ê–¢ (REALTIME) ---
        function send(txt) {
            if(!txt || !user) return;
            const newRef = push(ref(db, 'messages'));
            set(newRef, {
                text: txt,
                uid: user.uid,
                displayName: profile.displayName,
                username: profile.usernameDisplay,
                createdAt: Date.now()
            });
        }

        document.getElementById('btn-send').onclick = () => {
            if(ui.in.value.trim()) { send(ui.in.value.trim()); ui.in.value=''; }
        };
        ui.in.onkeypress = (e) => {
             if(e.key==='Enter' && ui.in.value.trim()) { send(ui.in.value.trim()); ui.in.value=''; }
        };
        document.getElementById('btn-img').onclick = () => {
            const url = prompt("–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É:");
            if(url) send(url);
        };

        // –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–ê)
        window.deleteMsg = (key) => {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞–≤—Å–µ–≥–¥–∞?")) {
                remove(ref(db, 'messages/' + key));
            }
        };

        function loadMessages() {
            onValue(ref(db, 'messages'), (snapshot) => {
                ui.list.innerHTML = '';
                const data = snapshot.val();
                if(!data) return;

                // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –º–∞—Å—Å–∏–≤ —Å –∫–ª—é—á–∞–º–∏ (—á—Ç–æ–±—ã —É–¥–∞–ª—è—Ç—å)
                const msgs = Object.entries(data).map(([key, val]) => ({ key, ...val }));
                msgs.sort((a, b) => a.createdAt - b.createdAt);

                msgs.forEach(m => {
                    const isMe = m.uid === user.uid;
                    const div = document.createElement('div');
                    div.className = `msg-row ${isMe ? 'me' : 'other'}`;
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–µ–Ω–∏
                    const name = m.displayName || '–ü—Ä–∏–∑—Ä–∞–∫';
                    const tag = m.username || 'anon';
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–¥–º–∏–Ω–∞ (–∫–æ—Ä–æ–Ω–∞)
                    let adminIcon = '';
                    if (tag === 'admin') adminIcon = '<span class="admin-badge">üëë</span>';

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏
                    let txt = m.text;
                    if(txt.startsWith('http')) txt = `<img src="${txt}" style="max-width:100%; border-radius:8px;">`;

                    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ body.is-admin)
                    const deleteBtn = `<div class="btn-delete" onclick="deleteMsg('${m.key}')">‚úï</div>`;

                    div.innerHTML = `
                        <div class="msg-bubble">
                            ${deleteBtn}
                            <span class="msg-name" onclick="alert('@${tag}')">${name} ${adminIcon}</span>
                            ${txt}
                        </div>
                    `;
                    ui.list.appendChild(div);
                });
                ui.list.scrollTop = ui.list.scrollHeight;
            });
        }

        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        document.getElementById('btn-settings').onclick = () => {
            ui.settings.style.display = ui.settings.style.display === 'block' ? 'none' : 'block';
        };
        
        // –õ–æ–≥–∏–∫–∞ —Å–º–µ–Ω—ã —Ü–≤–µ—Ç–æ–≤
        const r = document.querySelector(':root');
        
        document.getElementById('set-primary').addEventListener('input', (e) => {
            r.style.setProperty('--primary', e.target.value);
            r.style.setProperty('--msg-me', e.target.value);
            localStorage.setItem('theme-prime', e.target.value);
        });
        document.getElementById('set-me').addEventListener('input', (e) => {
            r.style.setProperty('--msg-me', e.target.value);
             localStorage.setItem('theme-me', e.target.value);
        });
        document.getElementById('set-other').addEventListener('input', (e) => {
            r.style.setProperty('--msg-other', e.target.value);
             localStorage.setItem('theme-other', e.target.value);
        });

        window.resetTheme = () => {
            r.style = '';
            localStorage.clear();
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
        if(localStorage.getItem('theme-prime')) r.style.setProperty('--primary', localStorage.getItem('theme-prime'));
        if(localStorage.getItem('theme-me')) r.style.setProperty('--msg-me', localStorage.getItem('theme-me'));
        if(localStorage.getItem('theme-other')) r.style.setProperty('--msg-other', localStorage.getItem('theme-other'));


        // –ú–æ–±–∏–ª–∫–∞
        window.openChat = () => { if(window.innerWidth<=700) { document.body.classList.add('chat-open'); } };
        document.getElementById('btn-back').onclick = () => document.body.classList.remove('chat-open');
    </script>
</body>
</html>
