<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Narrators v0.2</title>

<style>
:root{
--primary:#3390ec;
--bg:#fff;
--me:#eeffde;
--other:#f4f4f5;
--radius:12px;
--border:#e4e4e4;
--text:#000;
--sec:#707579;
}

*{box-sizing:border-box}
body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
height:100vh;
display:flex;
background:var(--bg);
color:var(--text);
}

/* PANELS */
.panel{
position:fixed;
top:0;left:0;
width:100%;height:100%;
background:#fff;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
z-index:5000;
}

input,textarea{
font-family:inherit;
}

/* AUTH */
.auth-box{
width:320px;
display:flex;
flex-direction:column;
gap:10px;
}
.auth-box input{
padding:12px;
border:1px solid var(--border);
border-radius:10px;
}
.auth-box button{
padding:14px;
border:none;
border-radius:10px;
background:var(--primary);
color:#fff;
font-weight:600;
cursor:pointer;
}

/* APP */
#app{
display:none;
width:100%;
}

/* SIDEBAR */
#sidebar{
width:320px;
border-right:1px solid var(--border);
display:flex;
flex-direction:column;
}
.search{
padding:10px;
}
.search input{
width:100%;
padding:10px;
border-radius:20px;
border:1px solid var(--border);
}
.list{
flex:1;
overflow:auto;
}
.user{
display:flex;
gap:10px;
padding:12px;
cursor:pointer;
}
.user:hover{background:#f5f5f5}
.avatar{
width:48px;height:48px;
border-radius:50%;
background:#ccc;
object-fit:cover;
}
.name{font-weight:600}
.tag{font-size:0.85rem;color:var(--sec)}

/* CHAT */
#chat{
flex:1;
display:flex;
flex-direction:column;
}
.header{
padding:15px;
border-bottom:1px solid var(--border);
font-weight:700;
}
.messages{
flex:1;
padding:20px;
overflow:auto;
display:flex;
flex-direction:column;
gap:6px;
}
.row.me{align-self:flex-end}
.bubble{
padding:10px 14px;
border-radius:var(--radius);
max-width:70%;
}
.me .bubble{background:var(--me)}
.other .bubble{background:var(--other)}
.sender{
font-size:0.75rem;
font-weight:700;
color:var(--primary);
cursor:pointer;
}
.input{
display:flex;
padding:10px;
border-top:1px solid var(--border);
}
.input textarea{
flex:1;
resize:none;
border:none;
outline:none;
font-size:1rem;
}
.input button{
border:none;
background:var(--primary);
color:#fff;
padding:10px 16px;
border-radius:10px;
margin-left:10px;
cursor:pointer;
}

/* PROFILE */
#profile{
display:none;
}
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth" class="panel">
<h1>Narrators</h1>
<div class="auth-box">
<input id="nick" placeholder="Ник">
<input id="tag" placeholder="@username">
<button id="enter">Войти</button>
<button id="google">Google</button>
</div>
</div>

<!-- PROFILE -->
<div id="profile" class="panel">
<img id="pAva" style="width:100px;height:100px;border-radius:50%">
<h2 id="pName"></h2>
<div id="pTag"></div>
<div id="pStatus"></div>
<button onclick="closeProfile()">Закрыть</button>
</div>

<!-- APP -->
<div id="app">
<div id="sidebar">
<div class="search">
<input id="search" placeholder="Поиск пользователей">
</div>
<div class="list" id="userList"></div>
</div>

<div id="chat">
<div class="header">Global Chat</div>
<div class="messages" id="messages"></div>
<div class="input">
<textarea id="msg" placeholder="Сообщение"></textarea>
<button onclick="send()">➤</button>
</div>
</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getAuth,signInWithPopup,GoogleAuthProvider,onAuthStateChanged,signInAnonymously} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {getDatabase,ref,set,push,onValue,get,child} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
authDomain:"narrators-messenger.firebaseapp.com",
databaseURL:"https://narrators-messenger-default-rtdb.firebaseio.com",
projectId:"narrators-messenger"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getDatabase(app);

let user=null,profile=null;

/* AUTH */
enter.onclick=()=>{
const n=nick.value.trim();
const t=tag.value.trim().replace("@","");
if(!n||!t)return alert("Введите данные");
signInAnonymously(auth).then(r=>{
set(ref(db,"users/"+r.user.uid),{
uid:r.user.uid,
displayName:n,
username:t.toLowerCase(),
usernameDisplay:t,
online:true,
lastSeen:Date.now()
});
});
};

google.onclick=()=>signInWithPopup(auth,new GoogleAuthProvider());

onAuthStateChanged(auth,u=>{
if(!u)return;
user=u;
get(child(ref(db),"users/"+u.uid)).then(s=>{
profile=s.val();
auth.style.display="none";
app.style.display="flex";
loadUsers();
loadMessages();
});
});

/* USERS */
function loadUsers(){
onValue(ref(db,"users"),snap=>{
userList.innerHTML="";
const q=search.value.toLowerCase();
snap.forEach(c=>{
const u=c.val();
if(q && !u.displayName.toLowerCase().includes(q) && !u.username.includes(q))return;
const d=document.createElement("div");
d.className="user";
d.innerHTML=`
<img src="${u.photoURL||'https://via.placeholder.com/50'}" class="avatar">
<div>
<div class="name">${u.displayName}</div>
<div class="tag">@${u.usernameDisplay}</div>
</div>`;
d.onclick=()=>openProfile(u.uid);
userList.appendChild(d);
});
});
}
search.oninput=loadUsers;

/* PROFILE */
window.openProfile=(uid)=>{
get(child(ref(db),"users/"+uid)).then(s=>{
const u=s.val();
pAva.src=u.photoURL||"https://via.placeholder.com/100";
pName.innerText=u.displayName;
pTag.innerText="@"+u.usernameDisplay;
pStatus.innerText=u.online?"online":"был в сети";
profile.style.display="flex";
});
};
window.closeProfile=()=>profile.style.display="none";

/* CHAT */
function loadMessages(){
onValue(ref(db,"messages"),snap=>{
messages.innerHTML="";
snap.forEach(c=>{
const m=c.val();
const r=document.createElement("div");
r.className="row "+(m.uid===user.uid?"me":"other");
r.innerHTML=`
<div class="bubble">
<div class="sender" onclick="openProfile('${m.uid}')">${m.displayName}</div>
<div>${m.text}</div>
</div>`;
messages.appendChild(r);
});
messages.scrollTop=messages.scrollHeight;
});
}

window.send=()=>{
if(!msg.value.trim())return;
push(ref(db,"messages"),{
text:msg.value,
uid:user.uid,
displayName:profile.displayName,
createdAt:Date.now()
});
msg.value="";
};
</script>
</body>
</html>
