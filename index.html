<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARRATORS // V11 RESTORED</title>
    <style>
        :root {
            /* –¢–≤–æ—è –∫—Ä–∞—Å–Ω–æ-–±–µ–ª–∞—è –±–∞–∑–∞ */
            --bg-body: #ffffff;
            --bg-sidebar: #f7f7f7;
            --bg-chat: #ffffff;
            --primary: #ff0033;
            --text-main: #222;
            --border: #ddd;
            
            /* –°–æ–æ–±—â–µ–Ω–∏—è */
            --msg-me: #ff0033;
            --msg-me-text: #fff;
            --msg-other: #f0f0f0;
            --msg-other-text: #000;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; height: 100vh; width: 100vw; display: flex; overflow: hidden; color: var(--text-main); background: var(--bg-body); }

        /* --- –í–•–û–î / –†–ï–ì–ê --- */
        .panel { position: fixed; top:0; left:0; width:100%; height:100%; background:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:5000; }
        button { cursor: pointer; border: none; outline: none; transition: 0.2s; }
        .btn-main { padding:12px 25px; background:var(--primary); color:#fff; border-radius:6px; font-weight:bold; text-transform:uppercase; font-size: 1rem; }
        input.auth { padding:12px; border:1px solid var(--border); width:280px; margin-bottom:15px; border-radius:6px; font-size: 1rem; }

        /* --- –û–°–ù–û–í–ù–û–ô –≠–ö–†–ê–ù (–õ–µ–π–∞—É—Ç V9) --- */
        #app { display:none; width:100%; height:100%; display: flex; }

        /* 1. –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–°–ª–µ–≤–∞) */
        #sidebar { 
            width: 320px; flex-shrink: 0; 
            background: var(--bg-sidebar); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column;
        }

        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); }
        .search-input { width: 100%; padding: 10px; border-radius: 20px; border: 1px solid var(--border); outline: none; }
        
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { 
            padding: 15px; display: flex; align-items: center; gap: 10px; cursor: pointer; 
            border-bottom: 1px solid transparent; transition: 0.2s;
        }
        .chat-item:hover { background: #fff; border-color: var(--border); }
        .chat-item.active { background: #fff; border-right: 4px solid var(--primary); }
        
        .avatar-circle { 
            width: 48px; height: 48px; border-radius: 50%; background: #ccc; 
            display: flex; justify-content: center; align-items: center; 
            font-weight: bold; color: #fff; object-fit: cover;
        }
        .avatar-circle.red { background: var(--primary); }

        .my-profile-mini { padding: 10px; text-align: center; font-size: 0.8rem; color: #888; border-top: 1px solid var(--border); }

        /* 2. –ß–ê–¢ (–°–ø—Ä–∞–≤–∞) */
        #chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; min-width: 0; }

        .chat-top-bar { 
            height: 60px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            background: var(--bg-chat); z-index: 10;
        }
        .chat-title { font-weight: bold; font-size: 1.1rem; }
        .top-btn { background: none; font-size: 1.2rem; color: #555; padding: 5px 10px; }
        .top-btn:hover { color: var(--primary); }

        /* –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }

        .msg-row { display: flex; flex-direction: column; max-width: 70%; position: relative; }
        .msg-row.me { align-self: flex-end; align-items: flex-end; }
        .msg-row.other { align-self: flex-start; align-items: flex-start; }

        .msg-bubble { 
            padding: 10px 14px; border-radius: 12px; font-size: 0.95rem; 
            word-wrap: break-word; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .msg-row.me .msg-bubble { background: var(--msg-me); color: var(--msg-me-text); border-bottom-right-radius: 2px; }
        .msg-row.other .msg-bubble { background: var(--msg-other); color: var(--msg-other-text); border-bottom-left-radius: 2px; }

        .msg-name { font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; opacity: 0.8; cursor: pointer; display: flex; gap: 5px; }
        .msg-time { font-size: 0.65rem; opacity: 0.6; margin-top: 5px; text-align: right; display: block; }
        
        .crown { color: gold; text-shadow: 0 0 2px black; }

        /* –ö–∞—Ä—Ç–∏–Ω–∫–∏ –≤ —á–∞—Ç–µ */
        .msg-img { max-width: 100%; border-radius: 8px; display: block; margin-top: 5px; }

        /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
        .input-wrapper { background: var(--bg-chat); border-top: 1px solid var(--border); display: flex; flex-direction: column; }
        
        .reply-bar { 
            padding: 8px 15px; background: #f9f9f9; border-bottom: 1px solid var(--border); 
            border-left: 3px solid var(--primary); display: none; justify-content: space-between; align-items: center;
        }
        .reply-text { font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%; }
        
        .input-row { padding: 15px; display: flex; gap: 10px; align-items: flex-end; }
        #msg-in { 
            flex: 1; border: 1px solid var(--border); border-radius: 20px; 
            padding: 10px 15px; outline: none; font-size: 1rem; max-height: 100px; resize: none;
        }
        #msg-in:focus { border-color: var(--primary); }
        .icon-btn { font-size: 1.4rem; background: none; color: #888; padding-bottom: 5px; }
        .icon-btn:hover { color: var(--primary); }

        /* --- –ù–ê–°–¢–†–û–ô–ö–ò (–í–´–ï–ó–ñ–ê–Æ–©–ê–Ø –ü–ê–ù–ï–õ–¨) --- */
        #settings-panel {
            position: fixed; top: 0; right: -350px; width: 320px; height: 100%;
            background: #fff; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 4000; transition: right 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        #settings-panel.open { right: 0; }
        
        .set-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
        .set-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        .set-group { margin-bottom: 25px; }
        .set-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: #555; }
        .set-preview { 
            padding: 15px; background: #eee; border-radius: 8px; margin-bottom: 10px; 
            display: flex; flex-direction: column; gap: 10px; 
        }

        /* --- –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ (–ü–ö–ú) --- */
        #ctx-menu {
            display: none; position: fixed; background: #fff; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 6px; 
            z-index: 9999; width: 150px;
        }
        .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 0.9rem; }
        .ctx-item:hover { background: #f5f5f5; }
        .ctx-item.del { color: red; }

        /* –ú–û–ë–ò–õ–ö–ê */
        @media (max-width: 700px) {
            #sidebar { width: 100%; }
            #chat-area { display: none; width: 100%; }
            body.chat-active #sidebar { display: none; }
            body.chat-active #chat-area { display: flex; }
            #btn-back { display: inline-block !important; }
        }
        #btn-back { display: none; }

    </style>
</head>
<body>

    <!-- –í–•–û–î -->
    <div id="login-screen" class="panel">
        <h1 style="color:var(--primary); font-size:2rem; margin-bottom:10px;">NARRATORS</h1>
        <button id="btn-login" class="btn-main">–í–û–ô–¢–ò –ß–ï–†–ï–ó GOOGLE</button>
    </div>

    <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
    <div id="reg-screen" class="panel" style="display:none;">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h2>
        <input id="reg-nick" class="auth" placeholder="–í–∞—à–µ –∏–º—è">
        <input id="reg-tag" class="auth" placeholder="@username">
        <input id="reg-ava" class="auth" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É (URL)">
        <button id="btn-save-reg" class="btn-main">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <!-- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="app">
        <!-- –°–ü–ò–°–û–ö (–°–õ–ï–í–ê) -->
        <div id="sidebar">
            <div class="sidebar-header">
                <input class="search-input" placeholder="–ü–æ–∏—Å–∫...">
            </div>
            <div class="chat-list">
                <div class="chat-item active" onclick="openGlobalChat()">
                    <div class="avatar-circle red">G</div>
                    <div>
                        <div style="font-weight: bold;">Global Chat</div>
                        <div style="font-size: 0.8rem; color: #888;">–û–±—â–∏–π –∫–∞–Ω–∞–ª</div>
                    </div>
                </div>
            </div>
            <div class="my-profile-mini" id="my-info">Loading...</div>
        </div>

        <!-- –ß–ê–¢ (–°–ü–†–ê–í–ê) -->
        <div id="chat-area">
            <div class="chat-top-bar">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="top-btn" id="btn-back" onclick="closeChatMobile()">‚¨Ö</button>
                    <span class="chat-title">Global Chat</span>
                </div>
                <div>
                    <button class="top-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
                    <button class="top-btn" onclick="doLogout()">üö™</button>
                </div>
            </div>

            <div id="messages"></div>

            <div class="input-wrapper">
                <!-- –ü–ª–∞—à–∫–∞ –æ—Ç–≤–µ—Ç–∞/—Ä–µ–¥–∞–∫—Ç–∞ -->
                <div class="reply-bar" id="action-bar">
                    <span class="reply-text" id="action-text">–û—Ç–≤–µ—Ç...</span>
                    <button style="border:none; background:none; font-size:1.2rem; cursor:pointer;" onclick="cancelAction()">‚úï</button>
                </div>

                <div class="input-row">
                    <button class="icon-btn" onclick="sendImg()">üì∑</button>
                    <textarea id="msg-in" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                    <button class="icon-btn" onclick="sendMsg()" style="color:var(--primary)">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò (–®–¢–û–†–ö–ê –°–ü–†–ê–í–ê) -->
    <div id="settings-panel">
        <div class="set-header">
            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            <button onclick="toggleSettings()" style="background:none; border:none; font-size:1.2rem;">‚úï</button>
        </div>
        <div class="set-body">
            
            <div class="set-group">
                <label>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</label>
                <div class="set-preview" id="prev-box">
                    <div style="align-self: flex-start; background: #f0f0f0; padding:8px; border-radius:8px;" id="prev-other">–ü—Ä–∏–≤–µ—Ç!</div>
                    <div style="align-self: flex-end; background: #ff0033; color:white; padding:8px; border-radius:8px;" id="prev-me">–•–∞–π! –ö–∞–∫ —Ç–µ–º–∞?</div>
                </div>
            </div>

            <div class="set-group">
                <label>–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (–ê–∫—Ü–µ–Ω—Ç)</label>
                <input type="color" id="in-primary" value="#ff0033" style="width:100%; height:40px;">
            </div>

            <div class="set-group">
                <label>–§–æ–Ω –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</label>
                <input type="color" id="in-me-bg" value="#ff0033" style="width:100%; height:40px;">
            </div>

             <div class="set-group">
                <label>–ú–æ—è –∞–≤–∞—Ç–∞—Ä–∫–∞ (URL)</label>
                <input type="text" id="in-avatar" class="auth" style="width:100%" placeholder="https://...">
            </div>

            <button class="btn-main" onclick="saveSettings()" style="width:100%">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
    </div>

    <!-- –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ -->
    <div id="ctx-menu">
        <div class="ctx-item" onclick="handleCtx('reply')">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="ctx-item" onclick="handleCtx('copy')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="ctx-item" onclick="handleCtx('edit')" id="btn-ctx-edit">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="ctx-item del" onclick="handleCtx('delete')" id="btn-ctx-del">üóë –£–¥–∞–ª–∏—Ç—å</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, get, child, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const config = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677"
        };

        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let user = null;
        let profile = null;
        let isAdmin = false;
        
        // –î–ª—è –¥–µ–π—Å—Ç–≤–∏–π (–æ—Ç–≤–µ—Ç/—Ä–µ–¥–∞–∫—Ç)
        let actionState = null; 
        let actionMsg = null;
        let ctxTarget = null; // —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π

        const ui = {
            login: document.getElementById('login-screen'),
            reg: document.getElementById('reg-screen'),
            app: document.getElementById('app'),
            list: document.getElementById('messages'),
            input: document.getElementById('msg-in'),
            actionBar: document.getElementById('action-bar'),
            actionText: document.getElementById('action-text'),
            settings: document.getElementById('settings-panel')
        };

        // --- AUTH ---
        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.doLogout = () => signOut(auth);

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                ui.login.style.display = 'none';
                get(child(ref(db), `users/${user.uid}`)).then(snap => {
                    if (snap.exists()) {
                        profile = snap.val();
                        initApp();
                    } else {
                        ui.reg.style.display = 'flex';
                        document.getElementById('reg-nick').value = user.displayName;
                    }
                });
            } else {
                ui.login.style.display = 'flex';
                ui.reg.style.display = 'none';
                ui.app.style.display = 'none';
            }
        });

        // --- REGISTRATION ---
        document.getElementById('btn-save-reg').onclick = () => {
            const nick = document.getElementById('reg-nick').value.trim();
            const tag = document.getElementById('reg-tag').value.trim().replace('@','');
            const ava = document.getElementById('reg-ava').value.trim();

            if(!nick || !tag) return alert("–ò–º—è –∏ —Ç–µ–≥ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!");

            const newData = {
                displayName: nick,
                username: tag.toLowerCase(),
                usernameDisplay: tag,
                photoURL: ava || user.photoURL,
                uid: user.uid
            };
            
            set(ref(db, `users/${user.uid}`), newData).then(() => {
                profile = newData;
                ui.reg.style.display = 'none';
                initApp();
            });
        };

        function initApp() {
            ui.app.style.display = 'flex'; // –í–µ—Ä–Ω—É–ª Flex –¥–ª—è –ª–µ–π–∞—É—Ç–∞
            document.getElementById('my-info').innerText = `${profile.displayName} (@${profile.usernameDisplay})`;
            
            if(profile.usernameDisplay === 'admin') isAdmin = true;
            
            loadMessages();
            loadTheme();
        }

        // --- MESSAGES ---
        window.sendMsg = () => {
            const txt = ui.input.value.trim();
            if(!txt) return;

            if (actionState === 'edit' && actionMsg) {
                update(ref(db, `messages/${actionMsg.key}`), { text: txt, isEdited: true });
            } else {
                const payload = {
                    text: txt,
                    uid: user.uid,
                    displayName: profile.displayName,
                    username: profile.usernameDisplay,
                    photoURL: profile.photoURL,
                    createdAt: Date.now()
                };
                if (actionState === 'reply' && actionMsg) {
                    payload.replyTo = { name: actionMsg.displayName, text: actionMsg.text };
                }
                push(ref(db, 'messages'), payload);
            }
            cancelAction();
            ui.input.value = '';
        };

        ui.input.addEventListener('keypress', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
        });

        window.sendImg = () => {
            const url = prompt("URL –ö–∞—Ä—Ç–∏–Ω–∫–∏:");
            if(url) { ui.input.value = url; sendMsg(); }
        };

        function loadMessages() {
            onValue(ref(db, 'messages'), (snap) => {
                ui.list.innerHTML = '';
                const data = snap.val();
                if(!data) return;

                const msgs = Object.entries(data).map(([k,v]) => ({key:k, ...v})).sort((a,b) => a.createdAt - b.createdAt);

                msgs.forEach(m => {
                    const isMe = m.uid === user.uid;
                    const row = document.createElement('div');
                    row.className = `msg-row ${isMe ? 'me' : 'other'}`;
                    
                    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–§–∏–∫—Å NaN/Undefined)
                    const name = m.displayName || "–ê—Ä—Ö–∏–≤";
                    let time = "";
                    if(m.createdAt && !isNaN(m.createdAt)) {
                        const d = new Date(m.createdAt);
                        time = d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
                    }

                    // –ê–≤–∞—Ç–∞—Ä–∫–∞ (–µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ, –±–µ—Ä–µ–º –∑–∞–≥–ª—É—à–∫—É)
                    let avaSrc = m.photoURL || ''; 
                    
                    // –ö–æ—Ä–æ–Ω–∞ –∞–¥–º–∏–Ω–∞
                    let crown = m.username === 'admin' ? '<span class="crown">üëë</span>' : '';

                    // –ö–æ–Ω—Ç–µ–Ω—Ç (–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏–ª–∏ –¢–µ–∫—Å—Ç)
                    let content = '';
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (URL –∏–ª–∏ Base64)
                    if(m.text.match(/\.(jpg|jpeg|png|gif|webp)/i) || m.text.startsWith('data:image')) {
                        content = `<img src="${m.text}" class="msg-img">`;
                    } else {
                        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML —Ç–µ–≥–æ–≤ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                        content = m.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    }

                    // –†–µ–ø–ª–∞–π
                    let replyHtml = '';
                    if(m.replyTo) {
                        replyHtml = `<div style="border-left:2px solid var(--primary); padding-left:5px; font-size:0.8rem; opacity:0.7; margin-bottom:5px;">
                            <b>${m.replyTo.name}:</b> ${m.replyTo.text.substring(0, 30)}...
                        </div>`;
                    }

                    const editMark = m.isEdited ? '(–∏–∑–º.)' : '';

                    row.innerHTML = `
                        <div class="msg-bubble" oncontextmenu="openCtx(event, '${m.key}', '${m.uid}')">
                            <div class="msg-name">${name} ${crown}</div>
                            ${replyHtml}
                            <div>${content}</div>
                            <span class="msg-time">${editMark} ${time}</span>
                        </div>
                    `;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –≤ DOM —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                    row.querySelector('.msg-bubble').dataMsg = m; 

                    ui.list.appendChild(row);
                });
                ui.list.scrollTop = ui.list.scrollHeight;
            });
        }

        // --- CONTEXT MENU ---
        window.openCtx = (e, key, uid) => {
            e.preventDefault();
            ctxTarget = e.currentTarget.dataMsg; // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞
            ctxTarget.key = key; // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∫–ª—é—á –µ—Å—Ç—å

            const menu = document.getElementById('ctx-menu');
            menu.style.display = 'block';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';

            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤
            const isMine = uid === user.uid;
            document.getElementById('btn-ctx-edit').style.display = isMine ? 'block' : 'none';
            document.getElementById('btn-ctx-del').style.display = (isMine || isAdmin) ? 'block' : 'none';
        };

        document.addEventListener('click', () => document.getElementById('ctx-menu').style.display = 'none');

        window.handleCtx = (action) => {
            if(!ctxTarget) return;
            if(action === 'reply') {
                actionState = 'reply';
                actionMsg = ctxTarget;
                ui.actionBar.style.display = 'flex';
                ui.actionText.innerText = `–û—Ç–≤–µ—Ç: ${ctxTarget.displayName}`;
            } else if(action === 'copy') {
                navigator.clipboard.writeText(ctxTarget.text);
            } else if(action === 'edit') {
                actionState = 'edit';
                actionMsg = ctxTarget;
                ui.actionBar.style.display = 'flex';
                ui.actionText.innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
                ui.input.value = ctxTarget.text;
            } else if(action === 'delete') {
                if(confirm('–£–¥–∞–ª–∏—Ç—å?')) remove(ref(db, `messages/${ctxTarget.key}`));
            }
        };

        window.cancelAction = () => {
            actionState = null;
            actionMsg = null;
            ui.actionBar.style.display = 'none';
            ui.input.value = '';
        };

        // --- SETTINGS & THEME ---
        window.toggleSettings = () => {
            ui.settings.classList.toggle('open');
            // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä –≤ –∏–Ω–ø—É—Ç
            document.getElementById('in-avatar').value = profile.photoURL || '';
        };

        // Live Preview
        const inPrime = document.getElementById('in-primary');
        const inMeBg = document.getElementById('in-me-bg');
        
        inPrime.addEventListener('input', () => {
            document.getElementById('prev-me').style.background = inMeBg.value;
        });
        inMeBg.addEventListener('input', () => {
            document.getElementById('prev-me').style.background = inMeBg.value;
        });

        window.saveSettings = () => {
            const r = document.documentElement.style;
            const pVal = inPrime.value;
            const bgVal = inMeBg.value;
            const newAva = document.getElementById('in-avatar').value.trim();

            // CSS Variables
            r.setProperty('--primary', pVal);
            r.setProperty('--msg-me', bgVal);

            // Save Theme Local
            localStorage.setItem('theme_p', pVal);
            localStorage.setItem('theme_bg', bgVal);

            // Save Avatar to DB
            if(newAva && newAva !== profile.photoURL) {
                update(ref(db, `users/${user.uid}`), { photoURL: newAva }).then(() => {
                    profile.photoURL = newAva;
                    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
                });
            } else {
                alert("–¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
            }
            toggleSettings();
        };

        function loadTheme() {
            const p = localStorage.getItem('theme_p');
            const bg = localStorage.getItem('theme_bg');
            if(p) {
                document.documentElement.style.setProperty('--primary', p);
                inPrime.value = p;
            }
            if(bg) {
                document.documentElement.style.setProperty('--msg-me', bg);
                inMeBg.value = bg;
            }
        }

        // Mobile
        window.openGlobalChat = () => document.body.classList.add('chat-active');
        window.closeChatMobile = () => document.body.classList.remove('chat-active');

    </script>
</body>
</html>
