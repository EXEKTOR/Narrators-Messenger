<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARRATORS V4 // FIXED</title>
    <style>
        :root {
            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Å–º–µ–Ω—ã —Ç–µ–º—ã */
            --bg-body: #f0f0f0;
            --bg-panel: #ffffff;
            --primary: #ff0033;
            --text-main: #222222;
            --text-dim: #666666;
            --msg-me: #ff0033;
            --msg-me-text: #ffffff;
            --msg-other: #e6e6e6;
            --msg-other-text: #000000;
            --border: #cccccc;
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* --- –í–•–û–î --- */
        #login-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2000;
        }
        h1 { color: var(--primary); letter-spacing: 1px; text-transform: uppercase; }
        button {
            padding: 12px 24px; border: none; background: var(--primary); color: #fff;
            font-weight: bold; cursor: pointer; border-radius: 4px; text-transform: uppercase;
        }
        button:active { opacity: 0.8; transform: scale(0.98); }

        /* --- –ß–ê–¢ –ü–ê–ù–ï–õ–¨ --- */
        #chat-panel {
            display: none; flex-direction: column;
            height: 100%; max-width: 900px; margin: 0 auto; width: 100%;
            background: var(--bg-panel);
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease;
            position: relative;
        }

        header {
            padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-panel);
            z-index: 10;
        }
        .header-controls { display: flex; gap: 10px; }
        .icon-btn { background: transparent; color: var(--text-main); padding: 5px; font-size: 1.2rem; }

        /* --- –°–û–û–ë–©–ï–ù–ò–Ø (–§–ò–ö–° –ú–û–ë–ò–õ–ö–ò) --- */
        #messages {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 8px;
            background: var(--bg-panel);
        }

        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.95rem;
            word-wrap: break-word;
            position: relative;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* –í–ê–ñ–ù–û: –§–∏–∫—Å –¥–ª—è "–°–≤–æ–∏—Ö" —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message.me {
            margin-left: auto; /* –¢–æ–ª–∫–∞–µ—Ç –≤–ø—Ä–∞–≤–æ */
            background-color: var(--msg-me);
            color: var(--msg-me-text);
            border-bottom-right-radius: 2px;
        }

        .message.other {
            margin-right: auto; /* –¢–æ–ª–∫–∞–µ—Ç –≤–ª–µ–≤–æ */
            background-color: var(--msg-other);
            color: var(--msg-other-text);
            border-bottom-left-radius: 2px;
        }

        .msg-author { font-size: 0.7em; opacity: 0.7; margin-bottom: 4px; display: block; }
        
        /* –ö–∞—Ä—Ç–∏–Ω–∫–∏ –≤ —á–∞—Ç–µ */
        .msg-img {
            max-width: 100%; border-radius: 8px; margin-top: 5px; display: block;
        }

        /* --- –í–í–û–î --- */
        .input-area {
            padding: 10px; border-top: 1px solid var(--border);
            display: flex; gap: 8px; background: var(--bg-panel); align-items: center;
        }
        #msg-input {
            flex: 1; padding: 12px; border: 1px solid var(--border);
            border-radius: 20px; outline: none; background: var(--bg-body); color: var(--text-main);
        }
        #btn-img { background: transparent; color: var(--text-dim); padding: 0 10px; font-size: 1.2rem; }

        /* --- –ù–ê–°–¢–†–û–ô–ö–ò (–ú–û–î–ê–õ–ö–ê) --- */
        #settings-modal {
            display: none; position: absolute; top: 60px; right: 10px;
            background: var(--bg-panel); border: 1px solid var(--border);
            padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 50; width: 250px;
        }
        .setting-row { margin-bottom: 15px; }
        .setting-row label { display: block; font-size: 0.9rem; margin-bottom: 5px; color: var(--text-dim); }
        input[type="color"] { width: 100%; height: 40px; border: none; cursor: pointer; }

        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <!-- –í–•–û–î -->
    <div id="login-panel">
        <h1>NARRATORS // V4</h1>
        <button id="btn-login">–í–û–ô–¢–ò –ß–ï–†–ï–ó GOOGLE</button>
    </div>

    <!-- –ß–ê–¢ -->
    <div id="chat-panel">
        <header>
            <span style="font-weight:900; color: var(--primary)">MESSENGER</span>
            <div class="header-controls">
                <button class="icon-btn" id="btn-settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã">‚öôÔ∏è</button>
                <button class="icon-btn" id="btn-logout" title="–í—ã–π—Ç–∏">üö™</button>
            </div>
        </header>

        <!-- –ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div id="settings-modal">
            <h3 style="margin-top:0">–¢–µ–º–∞</h3>
            <div class="setting-row">
                <label>–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (–ê–∫—Ü–µ–Ω—Ç)</label>
                <input type="color" id="color-primary" value="#ff0033">
            </div>
            <div class="setting-row">
                <label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞ (–°–Ω–∞—Ä—É–∂–∏)</label>
                <input type="color" id="color-bg" value="#f0f0f0">
            </div>
            <div class="setting-row">
                <label>–¶–≤–µ—Ç –ø–∞–Ω–µ–ª–µ–π (–í–Ω—É—Ç—Ä–∏)</label>
                <input type="color" id="color-panel" value="#ffffff">
            </div>
            <button id="btn-reset-theme" style="width:100%; font-size:0.8rem; background:#444;">–°–±—Ä–æ—Å</button>
        </div>

        <div id="messages"></div>

        <div class="input-area">
            <button id="btn-img" title="–í—Å—Ç–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">üì∑</button>
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button id="btn-send">‚û§</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677",
            measurementId: "G-XN1B0KZ5ML"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const els = {
            login: document.getElementById('login-panel'),
            chat: document.getElementById('chat-panel'),
            btnLogin: document.getElementById('btn-login'),
            btnLogout: document.getElementById('btn-logout'),
            input: document.getElementById('msg-input'),
            btnSend: document.getElementById('btn-send'),
            btnImg: document.getElementById('btn-img'),
            list: document.getElementById('messages'),
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            btnSettings: document.getElementById('btn-settings'),
            modalSettings: document.getElementById('settings-modal'),
            colorPrime: document.getElementById('color-primary'),
            colorBg: document.getElementById('color-bg'),
            colorPanel: document.getElementById('color-panel'),
            btnReset: document.getElementById('btn-reset-theme')
        };

        let currentUser = null;

        // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        els.btnLogin.addEventListener('click', () => signInWithPopup(auth, provider));
        els.btnLogout.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                els.login.style.display = 'none';
                els.chat.style.display = 'flex';
                loadChat();
            } else {
                els.login.style.display = 'flex';
                els.chat.style.display = 'none';
            }
        });

        // --- –û–¢–ü–†–ê–í–ö–ê ---
        async function sendMessage(txt) {
            if (!txt || !currentUser) return;
            try {
                await addDoc(collection(db, "messages"), {
                    text: txt,
                    uid: currentUser.uid,
                    displayName: currentUser.displayName,
                    createdAt: serverTimestamp()
                });
            } catch (e) { console.error(e); alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); }
        }

        // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
        els.btnSend.addEventListener('click', () => {
            const txt = els.input.value.trim();
            if(txt) { sendMessage(txt); els.input.value = ''; }
        });
        els.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const txt = els.input.value.trim();
                if(txt) { sendMessage(txt); els.input.value = ''; }
            }
        });

        // –ö–Ω–æ–ø–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É)
        els.btnImg.addEventListener('click', () => {
            const url = prompt("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (URL):");
            if (url) sendMessage(url);
        });

        // --- –ß–ê–¢ –ò –†–ï–ù–î–ï–† ---
        function loadChat() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"), limit(50));
            onSnapshot(q, (snapshot) => {
                els.list.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    const isMe = currentUser && data.uid === currentUser.uid;

                    div.className = `message ${isMe ? 'me' : 'other'}`;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ª–∏ —ç—Ç–æ (–ø–æ —Å—Å—ã–ª–∫–µ)
                    const isImage = data.text.match(/\.(jpeg|jpg|gif|png|webp)/i) || data.text.startsWith('http') && data.text.includes('images');
                    
                    let content = '';
                    if (isImage) {
                        content = `<img src="${data.text}" class="msg-img" onerror="this.style.display='none';this.parentElement.innerHTML+=' (–ë–∏—Ç–∞—è —Å—Å—ã–ª–∫–∞)'">`;
                    } else {
                        content = `<span>${data.text}</span>`;
                    }

                    div.innerHTML = `
                        <span class="msg-author">${data.displayName || 'Anon'}</span>
                        ${content}
                    `;
                    els.list.appendChild(div);
                });
                els.list.scrollTop = els.list.scrollHeight;
            });
        }

        // --- –ù–ê–°–¢–†–û–ô–ö–ò –¢–ï–ú–´ ---
        
        // –û—Ç–∫—Ä—ã—Ç—å/–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é
        els.btnSettings.addEventListener('click', () => {
            const display = els.modalSettings.style.display;
            els.modalSettings.style.display = display === 'block' ? 'none' : 'block';
        });

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞
        function setThemeVar(name, value) {
            document.documentElement.style.setProperty(name, value);
            localStorage.setItem(name, value);
        }

        // –°–ª—É—à–∞—Ç–µ–ª–∏ –ø–∞–ª–∏—Ç—Ä
        els.colorPrime.addEventListener('input', (e) => setThemeVar('--primary', e.target.value));
        els.colorPrime.addEventListener('input', (e) => setThemeVar('--msg-me', e.target.value)); // –ò —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–∂–µ –º–µ–Ω—è–µ–º
        
        els.colorBg.addEventListener('input', (e) => setThemeVar('--bg-body', e.target.value));
        els.colorPanel.addEventListener('input', (e) => setThemeVar('--bg-panel', e.target.value));

        // –°–±—Ä–æ—Å
        els.btnReset.addEventListener('click', () => {
            setThemeVar('--primary', '#ff0033');
            setThemeVar('--msg-me', '#ff0033');
            setThemeVar('--bg-body', '#f0f0f0');
            setThemeVar('--bg-panel', '#ffffff');
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–ø—É—Ç—ã –≤–∏–∑—É–∞–ª—å–Ω–æ
            els.colorPrime.value = '#ff0033';
            els.colorBg.value = '#f0f0f0';
            els.colorPanel.value = '#ffffff';
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
        window.onload = () => {
            if(localStorage.getItem('--bg-body')) setThemeVar('--bg-body', localStorage.getItem('--bg-body'));
            if(localStorage.getItem('--bg-panel')) setThemeVar('--bg-panel', localStorage.getItem('--bg-panel'));
            if(localStorage.getItem('--primary')) {
                setThemeVar('--primary', localStorage.getItem('--primary'));
                setThemeVar('--msg-me', localStorage.getItem('--primary'));
            }
        };

    </script>
</body>
</html>
