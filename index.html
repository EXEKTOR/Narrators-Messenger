<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Roboto', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #5a5a5a; border-radius: 3px; }
        .chat-item:hover { background: #2b2b2b; }
        .chat-item.active { background: #766ac8; }
        .message-bubble { max-width: 65%; word-wrap: break-word; }
        .typing-indicator span { animation: blink 1.4s infinite both; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
        .emoji-picker { display: none; }
        .emoji-picker.show { display: grid; }
        .context-menu { display: none; }
        .context-menu.show { display: block; }
        input:focus, textarea:focus { outline: none; }
    </style>
</head>
<body class="bg-[#0e0e0e] text-white h-screen overflow-hidden">
    
    <!-- Auth Screen -->
    <div id="authScreen" class="h-screen flex items-center justify-center bg-[#0e0e0e]">
        <div class="bg-[#212121] p-8 rounded-2xl w-96 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                    <svg class="w-14 h-14 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-semibold text-white">Telegram</h1>
                <p class="text-gray-400 text-sm mt-2" id="authSubtitle">–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>
            </div>
            
            <div id="loginForm">
                <input type="email" id="emailInput" placeholder="Email" 
                    class="w-full bg-[#181818] border border-[#3a3a3a] rounded-xl px-4 py-3 mb-3 text-white placeholder-gray-500 focus:border-[#766ac8] transition">
                <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å" 
                    class="w-full bg-[#181818] border border-[#3a3a3a] rounded-xl px-4 py-3 mb-3 text-white placeholder-gray-500 focus:border-[#766ac8] transition">
                <input type="text" id="usernameInput" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)" 
                    class="w-full bg-[#181818] border border-[#3a3a3a] rounded-xl px-4 py-3 mb-4 text-white placeholder-gray-500 focus:border-[#766ac8] transition">
                
                <button onclick="login()" class="w-full bg-[#766ac8] hover:bg-[#8774d8] text-white font-medium py-3 rounded-xl mb-2 transition">
                    –í–æ–π—Ç–∏
                </button>
                <button onclick="register()" class="w-full bg-transparent border border-[#766ac8] text-[#766ac8] hover:bg-[#766ac8] hover:text-white font-medium py-3 rounded-xl transition">
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
                <p id="authError" class="text-red-400 text-sm mt-3 text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="h-screen flex hidden">
        
        <!-- Left Sidebar -->
        <div class="w-[420px] bg-[#212121] flex flex-col border-r border-[#181818]">
            
            <!-- Header -->
            <div class="h-14 px-4 flex items-center justify-between border-b border-[#181818]">
                <button onclick="toggleMenu()" class="p-2 hover:bg-[#2b2b2b] rounded-full transition">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <div class="relative flex-1 mx-3">
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫" oninput="searchUsers()"
                        class="w-full bg-[#181818] rounded-full px-4 py-2 text-sm text-white placeholder-gray-500">
                    <svg class="w-5 h-5 text-gray-500 absolute right-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>

            <!-- Menu Dropdown -->
            <div id="menuDropdown" class="hidden absolute top-14 left-2 bg-[#2b2b2b] rounded-xl shadow-xl z-50 py-2 w-56">
                <div class="px-4 py-3 border-b border-[#3a3a3a]">
                    <div class="flex items-center gap-3">
                        <div id="menuAvatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-medium"></div>
                        <div>
                            <p id="menuUsername" class="font-medium text-white"></p>
                            <p class="text-xs text-gray-400">–í —Å–µ—Ç–∏</p>
                        </div>
                    </div>
                </div>
                <button onclick="showNewGroup()" class="w-full px-4 py-2 text-left hover:bg-[#3a3a3a] flex items-center gap-3 text-gray-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                </button>
                <button onclick="showSettings()" class="w-full px-4 py-2 text-left hover:bg-[#3a3a3a] flex items-center gap-3 text-gray-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <div class="border-t border-[#3a3a3a] mt-2 pt-2">
                    <button onclick="logout()" class="w-full px-4 py-2 text-left hover:bg-[#3a3a3a] flex items-center gap-3 text-red-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                        –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="hidden absolute top-28 left-4 right-4 bg-[#2b2b2b] rounded-xl shadow-xl z-40 max-h-64 overflow-y-auto w-[390px]"></div>

            <!-- Chat List -->
            <div id="chatList" class="flex-1 overflow-y-auto">
                <div class="text-center text-gray-500 py-8">
                    <p>–ù–µ—Ç —á–∞—Ç–æ–≤</p>
                    <p class="text-sm">–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
                </div>
            </div>
        </div>

        <!-- Right Panel - Chat Area -->
        <div class="flex-1 flex flex-col bg-[#0e0e0e]">
            
            <!-- No Chat Selected -->
            <div id="noChatSelected" class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <div class="w-32 h-32 mx-auto mb-4 bg-[#212121] rounded-full flex items-center justify-center">
                        <svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <p class="text-gray-500 text-lg">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
                </div>
            </div>

            <!-- Chat View -->
            <div id="chatView" class="flex-1 flex flex-col hidden">
                
                <!-- Chat Header -->
                <div class="h-14 px-4 flex items-center justify-between bg-[#212121] border-b border-[#181818]">
                    <div class="flex items-center gap-3">
                        <div id="chatAvatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-medium"></div>
                        <div>
                            <h2 id="chatName" class="font-medium text-white"></h2>
                            <p id="chatStatus" class="text-xs text-gray-400"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="startCall('voice')" class="p-2 hover:bg-[#2b2b2b] rounded-full transition">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                        </button>
                        <button onclick="startCall('video')" class="p-2 hover:bg-[#2b2b2b] rounded-full transition">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                        <button onclick="toggleChatMenu()" class="p-2 hover:bg-[#2b2b2b] rounded-full transition">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Chat Menu -->
                <div id="chatMenu" class="hidden absolute top-14 right-4 bg-[#2b2b2b] rounded-xl shadow-xl z-50 py-2 w-48">
                    <button onclick="clearChat()" class="w-full px-4 py-2 text-left hover:bg-[#3a3a3a] text-gray-300">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
                    <button onclick="deleteChat()" class="w-full px-4 py-2 text-left hover:bg-[#3a3a3a] text-red-400">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç</button>
                </div>

                <!-- Messages Area -->
                <div id="messagesArea" class="flex-1 overflow-y-auto px-4 py-4" style="background: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 80 80\"><circle cx=\"40\" cy=\"40\" r=\"1\" fill=\"%23222\"/></svg>') repeat;">
                </div>

                <!-- Typing Indicator -->
                <div id="typingIndicator" class="hidden px-4 py-2 text-gray-400 text-sm">
                    <span id="typingUser"></span> –ø–µ—á–∞—Ç–∞–µ—Ç<span class="typing-indicator"><span>.</span><span>.</span><span>.</span></span>
                </div>

                <!-- Message Input -->
                <div class="px-4 py-3 bg-[#212121] border-t border-[#181818]">
                    <div class="flex items-end gap-2">
                        <button onclick="toggleEmoji()" class="p-2 hover:bg-[#2b2b2b] rounded-full transition mb-1">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </button>
                        
                        <!-- Emoji Picker -->
                        <div id="emojiPicker" class="emoji-picker absolute bottom-16 left-4 bg-[#2b2b2b] rounded-xl p-3 shadow-xl z-50 grid-cols-8 gap-1 w-80">
                        </div>

                        <button onclick="attachFile()" class="p-2 hover:bg-[#2b2b2b] rounded-full transition mb-1">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                            </svg>
                        </button>
                        
                        <div class="flex-1 relative">
                            <textarea id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" rows="1" oninput="handleTyping(); autoResize(this)"
                                class="w-full bg-[#181818] rounded-2xl px-4 py-3 text-white placeholder-gray-500 resize-none max-h-32 overflow-y-auto"
                                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                        </div>
                        
                        <button id="sendBtn" onclick="sendMessage()" class="p-3 bg-[#766ac8] hover:bg-[#8774d8] rounded-full transition mb-1">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-[#212121] rounded-2xl w-[500px] max-h-[80vh] overflow-hidden">
            <div class="p-4 border-b border-[#3a3a3a] flex items-center justify-between">
                <h2 class="text-lg font-medium">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button onclick="hideSettings()" class="p-2 hover:bg-[#2b2b2b] rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-6">
                <div class="flex items-center gap-4 mb-6">
                    <div id="settingsAvatar" class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-2xl text-white font-medium"></div>
                    <div>
                        <input type="text" id="settingsUsername" class="bg-transparent text-xl font-medium border-b border-transparent hover:border-gray-500 focus:border-[#766ac8] px-1 py-1">
                        <p id="settingsEmail" class="text-gray-400 text-sm mt-1"></p>
                    </div>
                </div>
                <button onclick="updateProfile()" class="w-full bg-[#766ac8] hover:bg-[#8774d8] text-white py-3 rounded-xl transition">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </div>
        </div>
    </div>

    <!-- Context Menu for Messages -->
    <div id="messageContextMenu" class="context-menu fixed bg-[#2b2b2b] rounded-xl shadow-xl z-50 py-2 w-40">
        <button onclick="replyToMessage()" class="w-full px-4 py-2 text-left hover:bg-[#3a3a3a] text-gray-300 text-sm">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
        <button onclick="copyMessage()" class="w-full px-4 py-2 text-left hover:bg-[#3a3a3a] text-gray-300 text-sm">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="deleteMessage()" class="w-full px-4 py-2 text-left hover:bg-[#3a3a3a] text-red-400 text-sm">–£–¥–∞–ª–∏—Ç—å</button>
    </div>

<script>
// ==================== FIREBASE CONFIG ====================
// –í–°–¢–ê–í–¨–¢–ï –°–í–û–ô –ö–û–ù–§–ò–ì –ó–î–ï–°–¨:
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ==================== GLOBAL STATE ====================
let currentUser = null;
let currentChat = null;
let currentChatId = null;
let chats = {};
let users = {};
let typingTimeout = null;
let selectedMessageId = null;

// ==================== AUTH FUNCTIONS ====================
async function register() {
    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    const username = document.getElementById('usernameInput').value.trim();
    
    if (!email || !password || !username) {
        showAuthError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
    }
    
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Create user in database
        await db.ref('users/' + user.uid).set({
            uid: user.uid,
            email: email,
            username: username,
            avatar: getAvatarColor(),
            online: true,
            lastSeen: firebase.database.ServerValue.TIMESTAMP,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        showMainApp();
    } catch (error) {
        showAuthError(getErrorMessage(error.code));
    }
}

async function login() {
    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    
    if (!email || !password) {
        showAuthError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
        return;
    }
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        showAuthError(getErrorMessage(error.code));
    }
}

function logout() {
    if (currentUser) {
        db.ref('users/' + currentUser.uid).update({
            online: false,
            lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
    }
    auth.signOut();
}

function getErrorMessage(code) {
    const errors = {
        'auth/email-already-in-use': 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è',
        'auth/invalid-email': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email',
        'auth/weak-password': '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)',
        'auth/user-not-found': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
        'auth/wrong-password': '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
        'auth/invalid-credential': '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞'
    };
    return errors[code] || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
}

function showAuthError(message) {
    const errorEl = document.getElementById('authError');
    errorEl.textContent = message;
    errorEl.classList.remove('hidden');
    setTimeout(() => errorEl.classList.add('hidden'), 3000);
}

// ==================== AUTH STATE LISTENER ====================
auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        
        // Get user data
        const snapshot = await db.ref('users/' + user.uid).once('value');
        const userData = snapshot.val();
        
        if (userData) {
            currentUser.username = userData.username;
            currentUser.avatar = userData.avatar;
            
            // Update online status
            db.ref('users/' + user.uid).update({
                online: true,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Set offline on disconnect
            db.ref('users/' + user.uid).onDisconnect().update({
                online: false,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            
            showMainApp();
            loadChats();
            listenToAllUsers();
        }
    } else {
        currentUser = null;
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }
});

// ==================== MAIN APP ====================
function showMainApp() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    updateUserInfo();
}

function updateUserInfo() {
    document.getElementById('menuAvatar').textContent = currentUser.username?.charAt(0).toUpperCase() || '?';
    document.getElementById('menuUsername').textContent = currentUser.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('settingsAvatar').textContent = currentUser.username?.charAt(0).toUpperCase() || '?';
    document.getElementById('settingsUsername').value = currentUser.username || '';
    document.getElementById('settingsEmail').textContent = currentUser.email;
}

// ==================== USERS ====================
function listenToAllUsers() {
    db.ref('users').on('value', (snapshot) => {
        users = snapshot.val() || {};
        updateChatStatuses();
    });
}

async function searchUsers() {
    const query = document.getElementById('searchInput').value.trim().toLowerCase();
    const resultsEl = document.getElementById('searchResults');
    
    if (!query) {
        resultsEl.classList.add('hidden');
        return;
    }
    
    const snapshot = await db.ref('users').once('value');
    const allUsers = snapshot.val() || {};
    
    let html = '';
    Object.values(allUsers).forEach(user => {
        if (user.uid !== currentUser.uid && user.username.toLowerCase().includes(query)) {
            html += `
                <div class="flex items-center gap-3 p-3 hover:bg-[#3a3a3a] cursor-pointer" onclick="startChat('${user.uid}')">
                    <div class="w-10 h-10 rounded-full ${user.avatar} flex items-center justify-center text-white font-medium">
                        ${user.username.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <p class="font-medium text-white">${user.username}</p>
                        <p class="text-xs text-gray-400">${user.online ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}</p>
                    </div>
                </div>
            `;
        }
    });
    
    if (html) {
        resultsEl.innerHTML = html;
        resultsEl.classList.remove('hidden');
    } else {
        resultsEl.innerHTML = '<p class="p-4 text-gray-400 text-center">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        resultsEl.classList.remove('hidden');
    }
}

// ==================== CHATS ====================
function getChatId(uid1, uid2) {
    return [uid1, uid2].sort().join('_');
}

async function startChat(otherUserId) {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').classList.add('hidden');
    
    const chatId = getChatId(currentUser.uid, otherUserId);
    
    // Get other user data
    const userSnapshot = await db.ref('users/' + otherUserId).once('value');
    const otherUser = userSnapshot.val();
    
    // Create chat if not exists
    const chatRef = db.ref('chats/' + chatId);
    const chatSnapshot = await chatRef.once('value');
    
    if (!chatSnapshot.exists()) {
        await chatRef.set({
            id: chatId,
            participants: {
                [currentUser.uid]: true,
                [otherUserId]: true
            },
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
    
    // Add to user chats
    await db.ref('userChats/' + currentUser.uid + '/' + chatId).set({
        odtherUserId: otherUserId,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    await db.ref('userChats/' + otherUserId + '/' + chatId).set({
        odtherUserId: currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    openChat(chatId, otherUser);
}

function loadChats() {
    db.ref('userChats/' + currentUser.uid).orderByChild('timestamp').on('value', async (snapshot) => {
        const userChats = snapshot.val() || {};
        const chatListEl = document.getElementById('chatList');
        
        if (Object.keys(userChats).length === 0) {
            chatListEl.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <p>–ù–µ—Ç —á–∞—Ç–æ–≤</p>
                    <p class="text-sm">–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        for (const [chatId, chatData] of Object.entries(userChats)) {
            // Get other user
            const chatSnapshot = await db.ref('chats/' + chatId).once('value');
            const chat = chatSnapshot.val();
            
            if (!chat) continue;
            
            const otherUserId = Object.keys(chat.participants).find(id => id !== currentUser.uid);
            const userSnapshot = await db.ref('users/' + otherUserId).once('value');
            const otherUser = userSnapshot.val();
            
            if (!otherUser) continue;
            
            // Get last message
            const messagesSnapshot = await db.ref('messages/' + chatId).orderByChild('timestamp').limitToLast(1).once('value');
            const messages = messagesSnapshot.val();
            let lastMessage = '';
            let lastTime = '';
            let unread = 0;
            
            if (messages) {
                const msg = Object.values(messages)[0];
                lastMessage = msg.text.length > 30 ? msg.text.substring(0, 30) + '...' : msg.text;
                lastTime = formatTime(msg.timestamp);
                
                // Count unread
                const unreadSnapshot = await db.ref('messages/' + chatId).orderByChild('read').equalTo(false).once('value');
                const unreadMessages = unreadSnapshot.val() || {};
                unread = Object.values(unreadMessages).filter(m => m.senderId !== currentUser.uid).length;
            }
            
            const isActive = currentChatId === chatId;
            
            html += `
                <div class="chat-item flex items-center gap-3 px-4 py-3 cursor-pointer ${isActive ? 'active' : ''}" 
                     onclick="openChat('${chatId}', ${JSON.stringify(otherUser).replace(/"/g, '&quot;')})"
                     data-chat-id="${chatId}" data-user-id="${otherUserId}">
                    <div class="relative">
                        <div class="w-12 h-12 rounded-full ${otherUser.avatar} flex items-center justify-center text-white font-medium text-lg">
                            ${otherUser.username.charAt(0).toUpperCase()}
                        </div>
                        ${otherUser.online ? '<div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-[#212121]"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <h3 class="font-medium text-white truncate">${otherUser.username}</h3>
                            <span class="text-xs text-gray-400">${lastTime}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-400 truncate">${lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</p>
                            ${unread > 0 ? `<span class="bg-[#766ac8] text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">${unread}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        chatListEl.innerHTML = html;
    });
}

function updateChatStatuses() {
    document.querySelectorAll('.chat-item').forEach(item => {
        const userId = item.dataset.userId;
        const user = users[userId];
        if (user) {
            const onlineIndicator = item.querySelector('.bg-green-500');
            if (user.online && !onlineIndicator) {
                const avatar = item.querySelector('.rounded-full');
                avatar.parentElement.insertAdjacentHTML('beforeend', 
                    '<div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-[#212121]"></div>');
            } else if (!user.online && onlineIndicator) {
                onlineIndicator.remove();
            }
        }
    });
    
    // Update current chat status
    if (currentChat) {
        const user = users[currentChat.uid];
        if (user) {
            document.getElementById('chatStatus').textContent = user.online ? '–≤ —Å–µ—Ç–∏' : `–±—ã–ª(–∞) ${formatLastSeen(user.lastSeen)}`;
        }
    }
}

async function openChat(chatId, otherUser) {
    currentChatId = chatId;
    currentChat = otherUser;
    
    document.getElementById('noChatSelected').classList.add('hidden');
    document.getElementById('chatView').classList.remove('hidden');
    
    document.getElementById('chatAvatar').textContent = otherUser.username.charAt(0).toUpperCase();
    document.getElementById('chatAvatar').className = `w-10 h-10 rounded-full ${otherUser.avatar} flex items-center justify-center text-white font-medium`;
    document.getElementById('chatName').textContent = otherUser.username;
    document.getElementById('chatStatus').textContent = otherUser.online ? '–≤ —Å–µ—Ç–∏' : `–±—ã–ª(–∞) ${formatLastSeen(otherUser.lastSeen)}`;
    
    // Update active state in chat list
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.toggle('active', item.dataset.chatId === chatId);
    });
    
    // Mark messages as read
    db.ref('messages/' + chatId).orderByChild('senderId').equalTo(otherUser.uid).once('value', (snapshot) => {
        snapshot.forEach(child => {
            if (!child.val().read) {
                child.ref.update({ read: true });
            }
        });
    });
    
    // Load and listen to messages
    loadMessages(chatId);
    listenToTyping(chatId);
}

// ==================== MESSAGES ====================
function loadMessages(chatId) {
    db.ref('messages/' + chatId).orderByChild('timestamp').off();
    
    db.ref('messages/' + chatId).orderByChild('timestamp').on('value', (snapshot) => {
        const messages = snapshot.val() || {};
        const messagesArea = document.getElementById('messagesArea');
        
        let html = '';
        let lastDate = '';
        
        Object.entries(messages).forEach(([id, msg]) => {
            const msgDate = new Date(msg.timestamp).toLocaleDateString('ru-RU');
            
            if (msgDate !== lastDate) {
                html += `<div class="text-center my-4"><span class="bg-[#2b2b2b] text-gray-400 text-xs px-3 py-1 rounded-full">${formatDate(msg.timestamp)}</span></div>`;
                lastDate = msgDate;
            }
            
            const isOwn = msg.senderId === currentUser.uid;
            
            html += `
                <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} mb-2" data-message-id="${id}" oncontextmenu="showMessageMenu(event, '${id}', '${msg.text.replace(/'/g, "\\'")}')">
                    <div class="message-bubble ${isOwn ? 'bg-[#766ac8]' : 'bg-[#212121]'} rounded-2xl px-4 py-2 ${isOwn ? 'rounded-br-sm' : 'rounded-bl-sm'}">
                        ${msg.replyTo ? `<div class="text-xs ${isOwn ? 'text-purple-200' : 'text-gray-400'} border-l-2 ${isOwn ? 'border-purple-300' : 'border-gray-500'} pl-2 mb-1">${msg.replyTo}</div>` : ''}
                        <p class="text-white break-words">${escapeHtml(msg.text)}</p>
                        <div class="flex items-center justify-end gap-1 mt-1">
                            <span class="${isOwn ? 'text-purple-200' : 'text-gray-500'} text-xs">${formatTime(msg.timestamp)}</span>
                            ${isOwn ? `
                                <svg class="w-4 h-4 ${msg.read ? 'text-blue-300' : 'text-purple-200'}" fill="currentColor" viewBox="0 0 24 24">
                                    ${msg.read ? 
                                        '<path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"/>' : 
                                        '<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>'}
                                </svg>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        messagesArea.innerHTML = html || '<p class="text-center text-gray-500 py-8">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p>';
        messagesArea.scrollTop = messagesArea.scrollHeight;
    });
}

let replyToText = null;

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    
    if (!text || !currentChatId) return;
    
    const messageData = {
        senderId: currentUser.uid,
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        read: false
    };
    
    if (replyToText) {
        messageData.replyTo = replyToText;
        replyToText = null;
    }
    
    await db.ref('messages/' + currentChatId).push(messageData);
    
    // Update chat timestamp
    await db.ref('userChats/' + currentUser.uid + '/' + currentChatId).update({
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    const otherUserId = Object.keys((await db.ref('chats/' + currentChatId + '/participants').once('value')).val()).find(id => id !== currentUser.uid);
    await db.ref('userChats/' + otherUserId + '/' + currentChatId).update({
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    input.value = '';
    input.style.height = 'auto';
    
    // Stop typing indicator
    db.ref('typing/' + currentChatId + '/' + currentUser.uid).remove();
}

// ==================== TYPING INDICATOR ====================
function handleTyping() {
    if (!currentChatId) return;
    
    db.ref('typing/' + currentChatId + '/' + currentUser.uid).set({
        username: currentUser.username,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        db.ref('typing/' + currentChatId + '/' + currentUser.uid).remove();
    }, 2000);
}

function listenToTyping(chatId) {
    db.ref('typing/' + chatId).off();
    
    db.ref('typing/' + chatId).on('value', (snapshot) => {
        const typing = snapshot.val() || {};
        const typingIndicator = document.getElementById('typingIndicator');
        const typingUser = document.getElementById('typingUser');
        
        const otherTyping = Object.entries(typing).find(([uid, data]) => uid !== currentUser.uid);
        
        if (otherTyping) {
            typingUser.textContent = otherTyping[1].username;
            typingIndicator.classList.remove('hidden');
        } else {
            typingIndicator.classList.add('hidden');
        }
    });
}

// ==================== MESSAGE CONTEXT MENU ====================
function showMessageMenu(event, messageId, messageText) {
    event.preventDefault();
    selectedMessageId = messageId;
    
    const menu = document.getElementById('messageContextMenu');
    menu.classList.add('show');
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
    menu.dataset.text = messageText;
}

function replyToMessage() {
    const menu = document.getElementById('messageContextMenu');
    replyToText = menu.dataset.text;
    document.getElementById('messageInput').placeholder = `–û—Ç–≤–µ—Ç –Ω–∞: ${replyToText.substring(0, 30)}...`;
    document.getElementById('messageInput').focus();
    hideMessageMenu();
}

function copyMessage() {
    const menu = document.getElementById('messageContextMenu');
    navigator.clipboard.writeText(menu.dataset.text);
    hideMessageMenu();
}

async function deleteMessage() {
    if (selectedMessageId && currentChatId) {
        await db.ref('messages/' + currentChatId + '/' + selectedMessageId).remove();
    }
    hideMessageMenu();
}

function hideMessageMenu() {
    document.getElementById('messageContextMenu').classList.remove('show');
}

// ==================== CHAT ACTIONS ====================
async function clearChat() {
    if (currentChatId && confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è?')) {
        await db.ref('messages/' + currentChatId).remove();
    }
    toggleChatMenu();
}

async function deleteChat() {
    if (currentChatId && confirm('–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?')) {
        await db.ref('messages/' + currentChatId).remove();
        await db.ref('userChats/' + currentUser.uid + '/' + currentChatId).remove();
        
        currentChatId = null;
        currentChat = null;
        
        document.getElementById('chatView').classList.add('hidden');
        document.getElementById('noChatSelected').classList.remove('hidden');
    }
    toggleChatMenu();
}

// ==================== EMOJI ====================
function toggleEmoji() {
    const picker = document.getElementById('emojiPicker');
    picker.classList.toggle('show');
    
    if (picker.classList.contains('show') && !picker.innerHTML) {
        const emojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','üòö','üòô','ü•≤','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','ü•¥','üòµ','ü§Ø','ü§†','ü•≥','ü•∏','üòé','ü§ì','üßê','üëã','ü§ö','üñê','‚úã','üññ','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','üíï','üíû','üíì','üíó','üíñ','üíò','üíù'];
        picker.innerHTML = emojis.map(e => `<button class="text-2xl p-1 hover:bg-[#3a3a3a] rounded" onclick="insertEmoji('${e}')">${e}</button>`).join('');
    }
}

function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    input.value += emoji;
    input.focus();
}

// ==================== UI HELPERS ====================
function toggleMenu() {
    document.getElementById('menuDropdown').classList.toggle('hidden');
}

function toggleChatMenu() {
    document.getElementById('chatMenu').classList.toggle('hidden');
}

function showSettings() {
    document.getElementById('settingsModal').classList.remove('hidden');
    toggleMenu();
}

function hideSettings() {
    document.getElementById('settingsModal').classList.add('hidden');
}

async function updateProfile() {
    const newUsername = document.getElementById('settingsUsername').value.trim();
    if (newUsername) {
        await db.ref('users/' + currentUser.uid).update({ username: newUsername });
        currentUser.username = newUsername;
        updateUserInfo();
        hideSettings();
    }
}

function showNewGroup() {
    alert('–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
    toggleMenu();
}

function attachFile() {
    alert('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
}

function startCall(type) {
    alert(`${type === 'video' ? '–í–∏–¥–µ–æ' : '–ì–æ–ª–æ—Å–æ–≤—ã–µ'} –∑–≤–æ–Ω–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏`);
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
}

// ==================== UTILITIES ====================
function getAvatarColor() {
    const colors = [
        'bg-gradient-to-br from-red-500 to-pink-500',
        'bg-gradient-to-br from-blue-500 to-purple-600',
        'bg-gradient-to-br from-green-500 to-teal-500',
        'bg-gradient-to-br from-yellow-500 to-orange-500',
        'bg-gradient-to-br from-purple-500 to-pink-500',
        'bg-gradient-to-br from-indigo-500 to-blue-500',
        'bg-gradient-to-br from-cyan-500 to-blue-500'
    ];
    return colors[Math.floor(Math.random() * colors.length)];
}

function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function formatDate(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) return '–°–µ–≥–æ–¥–Ω—è';
    if (date.toDateString() === yesterday.toDateString()) return '–í—á–µ—Ä–∞';
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
}

function formatLastSeen(timestamp) {
    if (!timestamp) return '–¥–∞–≤–Ω–æ';
    const date = new Date(timestamp);
    const now = new Date();
    const diff = (now - date) / 1000;
    
    if (diff < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (diff < 3600) return `${Math.floor(diff / 60)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} —á –Ω–∞–∑–∞–¥`;
    return date.toLocaleDateString('ru-RU');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ==================== EVENT LISTENERS ====================
document.addEventListener('click', (e) => {
    // Close menus when clicking outside
    if (!e.target.closest('#menuDropdown') && !e.target.closest('button')) {
        document.getElementById('menuDropdown').classList.add('hidden');
    }
    if (!e.target.closest('#chatMenu') && !e.target.closest('button')) {
        document.getElementById('chatMenu').classList.add('hidden');
    }
    if (!e.target.closest('#emojiPicker') && !e.target.closest('button')) {
        document.getElementById('emojiPicker').classList.remove('show');
    }
    if (!e.target.closest('#searchResults') && !e.target.closest('#searchInput')) {
        document.getElementById('searchResults').classList.add('hidden');
    }
    if (!e.target.closest('#messageContextMenu')) {
        hideMessageMenu();
    }
});

// Close settings on Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        hideSettings();
        hideMessageMenu();
    }
});
</script>

</body>
</html>
