<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Narrators v0.1.4 | Profiles & Avatars</title>

    <style>
        :root {
            --primary: #3390ec;
            --primary-soft: rgba(51, 144, 236, 0.1);
            --bg-body: #ffffff;
            --bg-chat-color: #ffffff;
            --msg-me: #eeffde;
            --msg-me-text: #000000;
            --msg-other: #f4f4f5;
            --msg-other-text: #000000;
            --radius: 12px;
            --font-size: 16px;
            --border: #e4e4e4;
            --text-main: #000000;
            --text-sec: #707579;
            --ease: cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body { 
            font-family: -apple-system, sans-serif; 
            height: 100vh; width: 100vw; display: flex; overflow: hidden; 
            background: var(--bg-body); font-size: var(--font-size);
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .panel { position: fixed; inset: 0; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; padding: 30px; }
        .auth-card { width: 100%; max-width: 360px; text-align: center; }
        
        #app { display: none; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s; }
        #app.visible { display: flex; opacity: 1; }

        /* –°–∞–π–¥–±–∞—Ä */
        #sidebar { width: 380px; flex-shrink: 0; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-top { padding: 15px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); }
        
        /* –ß–∞—Ç */
        #chat-window { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chat-top-bar { height: 65px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 25px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        
        #messages-view { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }

        /* –ü—É–∑—ã—Ä–∏ —Å –∞–≤–∞—Ç–∞—Ä–∫–∞–º–∏ */
        .msg-wrapper { display: flex; gap: 10px; align-items: flex-end; max-width: 85%; animation: fadeIn 0.3s; }
        .msg-wrapper.my-msg { align-self: flex-end; flex-direction: row-reverse; }
        .msg-wrapper.other-msg { align-self: flex-start; }

        .chat-avatar { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; flex-shrink: 0; object-fit: cover; background: #eee; }
        .msg-bubble { padding: 10px 14px; border-radius: var(--radius); position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .my-msg .msg-bubble { background: var(--msg-me); color: var(--msg-me-text); border-bottom-right-radius: 4px; }
        .other-msg .msg-bubble { background: var(--msg-other); color: var(--msg-other-text); border-bottom-left-radius: 4px; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è */
        #profile-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .profile-card {
            background: #fff; width: 90%; max-width: 400px; border-radius: 20px;
            padding: 30px; text-align: center; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .profile-card .large-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 4px solid var(--primary-soft); }

        /* –ö–Ω–æ–ø–∫–∏ –∏ –∏–Ω–ø—É—Ç—ã */
        .btn-main { padding: 14px; background: var(--primary); color: #fff; border-radius: 12px; font-weight: 600; width: 100%; cursor: pointer; border:none; margin-top:10px; }
        .input-field { padding: 12px; border: 1px solid var(--border); border-radius: 10px; width: 100%; margin-bottom: 10px; font-size: 14px; }
        
        .bottom-controls { padding: 15px 20px; border-top: 1px solid var(--border); }
        .input-group { display: flex; align-items: center; gap: 10px; }
        #main-input { flex: 1; border: none; resize: none; font-size: 16px; padding: 5px; }

        /* –û—Å—Ç–∞–ª—å–Ω–æ–µ */
        .time-stamp { font-size: 10px; opacity: 0.5; display: block; text-align: right; margin-top: 4px; }
        .author-tag { font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 3px; display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="screen-auth" class="panel">
        <div class="auth-card">
            <h1 style="color:var(--primary); font-size:42px; margin-bottom:10px;">Narrators</h1>
            <p style="color:var(--text-sec); margin-bottom:30px;">Version 0.1.4 Production</p>
            <button id="auth-google-trigger" class="btn-main" style="background:#fff; color:#444; border:1px solid #ddd;">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
        </div>
    </div>

    <div id="screen-reg" class="panel" style="display:none;">
        <div class="auth-card">
            <h2>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <input id="reg-nickname" class="input-field" placeholder="–í–∞—à–µ –∏–º—è">
            <input id="reg-username" class="input-field" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–≥ (–Ω–∞–ø—Ä. john_doe)">
            <button id="reg-confirm-btn" class="btn-main">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
        </div>
    </div>

    <div id="app">
        <div id="sidebar">
            <div class="sidebar-top">
                <button onclick="uiAction.openMenu()" style="font-size:20px; background:none;">‚ò∞</button>
                <div style="font-weight:800; font-size:18px; flex:1; text-align:center;">Narrators</div>
            </div>
            <div style="padding: 10px 15px; border-bottom: 1px solid var(--border);">
                <input id="user-search-input" class="input-field" placeholder="–ü–æ–∏—Å–∫ @—Ç–µ–≥–∞..." style="margin-bottom:0;">
            </div>
            <div id="search-results" style="display:none; max-height: 200px; overflow-y: auto; background:#f9f9f9;"></div>
            
            <div class="chat-list-container" style="flex:1;">
                <div class="chat-row" style="padding:15px; display:flex; gap:12px; background:var(--primary-soft); cursor:pointer;">
                    <img src="https://cdn-icons-png.flaticon.com/512/1041/1041916.png" style="width:45px; height:45px; border-radius:50%;">
                    <div>
                        <div style="font-weight:700;">Global Chat Room</div>
                        <div style="font-size:12px; color:var(--text-sec);">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–¥–µ—Å—å</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-window">
            <div class="chat-top-bar">
                <div style="font-weight:700;">Global Chat Room</div>
            </div>
            <div id="messages-view"></div>
            <div class="bottom-controls">
                <div class="input-group">
                    <button onclick="chatEngine.attachImage()" style="font-size:20px; background:none;">üì∑</button>
                    <textarea id="main-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                    <button onclick="chatEngine.sendMessage()" style="color:var(--primary); font-size:24px; background:none;">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" onclick="uiAction.closeProfile(event)">
        <div class="profile-card" onclick="event.stopPropagation()">
            <img id="view-user-ava" class="large-avatar" src="">
            <h2 id="view-user-name">–ò–º—è –§–∞–º–∏–ª–∏—è</h2>
            <p id="view-user-tag" style="color:var(--primary); margin-bottom:10px;">@username</p>
            <p id="view-user-about" style="color:var(--text-sec); font-size:14px; margin-bottom:20px; line-height:1.4;">–û —Å–µ–±–µ –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ.</p>
            
            <div id="edit-profile-fields" style="display:none; border-top:1px solid #eee; pt:20px; margin-top:20px;">
                <p style="font-size:11px; font-weight:700; margin-bottom:10px; color:var(--primary);">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –ü–†–û–§–ò–õ–¨</p>
                <input id="edit-ava-url" class="input-field" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ">
                <textarea id="edit-about-text" class="input-field" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..." rows="2" style="resize:none;"></textarea>
                <button class="btn-main" onclick="uiAction.saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
            <button class="btn-main" style="background:#eee; color:#333; margin-top:15px;" onclick="uiAction.closeProfile()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithRedirect, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, get, child, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcrCVxPPU_PVOeFFBJ8sKXehMZyKaB4ks",
            authDomain: "narrators-messenger.firebaseapp.com",
            databaseURL: "https://narrators-messenger-default-rtdb.firebaseio.com",
            projectId: "narrators-messenger",
            storageBucket: "narrators-messenger.firebasestorage.app",
            messagingSenderId: "421115209686",
            appId: "1:421115209686:web:94d5560793540f14f02677"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getDatabase(firebaseApp);
        const provider = new GoogleAuthProvider();

        let state = { user: null, profile: null };

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        document.getElementById('auth-google-trigger').onclick = () => signInWithRedirect(auth, provider);
        
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                state.user = u;
                const snap = await get(ref(db, `users/${u.uid}`));
                if (snap.exists()) {
                    state.profile = snap.val();
                    launchApp();
                } else {
                    document.getElementById('screen-auth').style.display = 'none';
                    document.getElementById('screen-reg').style.display = 'flex';
                }
            } else {
                document.getElementById('screen-auth').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        document.getElementById('reg-confirm-btn').onclick = async () => {
            const nick = document.getElementById('reg-nickname').value.trim();
            const tag = document.getElementById('reg-username').value.trim().replace('@','');
            if (nick.length < 2 || tag.length < 2) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
            
            state.profile = { 
                uid: state.user.uid, displayName: nick, username: tag.toLowerCase(), 
                usernameDisplay: tag, photoURL: state.user.photoURL || '', about: "–ü—Ä–∏–≤–µ—Ç! –Ø –∏—Å–ø–æ–ª—å–∑—É—é Narrators."
            };
            await set(ref(db, `users/${state.user.uid}`), state.profile);
            launchApp();
        };

        function launchApp() {
            document.getElementById('screen-auth').style.display = 'none';
            document.getElementById('screen-reg').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('app').classList.add('visible');
            chatEngine.listen();
            initSearch();
        }

        // –î–í–ò–ñ–û–ö –ß–ê–¢–ê
        window.chatEngine = {
            sendMessage: function() {
                const input = document.getElementById('main-input');
                if (!input.value.trim()) return;
                push(ref(db, 'messages'), {
                    uid: state.user.uid,
                    displayName: state.profile.displayName,
                    photoURL: state.profile.photoURL,
                    text: input.value,
                    createdAt: Date.now()
                });
                input.value = '';
            },
            listen: function() {
                onValue(ref(db, 'messages'), (snap) => {
                    const view = document.getElementById('messages-view');
                    view.innerHTML = '';
                    const data = snap.val();
                    if (!data) return;
                    Object.entries(data).sort((a,b) => a[1].createdAt - b[1].createdAt).forEach(([id, m]) => {
                        const isMe = m.uid === state.user.uid;
                        const div = document.createElement('div');
                        div.className = `msg-wrapper ${isMe ? 'my-msg' : 'other-msg'}`;
                        div.innerHTML = `
                            <img class="chat-avatar" src="${m.photoURL || 'https://via.placeholder.com/50'}" onclick="uiAction.openProfile('${m.uid}')">
                            <div class="msg-bubble">
                                <span class="author-tag" onclick="uiAction.openProfile('${m.uid}')" style="cursor:pointer">${m.displayName}</span>
                                <div>${m.text}</div>
                                <span class="time-stamp">${new Date(m.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                            </div>
                        `;
                        view.appendChild(div);
                    });
                    view.scrollTop = view.scrollHeight;
                });
            }
        };

        // UI ACTIONS
        window.uiAction = {
            openProfile: async function(uid) {
                const modal = document.getElementById('profile-modal');
                const snap = await get(ref(db, `users/${uid}`));
                if (!snap.exists()) return;
                const u = snap.val();

                document.getElementById('view-user-ava').src = u.photoURL || 'https://via.placeholder.com/150';
                document.getElementById('view-user-name').innerText = u.displayName;
                document.getElementById('view-user-tag').innerText = '@' + u.usernameDisplay;
                document.getElementById('view-user-about').innerText = u.about || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Å—Ç–∞–≤–∏–ª –æ–ø–∏—Å–∞–Ω–∏—è.";

                // –ï—Å–ª–∏ —ç—Ç–æ –ú–û–ô –ø—Ä–æ—Ñ–∏–ª—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const isMe = uid === state.user.uid;
                document.getElementById('edit-profile-fields').style.display = isMe ? 'block' : 'none';
                if (isMe) {
                    document.getElementById('edit-ava-url').value = u.photoURL;
                    document.getElementById('edit-about-text').value = u.about || "";
                }

                modal.style.display = 'flex';
            },
            closeProfile: () => document.getElementById('profile-modal').style.display = 'none',
            saveProfile: async function() {
                const newAva = document.getElementById('edit-ava-url').value.trim();
                const newAbout = document.getElementById('edit-about-text').value.trim();
                
                const updates = { photoURL: newAva, about: newAbout };
                await update(ref(db, `users/${state.user.uid}`), updates);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                state.profile.photoURL = newAva;
                state.profile.about = newAbout;
                
                alert("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!");
                this.closeProfile();
            }
        };

        function initSearch() {
            const input = document.getElementById('user-search-input');
            const res = document.getElementById('search-results');
            input.oninput = async () => {
                const q = input.value.trim().toLowerCase().replace('@','');
                if (q.length < 2) return res.style.display = 'none';
                const snap = await get(ref(db, 'users'));
                res.innerHTML = '';
                if (snap.exists()) {
                    Object.values(snap.val()).filter(u => u.username.includes(q)).forEach(u => {
                        const d = document.createElement('div');
                        d.style.padding = '10px'; d.style.display='flex'; d.style.gap='10px'; d.style.cursor='pointer'; d.style.borderBottom='1px solid #eee';
                        d.innerHTML = `<img src="${u.photoURL}" style="width:30px; height:30px; border-radius:50%;"><p>${u.displayName} (@${u.usernameDisplay})</p>`;
                        d.onclick = () => uiAction.openProfile(u.uid);
                        res.appendChild(d);
                    });
                    res.style.display = 'block';
                }
            };
        }

        document.getElementById('main-input').onkeydown = (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); chatEngine.sendMessage(); }};
    </script>
</body>
</html>
